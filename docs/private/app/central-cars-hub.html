<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application de Facturation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { v4 as uuidv4 } from 'https://cdn.jsdelivr.net/npm/uuid@9.0.0/dist/esm-browser/index.js';
        
        // Global Firebase variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Set log level for debugging
        setLogLevel('Debug');

        // Firebase initialization
        let app, db, auth;
        let userId = null;
        let currentInvoiceId = null;
        let currentProductId = null;
        let products = [];
        let currentView = 'list';
        let latestInvoiceNumber = 0;

        // Initialize app and authentication
        const initFirebase = async () => {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id').textContent = `ID Utilisateur: ${userId}`;
                        setupRealtimeInvoices();
                        setupRealtimeProducts();
                        await fetchLatestInvoiceNumber();
                    } else {
                        userId = null;
                        document.getElementById('user-id').textContent = `ID Utilisateur: non authentifié`;
                    }
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Initialize views
                switchView('list');
            } catch (error) {
                console.error("Error during Firebase initialization or authentication:", error);
            }
        };

        // Function to fetch the latest invoice number
        const fetchLatestInvoiceNumber = async () => {
            const invoicesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/invoices`);
            try {
                // Fetch all documents and sort them by the invoice number suffix
                const querySnapshot = await getDocs(invoicesCollectionRef);
                let latest = 0;
                querySnapshot.forEach(doc => {
                    const numero = doc.data().numeroFacture;
                    if (numero) {
                        const parts = numero.split(/(\d+)/).filter(Boolean);
                        const suffix = parseInt(parts[parts.length - 1], 10);
                        if (!isNaN(suffix) && suffix > latest) {
                            latest = suffix;
                        }
                    }
                });
                latestInvoiceNumber = latest;
            } catch (error) {
                console.error("Error fetching latest invoice number:", error);
            }
        };

        // Function to generate the invoice number
        const generateInvoiceNumber = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            latestInvoiceNumber++;
            const invoiceNumber = String(latestInvoiceNumber).padStart(4, '0');
            return `${year}${month}${invoiceNumber}`;
        };

        // Function to set up real-time listening for invoices
        const setupRealtimeInvoices = () => {
            const invoicesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/invoices`);
            onSnapshot(invoicesCollectionRef, (snapshot) => {
                const invoices = [];
                snapshot.forEach(doc => {
                    invoices.push({ id: doc.id, ...doc.data() });
                });
                renderInvoiceList(invoices);
            });
        };

        // Function to set up real-time listening for products
        const setupRealtimeProducts = () => {
            const productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/products`);
            onSnapshot(productsCollectionRef, (snapshot) => {
                products = [];
                snapshot.forEach(doc => {
                    products.push({ id: doc.id, ...doc.data() });
                });
                renderProductList(products);
                populateProductDropdown(products);
            });
        };

        // Function to switch between views
        const switchView = (view, data = null) => {
            currentView = view;
            const views = ['invoice-list-view', 'invoice-editor-view', 'product-management-view'];
            views.forEach(v => document.getElementById(v).classList.add('hidden'));

            if (view === 'list') {
                document.getElementById('invoice-list-view').classList.remove('hidden');
            } else if (view === 'editor') {
                document.getElementById('invoice-editor-view').classList.remove('hidden');
                loadInvoiceData(data);
            } else if (view === 'product-management') {
                document.getElementById('product-management-view').classList.remove('hidden');
                loadProductData();
            }
        };
        window.switchView = switchView;

        // --- Invoice editor management functions ---

        // Function to load invoice data into the editing form
        const loadInvoiceData = (invoiceData) => {
            const form = document.getElementById('invoice-form');
            form.reset();
            currentInvoiceId = null;
            document.getElementById('product-list').innerHTML = '';
            
            if (invoiceData) {
                currentInvoiceId = invoiceData.id;
                document.getElementById('numero-facture').value = invoiceData.numeroFacture || '';
                document.getElementById('date-creation').value = invoiceData.dateCreation || '';
                document.getElementById('objet').value = invoiceData.objet || '';
                document.getElementById('nom-acheteur').value = invoiceData.nomAcheteur || '';
                document.getElementById('numero-tva').value = invoiceData.numeroTva || '';
                document.getElementById('siren').value = invoiceData.siren || '';
                document.getElementById('n-voie').value = invoiceData.nVoie || '';
                document.getElementById('ext-voie').value = invoiceData.extVoie || '';
                document.getElementById('type-voie').value = invoiceData.typeVoie || '';
                document.getElementById('nom-voie').value = invoiceData.nomVoie || '';
                document.getElementById('code-postal').value = invoiceData.codePostal || '';
                document.getElementById('ville').value = invoiceData.ville || '';
                document.getElementById('pays').value = invoiceData.pays || '';
                document.getElementById('telephone').value = invoiceData.telephone || '';
                document.getElementById('email').value = invoiceData.email || '';
                document.getElementById('immatriculation').value = invoiceData.immatriculation !== '' ? invoiceData.immatriculation : '';
                document.getElementById('immatriculation-toggle').checked = invoiceData.immatriculation !== '';
                document.getElementById('invoice-status').value = invoiceData.etat || 'Créé';

                if (invoiceData.produits && invoiceData.produits.length > 0) {
                    document.getElementById('product-list').innerHTML = '';
                    invoiceData.produits.forEach(prod => addProduct(prod));
                }
            } else {
                // Add a default row for a new invoice and generate a number
                document.getElementById('numero-facture').value = generateInvoiceNumber();
                document.getElementById('date-creation').valueAsDate = new Date();
                document.getElementById('invoice-status').value = 'Créé';
                addProduct();
            }
            calculateTotals();
        };

        // Function to render the list of invoices
        const renderInvoiceList = (invoices) => {
            const tableBody = document.getElementById('invoice-table-body');
            tableBody.innerHTML = '';
            invoices.forEach(invoice => {
                const row = document.createElement('tr');
                row.classList.add('border-b', 'hover:bg-gray-50');
                row.innerHTML = `
                    <td class="py-2 px-4">${invoice.numeroFacture || 'N/A'}</td>
                    <td class="py-2 px-4">${invoice.dateCreation || 'N/A'}</td>
                    <td class="py-2 px-4">${invoice.nomAcheteur || 'N/A'}</td>
                    <td class="py-2 px-4">${invoice.totalTTC ? invoice.totalTTC.toFixed(2) + ' EUR' : '0.00 EUR'}</td>
                    <td class="py-2 px-4">
                        <span class="inline-block px-2 py-1 text-xs font-semibold rounded-full ${
                            invoice.etat === 'Payé' ? 'bg-green-100 text-green-800' :
                            invoice.etat === 'Payé en partie' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'
                        }">
                            ${invoice.etat || 'Créé'}
                        </span>
                    </td>
                    <td class="py-2 px-4">
                        <button onclick='window.switchView("editor", ${JSON.stringify(invoice)})' class="bg-blue-500 text-white text-xs px-2 py-1 rounded-full hover:bg-blue-600 transition-colors">Éditer</button>
                        <button onclick='window.generatePdfFromInvoiceData(${JSON.stringify(invoice)})' class="bg-gray-700 text-white text-xs px-2 py-1 rounded-full ml-2 hover:bg-gray-800 transition-colors">PDF</button>
                        <button onclick='showConfirmModal("deleteInvoice", "${invoice.id}")' class="bg-red-500 text-white text-xs px-2 py-1 rounded-full ml-2 hover:bg-red-600 transition-colors">Supprimer</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        };

        // Function to save the invoice (create or update)
        const saveInvoice = async () => {
            const invoiceData = {
                numeroFacture: document.getElementById('numero-facture').value,
                dateCreation: document.getElementById('date-creation').value,
                objet: document.getElementById('objet').value,
                nomAcheteur: document.getElementById('nom-acheteur').value,
                numeroTva: document.getElementById('numero-tva').value,
                siren: document.getElementById('siren').value,
                nVoie: document.getElementById('n-voie').value,
                extVoie: document.getElementById('ext-voie').value,
                typeVoie: document.getElementById('type-voie').value,
                nomVoie: document.getElementById('nom-voie').value,
                codePostal: document.getElementById('code-postal').value,
                ville: document.getElementById('ville').value,
                pays: document.getElementById('pays').value,
                telephone: document.getElementById('telephone').value,
                email: document.getElementById('email').value,
                immatriculation: document.getElementById('immatriculation-toggle').checked ? document.getElementById('immatriculation').value : '',
                totalHT: parseFloat(document.getElementById('total-ht').textContent) || 0,
                totalTVA: parseFloat(document.getElementById('total-tva').textContent) || 0,
                totalTTC: parseFloat(document.getElementById('total-ttc').textContent) || 0,
                produits: getProductData(),
                etat: document.getElementById('invoice-status').value,
                modeReglement1: document.getElementById('premier-mode-reglement').value,
                reference1: document.getElementById('premiere-reference').value,
            };

            const invoicesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/invoices`);

            try {
                if (currentInvoiceId) {
                    await updateDoc(doc(invoicesCollectionRef, currentInvoiceId), invoiceData);
                } else {
                    await addDoc(invoicesCollectionRef, invoiceData);
                }
                switchView('list');
            } catch (error) {
                console.error("Error saving invoice:", error);
            }
        };
        window.saveInvoice = saveInvoice;

        // Function to delete an invoice
        const deleteInvoice = async (invoiceId) => {
            try {
                const invoicesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/invoices`);
                await deleteDoc(doc(invoicesCollectionRef, invoiceId));
                closeConfirmModal();
            } catch (error) {
                console.error("Error deleting invoice:", error);
            }
        };
        window.deleteInvoice = deleteInvoice;

        // Get product data from the invoice editor form
        const getProductData = () => {
            const products = [];
            document.querySelectorAll('.product-row-container').forEach(container => {
                const row = container.querySelector('.product-row');
                const product = {
                    nom: row.querySelector('.product-name').value,
                    ref: row.querySelector('.product-ref').value,
                    qte: parseFloat(row.querySelector('.qte').value) || 0,
                    categorie: row.querySelector('.product-category').value,
                    puHt: parseFloat(row.querySelector('.pu-ht').value) || 0,
                    tva: parseFloat(row.querySelector('.tva').value) || 0,
                    reduction: parseFloat(row.querySelector('.reduction').value) || 0,
                    totalHt: parseFloat(row.querySelector('.total-ht').value) || 0,
                    totalTtc: parseFloat(row.querySelector('.total-ttc').value) || 0,
                    observation: container.querySelector('.observation-field').value
                };
                products.push(product);
            });
            return products;
        };

        // Functions for calculating totals and managing product rows
        const addProduct = (productData = {}) => {
            const productList = document.getElementById('product-list');
            const newContainer = document.createElement('div');
            newContainer.classList.add('product-row-container', 'mb-4');
            
            const randomId = uuidv4();

            newContainer.innerHTML = `
                <div class="product-line-container relative">
                    <button type="button" onclick="window.removeProduct(this)" class="absolute left-0 top-1/2 -translate-y-1/2 bg-red-500 text-white w-6 h-6 flex items-center justify-center rounded-full ml-2 hover:bg-red-600 transition-colors z-20">
                        &times;
                    </button>
                    <div class="product-row grid grid-cols-11 gap-2 items-center pl-8">
                        <div class="col-span-2 relative">
                            <input type="text" placeholder="Nom" class="rounded-md p-2 product-name text-xs sm:text-sm" value="${productData.nom || ''}" data-uuid="${randomId}">
                            <div id="suggestions-box-${randomId}" class="suggestions-box absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto"></div>
                        </div>
                        <div><input type="text" placeholder="Réf" class="rounded-md p-2 product-ref text-xs sm:text-sm" value="${productData.ref || ''}"></div>
                        <div><input type="number" value="${productData.qte || 1}" min="1" class="rounded-md p-2 qte text-xs sm:text-sm"></div>
                        <div>
                            <select class="rounded-md p-2 product-category text-xs sm:text-sm">
                                <option>Prestation</option>
                            </select>
                        </div>
                        <div><input type="number" step="0.01" value="${productData.puHt || 0.00}" class="rounded-md p-2 pu-ht text-xs sm:text-sm"></div>
                        <div>
                            <select class="rounded-md p-2 tva text-xs sm:text-sm">
                                <option value="20" ${productData.tva === 20 ? 'selected' : ''}>20</option>
                                <option value="10" ${productData.tva === 10 ? 'selected' : ''}>10</option>
                                <option value="5.5" ${productData.tva === 5.5 ? 'selected' : ''}>5.5</option>
                                <option value="0" ${productData.tva === 0 ? 'selected' : ''}>0</option>
                            </select>
                        </div>
                        <div><input type="number" step="0.01" value="${productData.totalHt || 0.00}" class="rounded-md p-2 total-ht text-xs sm:text-sm" readonly></div>
                        <div>
                            <div class="flex items-center">
                                <input type="number" step="0.01" value="${productData.reduction || 0.00}" class="rounded-md p-2 reduction text-xs sm:text-sm">
                                <span class="ml-1 text-gray-500 text-xs">EUR</span>
                            </div>
                        </div>
                        <div><input type="number" step="0.01" value="${productData.totalTtc || 0.00}" class="rounded-md p-2 total-ttc text-xs sm:text-sm"></div>
                    </div>
                    <div class="mt-2 pl-8">
                        <label for="observation-${randomId}" class="block text-sm font-medium text-gray-700">Observation</label>
                        <textarea id="observation-${randomId}" class="observation-field w-full h-16 rounded-md p-2 text-sm">${productData.observation || ''}</textarea>
                    </div>
                </div>
            `;

            productList.appendChild(newContainer);
            
            const puHtInput = newContainer.querySelector('.pu-ht');
            const qteInput = newContainer.querySelector('.qte');
            const tvaSelect = newContainer.querySelector('.tva');
            const reductionInput = newContainer.querySelector('.reduction');
            const totalTtcInput = newContainer.querySelector('.total-ttc');
            const productNameInput = newContainer.querySelector('.product-name');
            const suggestionsBox = document.getElementById(`suggestions-box-${randomId}`);
            
            // Event listeners for calculations
            puHtInput.addEventListener('input', (event) => calculateFromPuht(event.target.closest('.product-row-container')));
            qteInput.addEventListener('input', (event) => calculateFromPuht(event.target.closest('.product-row-container')));
            tvaSelect.addEventListener('change', (event) => calculateFromPuht(event.target.closest('.product-row-container')));
            reductionInput.addEventListener('input', (event) => calculateFromPuht(event.target.closest('.product-row-container')));
            totalTtcInput.addEventListener('input', (event) => calculateFromTtc(event.target.closest('.product-row-container')));

            // Initialize autocompletion for the new row
            setupAutocomplete(productNameInput, suggestionsBox);
            
            calculateTotals();
        };
        window.addProduct = addProduct;

        const removeProduct = (button) => {
            const productList = document.getElementById('product-list');
            const container = button.closest('.product-row-container');
            productList.removeChild(container);
            calculateTotals();
        };
        window.removeProduct = removeProduct;

        // Function to set up autocompletion events
        const setupAutocomplete = (input, suggestionsBox) => {
            input.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                suggestionsBox.innerHTML = '';
                
                if (query.length < 1) {
                    suggestionsBox.classList.add('hidden');
                    return;
                }
                
                const filteredProducts = products.filter(prod => 
                    prod.nom.toLowerCase().includes(query) || prod.ref.toLowerCase().includes(query)
                );
                
                if (filteredProducts.length > 0) {
                    filteredProducts.forEach(prod => {
                        const suggestionItem = document.createElement('div');
                        suggestionItem.textContent = `${prod.nom} (${prod.ref})`;
                        suggestionItem.classList.add('p-3', 'cursor-pointer', 'hover:bg-blue-50', 'transition-colors', 'duration-200', 'text-gray-800');
                        
                        suggestionItem.addEventListener('click', () => {
                            // Fill the product row fields with selected data
                            const container = input.closest('.product-row-container');
                            container.querySelector('.product-name').value = prod.nom;
                            container.querySelector('.product-ref').value = prod.ref;
                            container.querySelector('.pu-ht').value = prod.puHt;
                            container.querySelector('.tva').value = prod.tva;
                            container.querySelector('.observation-field').value = prod.observation || '';
                            
                            // Update totals after filling
                            calculateFromPuht(container);
                            suggestionsBox.classList.add('hidden');
                        });
                        suggestionsBox.appendChild(suggestionItem);
                    });
                    suggestionsBox.classList.remove('hidden');
                } else {
                    suggestionsBox.classList.add('hidden');
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !suggestionsBox.contains(e.target)) {
                    suggestionsBox.classList.add('hidden');
                }
            });
        };

        const calculateFromPuht = (container) => {
            const row = container.querySelector('.product-row');
            const qte = parseFloat(row.querySelector('.qte').value) || 0;
            const puHt = parseFloat(row.querySelector('.pu-ht').value) || 0;
            const tvaPercent = parseFloat(row.querySelector('.tva').value) || 0;
            const reduction = parseFloat(row.querySelector('.reduction').value) || 0;

            const totalHt = (qte * puHt);
            const totalTtc = totalHt * (1 + (tvaPercent / 100)) - reduction;

            row.querySelector('.total-ht').value = totalHt.toFixed(2);
            row.querySelector('.total-ttc').value = totalTtc.toFixed(2);
            row.querySelector('.reduction').value = reduction.toFixed(2);

            calculateTotals();
        };

        const calculateFromTtc = (container) => {
            const row = container.querySelector('.product-row');
            const qte = parseFloat(row.querySelector('.qte').value) || 0;
            const tvaPercent = parseFloat(row.querySelector('.tva').value) || 0;
            const reduction = parseFloat(row.querySelector('.reduction').value) || 0;
            const totalTtc = parseFloat(row.querySelector('.total-ttc').value) || 0;
            
            if (qte === 0 || (1 + (tvaPercent / 100)) === 0) {
                row.querySelector('.pu-ht').value = '0.00';
                row.querySelector('.total-ht').value = '0.00';
            } else {
                const puHt = (totalTtc + reduction) / (qte * (1 + (tvaPercent / 100)));
                const totalHt = puHt * qte;

                row.querySelector('.pu-ht').value = puHt.toFixed(2);
                row.querySelector('.total-ht').value = totalHt.toFixed(2);
            }

            calculateTotals();
        };

        const calculateTotals = () => {
            let totalHtSum = 0;
            let totalHtReductionSum = 0;
            let totalTvaSum = 0;
            let totalTtcSum = 0;

            document.querySelectorAll('.product-row-container').forEach(container => {
                const row = container.querySelector('.product-row');
                const qte = parseFloat(row.querySelector('.qte').value) || 0;
                const puHt = parseFloat(row.querySelector('.pu-ht').value) || 0;
                const tvaPercent = parseFloat(row.querySelector('.tva').value) || 0;
                const reduction = parseFloat(row.querySelector('.reduction').value) || 0;

                const totalHtRow = qte * puHt;
                const totalTvaRow = totalHtRow * (tvaPercent / 100);
                const totalTtcRow = totalHtRow + totalTvaRow - reduction;
                const totalHtAfterReductionRow = totalHtRow - reduction;

                totalHtSum += totalHtRow;
                totalHtReductionSum += totalHtAfterReductionRow;
                totalTvaSum += totalTvaRow;
                totalTtcSum += totalTtcRow;
            });

            const totalHTElement = document.getElementById('total-ht');
            if (totalHTElement) totalHTElement.textContent = totalHtSum.toFixed(2) + ' EUR';
            const totalHTReductionElement = document.getElementById('total-ht-reduction');
            if (totalHTReductionElement) totalHTReductionElement.textContent = totalHtReductionSum.toFixed(2) + ' EUR';
            const totalTVAElement = document.getElementById('total-tva');
            if (totalTVAElement) totalTVAElement.textContent = totalTvaSum.toFixed(2) + ' EUR';
            const totalTTCElement = document.getElementById('total-ttc');
            if (totalTTCElement) totalTTCElement.textContent = totalTtcSum.toFixed(2) + ' EUR';
        };
        window.calculateTotals = calculateTotals;

        // Function to select a pre-registered product and add it to the invoice
        const selectProductFromDropdown = () => {
            const select = document.getElementById('pre-registered-product-select');
            const productId = select.value;
            if (productId) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    addProduct(product);
                }
            }
        };
        window.selectProductFromDropdown = selectProductFromDropdown;

        // Function to populate the dropdown menu of pre-registered products
        const populateProductDropdown = (products) => {
            const select = document.getElementById('pre-registered-product-select');
            if (select) {
                select.innerHTML = '<option value="">-- Sélectionner un produit --</option>';
                products.forEach(prod => {
                    const option = document.createElement('option');
                    option.value = prod.id;
                    option.textContent = prod.nom || prod.ref || prod.id;
                    select.appendChild(option);
                });
            }
        };

        // --- Product management functions ---

        // Function to render the list of products
        const renderProductList = (products) => {
            const tableBody = document.getElementById('product-table-body');
            tableBody.innerHTML = '';
            products.forEach(product => {
                const row = document.createElement('tr');
                row.classList.add('border-b', 'hover:bg-gray-50');
                row.innerHTML = `
                    <td class="py-2 px-4">${product.nom || 'N/A'}</td>
                    <td class="py-2 px-4">${product.ref || 'N/A'}</td>
                    <td class="py-2 px-4">${product.puHt ? product.puHt.toFixed(2) + ' EUR' : '0.00 EUR'}</td>
                    <td class="py-2 px-4">${product.tva || '0'}%</td>
                    <td class="py-2 px-4">
                        <button onclick='window.loadProductData("${product.id}")' class="bg-blue-500 text-white text-xs px-2 py-1 rounded-full hover:bg-blue-600 transition-colors">Éditer</button>
                        <button onclick='showConfirmModal("deleteProduct", "${product.id}")' class="bg-red-500 text-white text-xs px-2 py-1 rounded-full ml-2 hover:bg-red-600 transition-colors">Supprimer</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        };

        // Function to load product data into the management form
        const loadProductData = (productId = null) => {
            const form = document.getElementById('product-form');
            form.reset();
            currentProductId = null;
            document.getElementById('product-form-title').textContent = "Ajouter un produit";

            if (productId) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    currentProductId = productId;
                    document.getElementById('product-form-title').textContent = "Modifier un produit";
                    document.getElementById('product-name-form').value = product.nom || '';
                    document.getElementById('product-ref-form').value = product.ref || '';
                    document.getElementById('pu-ht-form').value = product.puHt || 0;
                    document.getElementById('tva-form').value = product.tva || 0;
                    document.getElementById('observation-form').value = product.observation || '';
                }
            }
        };
        window.loadProductData = loadProductData;

        // Function to save a pre-registered product
        const saveProduct = async () => {
            const productData = {
                nom: document.getElementById('product-name-form').value,
                ref: document.getElementById('product-ref-form').value,
                puHt: parseFloat(document.getElementById('pu-ht-form').value) || 0,
                tva: parseFloat(document.getElementById('tva-form').value) || 0,
                observation: document.getElementById('observation-form').value,
            };

            const productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/products`);

            try {
                if (currentProductId) {
                    await updateDoc(doc(productsCollectionRef, currentProductId), productData);
                } else {
                    await addDoc(productsCollectionRef, productData);
                }
                loadProductData(); // Reset the form
            } catch (error) {
                console.error("Error saving product:", error);
            }
        };
        window.saveProduct = saveProduct;

        // Function to delete a product
        const deleteProduct = async (productId) => {
            try {
                const productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/products`);
                await deleteDoc(doc(productsCollectionRef, productId));
                closeConfirmModal();
            } catch (error) {
                console.error("Error deleting product:", error);
            }
        };
        window.deleteProduct = deleteProduct;

        // --- Confirmation modal functions ---
        const showConfirmModal = (action, id) => {
            const modal = document.getElementById('confirm-modal');
            const message = document.getElementById('confirm-message');
            const confirmButton = document.getElementById('confirm-button');

            if (action === "deleteInvoice") {
                message.textContent = "Êtes-vous sûr de vouloir supprimer cette facture ?";
                confirmButton.onclick = () => window.deleteInvoice(id);
            } else if (action === "deleteProduct") {
                message.textContent = "Êtes-vous sûr de vouloir supprimer ce produit ?";
                confirmButton.onclick = () => window.deleteProduct(id);
            }
            modal.classList.remove('hidden');
        };
        window.showConfirmModal = showConfirmModal;

        const closeConfirmModal = () => {
            document.getElementById('confirm-modal').classList.add('hidden');
        };
        window.closeConfirmModal = closeConfirmModal;

        // --- PDF generation functions ---
        const generatePdfContent = (invoiceData) => {
            return `
                <!-- PDF Content Structure -->
                <div class="pdf-template p-8">
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px;">
                        <div>
                            <div style="font-size: 2.5em; font-weight: bold; color: #374151; font-family: 'Times New Roman', serif;">CENTRAL<br>CARS</div>
                        </div>
                        <div style="text-align: right;">
                            <h1 style="font-size: 2em; font-weight: bold; color: #374151; margin-bottom: 5px;">FACTURE</h1>
                            <p style="font-size: 0.9em;">N°: ${invoiceData.numeroFacture || ''}</p>
                            <p style="font-size: 0.9em;">Date: ${invoiceData.dateCreation || ''}</p>
                        </div>
                    </div>

                    <!-- Addresses -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 25px; border: 1px solid #ddd; padding: 15px; border-radius: 5px;">
                        <div style="width: 48%;">
                            <h2 style="font-size: 1.1em; font-weight: bold; color: #374151; border-bottom: 1px solid #999; padding-bottom: 3px; margin-bottom: 5px;">ENTREPRISE</h2>
                            <p style="font-size: 0.9em;">CENTRAL CARS</p>
                            <p style="font-size: 0.9em;">576 Rue MARCEL SEMBAT</p>
                            <p style="font-size: 0.9em;">59690 VIEUX-CONDE</p>
                            <p style="font-size: 0.9em;">SIREN: 789927548</p>
                            <p style="font-size: 0.9em;">TEL: 0667903559</p>
                            <p style="font-size: 0.9em;">contact@centralcars.fr</p>
                        </div>
                        <div style="width: 48%;">
                            <h2 style="font-size: 1.1em; font-weight: bold; color: #374151; border-bottom: 1px solid #999; padding-bottom: 3px; margin-bottom: 5px;">CLIENT(S)</h2>
                            <p style="font-size: 0.9em;">${invoiceData.nomAcheteur || ''}</p>
                            <p style="font-size: 0.9em;">${invoiceData.adresseAcheteur || ''}</p>
                            ${invoiceData.siren ? `<p style="font-size: 0.9em;">SIREN: ${invoiceData.siren}</p>` : ''}
                            ${invoiceData.numeroTva ? `<p style="font-size: 0.9em;">Numéro TVA: ${invoiceData.numeroTva}</p>` : ''}
                            <p style="font-size: 0.9em;">Email: ${invoiceData.email || 'N/A'}</p>
                        </div>
                    </div>

                    <!-- Product Table -->
                    <div style="margin-bottom: 25px;">
                        <h2 style="font-size: 1.1em; font-weight: bold; color: #374151; border-bottom: 1px solid #999; padding-bottom: 3px; margin-bottom: 5px;">Produits</h2>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background-color: #f2f2f2;">
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 0.85em; width: 40%;">Nom</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 0.85em; width: 10%;">Réf</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 0.85em; width: 8%;">Qté</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: right; font-size: 0.85em; width: 12%;">PU HT</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: right; font-size: 0.85em; width: 8%;">TVA%</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: right; font-size: 0.85em; width: 12%;">Total HT</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: right; font-size: 0.85em; width: 10%;">Total TTC</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invoiceData.produits.map(p => `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px; font-size: 0.85em;">
                                            ${p.nom || ''}
                                            ${p.observation ? `<br><small>${p.observation}</small>` : ''}
                                        </td>
                                        <td style="border: 1px solid #ddd; padding: 8px; font-size: 0.85em;">${p.ref || ''}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; font-size: 0.85em;">${p.qte}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; text-align: right; font-size: 0.85em;">${p.puHt.toFixed(2)} €</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; text-align: right; font-size: 0.85em;">${p.tva}%</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; text-align: right; font-size: 0.85em;">${p.totalHt.toFixed(2)} €</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; text-align: right; font-size: 0.85em;">${p.totalTtc.toFixed(2)} €</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <!-- Totals -->
                    <div style="display: flex; justify-content: flex-end; margin-bottom: 25px;">
                        <div style="width: 250px; border: 1px solid #ddd;">
                            <div style="display: flex; justify-content: space-between; padding: 8px;">
                                <span style="font-weight: bold;">Total HT</span>
                                <span>${invoiceData.totalHT.toFixed(2)} EUR</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px;">
                                <span style="font-weight: bold;">Total TVA</span>
                                <span>${invoiceData.totalTVA.toFixed(2)} EUR</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px; font-weight: bold; border-top: 1px solid #ddd;">
                                <span>Total TTC</span>
                                <span>${invoiceData.totalTTC.toFixed(2)} EUR</span>
                            </div>
                        </div>
                    </div>

                    <!-- Payment and Footer -->
                    <div style="margin-bottom: 25px;">
                        <h2 style="font-size: 1.1em; font-weight: bold; color: #374151; border-bottom: 1px solid #999; padding-bottom: 3px; margin-bottom: 5px;">Paiement</h2>
                        <p style="font-size: 0.9em;">À payer ${invoiceData.totalTTC.toFixed(2)} EUR</p>
                        <p style="font-size: 0.9em;">Premier mode de règlement: ${invoiceData.modeReglement1 || 'N/A'}</p>
                        <p style="font-size: 0.9em;">Première référence: ${invoiceData.reference1 || 'N/A'}</p>
                        <p style="font-size: 0.9em;">Etat: ${invoiceData.etat || 'N/A'}</p>
                        
                        <div style="margin-top: 25px;">
                            <p style="font-size: 0.9em;">IBAN: FR76 1695 8000 0185 5788 4622 936</p>
                            <p style="font-size: 0.9em;">BIC: QNTOFRP1XXX</p>
                        </div>
                    </div>

                    <div style="border-top: 1px solid #999; padding-top: 10px; text-align: center; font-size: 0.8em; color: #666; margin-top: 25px;">
                        <p>Conformément aux articles 441-6 c. com. et D. 441-5 c. com., tout retard de paiement entraîne de</p>
                        <p>plein droit, outre les pénalités de retard, une obligation pour le débiteur de payer une indemnité</p>
                        <p>forfaitaire de 40€ pour frais de recouvrement.</p>
                    </div>
                </div>
            `;
        };

        const downloadPdf = (invoiceData) => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const docContent = generatePdfContent(invoiceData);

            // Create a temporary element to render HTML to canvas
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.width = '210mm';
            tempDiv.innerHTML = docContent;
            document.body.appendChild(tempDiv);
            
            html2canvas(tempDiv, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210;
                const pageHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = pageHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, pageHeight);
                heightLeft -= 297;

                while (heightLeft >= 0) {
                    position = heightLeft - pageHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, pageHeight);
                    heightLeft -= 297;
                }

                const numeroFacture = invoiceData.numeroFacture;
                pdf.save(`Facture_${numeroFacture}.pdf`);
                
                // Remove the temporary element
                document.body.removeChild(tempDiv);
            });
        };
        
        const generatePdfFromForm = () => {
            const invoiceData = {
                numeroFacture: document.getElementById('numero-facture').value,
                dateCreation: document.getElementById('date-creation').value,
                nomAcheteur: document.getElementById('nom-acheteur').value,
                numeroTva: document.getElementById('numero-tva').value,
                siren: document.getElementById('siren').value,
                adresseAcheteur: `${document.getElementById('n-voie').value} ${document.getElementById('type-voie').value} ${document.getElementById('nom-voie').value}, ${document.getElementById('code-postal').value} ${document.getElementById('ville').value}`,
                produits: getProductData(),
                totalHT: parseFloat(document.getElementById('total-ht').textContent) || 0,
                totalTVA: parseFloat(document.getElementById('total-tva').textContent) || 0,
                totalTTC: parseFloat(document.getElementById('total-ttc').textContent) || 0,
                etat: document.getElementById('invoice-status').value,
                modeReglement1: document.getElementById('premier-mode-reglement').value,
                reference1: document.getElementById('premiere-reference').value,
                email: document.getElementById('email').value
            };
            downloadPdf(invoiceData);
        };
        window.generatePdfFromForm = generatePdfFromForm;
        
        const generatePdfFromInvoiceData = (invoiceData) => {
            invoiceData.adresseAcheteur = `${invoiceData.nVoie || ''} ${invoiceData.typeVoie || ''} ${invoiceData.nomVoie || ''}, ${invoiceData.codePostal || ''} ${invoiceData.ville || ''}`;
            downloadPdf(invoiceData);
        };
        window.generatePdfFromInvoiceData = generatePdfFromInvoiceData;


        // Call the initialization function on page load
        initFirebase();
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 1rem;
            margin-bottom: 2rem;
        }
        .tab-button {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 500;
            cursor: pointer;
        }
        .tab-button.active {
            background-color: #fcd34d;
            color: #1f2937;
        }
        .input-group {
            margin-bottom: 1rem;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        input, select, textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            background-color: #fff;
        }
        .product-row input, .product-row select {
            padding: 0.25rem;
            font-size: 0.75rem;
        }
        @media (min-width: 640px) {
            .product-row input, .product-row select {
                font-size: 0.875rem;
            }
        }
        @media (min-width: 768px) {
            .product-row input, .product-row select {
                font-size: 1rem;
            }
        }
        .suggestions-box {
            position: absolute;
            z-index: 10;
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            top: 100%;
            left: 0;
            right: 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .suggestions-box div {
            padding: 0.5rem;
            cursor: pointer;
        }
        .suggestions-box div:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">

    <div class="container">
        <div class="flex justify-end text-sm text-gray-400 mb-4 print-hidden">
            <span id="user-id"></span>
        </div>

        <!-- Invoice list view -->
        <div id="invoice-list-view" class="p-8 bg-white shadow-xl rounded-2xl">
            <div class="header">
                <h1 class="text-2xl font-bold">Mes Factures</h1>
                <div class="flex space-x-4">
                    <button onclick="window.switchView('product-management')" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-full font-semibold hover:bg-gray-300 transition-colors">
                        Gérer les produits
                    </button>
                    <button onclick="window.switchView('editor')" class="px-6 py-2 bg-yellow-400 text-gray-800 rounded-full font-semibold hover:bg-yellow-500 transition-colors">
                        + Créer une nouvelle facture
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg shadow-md">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="py-3 px-4 text-left text-gray-600 font-semibold">N° Facture</th>
                            <th class="py-3 px-4 text-left text-gray-600 font-semibold">Date</th>
                            <th class="py-3 px-4 text-left text-gray-600 font-semibold">Nom de l'Acheteur</th>
                            <th class="py-3 px-4 text-left text-gray-600 font-semibold">Total TTC</th>
                            <th class="py-3 px-4 text-left text-gray-600 font-semibold">État</th>
                            <th class="py-3 px-4 text-left text-gray-600 font-semibold">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="invoice-table-body">
                        <!-- Invoices will be inserted here by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Invoice editor view (hidden by default) -->
        <div id="invoice-editor-view" class="hidden p-8 bg-white shadow-xl rounded-2xl">
            <!-- Header -->
            <div class="header print-hidden">
                <div class="flex space-x-2">
                    <button class="tab-button bg-gray-200">ORDRE DE RÉPARATION</button>
                    <button class="tab-button bg-gray-200">DEVIS</button>
                    <button class="tab-button active">FACTURE</button>
                </div>
                <div class="text-gray-400 cursor-pointer" onclick="window.switchView('list')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </div>
            </div>

            <!-- User input form -->
            <form id="invoice-form" class="print-visible">
                <!-- General Information Section -->
                <div class="bg-gray-50 p-6 rounded-lg mb-8">
                    <h2 class="text-xl font-bold mb-4">Informations Générales</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <div class="input-group">
                                <label for="numero-facture">N° Facture</label>
                                <input type="text" id="numero-facture" value="" class="rounded-md p-2" readonly>
                            </div>
                            <div class="input-group">
                                <label for="date-creation">Date de création</label>
                                <input type="date" id="date-creation" value="" class="rounded-md p-2">
                            </div>
                            <div class="input-group">
                                <label for="objet">Objet</label>
                                <input type="text" id="objet" class="rounded-md p-2">
                            </div>
                        </div>
                        <div class="bg-gray-100 p-6 rounded-xl">
                            <h3 class="font-bold text-lg mb-4">Vendeur</h3>
                            <p class="font-semibold">CENTRAL CARS</p>
                            <p>576 Rue MARCEL SEMBAT</p>
                            <p>59690 VIEUX-CONDE</p>
                            <p class="mt-4">SIREN: 789927548</p>
                            <p>TEL: 0667903559</p>
                            <p>contact@centralcars.fr</p>
                        </div>
                    </div>
                </div>

                <!-- Buyer Information Section -->
                <div class="bg-gray-50 p-6 rounded-lg mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Informations de l'Acheteur</h2>
                        <select class="rounded-md p-2 bg-gray-200">
                            <option>Mes Contacts</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="input-group">
                            <label for="nom-acheteur">Nom</label>
                            <input type="text" id="nom-acheteur" class="rounded-md p-2">
                        </div>
                        <div class="input-group">
                            <label for="numero-tva">Numéro TVA</label>
                            <input type="text" id="numero-tva" class="rounded-md p-2">
                        </div>
                        <div class="input-group col-span-2">
                            <label for="siren">SIREN</label>
                            <input type="text" id="siren" class="rounded-md p-2">
                        </div>
                        <div class="grid grid-cols-2 gap-4 col-span-2">
                            <div class="input-group">
                                <label for="n-voie">N°</label>
                                <input type="text" id="n-voie" class="rounded-md p-2">
                            </div>
                            <div class="input-group">
                                <label for="ext-voie">Extension</label>
                                <input type="text" id="ext-voie" class="rounded-md p-2">
                            </div>
                        </div>
                        <div class="input-group col-span-2">
                            <label for="type-voie">Type de voie</label>
                            <input type="text" id="type-voie" class="rounded-md p-2">
                        </div>
                        <div class="input-group col-span-2">
                            <label for="nom-voie">Nom de la voie</label>
                            <input type="text" id="nom-voie" class="rounded-md p-2">
                        </div>
                        <div class="input-group">
                            <label for="code-postal">Code postal</label>
                            <input type="text" id="code-postal" class="rounded-md p-2">
                        </div>
                        <div class="input-group">
                            <label for="ville">Ville</label>
                            <input type="text" id="ville" class="rounded-md p-2">
                        </div>
                        <div class="input-group col-span-2">
                            <label for="pays">Pays</label>
                            <input type="text" id="pays" class="rounded-md p-2">
                        </div>
                        <div class="input-group">
                            <label for="telephone">Téléphone</label>
                            <input type="text" id="telephone" class="rounded-md p-2">
                        </div>
                        <div class="input-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" class="rounded-md p-2">
                        </div>
                        <div class="input-group col-span-2 flex items-center justify-between">
                            <label for="identification-vehicule" class="mb-0">Identification du véhicule</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" value="" class="sr-only peer" id="immatriculation-toggle">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                            <input type="text" id="immatriculation" placeholder="immatriculation" class="ml-4 rounded-md p-2 w-full">
                        </div>
                    </div>
                </div>
        
                <!-- Products Section -->
                <div class="bg-gray-50 p-6 rounded-lg mb-8">
                    <h2 class="text-xl font-bold mb-4">Lignes de Produits</h2>
                    <div class="flex items-center space-x-4 mb-4">
                        <button type="button" onclick="window.addProduct()" class="flex items-center px-4 py-2 bg-yellow-400 text-gray-800 rounded-full font-semibold hover:bg-yellow-500 transition-colors">
                            <span class="mr-2">+</span> Ajouter un produit
                        </button>
                        <span class="text-gray-500">ou</span>
                        <select id="pre-registered-product-select" onchange="window.selectProductFromDropdown()" class="rounded-md p-2 bg-gray-200">
                            <!-- Options will be generated here by JS -->
                            <option value="">-- Sélectionner un produit --</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-11 gap-2 font-semibold text-sm text-gray-600 border-b pb-2 mb-2">
                        <div class="col-span-1"></div>
                        <div class="col-span-2">Nom</div>
                        <div>Réf</div>
                        <div>Qté</div>
                        <div>Catégorie</div>
                        <div>PU HT</div>
                        <div>TVA%</div>
                        <div>Total HT</div>
                        <div>Réduction</div>
                        <div>Total TTC</div>
                    </div>
                    
                    <div id="product-list">
                        <!-- Product lines will be added here by JS -->
                    </div>
                </div>
                
                <!-- Payment & Totals Section -->
                <div class="bg-gray-50 p-6 rounded-lg mb-8">
                    <h2 class="text-xl font-bold mb-4">Paiement & Totaux</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <div class="input-group">
                                <label for="invoice-status">État</label>
                                <select id="invoice-status" class="rounded-md p-2">
                                    <option>Créé</option>
                                    <option>Payé</option>
                                    <option>Payé en partie</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mt-4">
                                <div>
                                    <label for="premier-mode-reglement">Premier mode de règlement</label>
                                    <select id="premier-mode-reglement" class="rounded-md p-2">
                                        <option>Carte bancaire</option>
                                        <option>Virement bancaire</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="montant-paye1">Montant payé</label>
                                    <input type="text" id="montant-paye1" class="rounded-md p-2">
                                </div>
                                <div class="col-span-2">
                                    <label for="premiere-reference">Première référence</label>
                                    <input type="text" id="premiere-reference" class="rounded-md p-2">
                                </div>
                                <div>
                                    <label for="deuxieme-mode-reglement">Deuxième mode de règlement</label>
                                    <select id="deuxieme-mode-reglement" class="rounded-md p-2">
                                        <option>...</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="montant-paye2">Montant payé</label>
                                    <input type="text" id="montant-paye2" class="rounded-md p-2">
                                </div>
                                <div class="col-span-2">
                                    <label for="deuxieme-reference">Deuxième référence</label>
                                    <input type="text" id="deuxieme-reference" class="rounded-md p-2">
                                </div>
                            </div>
                        </div>
            
                        <div class="bg-white p-6 rounded-xl">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-semibold">Total HT</span>
                                <span id="total-ht" class="font-bold text-lg">0,00 EUR</span>
                            </div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-semibold">Total HT après réduction</span>
                                <span id="total-ht-reduction" class="font-bold text-lg">0,00 EUR</span>
                            </div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-semibold">Total TVA</span>
                                <span id="total-tva" class="font-bold text-lg">0,00 EUR</span>
                            </div>
                            <div class="flex justify-between items-center mb-2 border-t pt-2 mt-2">
                                <span class="font-semibold">Total TTC</span>
                                <span id="total-ttc" class="font-bold text-xl text-yellow-500">0,00 EUR</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action buttons -->
                <div class="mt-8 flex justify-end space-x-4 print-hidden">
                    <button type="button" onclick="window.switchView('list')" class="px-6 py-2 border border-gray-300 text-gray-600 rounded-full font-semibold hover:bg-gray-200 transition-colors">ANNULER</button>
                    <button type="button" onclick="window.saveInvoice()" class="px-6 py-2 bg-yellow-400 text-gray-800 rounded-full font-semibold hover:bg-yellow-500 transition-colors">SAUVEGARDER</button>
                    <button type="button" onclick="window.generatePdfFromForm()" class="px-6 py-2 border border-gray-300 text-gray-600 rounded-full font-semibold hover:bg-gray-200 transition-colors">IMPRIMER</button>
                </div>
            </form>
        </div>
        
        <!-- Product management view (hidden by default) -->
        <div id="product-management-view" class="hidden p-8 bg-white shadow-xl rounded-2xl">
            <div class="header">
                <h1 class="text-2xl font-bold">Gestion des produits</h1>
                <button onclick="window.switchView('list')" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-full font-semibold hover:bg-gray-300 transition-colors">
                    Retour à la liste des factures
                </button>
            </div>
            
            <!-- Product add/edit form -->
            <div class="bg-gray-50 p-6 rounded-lg mb-8">
                <h2 id="product-form-title" class="text-xl font-bold mb-4">Ajouter un produit</h2>
                <form id="product-form" onsubmit="event.preventDefault(); window.saveProduct();">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="input-group">
                            <label for="product-name-form">Nom du produit</label>
                            <input type="text" id="product-name-form" required class="rounded-md p-2">
                        </div>
                        <div class="input-group">
                            <label for="product-ref-form">Référence</label>
                            <input type="text" id="product-ref-form" class="rounded-md p-2">
                        </div>
                        <div class="input-group">
                            <label for="pu-ht-form">Prix unitaire HT</label>
                            <input type="number" step="0.01" id="pu-ht-form" required class="rounded-md p-2">
                        </div>
                        <div class="input-group">
                            <label for="tva-form">TVA (%)</label>
                            <select id="tva-form" class="rounded-md p-2">
                                <option value="20">20</option>
                                <option value="10">10</option>
                                <option value="5.5">5.5</option>
                                <option value="0">0</option>
                            </select>
                        </div>
                        <div class="input-group col-span-2">
                            <label for="observation-form">Observation</label>
                            <textarea id="observation-form" class="w-full h-16 rounded-md p-2 text-sm"></textarea>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end space-x-4">
                        <button type="button" onclick="window.loadProductData()" class="px-6 py-2 border border-gray-300 text-gray-600 rounded-full font-semibold hover:bg-gray-200 transition-colors">Annuler</button>
                        <button type="submit" class="px-6 py-2 bg-yellow-400 text-gray-800 rounded-full font-semibold hover:bg-yellow-500 transition-colors">Sauvegarder</button>
                    </div>
                </form>
            </div>

            <!-- List of pre-registered products -->
            <h2 class="text-xl font-bold mb-4">Produits existants</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg shadow-md">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="py-3 px-4 text-left text-gray-600 font-semibold">Nom</th>
                            <th class="py-3 px-4 text-left text-gray-600 font-semibold">Référence</th>
                            <th class="py-3 px-4 text-left text-gray-600 font-semibold">PU HT</th>
                            <th class="py-3 px-4 text-left text-gray-600 font-semibold">TVA</th>
                            <th class="py-3 px-4 text-left text-gray-600 font-semibold">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="product-table-body">
                        <!-- Products will be inserted here by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Confirmation modal (hidden by default) -->
        <div id="confirm-modal" class="hidden fixed inset-0 z-50 overflow-auto bg-gray-800 bg-opacity-50 flex items-center justify-center">
            <div class="bg-white rounded-lg p-8 m-4 max-w-sm mx-auto shadow-lg">
                <p id="confirm-message" class="text-lg mb-6">Êtes-vous sûr de vouloir continuer ?</p>
                <div class="flex justify-end space-x-4">
                    <button onclick="window.closeConfirmModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-full hover:bg-gray-400 transition-colors">Annuler</button>
                    <button id="confirm-button" class="px-4 py-2 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors">Confirmer</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
