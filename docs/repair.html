<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outil Administratif - CENTRAL CARS</title>
    <link rel="icon" type="image/png" href="img/logo_a.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- jsPDF pour la génération de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.16/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #374151; /* text-gray-800 */
        }
        /* Style pour l'animation de scroll fluide */
        html {
            scroll-behavior: smooth;
        }
        /* Style pour la barre de défilement */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Empêcher le défilement du corps lorsque la modale est ouverte */
        .modal-open {
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header id="header" class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-gray-900">
                <i class="fas fa-car-side text-red-600"></i> CENTRAL <span class="text-red-600">CARS</span>
            </a>
            <div class="hidden md:flex space-x-8 items-center relative">
                <a href="index.html#accueil" class="text-gray-600 hover:text-red-600 transition duration-300">Accueil</a>
                <a href="index.html#vehicules" class="text-gray-600 hover:text-red-600 transition duration-300">Nos Véhicules</a>
                <a href="index.html#services" class="text-gray-600 hover:text-red-600 transition duration-300">Nos Services</a>
                <a href="index.html#contact" class="text-gray-600 hover:text-red-600 transition duration-300">Contact</a>
                
                <!-- Bouton de connexion/inscription pour les grands écrans (non connecté) -->
                <button id="login-signup-button-desktop" class="text-gray-600 hover:text-red-600 focus:outline-none">
                    <i class="fas fa-user-circle text-2xl"></i>
                </button>

                <!-- Bouton/Icône de l'utilisateur connecté pour les grands écrans -->
                <button id="authenticated-user-menu-toggle-desktop" class="text-red-600 hover:text-red-700 focus:outline-none hidden">
                    <i class="fas fa-user-check text-2xl"></i>
                </button>

                <!-- Menu du compte (pour les grands écrans) -->
                <div id="account-menu-desktop" class="account-menu hidden">
                    <div class="px-4 py-2 border-b text-sm text-gray-500" id="user-email-display-desktop"></div>
                    <a href="#" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Mon profil</a>
                    <a href="#" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Mes favoris</a>
                    <button id="admin-gerer-boutique-desktop" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">Gérer boutique</button>
                    <button id="admin-generer-annonce-desktop" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">Générer Annonce</button>
                    <button id="admin-acces-ants-desktop" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">Accès ANTS</button>
                    <button id="logout-button-desktop" class="logout-button text-sm">Se déconnecter</button>
                </div>
            </div>
            <div class="md:hidden flex items-center space-x-4 relative">
                <!-- Bouton de connexion/inscription pour les petits écrans (non connecté) -->
                <button id="login-signup-button-mobile" class="text-gray-600 hover:text-red-600 focus:outline-none">
                    <i class="fas fa-user-circle text-2xl"></i>
                </button>

                <!-- Bouton/Icône de l'utilisateur connecté pour les petits écrans -->
                <button id="authenticated-user-menu-toggle-mobile" class="text-red-600 hover:text-red-700 focus:outline-none hidden">
                    <i class="fas fa-user-check text-2xl"></i>
                </button>

                <button id="mobile-menu-button" class="text-gray-600 hover:text-red-600 focus:outline-none">
                    <i class="fas fa-bars text-2xl"></i>
                </button>

                <!-- Menu du compte (pour les petits écrans, affiché via le menu mobile ou popover) -->
                <div id="account-menu-mobile" class="account-menu hidden">
                    <div class="px-4 py-2 border-b text-sm text-gray-500" id="user-email-display-mobile"></div>
                    <a href="#" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Mon profil</a>
                    <a href="#" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Mes favoris</a>
                    <button id="admin-gerer-boutique-mobile" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">Gérer boutique</button>
                    <button id="admin-generer-annonce-mobile" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">Générer Annonce</button>
                    <button id="admin-acces-ants-mobile" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">Accès ANTS</button>
                    <button id="logout-button-mobile" class="logout-button text-sm">Se déconnecter</button>
                </div>
            </div>
        </nav>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-white">
            <a href="index.html#accueil" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Accueil</a>
            <a href="index.html#vehicules" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Nos Véhicules</a>
            <a href="index.html#services" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Nos Services</a>
            <a href="index.html#contact" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Contact</a>
            <!-- Les options du menu mobile pourraient inclure la déconnexion ici aussi si le menu popover n'est pas utilisé -->
        </div>
    </header>

    <main class="container mx-auto px-6 py-12">
        <h1 class="text-4xl font-bold text-center mb-8">Outil de Génération de Rapport de Réparation</h1>
        <p class="text-center text-gray-600 mb-12">Remplissez les informations ci-dessous pour générer un rapport de réparation en PDF.</p>

        <div id="pdf-generator-tool" class="bg-white p-8 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-6">Informations sur le Véhicule et les Réparations</h2>
            <form id="repair-report-form" class="space-y-6">
                <!-- Informations du véhicule -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="marque" class="block text-gray-700 font-semibold mb-2">Marque</label>
                        <input type="text" id="marque" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                    </div>
                    <div>
                        <label for="modele" class="block text-gray-700 font-semibold mb-2">Modèle</label>
                        <input type="text" id="modele" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                    </div>
                    <div>
                        <label for="immatriculation" class="block text-gray-700 font-semibold mb-2">Numéro d'immatriculation</label>
                        <input type="text" id="immatriculation" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                    </div>
                    <div>
                        <label for="chassis" class="block text-gray-700 font-semibold mb-2">Numéro de châssis (VIN)</label>
                        <input type="text" id="chassis" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                    </div>
                    <div>
                        <label for="kilometrage" class="block text-gray-700 font-semibold mb-2">Kilométrage</label>
                        <input type="number" id="kilometrage" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                    </div>
                    <div>
                        <label for="date-circulation" class="block text-gray-700 font-semibold mb-2">Date de 1ère mise en circulation</label>
                        <input type="date" id="date-circulation" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                    </div>
                </div>

                <!-- Réparations pré-définies -->
                <div class="border-t pt-6 mt-6">
                    <h3 class="text-xl font-bold mb-4">Réparations effectuées</h3>
                    <div id="repairs-checkboxes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        <!-- Checkboxes will be generated here by JS -->
                    </div>
                </div>

                <!-- Ajout de réparations manuelles -->
                <div class="border-t pt-6 mt-6">
                    <h3 class="text-xl font-bold mb-4">Ajouter d'autres réparations</h3>
                    <div class="flex flex-col md:flex-row gap-4">
                        <input type="text" id="manual-repair-input" class="flex-grow px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Ex: Remplacement du turbo">
                        <button type="button" id="add-manual-repair" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-300">Ajouter</button>
                    </div>
                    <ul id="manual-repairs-list" class="mt-4 space-y-2">
                        <!-- Manually added repairs will appear here -->
                    </ul>
                </div>

                <!-- Observation -->
                <div class="border-t pt-6 mt-6">
                    <h3 class="text-xl font-bold mb-4">Observation</h3>
                    <textarea id="observation" rows="5" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Ajoutez des observations supplémentaires ici..."></textarea>
                </div>

                <button type="submit" id="generate-pdf-button" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition duration-300">Générer le PDF</button>
            </form>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto px-6 text-center">
            <p>&copy; 2024 CENTRAL CARS. Tous droits réservés.</p>
            <p class="text-sm text-gray-400 mt-2">Site conçu avec ❤️</p>
        </div>
    </footer>

    <!-- CUSTOM ALERT MODAL -->
    <div id="custom-alert" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[999] hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center relative">
            <p id="custom-alert-message" class="text-lg font-semibold mb-4"></p>
            <button id="custom-alert-close" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">OK</button>
        </div>
    </div>

    <script type="module">
        // ====================================================================================================
        // IMPORTANT : CONFIGURATION DES RÈGLES DE SÉCURITÉ FIREBASE FIRESTORE
        //
        // L'erreur "Missing or insufficient permissions" indique que les règles de sécurité de votre base de données
        // Firebase ne permettent pas à l'utilisateur actuel d'effectuer l'opération demandée.
        //
        // VOUS DEVEVEZ APPLIQUER CES RÈGLES DANS VOTRE CONSOLE FIREBASE :
        // 1. Allez sur https://console.firebase.google.com/
        // 2. Sélectionnez votre projet.
        // 3. Dans le menu de gauche, cliquez sur "Firestore Database".
        // 4. Cliquez sur l'onglet "Règles".
        // 5. REMPLACEZ LE CONTENU EXISTANT par les règles ci-dessous :
        /*
        rules_version = '2';
        service cloud.firestore {
            match /databases/{database}/documents {

                // Règle pour les profils utilisateurs (rôles)
                // Chaque utilisateur peut lire et écrire son propre document 'user_data'
                match /artifacts/{appId}/users/{userId}/profile/user_data {
                    allow read, write: if request.auth != null && request.auth.uid == userId;
                }

                // Règle pour la collection 'vehicules'
                match /vehicules/{vehicleId} {
                    // Tous les utilisateurs (authentifiés ou non) peuvent lire les véhicules
                    allow read: if true;

                    // Seuls les administrateurs peuvent créer, mettre à jour et supprimer des véhicules
                    // Pour vérifier le rôle, nous lisons le document 'user_data' de l'utilisateur connecté.
                    allow create, update, delete: if request.auth != null && get(/databases/$(database)/documents/artifacts/$(app.id)/users/$(request.auth.uid)/profile/user_data).data.role == 'admin';
                }
            }
        }
        */
        // 6. Cliquez sur "Publier" pour sauvegarder les règles.
        //
        // ASSUREZ-VOUS ÉGALEMENT QU'UN UTILISATEUR A BIEN LE RÔLE 'admin' DANS FIRESTORE :
        // Pour qu'un utilisateur puisse utiliser le panneau d'administration, son rôle doit être 'admin'.
        // Après vous être connecté avec un compte, allez dans Firestore Database -> onglet "Données" :
        // artifacts -> votre_app_id -> users -> {UID_DE_L_UTILISATEUR} -> profile -> user_data
        // Modifiez le champ 'role' à 'admin'.
        // ====================================================================================================

        // --- IMPORTS ET CONFIGURATION FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Configuration Firebase fournie (doit correspondre à celle de votre index.html)
        const __app_id = 'central-cars-a37ae';
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyC1RQ5m7_utiAEsvyobIuuwxzAzBLx27Sw",
            authDomain: "central-cars-a37ae.firebaseapp.com",
            projectId: "central-cars-a37ae",
            storageBucket: "central-cars-a37ae.firebaseapp.com",
            messagingSenderId: "297273470734",
            appId: "1:297273470734:web:7d35e6619b28dc569d715f",
            measurementId: "G-4LXQG2VWP1"
        });

        const firebaseConfig = JSON.parse(__firebase_config);

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUserRole = null; // Variable pour stocker le rôle de l'utilisateur

        // --- Éléments du DOM ---
        const repairReportForm = document.getElementById('repair-report-form');
        const marqueInput = document.getElementById('marque');
        const modeleInput = document.getElementById('modele');
        const immatriculationInput = document.getElementById('immatriculation');
        const chassisInput = document.getElementById('chassis');
        const kilometrageInput = document.getElementById('kilometrage');
        const dateCirculationInput = document.getElementById('date-circulation');
        const repairsCheckboxesDiv = document.getElementById('repairs-checkboxes');
        const manualRepairInput = document.getElementById('manual-repair-input');
        const addManualRepairButton = document.getElementById('add-manual-repair');
        const manualRepairsList = document.getElementById('manual-repairs-list');
        const observationTextarea = document.getElementById('observation');
        const generatePdfButton = document.getElementById('generate-pdf-button');

        // --- Données de la société (à adapter) ---
        const companyInfo = {
            name: "CENTRAL CARS",
            siret: "78992754800022",
            address: "123 Rue de la République, 59690 Vieux-Condé, France",
            phone: "06 98 97 94 63",
            email: "contact@centralcars.fr"
        };

        // --- Réparations pré-définies ---
        const predefinedRepairs = [
            "Kit distribution",
            "Pompe à eau",
            "Disques et plaquettes de frein",
            "Vidange moteur et filtre à huile",
            "Injecteurs",
            "Amortisseurs avant",
            "Amortisseurs arrière",
            "Pneumatiques (avant)",
            "Pneumatiques (arrière)",
            "Embrayage",
            "Boîte de vitesse",
            "Turbo",
            "Joint de culasse",
            "Batterie",
            "Alternateur",
            "Démarreur",
            "Climatisation rechargée",
            "Contrôle technique"
        ];

        let manualRepairs = []; // Pour stocker les réparations ajoutées manuellement

        // --- Fonctions d'initialisation et de gestion du formulaire ---

        // Générer les cases à cocher pour les réparations pré-définies
        function generateRepairsCheckboxes() {
            repairsCheckboxesDiv.innerHTML = '';
            predefinedRepairs.forEach(repair => {
                const checkboxId = `repair-${repair.replace(/\s+/g, '-').replace(/[^\w-]/g, '').toLowerCase()}`;
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'flex items-center';
                checkboxDiv.innerHTML = `
                    <input type="checkbox" id="${checkboxId}" name="predefined-repair" value="${repair}" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="${checkboxId}" class="ml-2 text-gray-700 text-sm">${repair}</label>
                `;
                repairsCheckboxesDiv.appendChild(checkboxDiv);
            });
        }

        // Ajouter une réparation manuelle
        addManualRepairButton.addEventListener('click', () => {
            const repairText = manualRepairInput.value.trim();
            if (repairText && !manualRepairs.includes(repairText)) {
                manualRepairs.push(repairText);
                renderManualRepairs();
                manualRepairInput.value = ''; // Clear input
            } else if (manualRepairs.includes(repairText)) {
                showCustomAlert("Cette réparation a déjà été ajoutée.");
            }
        });

        // Rendre la liste des réparations manuelles
        function renderManualRepairs() {
            manualRepairsList.innerHTML = '';
            manualRepairs.forEach((repair, index) => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between bg-gray-50 p-2 rounded-md shadow-sm';
                li.innerHTML = `
                    <span class="text-gray-700">${repair}</span>
                    <button type="button" data-index="${index}" class="remove-manual-repair text-red-600 hover:text-red-800 focus:outline-none">
                        <i class="fas fa-times-circle"></i>
                    </button>
                `;
                manualRepairsList.appendChild(li);
            });

            // Ajouter les écouteurs pour la suppression
            document.querySelectorAll('.remove-manual-repair').forEach(button => {
                button.addEventListener('click', (event) => {
                    const indexToRemove = parseInt(event.currentTarget.dataset.index);
                    manualRepairs.splice(indexToRemove, 1);
                    renderManualRepairs();
                });
            });
        }

        // --- Génération du PDF ---
        generatePdfButton.addEventListener('click', async (e) => {
            e.preventDefault();

            // Vérifier les permissions de l'utilisateur
            if (currentUserRole !== 'admin') {
                showCustomAlert("Vous n'avez pas les permissions pour générer un PDF.");
                return;
            }

            // Récupérer les données du formulaire
            const vehicleData = {
                marque: marqueInput.value.trim(),
                modele: modeleInput.value.trim(),
                immatriculation: immatriculationInput.value.trim(),
                chassis: chassisInput.value.trim(),
                kilometrage: kilometrageInput.value.trim(),
                dateCirculation: dateCirculationInput.value.trim()
            };

            // Valider les champs requis
            for (const key in vehicleData) {
                if (!vehicleData[key]) {
                    showCustomAlert(`Veuillez remplir le champ "${key.replace(/([A-Z])/g, ' $1').toLowerCase()}".`);
                    return;
                }
            }

            const selectedPredefinedRepairs = Array.from(document.querySelectorAll('#repairs-checkboxes input[name="predefined-repair"]:checked'))
                                                .map(checkbox => checkbox.value);
            
            const allRepairs = [...selectedPredefinedRepairs, ...manualRepairs];
            const observation = observationTextarea.value.trim();
            const editionDate = new Date().toLocaleDateString('fr-FR', {
                year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });

            // Créer le document PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            let yOffset = 20;
            const margin = 20;
            const lineHeight = 7;
            const headerHeight = 40; // Espace pour l'en-tête de la société

            // Informations de la société (en-tête)
            doc.setFontSize(24);
            doc.setTextColor(204, 0, 0); // Rouge CENTRAL CARS
            doc.text(companyInfo.name, margin, yOffset);
            doc.setFontSize(10);
            doc.setTextColor(55, 65, 81); // Gris
            yOffset += lineHeight;
            doc.text(`SIRET: ${companyInfo.siret}`, margin, yOffset);
            yOffset += lineHeight;
            doc.text(companyInfo.address, margin, yOffset);
            yOffset += lineHeight;
            doc.text(`Téléphone: ${companyInfo.phone}`, margin, yOffset);
            yOffset += lineHeight;
            doc.text(`Email: ${companyInfo.email}`, margin, yOffset);

            yOffset = headerHeight + 10; // Réinitialiser yOffset après l'en-tête

            // Titre du rapport
            doc.setFontSize(18);
            doc.setTextColor(0, 0, 0); // Noir
            doc.text("Rapport de Réparation Véhicule", doc.internal.pageSize.width / 2, yOffset, { align: 'center' });
            yOffset += 15;

            // Informations du véhicule
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text("Informations du Véhicule :", margin, yOffset);
            yOffset += lineHeight;
            doc.setFont(undefined, 'normal');
            doc.text(`Marque: ${vehicleData.marque}`, margin, yOffset);
            yOffset += lineHeight;
            doc.text(`Modèle: ${vehicleData.modele}`, margin, yOffset);
            yOffset += lineHeight;
            doc.text(`Immatriculation: ${vehicleData.immatriculation}`, margin, yOffset);
            yOffset += lineHeight;
            doc.text(`Châssis (VIN): ${vehicleData.chassis}`, margin, yOffset);
            yOffset += lineHeight;
            doc.text(`Kilométrage: ${vehicleData.kilometrage} km`, margin, yOffset);
            yOffset += lineHeight;
            doc.text(`Date 1ère Circulation: ${vehicleData.dateCirculation}`, margin, yOffset);
            yOffset += 10;

            // Réparations
            doc.setFont(undefined, 'bold');
            doc.text("Réparations Effectuées :", margin, yOffset);
            yOffset += lineHeight;
            doc.setFont(undefined, 'normal');

            if (allRepairs.length > 0) {
                const repairsTableData = allRepairs.map(repair => [repair]);
                doc.autoTable({
                    startY: yOffset,
                    head: [['Description de la réparation']],
                    body: repairsTableData,
                    theme: 'striped',
                    styles: { fontSize: 10, cellPadding: 2 },
                    headStyles: { fillColor: [204, 0, 0], textColor: [255, 255, 255], fontStyle: 'bold' },
                    margin: { left: margin, right: margin },
                    didDrawPage: function (data) {
                        // Footer pour chaque page
                        doc.setFontSize(8);
                        doc.setTextColor(150);
                        doc.text(`Page ${doc.internal.getNumberOfPages()}`, doc.internal.pageSize.width - margin, doc.internal.pageSize.height - 10, { align: 'right' });
                        doc.text(`Édité le: ${editionDate}`, margin, doc.internal.pageSize.height - 10);
                    }
                });
                yOffset = doc.autoTable.previous.finalY + 10;
            } else {
                doc.text("Aucune réparation spécifiée.", margin, yOffset);
                yOffset += lineHeight + 10;
            }

            // Observation
            if (observation) {
                doc.setFont(undefined, 'bold');
                doc.text("Observation :", margin, yOffset);
                yOffset += lineHeight;
                doc.setFont(undefined, 'normal');
                // Utiliser splitTextToSize pour gérer les retours à la ligne automatiques
                const splitObservation = doc.splitTextToSize(observation, doc.internal.pageSize.width - 2 * margin);
                doc.text(splitObservation, margin, yOffset);
                yOffset += (splitObservation.length * lineHeight) + 10;
            }

            // Date d'édition (au bas de la dernière page si pas déjà dans le footer autoTable)
            if (!allRepairs.length > 0) { // Si pas de tableau, ajouter la date ici
                doc.setFontSize(10);
                doc.setTextColor(55, 65, 81); // Gris
                doc.text(`Date d'édition: ${editionDate}`, margin, doc.internal.pageSize.height - 15);
            }
            
            // Sauvegarder le PDF
            doc.save(`Rapport_Reparation_${vehicleData.marque}_${vehicleData.modele}_${vehicleData.immatriculation}.pdf`);
            showCustomAlert("Le PDF a été généré avec succès !");
        });

        // --- CUSTOM ALERT MODAL (remplace alert()) ---
        function showCustomAlert(message) {
            let customAlert = document.getElementById('custom-alert');
            let closeButton;

            if (!customAlert) {
                customAlert = document.createElement('div');
                customAlert.id = 'custom-alert';
                customAlert.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[999] hidden';
                customAlert.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center relative">
                        <p id="custom-alert-message" class="text-lg font-semibold mb-4"></p>
                        <button id="custom-alert-close" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">OK</button>
                    </div>
                `;
                document.body.appendChild(customAlert);
            }

            closeButton = customAlert.querySelector('#custom-alert-close');
            const oldClickListener = customAlert._closeClickListener;
            if (oldClickListener) {
                closeButton.removeEventListener('click', oldClickListener);
            }

            const newClickListener = () => {
                customAlert.classList.add('hidden');
            };

            if (closeButton) {
                closeButton.addEventListener('click', newClickListener);
                customAlert._closeClickListener = newClickListener;
            } else {
                console.error("Bouton de fermeture de l'alerte personnalisée introuvable.");
            }

            const oldBackdropListener = customAlert._backdropClickListener;
            if (oldBackdropListener) {
                customAlert.removeEventListener('click', oldBackdropListener);
            }

            const newBackdropListener = (event) => {
                if (event.target === customAlert) {
                    customAlert.classList.add('hidden');
                }
            };
            customAlert.addEventListener('click', newBackdropListener);
            customAlert._backdropClickListener = newBackdropListener;

            document.getElementById('custom-alert-message').textContent = message;
            customAlert.classList.remove('hidden');
        }

        // --- GESTION DE L'AUTHENTIFICATION ET DES PERMISSIONS ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userRef = doc(db, `artifacts/${__app_id}/users/${user.uid}/profile`, 'user_data');
                try {
                    const userDoc = await getDoc(userRef);
                    if (userDoc.exists()) {
                        currentUserRole = userDoc.data().role || 'client';
                    } else {
                        // Si le document n'existe pas, l'utilisateur est traité comme client
                        currentUserRole = 'client';
                    }
                } catch (error) {
                    console.error("Erreur lors de la récupération du rôle utilisateur:", error);
                    currentUserRole = 'client'; // Par défaut en cas d'erreur
                }
            } else {
                currentUserRole = null; // Aucun utilisateur connecté
            }

            // Masquer le contenu du formulaire si l'utilisateur n'est pas admin
            const pdfGeneratorTool = document.getElementById('pdf-generator-tool');
            if (currentUserRole !== 'admin') {
                pdfGeneratorTool.innerHTML = `<p class="text-center text-red-600 text-xl font-bold">Accès refusé. Seuls les administrateurs peuvent utiliser cet outil.</p>`;
            } else {
                // Si l'utilisateur est admin, assurez-vous que le formulaire est visible
                // (Il est visible par défaut dans le HTML, donc pas besoin de le "rendre" visible ici
                // sauf si vous aviez une logique pour le cacher initialement)
            }
        });

        // --- Initialisation au chargement du DOM ---
        document.addEventListener('DOMContentLoaded', () => {
            generateRepairsCheckboxes();
            renderManualRepairs(); // Initialiser la liste vide
        });

        // --- GESTION DU MENU MOBILE (copié depuis index.html pour la cohérence) ---
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

        // --- GESTION DU MENU DU COMPTE UTILISATEUR ET DU RÔLE (copié depuis index.html pour la cohérence) ---
        const authenticatedUserMenuToggleDesktop = document.getElementById('authenticated-user-menu-toggle-desktop');
        const authenticatedUserMenuToggleMobile = document.getElementById('authenticated-user-menu-toggle-mobile');
        const accountMenuDesktop = document.getElementById('account-menu-desktop');
        const accountMenuMobile = document.getElementById('account-menu-mobile');
        const logoutButtonDesktop = document.getElementById('logout-button-desktop');
        const logoutButtonMobile = document.getElementById('logout-button-mobile');
        const userEmailDisplayDesktop = document.getElementById('user-email-display-desktop');
        const userEmailDisplayMobile = document.getElementById('user-email-display-mobile');
        const adminGererBoutiqueDesktop = document.getElementById('admin-gerer-boutique-desktop');
        const adminGererBoutiqueMobile = document.getElementById('admin-gerer-boutique-mobile');
        const adminGenererAnnonceDesktop = document.getElementById('admin-generer-annonce-desktop');
        const adminGenererAnnonceMobile = document.getElementById('admin-generer-annonce-mobile');
        const adminAccesAntsDesktop = document.getElementById('admin-acces-ants-desktop');
        const adminAccesAntsMobile = document.getElementById('admin-acces-ants-mobile');
        const loginSignupButtonDesktop = document.getElementById('login-signup-button-desktop');
        const loginSignupButtonMobile = document.getElementById('login-signup-button-mobile');


        function toggleAccountMenu(menuElement) {
            menuElement.classList.toggle('hidden');
        }

        authenticatedUserMenuToggleDesktop.addEventListener('click', (event) => {
            event.stopPropagation();
            toggleAccountMenu(accountMenuDesktop);
            accountMenuMobile.classList.add('hidden');
        });

        authenticatedUserMenuToggleMobile.addEventListener('click', (event) => {
            event.stopPropagation();
            toggleAccountMenu(accountMenuMobile);
            accountMenuDesktop.classList.add('hidden');
        });

        document.addEventListener('click', (event) => {
            if (!accountMenuDesktop.contains(event.target) && !authenticatedUserMenuToggleDesktop.contains(event.target)) {
                accountMenuDesktop.classList.add('hidden');
            }
            if (!accountMenuMobile.contains(event.target) && !authenticatedUserMenuToggleMobile.contains(event.target)) {
                accountMenuMobile.classList.add('hidden');
            }
        });

        logoutButtonDesktop.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showCustomAlert("Vous avez été déconnecté.");
                window.location.href = 'index.html'; // Rediriger vers l'accueil après déconnexion
            } catch (error) {
                console.error("Erreur de déconnexion:", error.message);
                showCustomAlert("Erreur lors de la déconnexion. Veuillez réessayer.");
            }
        });

        logoutButtonMobile.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showCustomAlert("Vous avez été déconnecté.");
                window.location.href = 'index.html'; // Rediriger vers l'accueil après déconnexion
            } catch (error) {
                console.error("Erreur de déconnexion:", error.message);
                showCustomAlert("Erreur lors de la déconnexion. Veuillez réessayer.");
            }
        });

        // Mettre à jour l'état de l'interface utilisateur en fonction de l'authentification
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userRef = doc(db, `artifacts/${__app_id}/users/${user.uid}/profile`, 'user_data');
                try {
                    const userDoc = await getDoc(userRef);
                    if (userDoc.exists()) {
                        currentUserRole = userDoc.data().role || 'client';
                    } else {
                        await setDoc(userRef, { email: user.email, role: 'client' });
                        currentUserRole = 'client';
                    }
                } catch (error) {
                    console.error("Erreur lors de la récupération/création du rôle utilisateur:", error);
                    currentUserRole = 'client';
                }

                loginSignupButtonDesktop.classList.add('hidden');
                loginSignupButtonMobile.classList.add('hidden');
                authenticatedUserMenuToggleDesktop.classList.remove('hidden');
                authenticatedUserMenuToggleMobile.classList.remove('hidden');
                userEmailDisplayDesktop.textContent = user.email;
                userEmailDisplayMobile.textContent = user.email;

                if (currentUserRole === 'admin') {
                    adminGererBoutiqueDesktop.classList.remove('hidden');
                    adminGererBoutiqueMobile.classList.remove('hidden');
                    adminGenererAnnonceDesktop.classList.remove('hidden');
                    adminGenererAnnonceMobile.classList.remove('hidden');
                    adminAccesAntsDesktop.classList.remove('hidden');
                    adminAccesAntsMobile.classList.remove('hidden');
                } else {
                    adminGererBoutiqueDesktop.classList.add('hidden');
                    adminGererBoutiqueMobile.classList.add('hidden');
                    adminGenererAnnonceDesktop.classList.add('hidden');
                    adminGenererAnnonceMobile.classList.add('hidden');
                    adminAccesAntsDesktop.classList.add('hidden');
                    adminAccesAntsMobile.classList.add('hidden');
                }

            } else {
                loginSignupButtonDesktop.classList.remove('hidden');
                loginSignupButtonMobile.classList.remove('hidden');
                authenticatedUserMenuToggleDesktop.classList.add('hidden');
                authenticatedUserMenuToggleMobile.classList.add('hidden');
                accountMenuDesktop.classList.add('hidden');
                accountMenuMobile.classList.add('hidden');
                adminGererBoutiqueDesktop.classList.add('hidden');
                adminGererBoutiqueMobile.classList.add('hidden');
                adminGenererAnnonceDesktop.classList.add('hidden');
                adminGenererAnnonceMobile.classList.add('hidden');
                adminAccesAntsDesktop.classList.add('hidden');
                adminAccesAntsMobile.classList.add('hidden');
                currentUserRole = null;
            }
        });

        // Redirection des boutons d'administration (pour le menu du header)
        adminGererBoutiqueDesktop.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentUserRole === 'admin') {
                window.location.href = 'index.html#admin-panel';
            } else {
                showCustomAlert("Vous n'avez pas les permissions pour accéder à cette section.");
            }
        });
        adminGererBoutiqueMobile.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentUserRole === 'admin') {
                window.location.href = 'index.html#admin-panel';
            } else {
                showCustomAlert("Vous n'avez pas les permissions pour accéder à cette section.");
            }
        });

        adminGenererAnnonceDesktop.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentUserRole === 'admin') {
                window.location.href = 'annonce.html';
            } else {
                showCustomAlert("Vous n'avez pas les permissions pour accéder à cet outil.");
            }
        });
        adminGenererAnnonceMobile.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentUserRole === 'admin') {
                window.location.href = 'annonce.html';
            } else {
                showCustomAlert("Vous n'avez pas les permissions pour accéder à cet outil.");
            }
        });

        adminAccesAntsDesktop.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentUserRole === 'admin') {
                window.location.href = 'tools.html'; // Déjà sur cette page, mais utile si on cliquait depuis ailleurs
            } else {
                showCustomAlert("Vous n'avez pas les permissions pour accéder à cet outil.");
            }
        });
        adminAccesAntsMobile.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentUserRole === 'admin') {
                window.location.href = 'tools.html'; // Déjà sur cette page, mais utile si on cliquait depuis ailleurs
            } else {
                showCustomAlert("Vous n'avez pas les permissions pour accéder à cet outil.");
            }
        });
    </script>
</body>
</html>
