<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CENTRAL CARS</title>
    <link rel="icon" type="image/png" href="img/logo_a.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- jsPDF pour la génération de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.16/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style pour l'animation de scroll fluide */
        html {
            scroll-behavior: smooth;
        }
        /* Style pour la barre de défilement */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Empêcher le défilement du corps lorsque la modale est ouverte */
        .modal-open {
            overflow: hidden;
        }
        /* Style pour le menu déroulant du compte */
        .account-menu {
            position: absolute;
            top: calc(100% + 10px); /* Position sous le bouton */
            right: 0;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-width: 180px;
            z-index: 60; /* Au-dessus du header */
        }
        .account-menu a, .account-menu button {
            display: block;
            padding: 0.75rem 1rem;
            text-align: left;
            width: 100%;
            color: #4a5568; /* gray-700 */
            transition: background-color 0.2s;
        }
        .account-menu a:hover, .account-menu button:hover {
            background-color: #f7fafc; /* gray-100 */
        }
        .account-menu button.logout-button {
            color: #e53e3e; /* red-600 */
            font-weight: 600;
        }
        .account-menu button.logout-button:hover {
            background-color: #ffebeb; /* red-100 */
        }
        /* Correction : Supprimer !important pour permettre aux classes Tailwind de fonctionner */
        .hidden {
            display: none;
        }

        /* Styles pour le drag and drop des images */
        .image-preview-item {
            position: relative;
            cursor: grab;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }
        .image-preview-item.dragging {
            opacity: 0.5;
            border-color: #ef4444; /* red-500 */
        }
        .image-preview-item.drag-over {
            border-color: #3b82f6; /* blue-500 */
        }

        /* Styles pour l'image de la modale de détails du véhicule */
        .modal-image-container {
            width: 100%;
            max-height: 70vh; /* Ajuste la hauteur maximale pour ne pas prendre tout l'écran */
            display: flex; /* Utilise flexbox pour centrer l'image */
            align-items: center;
            justify-content: center;
            overflow: hidden; /* Cache les débordements si l'image est trop grande */
        }
        .modal-image-container img {
            width: auto; /* Laisse la largeur s'adapter à l'image */
            height: auto; /* Laisse la hauteur s'adapter à l'image */
            max-width: 100%; /* S'assure que l'image ne dépasse pas la largeur du conteneur */
            max-height: 100%; /* S'assure que l'image ne dépasse pas la hauteur du conteneur */
            object-fit: contain; /* S'assure que l'image entière est visible */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header id="header" class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#" class="text-2xl font-bold text-gray-900">
                <i class="fas fa-car-side text-red-600"></i> CENTRAL <span class="text-red-600">CARS</span>
            </a>
            <div class="hidden md:flex space-x-8 items-center relative">
                <a href="#accueil" class="text-gray-600 hover:text-red-600 transition duration-300">Accueil</a>
                <a href="#vehicules" class="text-gray-600 hover:text-red-600 transition duration-300">Nos Véhicules</a>
                <a href="#services" class="text-gray-600 hover:text-red-600 transition duration-300">Nos Services</a>
                <a href="#contact" class="text-gray-600 hover:text-red-600 transition duration-300">Contact</a>
                
                <!-- Bouton de connexion/inscription pour les grands écrans (non connecté) -->
                <button id="login-signup-button-desktop" class="text-gray-600 hover:text-red-600 focus:outline-none">
                    <i class="fas fa-user-circle text-2xl"></i>
                </button>

                <!-- Bouton/Icône de l'utilisateur connecté pour les grands écrans -->
                <button id="authenticated-user-menu-toggle-desktop" class="text-red-600 hover:text-red-700 focus:outline-none hidden">
                    <i class="fas fa-user-check text-2xl"></i>
                </button>

                <!-- Menu du compte (pour les grands écrans) -->
                <div id="account-menu-desktop" class="account-menu hidden">
                    <div class="px-4 py-2 border-b text-sm text-gray-500" id="user-email-display-desktop"></div>
                    <a href="#" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Mon profil</a>
                    <a href="#" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Mes favoris</a>
                    <button id="admin-gerer-boutique-desktop" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">Gérer boutique</button>
                    <button id="admin-generer-annonce-desktop" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">Générer Annonce</button>
                    <button id="admin-acces-ants-desktop" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">Accès ANTS</button>
                    <button id="admin-dossiers-ants-desktop" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">Dossiers ANTS</button>
                    <button id="admin-rapport-reparation-desktop" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">Rapport de réparation</button> 
                    <button id="logout-button-desktop" class="logout-button text-sm">Se déconnecter</button>
                </div>
            </div>
            <div class="md:hidden flex items-center space-x-4 relative">
                <!-- Bouton de connexion/inscription pour les petits écrans (non connecté) -->
                <button id="login-signup-button-mobile" class="text-gray-600 hover:text-red-600 focus:outline-none">
                    <i class="fas fa-user-circle text-2xl"></i>
                </button>

                <!-- Bouton/Icône de l'utilisateur connecté pour les petits écrans -->
                <button id="authenticated-user-menu-toggle-mobile" class="text-red-600 hover:text-red-700 focus:outline-none hidden">
                    <i class="fas fa-user-check text-2xl"></i>
                </button>

                <button id="mobile-menu-button" class="text-gray-600 hover:text-red-600 focus:outline-none">
                    <i class="fas fa-bars text-2xl"></i>
                </button>

                <!-- Menu du compte (pour les petits écrans, affiché via le menu mobile ou popover) -->
                <div id="account-menu-mobile" class="account-menu hidden">
                    <div class="px-4 py-2 border-b text-sm text-gray-500" id="user-email-display-mobile"></div>
                    <a href="#" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Mon profil</a>
                    <a href="#" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Mes favoris</a>
                    <button id="admin-gerer-boutique-mobile" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">Gérer boutique</button>
                    <button id="admin-generer-annonce-mobile" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">Générer Annonce</button>
                    <button id="admin-acces-ants-mobile" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">Accès ANTS</button>
                    <button id="admin-dossiers-ants-mobile" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">Dossiers ANTS</button>
                    <button id="admin-rapport-reparation-mobile" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">Rapport de réparation</button>
                    <button id="logout-button-mobile" class="logout-button text-sm">Se déconnecter</button>
                </div>
            </div>
        </nav>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-white">
            <a href="#accueil" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Accueil</a>
            <a href="#vehicules" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Nos Véhicules</a>
            <a href="#services" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Nos Services</a>
            <a href="#contact" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Contact</a>
        </div>
    </header>

    <main>
        <!-- Wrapper pour les sections de contenu principal -->
        <div id="main-content-sections">
            <!-- Section Accueil (Hero) -->
            <section id="accueil" class="h-screen bg-cover bg-center bg-fixed flex items-center justify-center" style="background-image: url('https://images.unsplash.com/photo-1553440569-bcc63803a83d?q=80&w=2025&auto=format&fit=crop');">
                <div class="absolute inset-0 bg-black opacity-50"></div>
                <div class="text-center text-white z-10 p-4">
                    <h1 class="text-4xl md:text-6xl font-bold mb-4">CENTRAL CARS</h1>
                    <p class="text-lg md:text-2xl mb-8">Professionnel de l'automobile depuis 2003.</p>
                    <a href="#vehicules" class="bg-red-600 text-white font-bold py-3 px-8 rounded-full hover:bg-red-700 transition duration-300 transform hover:scale-105">Découvrir nos voitures</a>
                </div>
            </section>

            <!-- Section Véhicules -->
            <section id="vehicules" class="py-20 bg-white">
                <div class="container mx-auto px-6">
                    <h2 class="text-3xl font-bold text-center mb-2">Nos Véhicules d'Occasion</h2>
                    <p class="text-center text-gray-500 mb-12">Des voitures sélectionnées et garanties pour votre sérénité.</p>
                    
                    <!-- Section de filtres -->
                    <div class="bg-gray-100 p-6 rounded-lg shadow-md mb-12">
                        <h3 class="text-xl font-bold mb-4">Filtrer les véhicules</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label for="filter-marque" class="block text-gray-700 text-sm font-semibold mb-2">Marque</label>
                                <select id="filter-marque" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                                    <option value="">Toutes les marques</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-modele" class="block text-gray-700 text-sm font-semibold mb-2">Modèle</label>
                                <select id="filter-modele" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                                    <option value="">Tous les modèles</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-carburant" class="block text-gray-700 text-sm font-semibold mb-2">Carburant</label>
                                <select id="filter-carburant" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                                    <option value="">Tous les carburants</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-boite-vitesse" class="block text-gray-700 text-sm font-semibold mb-2">Boîte de vitesse</label>
                                <select id="filter-boite-vitesse" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                                    <option value="">Toutes les boîtes</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-prix-min" class="block text-gray-700 text-sm font-semibold mb-2">Prix Min (€)</label>
                                <input type="number" id="filter-prix-min" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Ex: 5000">
                            </div>
                            <div>
                                <label for="filter-prix-max" class="block text-gray-700 text-sm font-semibold mb-2">Prix Max (€)</label>
                                <input type="number" id="filter-prix-max" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Ex: 20000">
                            </div>
                            <div class="flex items-end">
                                <input type="checkbox" id="filter-vendu" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded mr-2">
                                <label for="filter-vendu" class="text-gray-700 text-sm font-semibold">Afficher les véhicules vendus</label>
                            </div>
                            <div class="flex items-end">
                                <button id="reset-filters-button" class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition duration-300">Réinitialiser les filtres</button>
                            </div>
                        </div>
                    </div>

                    <div id="vehicle-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    </div>
                    <div id="loading-spinner" class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-red-600 text-4xl"></i>
                        <p class="mt-2 text-gray-600">Chargement des véhicules...</p>
                    </div>
                </div>
            </section>

            <!-- Section Nos Services -->
            <section id="services" class="py-20 bg-gray-100">
                <div class="container mx-auto px-6">
                    <h2 class="text-3xl font-bold text-center mb-12">Nos Services</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <div class="bg-white p-8 rounded-lg shadow-lg">
                            <h3 class="text-2xl font-bold mb-4 text-red-600"><i class="fas fa-wrench mr-3"></i>Atelier mécanique</h3>
                            <ul class="list-disc list-inside space-y-2 text-gray-700 text-lg">
                                <li>Entretiens toutes marques.</li>
                                <li>Vidange moteur, remplacement des filtres.</li>
                                <li>Kit distribution et courroie accessoire.</li>
                                <li>Disques et plaquettes de frein.</li>
                                <li>Allumage (bougie, injecteurs, etc..)</li>
                                <li>Et bien d'autres...</li>
                            </ul>
                        </div>
                        <div class="bg-white p-8 rounded-lg shadow-lg">
                            <h3 class="text-2xl font-bold mb-4 text-red-600"><i class="fas fa-cogs mr-3"></i>Géométrie et Équilibrage</h3>
                            <ul class="list-disc list-inside space-y-2 text-gray-700 text-lg">
                                <li>Montage des pneumatiques sur jantes.</li>
                                <li>Equilibrage de la roue.</li>
                                <li>Geométrie des roues.</li>
                            </ul>
                        </div>
                        <div class="bg-white p-8 rounded-lg shadow-lg">
                            <h3 class="text-2xl font-bold mb-4 text-red-600"><i class="fas fa-key mr-3"></i>Reproduction de Clés</h3>
                            <ul class="list-disc list-inside space-y-2 text-gray-700 text-lg">
                                <li>Reproduction de clé toutes marques.</li>
                                <li>Clés simples ou centralisées.</li>
                                <li>Taillage de lame et reprogrammation.</li>
                            </ul>
                        </div>
                        <div class="md:col-span-full bg-white p-8 rounded-lg shadow-lg">
                            <h3 class="text-2xl font-bold mb-4 text-red-600"><i class="fas fa-file-alt mr-3"></i>Service Administratif (Carte Grise)</h3>
                            <ul class="list-disc list-inside space-y-2 text-gray-700 text-lg">
                                <li>Habilité par le Service Instructeur des Véhicules.</li>
                                <li>Cartes grises françaises.</li>
                                <li>Véhicules importés : délivrance de WW, reception du Quitus Fiscal et demande de carte grise définitive.</li>
                                <li>Déclaration de cession, déclaration de perte, demande de duplicatat, modification techniques, etc...</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section Contact -->
            <section id="contact" class="py-20 bg-white">
                <div class="container mx-auto px-6">
                    <h2 class="text-3xl font-bold text-center mb-12">Contactez-nous</h2>
                    <div class="flex flex-wrap -mx-4">
                        <!-- Formulaire de contact -->
                        <div class="w-full lg:w-1/2 px-4 mb-8 lg:mb-0">
                            <div class="bg-gray-100 p-8 rounded-lg shadow-lg">
                                <h3 class="text-2xl font-bold mb-6">Envoyez-nous un message</h3>
                                <form>
                                    <div class="mb-4">
                                        <label for="name" class="block text-gray-700 font-semibold mb-2">Nom complet</label>
                                        <input type="text" id="name" name="name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Votre nom">
                                    </div>
                                    <div class="mb-4">
                                        <label for="email" class="block text-gray-700 font-semibold mb-2">Email</label>
                                        <input type="email" id="email" name="email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Votre email">
                                    </div>
                                    <div class="mb-6">
                                        <label for="message" class="block text-gray-700 font-semibold mb-2">Message</label>
                                        <textarea id="message" name="message" rows="5" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Votre message..."></textarea>
                                    </div>
                                    <button type="submit" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition duration-300">Envoyer</button>
                                </form>
                            </div>
                        </div>
                        <!-- Informations de contact -->
                        <div class="w-full lg:w-1/2 px-4">
                            <div class="bg-gray-100 p-8 rounded-lg shadow-lg h-full">
                                <h3 class="text-2xl font-bold mb-6">Nos Coordonnées</h3>
                                <div class="space-y-6 text-lg">
                                    <p class="flex items-start">
                                        <i class="fas fa-map-marker-alt text-red-600 mt-1 mr-4 w-6 text-center"></i>
                                        <span>CENTRAL CARS<br>576 RUE MARCEL SEMBAT<br>59690 Vieux-Condé, France</span>
                                    </p>
                                    <p class="flex items-center">
                                        <i class="fas fa-phone text-red-600 mr-4 w-6 text-center"></i>
                                        <a href="tel:+33698979463" class="hover:text-red-600">06 98 97 94 63</a>
                                     </p>
                                    <p class="flex items-center">
                                        <i class="fas fa-envelope text-red-600 mr-4 w-6 text-center"></i>
                                        <a href="mailto:contact@centralcars.fr" class="hover:text-red-600">contact@centralcars.fr</a>
                                     </p>
                                    <p class="flex items-center">
                                        <i class="fas fa-id-card text-red-600 mr-4 w-6 text-center"></i>
                                        <span>SIRET: 78992754800022</span>
                                    </p>
                                </div>
                                <div class="mt-8">
                                    <h4 class="text-xl font-bold mb-4">Horaires d'ouverture</h4>
                                    <ul class="space-y-2">
                                        <li><strong>Lundi - Vendredi :</strong> 9h00 - 18h00</li>
                                        <li><strong>Samedi :</strong> 9h00 - 12h00</li>
                                        <li><strong>Dimanche :</strong> Fermé</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Admin Panel Section -->
        <section id="admin-panel" class="py-20 bg-gray-100 hidden">
            <div class="container mx-auto px-6">
                <h2 class="text-3xl font-bold text-center mb-12">Gérer boutique</h2>

                <div class="flex justify-start mb-8">
                    <button id="back-to-home-button" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition duration-300">
                        <i class="fas fa-arrow-left mr-2"></i> Retour à l'accueil
                    </button>
                </div>

                <!-- Formulaire d'ajout/modification de véhicule -->
                <div class="bg-white p-8 rounded-lg shadow-lg mb-12">
                    <h3 class="text-2xl font-bold mb-6" id="vehicle-form-title">Ajouter un nouveau véhicule</h3>
                    <form id="vehicle-form" class="space-y-4">
                        <input type="hidden" id="vehicle-id">
                        <div>
                            <label for="vehicle-titre-annonce" class="block text-gray-700 font-semibold mb-2">Titre de l'annonce</label>
                            <input type="text" id="vehicle-titre-annonce" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        </div>
                        <div>
                            <label for="vehicle-marque" class="block text-gray-700 font-semibold mb-2">Marque</label>
                            <select id="vehicle-marque" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                                <option value="">Sélectionner une marque</option>
                            </select>
                        </div>
                        <div>
                            <label for="vehicle-modele" class="block text-gray-700 font-semibold mb-2">Modèle</label>
                            <select id="vehicle-modele" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                                <option value="">Sélectionner un modèle</option>
                            </select>
                        </div>
                        <div>
                            <label for="vehicle-annee-modele" class="block text-gray-700 font-semibold mb-2">Année du modèle</label>
                            <input type="number" id="vehicle-annee-modele" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" min="1900" max="2099" required>
                        </div>
                        <div>
                            <label for="vehicle-date-circulation" class="block text-gray-700 font-semibold mb-2">Date de première mise en circulation (MM/AAAA)</label>
                            <input type="text" id="vehicle-date-circulation" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="MM/AAAA" pattern="(0[1-9]|1[0-2])\/(19|20)\d{2}" required>
                        </div>
                        <div>
                            <label for="vehicle-kilometrage" class="block text-gray-700 font-semibold mb-2">Kilométrage</label>
                            <input type="number" id="vehicle-kilometrage" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        </div>
                        <div>
                            <label for="vehicle-carburant" class="block text-gray-700 font-semibold mb-2">Carburant</label>
                            <select id="vehicle-carburant" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                                <option value="">Sélectionner un type de carburant</option>
                            </select>
                        </div>
                        <div>
                            <label for="vehicle-boite-vitesse" class="block text-gray-700 font-semibold mb-2">Boîte de vitesse</label>
                            <select id="vehicle-boite-vitesse" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                                <option value="">Sélectionner un type de boîte</option>
                            </select>
                        </div>
                        <div>
                            <label for="vehicle-couleur" class="block text-gray-700 font-semibold mb-2">Couleur</label>
                            <input type="text" id="vehicle-couleur" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                        </div>
                        <div>
                            <label for="vehicle-nb-places" class="block text-gray-700 font-semibold mb-2">Nombre de places</label>
                            <input type="number" id="vehicle-nb-places" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" min="1" max="9">
                        </div>
                        <div>
                            <label for="vehicle-nb-portes" class="block text-gray-700 font-semibold mb-2">Nombre de portes</label>
                            <input type="number" id="vehicle-nb-portes" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" min="1" max="5">
                        </div>
                        <div>
                            <label for="vehicle-puissance-fiscale" class="block text-gray-700 font-semibold mb-2">Puissance fiscale (CV)</label>
                            <input type="number" id="vehicle-puissance-fiscale" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" min="1">
                        </div>
                        <div>
                            <label for="vehicle-puissance-din" class="block text-gray-700 font-semibold mb-2">Puissance DIN (ch)</label>
                            <input type="number" id="vehicle-puissance-din" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" min="1">
                        </div>
                        <div>
                            <label for="vehicle-critair" class="block text-gray-700 font-semibold mb-2">Crit'Air</label>
                            <select id="vehicle-critair" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                                <option value="">Sélectionner une vignette</option>
                                <option value="0">0 (Vert)</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="Non classé">Non classé</option>
                            </select>
                        </div>
                        <div>
                            <label for="vehicle-prix" class="block text-gray-700 font-semibold mb-2">Prix (€)</label>
                            <input type="number" id="vehicle-prix" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" step="0.01" required>
                        </div>
                        <div>
                            <label for="vehicle-description" class="block text-gray-700 font-semibold mb-2">Description</label>
                            <textarea id="vehicle-description" rows="4" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"></textarea>
                        </div>
                        
                        <div class="border-t pt-4 mt-4">
                            <h4 class="text-xl font-bold mb-4">Options</h4>
                            <div id="vehicle-options-checkboxes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            </div>
                        </div>

                        <div class="border-t pt-4 mt-4">
                            <h4 class="text-xl font-bold mb-4">Entretiens effectués</h4>
                            <div id="vehicle-maintenances-checkboxes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            </div>
                        </div>

                        <div class="flex flex-wrap gap-4 mt-4">
                            <div class="flex items-center">
                                <input type="checkbox" id="vehicle-vendu" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                                <label for="vehicle-vendu" class="ml-2 block text-gray-700 font-semibold">Véhicule vendu</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="vehicle-hidden" class="h-4 w-4 text-gray-600 focus:ring-gray-500 border-gray-300 rounded">
                                <label for="vehicle-hidden" class="ml-2 block text-gray-700 font-semibold">Cacher l'annonce</label>
                            </div>
                        </div>

                        <div class="border-t pt-4 mt-4">
                            <h4 class="text-xl font-bold mb-4">Images du véhicule (glisser-déposer pour réordonner)</h4>
                            <input type="file" id="vehicle-image-upload" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" multiple accept="image/*">
                            <div id="image-upload-preview" class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-4">
                            </div>
                            <div id="image-upload-spinner" class="text-center py-4 hidden">
                                <i class="fas fa-spinner fa-spin text-red-600 text-2xl"></i>
                                <p class="mt-2 text-gray-600">Téléchargement des images...</p>
                            </div>
                            <input type="hidden" id="vehicle-images-urls">
                        </div>

                        <button type="submit" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition duration-300" id="submit-vehicle-button">Ajouter le véhicule</button>
                        <button type="button" class="w-full bg-gray-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-600 transition duration-300 mt-2 hidden" id="cancel-edit-button">Annuler la modification</button>
                    </form>
                </div>

                <h3 class="text-2xl font-bold text-center mb-6">Véhicules existants</h3>
                <div id="admin-vehicle-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                </div>
                <div id="admin-loading-spinner" class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-red-600 text-4xl"></i>
                    <p class="mt-2 text-gray-600">Chargement des véhicules...</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8">
        <div class="container mx-auto px-6 text-center">
            <p>&copy; 2024 CENTRAL CARS. Tous droits réservés.</p>
            <p class="text-sm text-gray-400 mt-2">Site conçu avec ❤️</p>
        </div>
    </footer>

    <!-- Modale de détails du véhicule -->
    <div id="vehicle-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div id="modal-content" class="bg-white rounded-lg shadow-2xl w-11/12 md:w-3/4 lg:w-2/3 max-h-[90vh] overflow-y-auto relative transform transition-all duration-300 scale-95 opacity-0">
        </div>
    </div>

    <!-- Modale de contact pour le véhicule -->
    <div id="vehicle-contact-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[51] hidden">
        <div id="vehicle-contact-modal-content" class="bg-white rounded-lg shadow-2xl w-11/12 md:w-1/2 lg:w-1/3 p-8 relative transform transition-all duration-300 scale-95 opacity-0">
            <button id="close-vehicle-contact-modal-button" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 text-2xl">&times;</button>
            <h2 class="text-2xl font-bold text-center mb-6">Ce véhicule vous intéresse ?</h2>
            <p class="text-center text-gray-700 mb-6">Contactez-nous pour plus d'informations ou pour prendre rendez-vous.</p>
            <div class="flex flex-col space-y-4">
                <a id="contact-phone-link" href="tel:+33698979463" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-center hover:bg-blue-700 transition duration-300 flex items-center justify-center">
                    <i class="fas fa-phone mr-3"></i> Appeler (06 98 97 94 63)
                </a>
                <a id="contact-email-link" href="mailto:contact@centralcars.fr" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-center hover:bg-green-700 transition duration-300 flex items-center justify-center">
                    <i class="fas fa-envelope mr-3"></i> Envoyer un e-mail
                </a>
            </div>
        </div>
    </div>

    <!-- Modale de connexion/inscription -->
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl w-11/12 md:w-1/2 lg:w-1/3 p-8 relative transform transition-all duration-300 scale-95 opacity-0" id="auth-modal-content">
            <button id="close-auth-modal-button" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 text-2xl">&times;</button>
            <h2 class="text-3xl font-bold text-center mb-6" id="auth-modal-title">Connexion</h2>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-gray-700 font-semibold mb-2">Email</label>
                    <input type="email" id="login-email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Votre email" required>
                </div>
                <div>
                    <label for="login-password" class="block text-gray-700 font-semibold mb-2">Mot de passe</label>
                    <input type="password" id="login-password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Votre mot de passe" required>
                </div>
                <button type="submit" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition duration-300">Se connecter</button>
            </form>

            <form id="signup-form" class="space-y-4 hidden">
                <div>
                    <label for="signup-email" class="block text-gray-700 font-semibold mb-2">Email</label>
                    <input type="email" id="signup-email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Votre email" required>
                </div>
                <div>
                    <label for="signup-password" class="block text-gray-700 font-semibold mb-2">Mot de passe</label>
                    <input type="password" id="signup-password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Votre mot de passe" required>
                </div>
                <button type="submit" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition duration-300">S'inscrire</button>
            </form>

            <p class="text-center mt-4">
                <button id="toggle-auth-mode" class="text-red-600 hover:underline">Pas encore de compte ? S'inscrire</button>
            </p>
        </div>
    </div>

    <!-- Modale de l'outil de génération de PDF -->
    <div id="pdf-tool-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div id="pdf-tool-modal-content" class="bg-white rounded-lg shadow-2xl w-11/12 md:w-3/4 lg:w-2/3 max-h-[90vh] overflow-y-auto relative transform transition-all duration-300 scale-95 opacity-0">
            <button id="close-pdf-tool-modal-button" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 text-2xl">&times;</button>
            <div class="p-8">
                <h1 class="text-3xl font-bold text-center mb-6">Outil de Génération de Rapport de Réparation</h1>
                <p class="text-center text-gray-600 mb-8">Remplissez les informations ci-dessous pour générer un rapport de réparation en PDF.</p>

                <form id="repair-report-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="marque" class="block text-gray-700 font-semibold mb-2">Marque</label>
                            <input type="text" id="marque" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        </div>
                        <div>
                            <label for="modele" class="block text-gray-700 font-semibold mb-2">Modèle</label>
                            <input type="text" id="modele" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        </div>
                        <div>
                            <label for="immatriculation" class="block text-gray-700 font-semibold mb-2">Numéro d'immatriculation</label>
                            <input type="text" id="immatriculation" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        </div>
                        <div>
                            <label for="chassis" class="block text-gray-700 font-semibold mb-2">Numéro de châssis (VIN)</label>
                            <input type="text" id="chassis" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        </div>
                        <div>
                            <label for="kilometrage" class="block text-gray-700 font-semibold mb-2">Kilométrage</label>
                            <input type="number" id="kilometrage" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        </div>
                        <div>
                            <label for="date-circulation" class="block text-gray-700 font-semibold mb-2">Date de 1ère mise en circulation</label>
                            <input type="date" id="date-circulation" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        </div>
                    </div>

                    <div class="border-t pt-6 mt-6">
                        <h3 class="text-xl font-bold mb-4">Réparations effectuées</h3>
                        <div id="repairs-checkboxes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        </div>
                    </div>

                    <div class="border-t pt-6 mt-6">
                        <h3 class="text-xl font-bold mb-4">Ajouter d'autres réparations</h3>
                        <div class="flex flex-col md:flex-row gap-4">
                            <input type="text" id="manual-repair-input" class="flex-grow px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Ex: Remplacement du turbo">
                            <button type="button" id="add-manual-repair" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-300">Ajouter</button>
                        </div>
                        <ul id="manual-repairs-list" class="mt-4 space-y-2">
                        </ul>
                    </div>

                    <div class="border-t pt-6 mt-6">
                        <h3 class="text-xl font-bold mb-4">Observation</h3>
                        <textarea id="observation" rows="5" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Ajoutez des observations supplémentaires ici..."></textarea>
                    </div>

                    <button type="submit" id="generate-pdf-button" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition duration-300">Générer le PDF</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- ================================================================================= -->
    <!-- MODALE : GESTION DES DOSSIERS ANTS -->
    <!-- ================================================================================= -->
    <div id="ants-dossiers-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div id="ants-dossiers-modal-content" class="bg-white rounded-lg shadow-2xl w-11/12 md:w-4/5 lg:w-3/4 max-h-[90vh] overflow-y-auto relative transform transition-all duration-300 scale-95 opacity-0">
            <button id="close-ants-dossiers-modal-button" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 text-2xl">&times;</button>
            <div class="p-8">
                <h1 class="text-3xl font-bold text-center mb-8">Gestion des Dossiers ANTS</h1>

                <!-- Bouton pour afficher le formulaire -->
                <div class="mb-6 text-center">
                    <button id="toggle-dossier-form-button" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition duration-300">
                        <i class="fas fa-plus mr-2"></i> Ajouter un dossier
                    </button>
                </div>

                <!-- Formulaire d'ajout/modification de dossier (initialement caché) -->
                <div id="dossier-form-container" class="bg-gray-50 p-6 rounded-lg shadow-inner mb-10 hidden">
                    <h3 class="text-2xl font-bold mb-6" id="dossier-form-title">Créer un nouveau dossier</h3>
                    <form id="ants-dossier-form" class="space-y-4">
                        <input type="hidden" id="dossier-id">
                        
                        <!-- Type de client -->
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Type de client</label>
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center">
                                    <input type="radio" name="dossier-type" value="Particulier" class="form-radio text-red-600" checked>
                                    <span class="ml-2">Particulier</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="dossier-type" value="Pro" class="form-radio text-red-600">
                                    <span class="ml-2">Professionnel</span>
                                </label>
                            </div>
                        </div>

                        <!-- Champs pour Professionnel (cachés par défaut) -->
                        <div id="dossier-pro-fields" class="hidden space-y-4">
                            <div>
                                <label for="dossier-professionnel" class="block text-gray-700 font-semibold mb-2">Professionnel</label>
                                <select id="dossier-professionnel" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                                    <option value="">Sélectionner un professionnel</option>
                                </select>
                            </div>
                            <div>
                                <label for="dossier-num-quitus" class="block text-gray-700 font-semibold mb-2">Numéro quitus fiscal</label>
                                <input type="text" id="dossier-num-quitus" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                            </div>
                        </div>

                        <!-- Informations Client et Véhicule -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="dossier-nom-client" class="block text-gray-700 font-semibold mb-2">Nom du client</label>
                                <input type="text" id="dossier-nom-client" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                            </div>
                            <div>
                                <label for="dossier-prenom-client" class="block text-gray-700 font-semibold mb-2">Prénom du client</label>
                                <input type="text" id="dossier-prenom-client" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                            </div>
                             <div>
                                <label for="dossier-marque-vehicule" class="block text-gray-700 font-semibold mb-2">Marque du véhicule</label>
                                <select id="dossier-marque-vehicule" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                                    <option value="">Sélectionner une marque</option>
                                </select>
                            </div>
                            <div>
                                <label for="dossier-modele-vehicule" class="block text-gray-700 font-semibold mb-2">Modèle du véhicule</label>
                                <select id="dossier-modele-vehicule" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                                    <option value="">Sélectionner un modèle</option>
                                </select>
                            </div>
                        </div>

                        <!-- Informations Dossier -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="dossier-vin" class="block text-gray-700 font-semibold mb-2">Code VIN (4 derniers)</label>
                                <input type="text" id="dossier-vin" maxlength="4" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                            </div>
                            <div>
                                <label for="dossier-num-facture" class="block text-gray-700 font-semibold mb-2">Numéro de facture</label>
                                <input type="text" id="dossier-num-facture" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                            </div>
                            <div>
                                <label for="dossier-num-demarche" class="block text-gray-700 font-semibold mb-2">Numéro de démarche ANTS</label>
                                <input type="text" id="dossier-num-demarche" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                            </div>
                        </div>

                        <!-- Commentaire -->
                        <div>
                            <label for="dossier-commentaire" class="block text-gray-700 font-semibold mb-2">Commentaire</label>
                            <textarea id="dossier-commentaire" rows="3" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"></textarea>
                        </div>

                        <!-- Boutons -->
                        <div class="flex space-x-4 pt-4">
                            <button type="submit" id="submit-dossier-button" class="flex-1 bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition duration-300">Créer le dossier</button>
                            <button type="button" id="cancel-edit-dossier-button" class="flex-1 bg-gray-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-600 transition duration-300">Annuler</button>
                        </div>
                    </form>
                </div>

                <!-- Section de recherche et de filtre -->
                <div class="bg-gray-50 p-4 rounded-lg shadow-inner mb-6">
                    <h4 class="text-xl font-bold mb-4">Rechercher et Filtrer les Dossiers</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="dossier-search-input" class="block text-gray-700 text-sm font-semibold mb-2">Rechercher (Nom, Prénom, VIN, Pro...)</label>
                            <input type="text" id="dossier-search-input" placeholder="Entrez votre recherche..." class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                        </div>
                        <div>
                            <label for="dossier-filter-type" class="block text-gray-700 text-sm font-semibold mb-2">Filtrer par Type de Client</label>
                            <select id="dossier-filter-type" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                                <option value="">Tous les types</option>
                                <option value="Particulier">Particulier</option>
                                <option value="Pro">Professionnel</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button id="dossier-reset-filters" class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition duration-300">Réinitialiser</button>
                        </div>
                    </div>
                </div>


                <!-- Liste des dossiers existants -->
                <h3 class="text-2xl font-bold text-center mb-6">Dossiers existants</h3>
                <div id="ants-dossiers-list-container" class="overflow-x-auto">
                    <!-- Le tableau des dossiers sera injecté ici par JavaScript -->
                </div>
                 <div id="ants-dossiers-loading-spinner" class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-red-600 text-4xl"></i>
                    <p class="mt-2 text-gray-600">Chargement des dossiers...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- NOUVELLE MODALE : RÉCAPITULATIF DU DOSSIER -->
    <div id="dossier-summary-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[51] hidden">
        <div id="dossier-summary-modal-content" class="bg-white rounded-lg shadow-2xl w-11/12 md:w-1/2 lg:w-1/3 max-h-[90vh] overflow-y-auto relative transform transition-all duration-300 scale-95 opacity-0">
            <button id="close-dossier-summary-modal-button" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 text-2xl">&times;</button>
            <div class="p-8">
                <h2 class="text-2xl font-bold text-center mb-6">Récapitulatif du Dossier</h2>
                <div class="space-y-4 text-gray-700">
                    <div>
                        <h4 class="font-semibold text-gray-500 text-sm">Client</h4>
                        <p id="summary-client-name" class="text-lg"></p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-500 text-sm">Type</h4>
                        <p id="summary-client-type" class="text-lg"></p>
                    </div>
                    <div id="summary-pro-section" class="hidden">
                        <h4 class="font-semibold text-gray-500 text-sm">Professionnel</h4>
                        <p id="summary-pro-name" class="text-lg"></p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-500 text-sm">Véhicule</h4>
                        <p id="summary-vehicle" class="text-lg"></p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-500 text-sm">Code VIN (4 derniers)</h4>
                        <p id="summary-vin" class="text-lg font-mono"></p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-500 text-sm">Numéro de Facture</h4>
                        <p id="summary-num-facture" class="text-lg"></p>
                    </div>
                    <div id="summary-quitus-section" class="hidden">
                        <h4 class="font-semibold text-gray-500 text-sm">Numéro Quitus Fiscal</h4>
                        <p id="summary-num-quitus" class="text-lg"></p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-500 text-sm">Numéro de Démarche ANTS</h4>
                        <a id="summary-num-demarche" href="#" target="_blank" class="text-lg text-blue-600 hover:underline"></a>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-500 text-sm">Commentaire</h4>
                        <p id="summary-comment" class="text-lg bg-gray-50 p-3 rounded-md min-h-[50px]"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- CUSTOM ALERT MODAL -->
    <div id="custom-alert" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[999] hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center relative">
            <p id="custom-alert-message" class="text-lg font-semibold mb-4"></p>
            <button id="custom-alert-close" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">OK</button>
        </div>
    </div>

    <!-- CUSTOM CONFIRM MODAL -->
    <div id="custom-confirm" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[999] hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center relative">
            <p id="custom-confirm-message" class="text-lg font-semibold mb-4"></p>
            <div class="flex justify-center space-x-4">
                <button id="custom-confirm-ok" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">Oui</button>
                <button id="custom-confirm-cancel" class="bg-gray-400 text-white py-2 px-4 rounded-lg hover:bg-gray-500 transition duration-300">Annuler</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- IMPORTS ET CONFIGURATION FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, addDoc, deleteDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";


        // Configuration Firebase fournie
        const __app_id = 'central-cars-a37ae';
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyC1RQ5m7_utiAEsvyobIuuwxzAzBLx27Sw",
            authDomain: "central-cars-a37ae.firebaseapp.com",
            projectId: "central-cars-a37ae",
            storageBucket: "central-cars-a37ae.firebaseapp.com",
            messagingSenderId: "297273470734",
            appId: "1:297273470734:web:7d35e6619b28dc569d715f",
            measurementId: "G-4LXQG2VWP1"
        });

        const firebaseConfig = JSON.parse(__firebase_config);

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- VARIABLES GLOBALES ---
        let allVehicles = []; 
        window.currentUserRole = null; 
        let allAntsDossiers = [];

        // --- GESTION DU MENU MOBILE ---
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

        // --- RÉFÉRENCES DES ÉLÉMENTS DE FILTRE ---
        const filterMarqueSelect = document.getElementById('filter-marque');
        const filterModeleSelect = document.getElementById('filter-modele');
        const filterCarburantSelect = document.getElementById('filter-carburant');
        const filterBoiteVitesseSelect = document.getElementById('filter-boite-vitesse');
        const filterPrixMinInput = document.getElementById('filter-prix-min');
        const filterPrixMaxInput = document.getElementById('filter-prix-max');
        const filterVenduCheckbox = document.getElementById('filter-vendu');
        const resetFiltersButton = document.getElementById('reset-filters-button');

        // --- FONCTION POUR AFFICHER LES VÉHICULES (Côté client) ---
        function displayVehicles(vehiclesToDisplay) {
            const vehicleList = document.getElementById('vehicle-list');
            const loadingSpinner = document.getElementById('loading-spinner');
            vehicleList.innerHTML = ''; 

            let visibleVehicles = vehiclesToDisplay.filter(v => !v.hidden);

            if (visibleVehicles.length === 0) {
                 vehicleList.innerHTML = `<p class="text-center col-span-full">Aucun véhicule ne correspond à vos critères de recherche.</p>`;
            } else {
                visibleVehicles.sort((a, b) => {
                    return (a.vendu || false) - (b.vendu || false);
                });

                visibleVehicles.forEach(vehicle => {
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow-lg overflow-hidden transform hover:-translate-y-2 transition-transform duration-300 relative';
                    const imageUrl = vehicle.images && vehicle.images.length > 0 ? vehicle.images[0] : 'https://placehold.co/600x400/cccccc/ffffff?text=Image+Indisponible';
                    
                    const soldBadge = vehicle.vendu ? `
                        <span class="absolute top-2 left-2 bg-red-600 text-white text-xs font-bold px-3 py-1 rounded-full z-10">VENDU</span>
                    ` : '';

                    card.innerHTML = `
                        ${soldBadge}
                        <img src="${imageUrl}" alt="Image de ${vehicle.nom}" class="w-full h-56 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/ffffff?text=Image+Invalide';">
                        <div class="p-6">
                            <h3 class="text-2xl font-bold mb-2">${vehicle.titreAnnonce || vehicle.nom || 'Titre non disponible'}</h3>
                            <p class="text-gray-600 mb-2">${vehicle.marque || 'N/A'} - ${vehicle.modele || 'N/A'}</p>
                            <div class="text-gray-600 mb-4 space-y-1">
                                <p><i class="fas fa-calendar-alt w-6 text-red-500"></i> ${vehicle.anneeModele || 'N/A'}</p>
                                <p><i class="fas fa-tachometer-alt w-6 text-red-500"></i> ${vehicle.kilometrage ? vehicle.kilometrage.toLocaleString('fr-FR') : 'N/A'} km</p>
                                <p><i class="fas fa-gas-pump w-6 text-red-500"></i> ${vehicle.carburant || 'N/A'}</p>
                            </div>
                            <p class="text-3xl font-bold text-red-600 mb-4">${vehicle.prix ? vehicle.prix.toLocaleString('fr-FR') : 'N/A'} €</p>
                            <button data-id="${vehicle.id}" class="details-button w-full bg-gray-800 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-900 transition duration-300">
                                Voir les détails
                            </button>
                        </div>
                    `;
                    vehicleList.appendChild(card);
                });
            }
             loadingSpinner.style.display = 'none';
        }

        // --- GESTION DE LA MODALE DE DÉTAILS DU VÉHICULE ---
        const vehicleModal = document.getElementById('vehicle-modal');
        const vehicleModalContent = document.getElementById('modal-content');

        function openVehicleModal(vehicle) {
            let currentImageIndex = 0;
            const images = vehicle.images && vehicle.images.length > 0 ? vehicle.images : ['https://placehold.co/800x600/cccccc/ffffff?text=Image+Indisponible'];

            const soldBadgeModal = vehicle.vendu ? `
                <span class="absolute top-4 left-4 bg-red-600 text-white text-lg font-bold px-4 py-2 rounded-full z-10">VENDU</span>
            ` : '';

            vehicleModalContent.innerHTML = `
                <button id="close-vehicle-modal-button" class="absolute top-4 right-4 text-white bg-black bg-opacity-50 rounded-full w-8 h-8 flex items-center justify-center text-2xl hover:bg-opacity-75 z-20">&times;</button>
                
                <div class="modal-image-container relative">
                    ${soldBadgeModal}
                    <img id="modal-image" src="${images[0]}" alt="Image principale de ${vehicle.titreAnnonce || vehicle.nom}" class="rounded-t-lg" onerror="this.onerror=null;this.src='https://placehold.co/800x600/cccccc/ffffff?text=Image+Invalide';">
                    <div id="modal-image-prev" class="absolute left-0 top-1/2 -translate-y-1/2 p-2 m-2 bg-black bg-opacity-50 text-white rounded-full cursor-pointer hover:bg-opacity-75 ${images.length <= 1 ? 'hidden' : ''}"><i class="fas fa-chevron-left"></i></div>
                    <div id="modal-image-next" class="absolute right-0 top-1/2 -translate-y-1/2 p-2 m-2 bg-black bg-opacity-50 text-white rounded-full cursor-pointer hover:bg-opacity-75 ${images.length <= 1 ? 'hidden' : ''}"><i class="fas fa-chevron-right"></i></div>
                </div>

                <div class="p-6 md:p-8">
                    <h2 class="text-3xl font-bold mb-2">${vehicle.titreAnnonce || vehicle.nom || 'Titre non disponible'}</h2>
                    <p class="text-xl text-gray-700 mb-4">${vehicle.marque || 'N/A'} - ${vehicle.modele || 'N/A'}</p>
                    <p class="text-4xl font-bold text-red-600 mb-6">${vehicle.prix ? vehicle.prix.toLocaleString('fr-FR') : 'N/A'} €</p>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center mb-6">
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.anneeModele || 'N/A'}</div><div class="text-sm text-gray-600">Année Modèle</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.dateCirculation || 'N/A'}</div><div class="text-sm text-gray-600">1ère circulation</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.kilometrage ? vehicle.kilometrage.toLocaleString('fr-FR') : 'N/A'}</div><div class="text-sm text-gray-600">Km</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.carburant || 'N/A'}</div><div class="text-sm text-gray-600">Carburant</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.boiteVitesse || 'N/A'}</div><div class="text-sm text-gray-600">Boîte</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.couleur || 'N/A'}</div><div class="text-sm text-gray-600">Couleur</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.nbPlaces || 'N/A'}</div><div class="text-sm text-gray-600">Places</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.nbPortes || 'N/A'}</div><div class="text-sm text-gray-600">Portes</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.puissanceFiscale || 'N/A'} CV</div><div class="text-sm text-gray-600">Puissance Fisc.</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.puissanceDIN || 'N/A'} ch</div><div class="text-sm text-gray-600">Puissance DIN</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.critAir || 'N/A'}</div><div class="text-sm text-gray-600">Crit'Air</div></div>
                    </div>

                    <h3 class="text-xl font-bold mb-3 border-b pb-2">Description</h3>
                    <p class="text-gray-700 mb-6">${vehicle.description || 'Aucune description.'}</p>

                    <h3 class="text-xl font-bold mb-3 border-b pb-2">Équipements et options</h3>
                    <ul class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 text-gray-700">
                        ${(vehicle.options && vehicle.options.length > 0) ? vehicle.options.map(opt => `<li><i class="fas fa-check-circle text-green-500 mr-2"></i>${opt}</li>`).join('') : '<li>Aucune option spécifiée.</li>'}
                    </ul>

                    <h3 class="text-xl font-bold mb-3 border-b pb-2 mt-6">Entretiens effectués</h3>
                    <ul class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 text-gray-700">
                        ${(vehicle.maintenances && vehicle.maintenances.length > 0) ? vehicle.maintenances.map(maint => `<li><i class="fas fa-wrench text-blue-500 mr-2"></i>${maint}</li>`).join('') : '<li>Aucun entretien spécifié.</li>'}
                    </ul>

                    <div class="mt-8 pt-4 border-t border-gray-200 text-sm text-gray-700 leading-relaxed">
                        <p>Tarif hors carte grise.</p>
                        <p class="mt-2">🧑🏼‍🔧 Garantie moteur et boîte 6 mois (extension de garantie possible).</p>
                        <p class="mt-2">🇫🇷🇫🇷HABILITÉE SERVICE CARTE GRISE 🇫🇷🇫🇷</p>
                        <p>Habilité par le Agence Nationale des Titres Sécurisés.</p>
                        <p>Nous nous occupons de toutes les démarches administratives d'immatriculation !</p>
                        <p class="mt-4 font-semibold">Pour faciliter les démarches administratives pensez a vous munir des pièces suivantes lors de votre visite : </p>
                        <ul class="list-disc list-inside ml-4">
                            <li>🔸Pièce d'identité en cours de validité.</li>
                            <li>🔸Permis de conduire en cours de validité.</li>
                            <li>🔸Justificatif de domicile moins de 3 mois (facture ou avis d'imposition).</li>
                            <li>🔸En cas d'hébergement : une attestation d'hébergement et la copie de la carte d'identité de l'hébergeur.</li>
                        </ul>
                        <p class="mt-4 font-bold text-lg text-center">🟥🟦 CENTRAL CARS 🟥🟦</p>
                        <p class="text-center">📫576 Rue Marcel Sembat</p>
                        <p class="text-center">59690 Vieux-condé</p>
                        <p class="mt-4 font-bold text-center">⏰HORAIRES D'OUVERTURE⏰</p>
                        <p class="text-center">- Du lundi au vendredi : 09H00-12H00 / 14H00-17h30</p>
                        <p class="text-center">- SAMEDI : 9h30 -12h 14h30 - 17H00</p>
                        <p class="mt-4 text-red-600 font-semibold text-center">⚠ Merci de prendre rendez-vous par téléphone avant votre venue afin de mieux pouvoir vous accueillir et de vous assurez de la disponibilité du véhicule ⚠</p>
                        <p class="mt-4 text-xs text-gray-500 text-center">*sous réserve d’erreurs lors de l’édition des annonce.</p>
                    </div>

                     <div class="mt-8 text-center">
                        <button id="contact-us-button" class="bg-red-600 text-white font-bold py-3 px-8 rounded-full hover:bg-red-700 transition duration-300">Ce véhicule m'intéresse</button>
                    </div>
                </div>
            `;
            
            document.body.classList.add('modal-open');
            vehicleModal.classList.remove('hidden');
            setTimeout(() => {
                vehicleModalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);

            const modalImage = document.getElementById('modal-image');
            const prevBtn = document.getElementById('modal-image-prev');
            const nextBtn = document.getElementById('modal-image-next');

            function updateImage() {
                modalImage.src = images[currentImageIndex];
            }

            if (images.length > 1) {
                prevBtn.addEventListener('click', () => {
                    currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
                    updateImage();
                });

                nextBtn.addEventListener('click', () => {
                    currentImageIndex = (currentImageIndex + 1) % images.length;
                    updateImage();
                });
            }

            document.getElementById('close-vehicle-modal-button').addEventListener('click', closeVehicleModal);
            
            document.getElementById('contact-us-button').addEventListener('click', () => {
                closeVehicleModal(); 
                openVehicleContactModal(); 
            });
        }

        function closeVehicleModal() {
            vehicleModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                vehicleModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            }, 300);
        }

        vehicleModal.addEventListener('click', (event) => {
            if (event.target === vehicleModal) {
                closeVehicleModal();
            }
        });
        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && !vehicleModal.classList.contains('hidden')) {
                closeVehicleModal();
            }
        });

        document.getElementById('vehicle-list').addEventListener('click', (event) => {
            const detailsButton = event.target.closest('.details-button');
            if (detailsButton) {
                const vehicleId = detailsButton.dataset.id;
                const vehicle = allVehicles.find(v => v.id === vehicleId); 
                if (vehicle) {
                    openVehicleModal(vehicle);
                }
            }
        });
        
        // --- CHARGEMENT DES DONNÉES DEPUIS FIRESTORE ---
        function listenForVehicles() {
            const vehiclesCollection = collection(db, "vehicules");
            const loadingSpinner = document.getElementById('loading-spinner');
            const vehicleList = document.getElementById('vehicle-list');

            onSnapshot(vehiclesCollection, (snapshot) => {
                allVehicles = []; 
                snapshot.forEach((doc) => {
                    allVehicles.push({ id: doc.id, ...doc.data() });
                });
                applyFilters(); 
                loadingSpinner.style.display = 'none';
            }, (error) => {
                console.error("Erreur lors de la récupération des véhicules: ", error);
                loadingSpinner.style.display = 'none';
                vehicleList.innerHTML = `<p class="text-center col-span-full text-red-500">Impossible de charger les véhicules. Vérifiez la console pour plus de détails.</p>`;
            });
        }

        listenForVehicles();

        // --- GESTION DE LA MODALE DE CONTACT DU VÉHICULE ---
        const vehicleContactModal = document.getElementById('vehicle-contact-modal');
        const vehicleContactModalContent = document.getElementById('vehicle-contact-modal-content');
        const closeVehicleContactModalButton = document.getElementById('close-vehicle-contact-modal-button');
        const contactPhoneLink = document.getElementById('contact-phone-link');
        const contactEmailLink = document.getElementById('contact-email-link');

        function openVehicleContactModal() {
            const contactPhone = '0698979463';
            const contactEmail = 'contact@centralcars.fr';
            contactPhoneLink.href = `tel:${contactPhone}`;
            contactPhoneLink.innerHTML = `<i class="fas fa-phone mr-3"></i> Appeler (${contactPhone.replace(/(\d{2})(?=\d)/g, '$1 ').trim()})`;
            contactEmailLink.href = `mailto:${contactEmail}`;

            document.body.classList.add('modal-open');
            vehicleContactModal.classList.remove('hidden');
            setTimeout(() => {
                vehicleContactModalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeVehicleContactModal() {
            vehicleContactModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                vehicleContactModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            }, 300);
        }

        closeVehicleContactModalButton.addEventListener('click', closeVehicleContactModal);
        vehicleContactModal.addEventListener('click', (event) => {
            if (event.target === vehicleContactModal) {
                closeVehicleContactModal();
            }
        });
        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && !vehicleContactModal.classList.contains('hidden')) {
                closeVehicleContactModal();
            }
        });


        // --- GESTION DE LA MODALE DE CONNEXION/INSCRIPTION ---
        const authModal = document.getElementById('auth-modal');
        const authModalContent = document.getElementById('auth-modal-content');
        const closeAuthModalButton = document.getElementById('close-auth-modal-button');
        const loginSignupButtonDesktop = document.getElementById('login-signup-button-desktop');
        const loginSignupButtonMobile = document.getElementById('login-signup-button-mobile');
        const authModalTitle = document.getElementById('auth-modal-title');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const toggleAuthModeButton = document.getElementById('toggle-auth-mode');

        function openAuthModal() {
            document.body.classList.add('modal-open');
            authModal.classList.remove('hidden');
            setTimeout(() => {
                authModalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeAuthModal() {
            authModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                authModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            }, 300);
        }

        loginSignupButtonDesktop.addEventListener('click', openAuthModal);
        loginSignupButtonMobile.addEventListener('click', openAuthModal);
        closeAuthModalButton.addEventListener('click', closeAuthModal);

        authModal.addEventListener('click', (event) => {
            if (event.target === authModal) {
                closeAuthModal();
            }
        });

        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && !authModal.classList.contains('hidden')) {
                closeAuthModal();
            }
        });

        toggleAuthModeButton.addEventListener('click', () => {
            if (loginForm.classList.contains('hidden')) {
                authModalTitle.textContent = 'Connexion';
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
                toggleAuthModeButton.textContent = 'Pas encore de compte ? S\'inscrire';
            } else {
                authModalTitle.textContent = 'Inscription';
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                toggleAuthModeButton.textContent = 'Déjà un compte ? Se connecter';
            }
        });

        // --- GESTION DE L'AUTHENTIFICATION FIREBASE ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                closeAuthModal();
                console.log("Connexion réussie !");
            } catch (error) {
                console.error("Erreur de connexion:", error.message);
                const errorMessage = error.message.includes('auth/invalid-email') ? 'Adresse email invalide.' :
                                     error.message.includes('auth/user-not-found') ? 'Aucun utilisateur trouvé avec cet email.' :
                                     error.message.includes('auth/wrong-password') ? 'Mot de passe incorrect.' :
                                     'Erreur de connexion. Veuillez réessayer.';
                showCustomAlert(errorMessage);
            }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = signupForm['signup-email'].value;
            const password = signupForm['signup-password'].value;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await setDoc(doc(db, `artifacts/${__app_id}/users/${user.uid}/profile`, 'user_data'), {
                    email: user.email,
                    role: 'client' 
                });
                closeAuthModal();
                console.log("Inscription réussie !");
            } catch (error) {
                console.error("Erreur d'inscription:", error.message);
                const errorMessage = error.message.includes('auth/email-already-in-use') ? 'Cet email est déjà utilisé.' :
                                     error.message.includes('auth/weak-password') ? 'Le mot de passe doit contenir au moins 6 caractères.' :
                                     'Erreur d\'inscription. Veuillez réessayer.';
                showCustomAlert(errorMessage);
            }
        });

        // --- GESTION DU MENU DU COMPTE UTILISATEUR ET DU RÔLE ---
        const authenticatedUserMenuToggleDesktop = document.getElementById('authenticated-user-menu-toggle-desktop');
        const authenticatedUserMenuToggleMobile = document.getElementById('authenticated-user-menu-toggle-mobile');
        const accountMenuDesktop = document.getElementById('account-menu-desktop');
        const accountMenuMobile = document.getElementById('account-menu-mobile');
        const logoutButtonDesktop = document.getElementById('logout-button-desktop');
        const logoutButtonMobile = document.getElementById('logout-button-mobile');
        const userEmailDisplayDesktop = document.getElementById('user-email-display-desktop');
        const userEmailDisplayMobile = document.getElementById('user-email-display-mobile');
        const adminGererBoutiqueDesktop = document.getElementById('admin-gerer-boutique-desktop');
        const adminGererBoutiqueMobile = document.getElementById('admin-gerer-boutique-mobile');
        const adminGenererAnnonceDesktop = document.getElementById('admin-generer-annonce-desktop');
        const adminGenererAnnonceMobile = document.getElementById('admin-generer-annonce-mobile');
        const adminAccesAntsDesktop = document.getElementById('admin-acces-ants-desktop');
        const adminAccesAntsMobile = document.getElementById('admin-acces-ants-mobile');
        const adminDossiersAntsDesktop = document.getElementById('admin-dossiers-ants-desktop');
        const adminDossiersAntsMobile = document.getElementById('admin-dossiers-ants-mobile');
        const adminRapportReparationDesktop = document.getElementById('admin-rapport-reparation-desktop');
        const adminRapportReparationMobile = document.getElementById('admin-rapport-reparation-mobile');


        function toggleAccountMenu(menuElement) {
            menuElement.classList.toggle('hidden');
        }

        authenticatedUserMenuToggleDesktop.addEventListener('click', (event) => {
            event.stopPropagation(); 
            toggleAccountMenu(accountMenuDesktop);
            accountMenuMobile.classList.add('hidden'); 
        });

        authenticatedUserMenuToggleMobile.addEventListener('click', (event) => {
            event.stopPropagation(); 
            toggleAccountMenu(accountMenuMobile);
            accountMenuDesktop.classList.add('hidden'); 
        });

        document.addEventListener('click', (event) => {
            if (!accountMenuDesktop.contains(event.target) && !authenticatedUserMenuToggleDesktop.contains(event.target)) {
                accountMenuDesktop.classList.add('hidden');
            }
            if (!accountMenuMobile.contains(event.target) && !authenticatedUserMenuToggleMobile.contains(event.target)) {
                accountMenuMobile.classList.add('hidden');
            }
        });

        [logoutButtonDesktop, logoutButtonMobile].forEach(button => {
            button.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    console.log("Déconnexion réussie !");
                    accountMenuDesktop.classList.add('hidden');
                    accountMenuMobile.classList.add('hidden');
                    showCustomAlert("Vous avez été déconnecté.");
                } catch (error) {
                    console.error("Erreur de déconnexion:", error.message);
                    showCustomAlert("Erreur lors de la déconnexion. Veuillez réessayer.");
                }
            });
        });

        onAuthStateChanged(auth, async (user) => { 
            if (user) {
                console.log("Utilisateur connecté:", user.email);
                
                const userRef = doc(db, `artifacts/${__app_id}/users/${user.uid}/profile`, 'user_data');
                let userRole = 'client'; 

                try {
                    const userDoc = await getDoc(userRef);
                    if (userDoc.exists()) {
                        userRole = userDoc.data().role || 'client';
                    } else {
                        await setDoc(userRef, { email: user.email, role: 'client' });
                        userRole = 'client';
                    }
                } catch (error) {
                    console.error("Erreur lors de la récupération/création du rôle utilisateur:", error);
                }

                window.currentUserRole = userRole; 

                loginSignupButtonDesktop.classList.add('hidden');
                loginSignupButtonMobile.classList.add('hidden');
                authenticatedUserMenuToggleDesktop.classList.remove('hidden');
                authenticatedUserMenuToggleMobile.classList.remove('hidden');
                userEmailDisplayDesktop.textContent = user.email;
                userEmailDisplayMobile.textContent = user.email;

                const adminButtonsDesktop = [adminGererBoutiqueDesktop, adminGenererAnnonceDesktop, adminAccesAntsDesktop, adminDossiersAntsDesktop, adminRapportReparationDesktop];
                const adminButtonsMobile = [adminGererBoutiqueMobile, adminGenererAnnonceMobile, adminAccesAntsMobile, adminDossiersAntsMobile, adminRapportReparationMobile];
                
                if (userRole === 'admin') {
                    adminButtonsDesktop.forEach(btn => btn.classList.remove('hidden'));
                    adminButtonsMobile.forEach(btn => btn.classList.remove('hidden'));
                } else {
                    adminButtonsDesktop.forEach(btn => btn.classList.add('hidden'));
                    adminButtonsMobile.forEach(btn => btn.classList.add('hidden'));
                }

            } else {
                console.log("Aucun utilisateur connecté.");
                loginSignupButtonDesktop.classList.remove('hidden');
                loginSignupButtonMobile.classList.remove('hidden');
                authenticatedUserMenuToggleDesktop.classList.add('hidden');
                authenticatedUserMenuToggleMobile.classList.add('hidden');
                accountMenuDesktop.classList.add('hidden'); 
                accountMenuMobile.classList.add('hidden'); 
                
                const allAdminButtons = [
                    adminGererBoutiqueDesktop, adminGererBoutiqueMobile,
                    adminGenererAnnonceDesktop, adminGenererAnnonceMobile,
                    adminAccesAntsDesktop, adminAccesAntsMobile,
                    adminDossiersAntsDesktop, adminDossiersAntsMobile,
                    adminRapportReparationDesktop, adminRapportReparationMobile
                ];
                allAdminButtons.forEach(btn => btn.classList.add('hidden'));

                window.currentUserRole = null; 
                hideAdminPanel();
                closeAntsDossiersModal(); // Fermer la modale si l'utilisateur se déconnecte
            }
        });

        // --- CUSTOM ALERT & CONFIRM MODALS ---
        function showCustomAlert(message) {
            document.getElementById('custom-alert-message').textContent = message;
            const customAlert = document.getElementById('custom-alert');
            customAlert.classList.remove('hidden');
            document.getElementById('custom-alert-close').onclick = () => customAlert.classList.add('hidden');
        }

        function showCustomConfirm(message, onConfirm) {
            document.getElementById('custom-confirm-message').textContent = message;
            const customConfirm = document.getElementById('custom-confirm');
            customConfirm.classList.remove('hidden');
            document.getElementById('custom-confirm-ok').onclick = () => {
                customConfirm.classList.add('hidden');
                onConfirm(true);
            };
            document.getElementById('custom-confirm-cancel').onclick = () => {
                customConfirm.classList.add('hidden');
                onConfirm(false);
            };
        }

        // --- GESTION DU PANNEAU D'ADMINISTRATION ---
        const adminPanel = document.getElementById('admin-panel');
        const mainContentSections = document.getElementById('main-content-sections');
        const vehicleForm = document.getElementById('vehicle-form');
        const vehicleIdInput = document.getElementById('vehicle-id');
        const vehicleTitreAnnonceInput = document.getElementById('vehicle-titre-annonce');
        const vehicleMarqueSelect = document.getElementById('vehicle-marque');
        const vehicleModeleSelect = document.getElementById('vehicle-modele');
        const vehicleAnneeModeleInput = document.getElementById('vehicle-annee-modele');
        const vehicleDateCirculationInput = document.getElementById('vehicle-date-circulation');
        const vehicleKilometrageInput = document.getElementById('vehicle-kilometrage');
        const vehicleCarburantSelect = document.getElementById('vehicle-carburant');
        const vehicleBoiteVitesseSelect = document.getElementById('vehicle-boite-vitesse');
        const vehicleCouleurInput = document.getElementById('vehicle-couleur');
        const vehicleNbPlacesInput = document.getElementById('vehicle-nb-places');
        const vehicleNbPortesInput = document.getElementById('vehicle-nb-portes');
        const vehiclePuissanceFiscaleInput = document.getElementById('vehicle-puissance-fiscale');
        const vehiclePuissanceDINInput = document.getElementById('vehicle-puissance-din');
        const vehicleCritAirSelect = document.getElementById('vehicle-critair');
        const vehiclePrixInput = document.getElementById('vehicle-prix');
        const vehicleDescriptionInput = document.getElementById('vehicle-description');
        const vehicleImageUploadInput = document.getElementById('vehicle-image-upload');
        const imageUploadPreview = document.getElementById('image-upload-preview');
        const imageUploadSpinner = document.getElementById('image-upload-spinner');
        const vehicleImagesUrlsInput = document.getElementById('vehicle-images-urls');
        const vehicleOptionsCheckboxesDiv = document.getElementById('vehicle-options-checkboxes');
        const vehicleMaintenancesCheckboxesDiv = document.getElementById('vehicle-maintenances-checkboxes');
        const vehicleVenduCheckbox = document.getElementById('vehicle-vendu');
        const vehicleHiddenCheckbox = document.getElementById('vehicle-hidden');

        const submitVehicleButton = document.getElementById('submit-vehicle-button');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const vehicleFormTitle = document.getElementById('vehicle-form-title');
        const adminVehicleList = document.getElementById('admin-vehicle-list');
        const adminLoadingSpinner = document.getElementById('admin-loading-spinner');
        const backToHomeButton = document.getElementById('back-to-home-button');

        // --- Données pour les listes déroulantes et options ---
        const carData = {
            "Renault": ["Clio", "Mégane", "Captur", "Kadjar", "Austral", "Arkana", "Twingo", "Zoe", "Scénic", "Talisman", "Espace", "Koleos", "Kangoo"],
            "Peugeot": ["206", "207", "208", "306", "307", "308", "2008", "3008", "5008", "508", "107", "108", "Rifter", "Partner", "Traveller", "Expert"],
            "Citroën": ["C1", "C2", "C3", "C4", "C5", "C4 Picasso", "Xsara", "Xsara Picasso", "C5 Aircross", "C3 Aircross", "Berlingo", "C4 Cactus", "Jumpy", "Spacetourer"],
            "Volkswagen": ["Golf", "Polo", "Tiguan", "Passat", "T-Roc", "Arteon", "Up!", "ID.3", "ID.4", "ID.5", "ID.Buzz", "Touran", "Touareg", "Caddy"],
            "Audi": ["A1", "A3", "A4", "A5", "A6", "A7", "A8", "Q2", "Q3", "Q4 e-tron", "Q5", "Q7", "Q8", "e-tron", "TT", "R8"],
            "BMW": ["Série 1", "Série 2", "Série 3", "Série 4", "Série 5", "Série 6", "Série 7", "Série 8", "X1", "X2", "X3", "X4", "X5", "X6", "X7", "Z4", "i3", "i4", "iX", "iX3", "i5", "i7"],
            "Mercedes-Benz": ["Classe A", "Classe B", "Classe C", "Classe E", "Classe S", "CLA", "CLS", "GLA", "GLC", "GLE", "GLS", "EQA", "EQB", "EQC", "EQE", "EQS", "AMG GT", "Citan", "Vito", "Sprinter"],
            "Ford": ["Fiesta", "Focus", "Puma", "Kuga", "Mustang Mach-E", "Explorer", "Edge", "Mondeo", "Galaxy", "S-Max", "Ranger", "Transit Custom", "Tourneo Custom"],
            "Toyota": ["Yaris", "Corolla", "C-HR", "RAV4", "Aygo", "Mirai", "Camry", "Prius", "Highlander", "Land Cruiser", "Hilux", "Proace"],
            "Nissan": ["Qashqai", "Note", "Juke", "X-Trail", "Micra", "Leaf", "Ariya", "Navara", "Townstar"],
            "Hyundai": ["i10", "i20", "i30", "Kona", "Tucson", "Santa Fe", "Bayon", "Ioniq 5", "Ioniq 6", "Nexo"],
            "Kia": ["Picanto", "Rio", "Ceed", "Sportage", "Niro", "EV6", "Stonic", "Xceed", "Sorento", "Soul EV"],
            "Opel": ["Corsa", "Astra", "Mokka", "Grandland", "Crossland", "Combo Life", "Zafira", "Meriva", "Vivaro"],
            "Skoda": ["Fabia", "Octavia", "Superb", "Kamiq", "Karoq", "Kodiaq", "Enyaq iV", "Scala"],
            "Seat": ["Ibiza", "Leon", "Ateca", "Arona", "Tarraco", "Toledo", "Alhambra"],
            "Fiat": ["500", "Panda", "Tipo", "500X", "500e", "Ducato", "Talento"],
            "Volvo": ["S60", "V60", "S90", "V90", "XC40", "XC60", "XC90", "C40 Recharge", "EX30", "EX90"],
            "Tesla": ["Model 3", "Model Y", "Model S", "Model X", "Cybertruck"],
            "Dacia": ["Sandero", "Duster", "Spring", "Jogger", "Lodgy", "Logan"],
            "Mazda": ["Mazda2", "Mazda3", "Mazda6", "CX-30", "CX-5", "CX-60", "CX-80", "MX-30", "MX-5"],
            "Honda": ["Civic", "CR-V", "Jazz", "HR-V", "e", "ZR-V"],
            "Suzuki": ["Alto","Swift", "Vitara", "Ignis", "S-Cross", "Jimny", "Across"],
            "Jeep": ["Renegade", "Compass", "Wrangler", "Grand Cherokee", "Avenger"],
            "Land Rover": ["Range Rover Evoque", "Discovery Sport", "Defender", "Range Rover Sport", "Discovery", "Range Rover"],
            "Porsche": ["911", "Cayenne", "Macan", "Panamera", "Taycan", "718 Boxster", "718 Cayman"],
            "Alfa Romeo": ["Mito", "Guilietta", "Giulia", "Stelvio", "Tonale"],
            "Lexus": ["IS", "ES", "LS", "RC", "LC", "UX", "NX", "RX", "RZ"],
            "Mini": ["Copper", "Copper S", "Countryman", "Clubman", "Cabrio", "Aceman"],
            "Cupra": ["Formentor", "Born", "Leon", "Ateca", "Tavascan"],
            "Polestar": ["Polestar 2", "Polestar 3", "Polestar 4"],
            "MG": ["ZS EV", "MG4 EV", "HS", "MG5 EV", "Cyberster"]
        };

        const carburants = ["Essence", "Diesel", "Électrique", "Hybride", "Hybride Rechargeable", "GPL", "E85"];
        const boiteVitesse = ["Manuelle", "Automatique"];
        const critAirOptions = ["0 (Vert)", "1", "2", "3", "4", "5", "Non classé"];

        const vehicleOptionsData = {
            "Sécurité": ["ABS", "ESP", "Airbags frontaux", "Airbags latéraux", "Airbags rideaux", "Aide au freinage d'urgence", "Contrôle de la pression des pneus", "Fixations ISOFIX", "Détecteur d'angle mort", "Alerte de franchissement de ligne", "Régulateur de vitesse adaptatif", "Caméra de recul", "Radars de stationnement avant", "Radars de stationnement arrière", "Phares LED", "Feux de jour LED", "Système de surveillance de la vigilance du conducteur", "Freinage automatique d'urgence"],
            "Intérieur": ["Climatisation manuelle", "Climatisation automatique bi-zone", "Sièges chauffants", "Sièges en cuir", "Volant multifonction", "Volant chauffant", "Accoudoir central", "Vitres électriques avant", "Vitres électriques arrière", "Rétroviseurs électriques", "Écran tactile", "GPS", "Bluetooth", "Apple CarPlay", "Android Auto", "Prise USB", "Prise 12V", "Toit ouvrant panoramique", "Instrumentation numérique", "Éclairage d'ambiance", "Sellerie tissu", "Sellerie semi-cuir", "Sièges sport"],
            "Extérieur": ["Jantes alliage", "Peinture métallisée", "Phares antibrouillard", "Barres de toit", "Attelage", "Vitres teintées", "Rétroviseurs rabattables électriquement", "Capteur de pluie", "Capteur de luminosité", "Hayon électrique", "Phares Xénon", "Toit ouvrant", "Becquet arrière", "Échappement sport"],
            "Confort": ["Démarrage sans clé", "Accès mains libres", "Aide au démarrage en côte", "Frein de parking électrique", "Direction assistée", "Verrouillage centralisé à distance", "Régulateur de vitesse", "Limiteur de vitesse", "Aide au stationnement", "Sièges réglables en hauteur"],
            "Autres": ["Carnet d'entretien", "Double des clés", "Non-fumeur", "Garantie constructeur", "Roue de secours", "Kit de réparation pneus", "Pack sport", "Suspension sport"]
        };

        const vehicleMaintenanceData = ["Kit distribution + pompe à eau", "Vidange moteur + filtre à huile", "Disques et plaquettes de frein", "Pneumatiques", "Contrôle technique OK", "Révision complète", "Climatisation rechargée", "Amortisseurs avant", "Amortisseurs arrière", "Batterie neuve", "Bougies d'allumage", "Filtre à air", "Filtre à carburant", "Filtre d'habitacle", "Embrayage"];

        const CLOUDINARY_CLOUD_NAME = 'dxneu57c0';
        const CLOUDINARY_UPLOAD_PRESET = 'central_cars_unsigned_upload';
        const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;


        // --- Fonctions d'initialisation des listes déroulantes et options ---
        function populateMarques(selectElement, includeAllOption = false, data = carData) {
            selectElement.innerHTML = includeAllOption ? '<option value="">Toutes les marques</option>' : '<option value="">Sélectionner une marque</option>';
            for (const marque in data) {
                const option = document.createElement('option');
                option.value = marque;
                option.textContent = marque;
                selectElement.appendChild(option);
            }
        }

        function populateModeles(selectElement, selectedMarque, includeAllOption = false, data = carData) {
            selectElement.innerHTML = includeAllOption ? '<option value="">Tous les modèles</option>' : '<option value="">Sélectionner un modèle</option>';
            if (selectedMarque && data[selectedMarque]) {
                data[selectedMarque].forEach(modele => {
                    const option = document.createElement('option');
                    option.value = modele;
                    option.textContent = modele;
                    selectElement.appendChild(option);
                });
            }
        }

        function populateGenericDropdown(selectElement, data, placeholder, includeAllOption = false) {
             selectElement.innerHTML = includeAllOption ? `<option value="">${placeholder}</option>` : `<option value="">${placeholder}</option>`;
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                selectElement.appendChild(option);
            });
        }

        function generateCheckboxes(container, data, namePrefix) {
            container.innerHTML = '';
            if (typeof data === 'object' && !Array.isArray(data)) { // Grouped data (like options)
                 for (const category in data) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'col-span-1';
                    categoryDiv.innerHTML = `<h5 class="font-semibold text-gray-700 mb-2">${category}</h5>`;
                    
                    data[category].forEach(optionText => {
                        const checkboxId = `${namePrefix}-${optionText.replace(/\s+/g, '-').toLowerCase()}`;
                        const checkboxDiv = document.createElement('div');
                        checkboxDiv.className = 'flex items-center mb-1';
                        checkboxDiv.innerHTML = `
                            <input type="checkbox" id="${checkboxId}" name="vehicle-${namePrefix}" value="${optionText}" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                            <label for="${checkboxId}" class="ml-2 text-gray-700 text-sm">${optionText}</label>
                        `;
                        categoryDiv.appendChild(checkboxDiv);
                    });
                    container.appendChild(categoryDiv);
                }
            } else { // Simple array data (like maintenance)
                data.forEach(itemText => {
                    const checkboxId = `${namePrefix}-${itemText.replace(/\s+/g, '-').replace(/[^\w-]/g, '').toLowerCase()}`;
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'flex items-center mb-1';
                    checkboxDiv.innerHTML = `
                        <input type="checkbox" id="${checkboxId}" name="vehicle-${namePrefix}" value="${itemText}" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="${checkboxId}" class="ml-2 text-gray-700 text-sm">${itemText}</label>
                    `;
                    container.appendChild(checkboxDiv);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Admin vehicle form
            populateMarques(vehicleMarqueSelect);
            populateGenericDropdown(vehicleCarburantSelect, carburants, 'Sélectionner un type de carburant');
            populateGenericDropdown(vehicleBoiteVitesseSelect, boiteVitesse, 'Sélectionner un type de boîte');
            populateGenericDropdown(vehicleCritAirSelect, critAirOptions, 'Sélectionner une vignette');
            generateCheckboxes(vehicleOptionsCheckboxesDiv, vehicleOptionsData, 'option');
            generateCheckboxes(vehicleMaintenancesCheckboxesDiv, vehicleMaintenanceData, 'maintenance');

            // Client filters
            populateMarques(filterMarqueSelect, true);
            populateGenericDropdown(filterCarburantSelect, carburants, 'Tous les carburants', true);
            populateGenericDropdown(filterBoiteVitesseSelect, boiteVitesse, 'Toutes les boîtes', true);
            
            // ANTS Dossier Form
            populateProfessionnels();
            populateMarques(document.getElementById('dossier-marque-vehicule'));

            // PDF Tool
            generateRepairsCheckboxes();
            renderManualRepairs();
        });

        vehicleMarqueSelect.addEventListener('change', (e) => populateModeles(vehicleModeleSelect, e.target.value));
        filterMarqueSelect.addEventListener('change', (e) => {
            populateModeles(filterModeleSelect, e.target.value, true);
            applyFilters();
        });
        document.getElementById('dossier-marque-vehicule').addEventListener('change', (e) => populateModeles(document.getElementById('dossier-modele-vehicule'), e.target.value));


        // --- Fonctions d'upload d'images Cloudinary et Drag & Drop ---
        let uploadedImageUrls = []; 
        let draggedItem = null; 

        function renderImagePreviews() {
            imageUploadPreview.innerHTML = '';
            uploadedImageUrls.forEach((url, index) => {
                const imgDiv = document.createElement('div');
                imgDiv.className = 'image-preview-item relative group cursor-grab border-2 border-transparent rounded-lg overflow-hidden';
                imgDiv.draggable = true;
                imgDiv.dataset.url = url;
                imgDiv.dataset.index = index;

                imgDiv.innerHTML = `
                    <img src="${url}" class="w-full h-24 object-cover rounded-lg shadow-md">
                    <button type="button" data-url="${url}" class="remove-image-button absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity">&times;</button>
                `;
                imageUploadPreview.appendChild(imgDiv);
            });
            vehicleImagesUrlsInput.value = uploadedImageUrls.join(',');
        }

        vehicleImageUploadInput.addEventListener('change', async (event) => {
            const files = event.target.files;
            if (files.length === 0) return;

            imageUploadSpinner.classList.remove('hidden');
            
            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

                try {
                    const response = await fetch(CLOUDINARY_UPLOAD_URL, { method: 'POST', body: formData });
                    const data = await response.json();
                    if (data.secure_url) {
                        uploadedImageUrls.push(data.secure_url);
                    } else {
                        showCustomAlert(`Erreur lors du téléchargement de l'image ${file.name}.`);
                    }
                } catch (error) {
                    showCustomAlert(`Erreur réseau lors du téléchargement de l'image ${file.name}.`);
                }
            }
            renderImagePreviews();
            imageUploadSpinner.classList.add('hidden');
        });

        imageUploadPreview.addEventListener('click', (event) => {
            if (event.target.closest('.remove-image-button')) {
                const imageUrlToRemove = event.target.closest('.remove-image-button').dataset.url;
                uploadedImageUrls = uploadedImageUrls.filter(url => url !== imageUrlToRemove);
                renderImagePreviews();
            }
        });

        imageUploadPreview.addEventListener('dragstart', (e) => {
            draggedItem = e.target.closest('.image-preview-item');
            if (draggedItem) {
                e.dataTransfer.setData('text/plain', draggedItem.dataset.url);
                setTimeout(() => draggedItem.classList.add('dragging'), 0);
            }
        });
        imageUploadPreview.addEventListener('dragover', (e) => {
            e.preventDefault();
            const targetItem = e.target.closest('.image-preview-item');
            if (targetItem && targetItem !== draggedItem) {
                targetItem.classList.add('drag-over');
            }
        });
        imageUploadPreview.addEventListener('dragleave', (e) => {
            e.target.closest('.image-preview-item')?.classList.remove('drag-over');
        });
        imageUploadPreview.addEventListener('drop', (e) => {
            e.preventDefault();
            const targetItem = e.target.closest('.image-preview-item');
            if (draggedItem && targetItem && draggedItem !== targetItem) {
                const draggedIndex = uploadedImageUrls.indexOf(draggedItem.dataset.url);
                const targetIndex = uploadedImageUrls.indexOf(targetItem.dataset.url);
                if (draggedIndex > -1 && targetIndex > -1) {
                    const [removed] = uploadedImageUrls.splice(draggedIndex, 1);
                    uploadedImageUrls.splice(targetIndex, 0, removed);
                    renderImagePreviews();
                }
            }
            targetItem?.classList.remove('drag-over');
            draggedItem?.classList.remove('dragging');
        });
        imageUploadPreview.addEventListener('dragend', () => {
            draggedItem?.classList.remove('dragging');
            document.querySelectorAll('.image-preview-item.drag-over').forEach(item => item.classList.remove('drag-over'));
            draggedItem = null;
        });


        // Fonction pour afficher les véhicules dans le panneau d'administration
        function displayAdminVehicles(vehicles) {
            adminVehicleList.innerHTML = '';
            if (vehicles.length === 0) {
                adminVehicleList.innerHTML = `<p class="text-center col-span-full">Aucun véhicule à gérer pour le moment.</p>`;
            } else {
                vehicles.forEach(vehicle => {
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow-lg overflow-hidden relative';
                    const imageUrl = vehicle.images && vehicle.images.length > 0 ? vehicle.images[0] : 'https://placehold.co/600x400/cccccc/ffffff?text=Image+Indisponible';
                    
                    const soldBadge = vehicle.vendu ? `<span class="absolute top-2 left-2 bg-red-600 text-white text-xs font-bold px-3 py-1 rounded-full z-10">VENDU</span>` : '';

                    card.innerHTML = `
                        ${soldBadge}
                        <img src="${imageUrl}" alt="Image de ${vehicle.titreAnnonce || vehicle.nom}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/ffffff?text=Image+Invalide';">
                        <div class="p-4">
                            <h4 class="text-xl font-bold mb-2">${vehicle.titreAnnonce || vehicle.nom || 'N/A'}</h4>
                            <p class="text-gray-600 text-sm mb-2">${vehicle.marque || 'N/A'} - ${vehicle.modele || 'N/A'}</p>
                            <p class="text-2xl font-bold text-red-600 mb-4">${vehicle.prix ? vehicle.prix.toLocaleString('fr-FR') : 'N/A'} €</p>
                            <div class="flex items-center mb-4">
                                <input type="checkbox" id="admin-hide-${vehicle.id}" data-id="${vehicle.id}" class="admin-hide-checkbox h-4 w-4 text-gray-600 focus:ring-gray-500 border-gray-300 rounded" ${vehicle.hidden ? 'checked' : ''}>
                                <label for="admin-hide-${vehicle.id}" class="ml-2 block text-gray-700 text-sm">Cacher l'annonce</label>
                            </div>
                            <div class="flex space-x-2">
                                <button data-id="${vehicle.id}" class="edit-vehicle-button flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">Modifier</button>
                                <button data-id="${vehicle.id}" class="delete-vehicle-button flex-1 bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">Supprimer</button>
                            </div>
                        </div>
                    `;
                    adminVehicleList.appendChild(card);
                });

                document.querySelectorAll('.admin-hide-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', async (event) => {
                        const vehicleId = event.target.dataset.id;
                        const isHidden = event.target.checked;
                        try {
                            await updateDoc(doc(db, "vehicules", vehicleId), { hidden: isHidden });
                            showCustomAlert(`Annonce ${isHidden ? 'cachée' : 'affichée'} avec succès !`);
                        } catch (error) {
                            showCustomAlert("Erreur lors de la mise à jour de la visibilité de l'annonce.");
                        }
                    });
                });
            }
            adminLoadingSpinner.style.display = 'none';
        }

        // --- GESTION DU PANNEAU D'ADMINISTRATION ---
        function showAdminPanel() {
            mainContentSections.classList.add('hidden');
            adminPanel.classList.remove('hidden');
            closeAllModals();
            listenForAdminVehicles();
            resetVehicleForm();
        }

        function hideAdminPanel() {
            adminPanel.classList.add('hidden');
            mainContentSections.classList.remove('hidden');
        }
        
        function closeAllModals() {
            closeVehicleModal();
            closeAuthModal();
            closeVehicleContactModal();
            closePdfToolModal();
            closeAntsDossiersModal();
            closeDossierSummaryModal(); // Ajouté
        }

        adminGererBoutiqueDesktop.addEventListener('click', (e) => {
            e.preventDefault();
            if (window.currentUserRole === 'admin') {
                showAdminPanel();
                accountMenuDesktop.classList.add('hidden');
            } else {
                showCustomAlert("Vous n'avez pas les permissions pour accéder à cette section.");
            }
        });
        adminGererBoutiqueMobile.addEventListener('click', (e) => {
            e.preventDefault();
            if (window.currentUserRole === 'admin') {
                showAdminPanel();
                accountMenuMobile.classList.add('hidden');
            } else {
                showCustomAlert("Vous n'avez pas les permissions pour accéder à cette section.");
            }
        });

        [adminGenererAnnonceDesktop, adminGenererAnnonceMobile].forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                if (window.currentUserRole === 'admin') {
                    window.location.href = 'annonce.html';
                } else {
                    showCustomAlert("Vous n'avez pas les permissions pour accéder à cet outil.");
                }
            });
        });

        [adminAccesAntsDesktop, adminAccesAntsMobile].forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                if (window.currentUserRole === 'admin') {
                    window.location.href = 'tools.html';
                } else {
                    showCustomAlert("Vous n'avez pas les permissions pour accéder à cet outil.");
                }
            });
        });

        [adminRapportReparationDesktop, adminRapportReparationMobile].forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                if (window.currentUserRole === 'admin') {
                    openPdfToolModal();
                    accountMenuDesktop.classList.add('hidden');
                    accountMenuMobile.classList.add('hidden');
                } else {
                    showCustomAlert("Vous n'avez pas les permissions pour accéder à cet outil.");
                }
            });
        });
        
        [adminDossiersAntsDesktop, adminDossiersAntsMobile].forEach(btn => {
             btn.addEventListener('click', (e) => {
                e.preventDefault();
                if (window.currentUserRole === 'admin') {
                    openAntsDossiersModal();
                    accountMenuDesktop.classList.add('hidden');
                    accountMenuMobile.classList.add('hidden');
                } else {
                    showCustomAlert("Vous n'avez pas les permissions pour accéder à cet outil.");
                }
            });
        });


        backToHomeButton.addEventListener('click', (e) => {
            e.preventDefault();
            hideAdminPanel();
        });


        function listenForAdminVehicles() {
            const vehiclesCollection = collection(db, "vehicules");
            adminLoadingSpinner.style.display = 'block';
            onSnapshot(vehiclesCollection, (snapshot) => {
                const adminVehicles = [];
                snapshot.forEach((doc) => {
                    adminVehicles.push({ id: doc.id, ...doc.data() });
                });
                displayAdminVehicles(adminVehicles);
            }, (error) => {
                adminLoadingSpinner.style.display = 'none';
                adminVehicleList.innerHTML = `<p class="text-center col-span-full text-red-500">Impossible de charger les véhicules pour la gestion.</p>`;
            });
        }

        vehicleForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const vehicleId = vehicleIdInput.value;
            const selectedOptions = Array.from(document.querySelectorAll('input[name="vehicle-option"]:checked')).map(cb => cb.value);
            const selectedMaintenances = Array.from(document.querySelectorAll('input[name="vehicle-maintenance"]:checked')).map(cb => cb.value);

            const vehicleData = {
                titreAnnonce: vehicleTitreAnnonceInput.value,
                marque: vehicleMarqueSelect.value,
                modele: vehicleModeleSelect.value,
                anneeModele: parseInt(vehicleAnneeModeleInput.value),
                dateCirculation: vehicleDateCirculationInput.value,
                kilometrage: parseInt(vehicleKilometrageInput.value),
                carburant: vehicleCarburantSelect.value,
                boiteVitesse: vehicleBoiteVitesseSelect.value,
                couleur: vehicleCouleurInput.value,
                nbPlaces: parseInt(vehicleNbPlacesInput.value),
                nbPortes: parseInt(vehicleNbPortesInput.value),
                puissanceFiscale: parseInt(vehiclePuissanceFiscaleInput.value),
                puissanceDIN: parseInt(vehiclePuissanceDINInput.value),
                critAir: vehicleCritAirSelect.value,
                prix: parseFloat(vehiclePrixInput.value),
                description: vehicleDescriptionInput.value,
                images: uploadedImageUrls,
                options: selectedOptions,
                maintenances: selectedMaintenances,
                vendu: vehicleVenduCheckbox.checked,
                hidden: vehicleHiddenCheckbox.checked
            };

            try {
                if (vehicleId) {
                    await setDoc(doc(db, "vehicules", vehicleId), vehicleData);
                    showCustomAlert("Véhicule modifié avec succès !");
                } else {
                    await addDoc(collection(db, "vehicules"), vehicleData);
                    showCustomAlert("Véhicule ajouté avec succès !");
                }
                resetVehicleForm();
            } catch (error) {
                showCustomAlert("Erreur lors de l'opération sur le véhicule. Vérifiez les permissions Firebase.");
            }
        });

        function resetVehicleForm() {
            vehicleForm.reset();
            vehicleIdInput.value = '';
            submitVehicleButton.textContent = 'Ajouter le véhicule';
            vehicleFormTitle.textContent = 'Ajouter un nouveau véhicule';
            cancelEditButton.classList.add('hidden');
            imageUploadPreview.innerHTML = '';
            uploadedImageUrls = [];
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            populateModeles(vehicleModeleSelect, '');
        }

        adminVehicleList.addEventListener('click', (event) => {
            const button = event.target.closest('button');
            if (!button) return;

            const id = button.dataset.id;
            if (button.classList.contains('edit-vehicle-button')) {
                const vehicleToEdit = allVehicles.find(v => v.id === id);
                if (vehicleToEdit) {
                    vehicleIdInput.value = vehicleToEdit.id;
                    vehicleTitreAnnonceInput.value = vehicleToEdit.titreAnnonce || '';
                    vehicleMarqueSelect.value = vehicleToEdit.marque || '';
                    populateModeles(vehicleModeleSelect, vehicleToEdit.marque); 
                    vehicleModeleSelect.value = vehicleToEdit.modele || '';
                    vehicleAnneeModeleInput.value = vehicleToEdit.anneeModele || '';
                    vehicleDateCirculationInput.value = vehicleToEdit.dateCirculation || '';
                    vehicleKilometrageInput.value = vehicleToEdit.kilometrage || '';
                    vehicleCarburantSelect.value = vehicleToEdit.carburant || '';
                    vehicleBoiteVitesseSelect.value = vehicleToEdit.boiteVitesse || '';
                    vehicleCouleurInput.value = vehicleToEdit.couleur || '';
                    vehicleNbPlacesInput.value = vehicleToEdit.nbPlaces || '';
                    vehicleNbPortesInput.value = vehicleToEdit.nbPortes || '';
                    vehiclePuissanceFiscaleInput.value = vehicleToEdit.puissanceFiscale || '';
                    vehiclePuissanceDINInput.value = vehicleToEdit.puissanceDIN || '';
                    vehicleCritAirSelect.value = vehicleToEdit.critAir || '';
                    vehiclePrixInput.value = vehicleToEdit.prix || '';
                    vehicleDescriptionInput.value = vehicleToEdit.description || '';
                    
                    uploadedImageUrls = vehicleToEdit.images ? [...vehicleToEdit.images] : [];
                    renderImagePreviews();

                    document.querySelectorAll('input[name="vehicle-option"]').forEach(cb => cb.checked = vehicleToEdit.options?.includes(cb.value));
                    document.querySelectorAll('input[name="vehicle-maintenance"]').forEach(cb => cb.checked = vehicleToEdit.maintenances?.includes(cb.value));
                    
                    vehicleVenduCheckbox.checked = vehicleToEdit.vendu || false;
                    vehicleHiddenCheckbox.checked = vehicleToEdit.hidden || false;

                    submitVehicleButton.textContent = 'Modifier le véhicule';
                    vehicleFormTitle.textContent = 'Modifier le véhicule existant';
                    cancelEditButton.classList.remove('hidden');
                    vehicleForm.scrollIntoView({ behavior: 'smooth' });
                }
            } else if (button.classList.contains('delete-vehicle-button')) {
                 showCustomConfirm("Êtes-vous sûr de vouloir supprimer ce véhicule ?", async (confirmed) => {
                    if (confirmed) {
                        try {
                            await deleteDoc(doc(db, "vehicules", id));
                            showCustomAlert("Véhicule supprimé avec succès !");
                        } catch (error) {
                            showCustomAlert("Erreur lors de la suppression du véhicule.");
                        }
                    }
                });
            }
        });

        cancelEditButton.addEventListener('click', resetVehicleForm);

        // --- LOGIQUE DE FILTRAGE DES VÉHICULES ---
        function applyFilters() {
            let filteredVehicles = [...allVehicles];

            const filters = {
                marque: filterMarqueSelect.value,
                modele: filterModeleSelect.value,
                carburant: filterCarburantSelect.value,
                boiteVitesse: filterBoiteVitesseSelect.value,
                prixMin: parseFloat(filterPrixMinInput.value),
                prixMax: parseFloat(filterPrixMaxInput.value),
                showSold: filterVenduCheckbox.checked
            };

            filteredVehicles = filteredVehicles.filter(v => {
                if (filters.marque && v.marque !== filters.marque) return false;
                if (filters.modele && v.modele !== filters.modele) return false;
                if (filters.carburant && v.carburant !== filters.carburant) return false;
                if (filters.boiteVitesse && v.boiteVitesse !== filters.boiteVitesse) return false;
                if (!isNaN(filters.prixMin) && v.prix < filters.prixMin) return false;
                if (!isNaN(filters.prixMax) && v.prix > filters.prixMax) return false;
                if (!filters.showSold && v.vendu) return false;
                return true;
            });

            displayVehicles(filteredVehicles);
        }

        [filterMarqueSelect, filterModeleSelect, filterCarburantSelect, filterBoiteVitesseSelect, filterPrixMinInput, filterPrixMaxInput, filterVenduCheckbox].forEach(el => {
            el.addEventListener(el.type === 'checkbox' ? 'change' : 'input', applyFilters);
        });

        resetFiltersButton.addEventListener('click', () => {
            filterMarqueSelect.value = '';
            populateModeles(filterModeleSelect, '', true);
            filterCarburantSelect.value = '';
            filterBoiteVitesseSelect.value = '';
            filterPrixMinInput.value = '';
            filterPrixMaxInput.value = '';
            filterVenduCheckbox.checked = false;
            applyFilters();
        });

        // ====================================================================================================
        // GESTION DE LA MODALE PDF
        // ====================================================================================================
        const pdfToolModal = document.getElementById('pdf-tool-modal');
        const pdfToolModalContent = document.getElementById('pdf-tool-modal-content');
        const closePdfToolModalButton = document.getElementById('close-pdf-tool-modal-button');
        const repairReportForm = document.getElementById('repair-report-form');
        const repairsCheckboxesDiv = document.getElementById('repairs-checkboxes');
        const manualRepairInput = document.getElementById('manual-repair-input');
        const addManualRepairButton = document.getElementById('add-manual-repair');
        const manualRepairsList = document.getElementById('manual-repairs-list');
        const generatePdfButton = document.getElementById('generate-pdf-button');
        const predefinedRepairs = ["Kit distribution", "Pompe à eau", "Disques et plaquettes de frein", "Vidange moteur et filtre à huile", "Injecteurs", "Amortisseurs avant", "Amortisseurs arrière", "Pneumatiques (avant)", "Pneumatiques (arrière)", "Embrayage", "Boîte de vitesse", "Turbo", "Joint de culasse", "Batterie", "Alternateur", "Démarreur", "Climatisation rechargée", "Geometrie"];
        let manualRepairs = [];

        function openPdfToolModal() {
            if (window.currentUserRole === 'admin') {
                document.body.classList.add('modal-open');
                pdfToolModal.classList.remove('hidden');
                setTimeout(() => pdfToolModalContent.classList.remove('scale-95', 'opacity-0'), 10);
                resetPdfForm();
            } else {
                showCustomAlert("Accès non autorisé.");
            }
        }
        function closePdfToolModal() {
            pdfToolModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                pdfToolModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            }, 300);
        }
        function resetPdfForm() {
            repairReportForm.reset();
            manualRepairs = [];
            renderManualRepairs();
            repairsCheckboxesDiv.querySelectorAll('input').forEach(cb => cb.checked = false);
        }
        function generateRepairsCheckboxes() {
            repairsCheckboxesDiv.innerHTML = predefinedRepairs.map(repair => {
                const id = `repair-${repair.replace(/\s+/g, '-').toLowerCase()}`;
                return `<div class="flex items-center">
                          <input type="checkbox" id="${id}" name="predefined-repair" value="${repair}" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                          <label for="${id}" class="ml-2 text-gray-700 text-sm">${repair}</label>
                        </div>`;
            }).join('');
        }
        function renderManualRepairs() {
            manualRepairsList.innerHTML = manualRepairs.map((repair, index) => `
                <li class="flex items-center justify-between bg-gray-50 p-2 rounded-md shadow-sm">
                    <span class="text-gray-700">${repair}</span>
                    <button type="button" data-index="${index}" class="remove-manual-repair text-red-600 hover:text-red-800"><i class="fas fa-times-circle"></i></button>
                </li>
            `).join('');
        }
        addManualRepairButton.addEventListener('click', () => {
            const text = manualRepairInput.value.trim();
            if (text && !manualRepairs.includes(text)) {
                manualRepairs.push(text);
                renderManualRepairs();
                manualRepairInput.value = '';
            }
        });
        manualRepairsList.addEventListener('click', (e) => {
            if (e.target.closest('.remove-manual-repair')) {
                manualRepairs.splice(e.target.closest('.remove-manual-repair').dataset.index, 1);
                renderManualRepairs();
            }
        });
        closePdfToolModalButton.addEventListener('click', closePdfToolModal);
        pdfToolModal.addEventListener('click', (e) => e.target === pdfToolModal && closePdfToolModal());
        generatePdfButton.addEventListener('click', (e) => {
            e.preventDefault();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            // ... (logique de génération PDF existante) ...
            showCustomAlert("Génération de PDF non implémentée dans cet exemple.");
        });

        // ====================================================================================================
        // GESTION DES DOSSIERS ANTS
        // ====================================================================================================
        const antsDossiersModal = document.getElementById('ants-dossiers-modal');
        const antsDossiersModalContent = document.getElementById('ants-dossiers-modal-content');
        const closeAntsDossiersModalButton = document.getElementById('close-ants-dossiers-modal-button');
        const antsDossierForm = document.getElementById('ants-dossier-form');
        const dossierFormTitle = document.getElementById('dossier-form-title');
        const dossierIdInput = document.getElementById('dossier-id');
        const dossierProFields = document.getElementById('dossier-pro-fields');
        const dossierProfessionnelSelect = document.getElementById('dossier-professionnel');
        const dossierNomClientInput = document.getElementById('dossier-nom-client');
        const dossierPrenomClientInput = document.getElementById('dossier-prenom-client');
        const dossierMarqueVehiculeSelect = document.getElementById('dossier-marque-vehicule');
        const dossierModeleVehiculeSelect = document.getElementById('dossier-modele-vehicule');
        const dossierVinInput = document.getElementById('dossier-vin');
        const dossierNumFactureInput = document.getElementById('dossier-num-facture');
        const dossierNumQuitusInput = document.getElementById('dossier-num-quitus');
        const dossierNumDemarcheInput = document.getElementById('dossier-num-demarche');
        const dossierCommentaireTextarea = document.getElementById('dossier-commentaire');
        const submitDossierButton = document.getElementById('submit-dossier-button');
        const cancelEditDossierButton = document.getElementById('cancel-edit-dossier-button');
        const antsDossiersListContainer = document.getElementById('ants-dossiers-list-container');
        const antsDossiersLoadingSpinner = document.getElementById('ants-dossiers-loading-spinner');
        const dossierSearchInput = document.getElementById('dossier-search-input');
        const dossierFilterType = document.getElementById('dossier-filter-type');
        const dossierResetFilters = document.getElementById('dossier-reset-filters');
        const toggleDossierFormButton = document.getElementById('toggle-dossier-form-button');
        const dossierFormContainer = document.getElementById('dossier-form-container');
        
        // NOUVEAU : Références pour la modale de récapitulatif
        const dossierSummaryModal = document.getElementById('dossier-summary-modal');
        const dossierSummaryModalContent = document.getElementById('dossier-summary-modal-content');
        const closeDossierSummaryModalButton = document.getElementById('close-dossier-summary-modal-button');

        const professionnels = ["ESPACE AUTO", "MAIN AUTO", "GH AUTO", "BONIFACIO", "AKH", "ACARTOP", "AUTO HORIZON", "CENTRAL CARS"];

        function populateProfessionnels() {
            dossierProfessionnelSelect.innerHTML = '<option value="">Sélectionner un professionnel</option>';
            professionnels.forEach(pro => {
                const option = document.createElement('option');
                option.value = pro;
                option.textContent = pro;
                dossierProfessionnelSelect.appendChild(option);
            });
        }

        function openAntsDossiersModal() {
            document.body.classList.add('modal-open');
            antsDossiersModal.classList.remove('hidden');
            setTimeout(() => antsDossiersModalContent.classList.remove('scale-95', 'opacity-0'), 10);
            
            dossierSearchInput.value = '';
            dossierFilterType.value = '';
            resetDossierForm();
            listenForAntsDossiers();
        }

        function closeAntsDossiersModal() {
            antsDossiersModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                antsDossiersModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            }, 300);
        }

        closeAntsDossiersModalButton.addEventListener('click', closeAntsDossiersModal);
        antsDossiersModal.addEventListener('click', (e) => e.target === antsDossiersModal && closeAntsDossiersModal());

        antsDossierForm['dossier-type'].forEach(radio => {
            radio.addEventListener('change', (e) => {
                dossierProFields.classList.toggle('hidden', e.target.value !== 'Pro');
            });
        });

        function resetDossierForm() {
            antsDossierForm.reset();
            dossierIdInput.value = '';
            dossierFormTitle.textContent = 'Créer un nouveau dossier';
            submitDossierButton.textContent = 'Créer le dossier';
            cancelEditDossierButton.classList.remove('hidden'); // On le montre par défaut dans le formulaire
            dossierProFields.classList.add('hidden');
            populateModeles(dossierModeleVehiculeSelect, '');

            dossierFormContainer.classList.add('hidden');
            toggleDossierFormButton.classList.remove('hidden');
        }

        cancelEditDossierButton.addEventListener('click', resetDossierForm);

        toggleDossierFormButton.addEventListener('click', () => {
            dossierIdInput.value = '';
            antsDossierForm.reset();
            dossierFormTitle.textContent = 'Créer un nouveau dossier';
            submitDossierButton.textContent = 'Créer le dossier';
            cancelEditDossierButton.classList.remove('hidden');
            dossierProFields.classList.add('hidden');
            
            dossierFormContainer.classList.remove('hidden');
            toggleDossierFormButton.classList.add('hidden');
            antsDossierForm.scrollIntoView({ behavior: 'smooth' });
        });

        function listenForAntsDossiers() {
            const dossiersCollection = collection(db, "dossiers_ants");
            antsDossiersLoadingSpinner.style.display = 'block';
            antsDossiersListContainer.innerHTML = '';

            onSnapshot(dossiersCollection, (snapshot) => {
                allAntsDossiers = [];
                snapshot.forEach(doc => allAntsDossiers.push({ id: doc.id, ...doc.data() }));
                
                allAntsDossiers.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));

                applyDossierFilters();
                antsDossiersLoadingSpinner.style.display = 'none';
            }, (error) => {
                console.error("Erreur lors de la récupération des dossiers ANTS:", error);
                antsDossiersLoadingSpinner.style.display = 'none';
                antsDossiersListContainer.innerHTML = '<p class="text-center text-red-500">Erreur de chargement des dossiers.</p>';
            });
        }

        function applyDossierFilters() {
            const searchTerm = dossierSearchInput.value.toLowerCase().trim();
            const filterType = dossierFilterType.value;

            const filteredDossiers = allAntsDossiers.filter(dossier => {
                const typeMatch = !filterType || dossier.typeClient === filterType;

                const searchMatch = !searchTerm ||
                    (dossier.nomClient && dossier.nomClient.toLowerCase().includes(searchTerm)) ||
                    (dossier.prenomClient && dossier.prenomClient.toLowerCase().includes(searchTerm)) ||
                    (dossier.vin && dossier.vin.toLowerCase().includes(searchTerm)) ||
                    (dossier.professionnel && dossier.professionnel.toLowerCase().includes(searchTerm)) ||
                    (dossier.numDemarche && dossier.numDemarche.toLowerCase().includes(searchTerm));

                return typeMatch && searchMatch;
            });

            displayAntsDossiers(filteredDossiers);
        }
        
        function displayAntsDossiers(dossiers) {
            if (dossiers.length === 0) {
                antsDossiersListContainer.innerHTML = '<div class="text-center py-8"><p class="text-gray-500">Aucun dossier ne correspond à vos critères.</p></div>';
                return;
            }

            const table = `
                <table class="min-w-full bg-white border border-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Véhicule</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N° Démarche</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${dossiers.map(dossier => `
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <button data-id='${dossier.id}' class="view-dossier-summary-button text-sm font-medium text-blue-600 hover:text-blue-800 hover:underline text-left">
                                        ${dossier.nomClient} ${dossier.prenomClient}
                                    </button>
                                    <div class="text-sm text-gray-500">${dossier.typeClient}${dossier.typeClient === 'Pro' ? ` (${dossier.professionnel || 'N/A'})` : ''}</div>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${dossier.marqueVehicule} ${dossier.modeleVehicule}</div>
                                    <div class="text-sm text-gray-500">VIN: ...${dossier.vin}</div>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm">
                                    <a href="https://mesdemarches.siv.interieur.gouv.fr/siv-tp/#/reprise/${dossier.numDemarche}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline">
                                        ${dossier.numDemarche}
                                    </a>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${dossier.createdAt ? dossier.createdAt.toDate().toLocaleDateString('fr-FR') : 'N/A'}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                                    <button data-id='${dossier.id}' class="edit-dossier-button text-blue-600 hover:text-blue-900 mr-3">Modifier</button>
                                    <button data-id='${dossier.id}' class="delete-dossier-button text-red-600 hover:text-red-900">Supprimer</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            antsDossiersListContainer.innerHTML = table;
        }
        
        dossierSearchInput.addEventListener('input', applyDossierFilters);
        dossierFilterType.addEventListener('change', applyDossierFilters);
        dossierResetFilters.addEventListener('click', () => {
            dossierSearchInput.value = '';
            dossierFilterType.value = '';
            applyDossierFilters();
        });

        antsDossierForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const dossierId = dossierIdInput.value;
            const typeClient = antsDossierForm['dossier-type'].value;

            const dossierData = {
                typeClient: typeClient,
                professionnel: typeClient === 'Pro' ? dossierProfessionnelSelect.value : '',
                nomClient: dossierNomClientInput.value,
                prenomClient: dossierPrenomClientInput.value,
                marqueVehicule: dossierMarqueVehiculeSelect.value,
                modeleVehicule: dossierModeleVehiculeSelect.value,
                vin: dossierVinInput.value,
                numFacture: dossierNumFactureInput.value,
                numQuitus: typeClient === 'Pro' ? dossierNumQuitusInput.value : '',
                numDemarche: dossierNumDemarcheInput.value,
                commentaire: dossierCommentaireTextarea.value,
                createdAt: new Date()
            };

            try {
                if (dossierId) {
                    await setDoc(doc(db, "dossiers_ants", dossierId), dossierData, { merge: true });
                    showCustomAlert("Dossier modifié avec succès !");
                } else {
                    await addDoc(collection(db, "dossiers_ants"), dossierData);
                    showCustomAlert("Dossier créé avec succès !");
                }
                resetDossierForm();
            } catch (error) {
                console.error("Erreur avec le dossier ANTS:", error);
                showCustomAlert("Erreur lors de l'opération sur le dossier. Vérifiez les permissions.");
            }
        });

        antsDossiersListContainer.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            const dossierId = button.dataset.id;
            
            // NOUVEAU : Gère le clic sur le bouton de récapitulatif
            if (button.classList.contains('view-dossier-summary-button')) {
                const dossierToView = allAntsDossiers.find(d => d.id === dossierId);
                if (dossierToView) {
                    openDossierSummaryModal(dossierToView);
                }
                return;
            }

            const dossierRef = doc(db, "dossiers_ants", dossierId);

            if (button.classList.contains('delete-dossier-button')) {
                showCustomConfirm("Êtes-vous sûr de vouloir supprimer ce dossier ?", async (confirmed) => {
                    if (confirmed) {
                        try {
                            await deleteDoc(dossierRef);
                            showCustomAlert("Dossier supprimé.");
                        } catch (error) {
                            showCustomAlert("Erreur lors de la suppression.");
                        }
                    }
                });
            } else if (button.classList.contains('edit-dossier-button')) {
                const docSnap = await getDoc(dossierRef);
                if (docSnap.exists()) {
                    dossierFormContainer.classList.remove('hidden');
                    toggleDossierFormButton.classList.add('hidden');

                    const data = docSnap.data();
                    dossierIdInput.value = docSnap.id;
                    antsDossierForm['dossier-type'].value = data.typeClient;
                    dossierNomClientInput.value = data.nomClient;
                    dossierPrenomClientInput.value = data.prenomClient;
                    dossierMarqueVehiculeSelect.value = data.marqueVehicule;
                    populateModeles(dossierModeleVehiculeSelect, data.marqueVehicule);
                    dossierModeleVehiculeSelect.value = data.modeleVehicule;
                    dossierVinInput.value = data.vin;
                    dossierNumFactureInput.value = data.numFacture;
                    dossierNumDemarcheInput.value = data.numDemarche;
                    dossierCommentaireTextarea.value = data.commentaire;

                    if (data.typeClient === 'Pro') {
                        dossierProFields.classList.remove('hidden');
                        dossierProfessionnelSelect.value = data.professionnel;
                        dossierNumQuitusInput.value = data.numQuitus;
                    } else {
                        dossierProFields.classList.add('hidden');
                    }

                    dossierFormTitle.textContent = 'Modifier le dossier';
                    submitDossierButton.textContent = 'Modifier le dossier';
                    cancelEditDossierButton.classList.remove('hidden');
                    antsDossierForm.scrollIntoView({ behavior: 'smooth' });
                }
            }
        });

        // NOUVEAU : Fonctions pour la modale de récapitulatif
        function openDossierSummaryModal(dossier) {
            document.getElementById('summary-client-name').textContent = `${dossier.nomClient} ${dossier.prenomClient}`;
            document.getElementById('summary-client-type').textContent = dossier.typeClient;
            document.getElementById('summary-vehicle').textContent = `${dossier.marqueVehicule} ${dossier.modeleVehicule}`;
            document.getElementById('summary-vin').textContent = dossier.vin;
            document.getElementById('summary-num-facture').textContent = dossier.numFacture;
            const demarcheLink = document.getElementById('summary-num-demarche');
            demarcheLink.textContent = dossier.numDemarche;
            demarcheLink.href = `https://mesdemarches.siv.interieur.gouv.fr/siv-tp/#/reprise/${dossier.numDemarche}`;
            document.getElementById('summary-comment').textContent = dossier.commentaire || "Aucun commentaire.";

            const proSection = document.getElementById('summary-pro-section');
            const quitusSection = document.getElementById('summary-quitus-section');
            if (dossier.typeClient === 'Pro') {
                document.getElementById('summary-pro-name').textContent = dossier.professionnel || 'Non spécifié';
                document.getElementById('summary-num-quitus').textContent = dossier.numQuitus || 'Non spécifié';
                proSection.classList.remove('hidden');
                quitusSection.classList.remove('hidden');
            } else {
                proSection.classList.add('hidden');
                quitusSection.classList.add('hidden');
            }

            dossierSummaryModal.classList.remove('hidden');
            setTimeout(() => dossierSummaryModalContent.classList.remove('scale-95', 'opacity-0'), 10);
        }

        function closeDossierSummaryModal() {
            dossierSummaryModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                dossierSummaryModal.classList.add('hidden');
            }, 300);
        }

        closeDossierSummaryModalButton.addEventListener('click', closeDossierSummaryModal);
        dossierSummaryModal.addEventListener('click', (e) => e.target === dossierSummaryModal && closeDossierSummaryModal());
        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && !dossierSummaryModal.classList.contains('hidden')) {
                closeDossierSummaryModal();
            }
        });

    </script>
</body>
</html>
