<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CENTRAL CARS</title>
    <link rel="icon" type="image/png" href="img/logo_a.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- jsPDF pour la génération de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.16/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style pour l'animation de scroll fluide */
        html {
            scroll-behavior: smooth;
        }
        /* Style pour la barre de défilement */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Empêcher le défilement du corps lorsque la modale est ouverte */
        .modal-open {
            overflow: hidden;
        }
        /* Style pour le menu déroulant du compte */
        .account-menu {
            position: absolute;
            top: calc(100% + 10px); /* Position sous le bouton */
            right: 0;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-width: 180px;
            z-index: 60; /* Au-dessus du header */
        }
        .account-menu a, .account-menu button {
            display: block;
            padding: 0.75rem 1rem;
            text-align: left;
            width: 100%;
            color: #4a5568; /* gray-700 */
            transition: background-color 0.2s;
        }
        .account-menu a:hover, .account-menu button:hover {
            background-color: #f7fafc; /* gray-100 */
        }
        .account-menu button.logout-button {
            color: #e53e3e; /* red-600 */
            font-weight: 600;
        }
        .account-menu button.logout-button:hover {
            background-color: #ffebeb; /* red-100 */
        }
        /* Correction : Supprimer !important pour permettre aux classes Tailwind de fonctionner */
        .hidden {
            display: none;
        }

        /* Styles pour le drag and drop des images */
        .image-preview-item {
            position: relative;
            cursor: grab;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }
        .image-preview-item.dragging {
            opacity: 0.5;
            border-color: #ef4444; /* red-500 */
        }
        .image-preview-item.drag-over {
            border-color: #3b82f6; /* blue-500 */
        }

        /* Styles pour l'image de la modale de détails du véhicule */
        .modal-image-container {
            width: 100%;
            max-height: 70vh; /* Ajuste la hauteur maximale pour ne pas prendre tout l'écran */
            display: flex; /* Utilise flexbox pour centrer l'image */
            align-items: center;
            justify-content: center;
            overflow: hidden; /* Cache les débordements si l'image est trop grande */
        }
        .modal-image-container img {
            width: auto; /* Laisse la largeur s'adapter à l'image */
            height: auto; /* Laisse la hauteur s'adapter à l'image */
            max-width: 100%; /* S'assure que l'image ne dépasse pas la largeur du conteneur */
            max-height: 100%; /* S'assure que l'image ne dépasse pas la hauteur du conteneur */
            object-fit: contain; /* S'assure que l'image entière est visible */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header id="header" class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#" class="text-2xl font-bold text-gray-900">
                <i class="fas fa-car-side text-red-600"></i> CENTRAL <span class="text-red-600">CARS</span>
            </a>
            <div class="hidden md:flex space-x-8 items-center relative">
                <a href="#accueil" class="text-gray-600 hover:text-red-600 transition duration-300">Accueil</a>
                <a href="#vehicules" class="text-gray-600 hover:text-red-600 transition duration-300">Nos Véhicules</a>
                <a href="#services" class="text-gray-600 hover:text-red-600 transition duration-300">Nos Services</a>
                <a href="#contact" class="text-gray-600 hover:text-red-600 transition duration-300">Contact</a>
                
                <!-- Bouton de connexion/inscription pour les grands écrans (non connecté) -->
                <button id="login-signup-button-desktop" class="text-gray-600 hover:text-red-600 focus:outline-none">
                    <i class="fas fa-user-circle text-2xl"></i>
                </button>

                <!-- Bouton/Icône de l'utilisateur connecté pour les grands écrans -->
                <button id="authenticated-user-menu-toggle-desktop" class="text-red-600 hover:text-red-700 focus:outline-none hidden">
                    <i class="fas fa-user-check text-2xl"></i>
                </button>

                <!-- Menu du compte (pour les grands écrans) -->
                <div id="account-menu-desktop" class="account-menu hidden">
                    <div class="px-4 py-2 border-b text-sm text-gray-500" id="user-email-display-desktop"></div>
                    <a href="#" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Mon profil</a>
                    <a href="#" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Mes favoris</a>
                    <button id="admin-gerer-boutique-desktop" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">Gérer boutique</button>
                    <button id="admin-generer-annonce-desktop" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">Générer Annonce</button>
                    <button id="admin-acces-ants-desktop" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">Accès ANTS</button>
                    <button id="admin-rapport-reparation-desktop" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">Rapport de réparation</button> <!-- NOUVEAU BOUTON -->
                    <button id="logout-button-desktop" class="logout-button text-sm">Se déconnecter</button>
                </div>
            </div>
            <div class="md:hidden flex items-center space-x-4 relative">
                <!-- Bouton de connexion/inscription pour les petits écrans (non connecté) -->
                <button id="login-signup-button-mobile" class="text-gray-600 hover:text-red-600 focus:outline-none">
                    <i class="fas fa-user-circle text-2xl"></i>
                </button>

                <!-- Bouton/Icône de l'utilisateur connecté pour les petits écrans -->
                <button id="authenticated-user-menu-toggle-mobile" class="text-red-600 hover:text-red-700 focus:outline-none hidden">
                    <i class="fas fa-user-check text-2xl"></i>
                </button>

                <button id="mobile-menu-button" class="text-gray-600 hover:text-red-600 focus:outline-none">
                    <i class="fas fa-bars text-2xl"></i>
                </button>

                <!-- Menu du compte (pour les petits écrans, affiché via le menu mobile ou popover) -->
                <div id="account-menu-mobile" class="account-menu hidden">
                    <div class="px-4 py-2 border-b text-sm text-gray-500" id="user-email-display-mobile"></div>
                    <a href="#" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Mon profil</a>
                    <a href="#" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Mes favoris</a>
                    <button id="admin-gerer-boutique-mobile" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">Gérer boutique</button>
                    <button id="admin-generer-annonce-mobile" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">Générer Annonce</button>
                    <button id="admin-acces-ants-mobile" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">Accès ANTS</button>
                    <button id="admin-rapport-reparation-mobile" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">Rapport de réparation</button> <!-- NOUVEAU BOUTON -->
                    <button id="logout-button-mobile" class="logout-button text-sm">Se déconnecter</button>
                </div>
            </div>
        </nav>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-white">
            <a href="#accueil" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Accueil</a>
            <a href="#vehicules" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Nos Véhicules</a>
            <a href="#services" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Nos Services</a>
            <a href="#contact" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Contact</a>
            <!-- Les options du menu mobile pourraient inclure la déconnexion ici aussi si le menu popover n'est pas utilisé -->
        </div>
    </header>

    <main>
        <!-- Wrapper pour les sections de contenu principal -->
        <div id="main-content-sections">
            <!-- Section Accueil (Hero) -->
            <section id="accueil" class="h-screen bg-cover bg-center bg-fixed flex items-center justify-center" style="background-image: url('https://images.unsplash.com/photo-1553440569-bcc63803a83d?q=80&w=2025&auto=format&fit=crop');">
                <div class="absolute inset-0 bg-black opacity-50"></div>
                <div class="text-center text-white z-10 p-4">
                    <h1 class="text-4xl md:text-6xl font-bold mb-4">CENTRAL CARS</h1>
                    <p class="text-lg md:text-2xl mb-8">Professionnel de l'automobile depuis 2003.</p>
                    <a href="#vehicules" class="bg-red-600 text-white font-bold py-3 px-8 rounded-full hover:bg-red-700 transition duration-300 transform hover:scale-105">Découvrir nos voitures</a>
                </div>
            </section>

            <!-- Section Véhicules -->
            <section id="vehicules" class="py-20 bg-white">
                <div class="container mx-auto px-6">
                    <h2 class="text-3xl font-bold text-center mb-2">Nos Véhicules d'Occasion</h2>
                    <p class="text-center text-gray-500 mb-12">Des voitures sélectionnées et garanties pour votre sérénité.</p>
                    
                    <!-- Section de filtres -->
                    <div class="bg-gray-100 p-6 rounded-lg shadow-md mb-12">
                        <h3 class="text-xl font-bold mb-4">Filtrer les véhicules</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label for="filter-marque" class="block text-gray-700 text-sm font-semibold mb-2">Marque</label>
                                <select id="filter-marque" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                                    <option value="">Toutes les marques</option>
                                    <!-- Options will be populated by JS -->
                                </select>
                            </div>
                            <div>
                                <label for="filter-modele" class="block text-gray-700 text-sm font-semibold mb-2">Modèle</label>
                                <select id="filter-modele" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                                    <option value="">Tous les modèles</option>
                                    <!-- Options will be populated by JS based on selected brand -->
                                </select>
                            </div>
                            <div>
                                <label for="filter-carburant" class="block text-gray-700 text-sm font-semibold mb-2">Carburant</label>
                                <select id="filter-carburant" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                                    <option value="">Tous les carburants</option>
                                    <!-- Options will be populated by JS -->
                                </select>
                            </div>
                            <div>
                                <label for="filter-boite-vitesse" class="block text-gray-700 text-sm font-semibold mb-2">Boîte de vitesse</label>
                                <select id="filter-boite-vitesse" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                                    <option value="">Toutes les boîtes</option>
                                    <!-- Options will be populated by JS -->
                                </select>
                            </div>
                            <div>
                                <label for="filter-prix-min" class="block text-gray-700 text-sm font-semibold mb-2">Prix Min (€)</label>
                                <input type="number" id="filter-prix-min" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Ex: 5000">
                            </div>
                            <div>
                                <label for="filter-prix-max" class="block text-gray-700 text-sm font-semibold mb-2">Prix Max (€)</label>
                                <input type="number" id="filter-prix-max" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Ex: 20000">
                            </div>
                            <div class="flex items-end">
                                <input type="checkbox" id="filter-vendu" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded mr-2">
                                <label for="filter-vendu" class="text-gray-700 text-sm font-semibold">Afficher les véhicules vendus</label>
                            </div>
                            <div class="flex items-end">
                                <button id="reset-filters-button" class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition duration-300">Réinitialiser les filtres</button>
                            </div>
                        </div>
                    </div>

                    <div id="vehicle-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <!-- Les fiches de véhicules seront injectées ici par JavaScript -->
                    </div>
                    <div id="loading-spinner" class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-red-600 text-4xl"></i>
                        <p class="mt-2 text-gray-600">Chargement des véhicules...</p>
                    </div>
                </div>
            </section>

            <!-- Section Nos Services -->
            <section id="services" class="py-20 bg-gray-100">
                <div class="container mx-auto px-6">
                    <h2 class="text-3xl font-bold text-center mb-12">Nos Services</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <div class="bg-white p-8 rounded-lg shadow-lg">
                            <h3 class="text-2xl font-bold mb-4 text-red-600"><i class="fas fa-wrench mr-3"></i>Atelier mécanique</h3>
                            <ul class="list-disc list-inside space-y-2 text-gray-700 text-lg">
                                <li>Entretiens toutes marques.</li>
                                <li>Vidange moteur, remplacement des filtres.</li>
                                <li>Kit distribution et courroie accessoire.</li>
                                <li>Disques et plaquettes de frein.</li>
                                <li>Allumage (bougie, injecteurs, etc..)</li>
                                <li>Et bien d'autres...</li>
                            </ul>
                        </div>
                        <div class="bg-white p-8 rounded-lg shadow-lg">
                            <h3 class="text-2xl font-bold mb-4 text-red-600"><i class="fas fa-cogs mr-3"></i>Géométrie et Équilibrage</h3>
                            <ul class="list-disc list-inside space-y-2 text-gray-700 text-lg">
                                <li>Montage des pneumatiques sur jantes.</li>
                                <li>Equilibrage de la roue.</li>
                                <li>Geométrie des roues.</li>
                            </ul>
                        </div>
                        <div class="bg-white p-8 rounded-lg shadow-lg">
                            <h3 class="text-2xl font-bold mb-4 text-red-600"><i class="fas fa-key mr-3"></i>Reproduction de Clés</h3>
                            <ul class="list-disc list-inside space-y-2 text-gray-700 text-lg">
                                <li>Reproduction de clé toutes marques.</li>
                                <li>Clés simples ou centralisées.</li>
                                <li>Taillage de lame et reprogrammation.</li>
                            </ul>
                        </div>
                        <div class="md:col-span-full bg-white p-8 rounded-lg shadow-lg">
                            <h3 class="text-2xl font-bold mb-4 text-red-600"><i class="fas fa-file-alt mr-3"></i>Service Administratif (Carte Grise)</h3>
                            <ul class="list-disc list-inside space-y-2 text-gray-700 text-lg">
                                <li>Habilité par le Service Instructeur des Véhicules.</li>
                                <li>Cartes grises françaises.</li>
                                <li>Véhicules importés : délivrance de WW, reception du Quitus Fiscal et demande de carte grise définitive.</li>
                                <li>Déclaration de cession, déclaration de perte, demande de duplicatat, modification techniques, etc...</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section Contact -->
            <section id="contact" class="py-20 bg-white">
                <div class="container mx-auto px-6">
                    <h2 class="text-3xl font-bold text-center mb-12">Contactez-nous</h2>
                    <div class="flex flex-wrap -mx-4">
                        <!-- Formulaire de contact -->
                        <div class="w-full lg:w-1/2 px-4 mb-8 lg:mb-0">
                            <div class="bg-gray-100 p-8 rounded-lg shadow-lg">
                                <h3 class="text-2xl font-bold mb-6">Envoyez-nous un message</h3>
                                <form>
                                    <div class="mb-4">
                                        <label for="name" class="block text-gray-700 font-semibold mb-2">Nom complet</label>
                                        <input type="text" id="name" name="name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Votre nom">
                                    </div>
                                    <div class="mb-4">
                                        <label for="email" class="block text-gray-700 font-semibold mb-2">Email</label>
                                        <input type="email" id="email" name="email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Votre email">
                                    </div>
                                    <div class="mb-6">
                                        <label for="message" class="block text-gray-700 font-semibold mb-2">Message</label>
                                        <textarea id="message" name="message" rows="5" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Votre message..."></textarea>
                                    </div>
                                    <button type="submit" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition duration-300">Envoyer</button>
                                </form>
                            </div>
                        </div>
                        <!-- Informations de contact -->
                        <div class="w-full lg:w-1/2 px-4">
                            <div class="bg-gray-100 p-8 rounded-lg shadow-lg h-full">
                                <h3 class="text-2xl font-bold mb-6">Nos Coordonnées</h3>
                                <div class="space-y-6 text-lg">
                                    <p class="flex items-start">
                                        <i class="fas fa-map-marker-alt text-red-600 mt-1 mr-4 w-6 text-center"></i>
                                        <span>CENTRAL CARS<br>123 Rue de la République<br>59690 Vieux-Condé, France</span>
                                    </p>
                                    <p class="flex items-center">
                                        <i class="fas fa-phone text-red-600 mr-4 w-6 text-center"></i>
                                        <a href="tel:+33698979463" class="hover:text-red-600">06 98 97 94 63</a>
                                     </p>
                                    <p class="flex items-center">
                                        <i class="fas fa-envelope text-red-600 mr-4 w-6 text-center"></i>
                                        <a href="mailto:contact@centralcars.fr" class="hover:text-red-600">contact@centralcars.fr</a>
                                     </p>
                                    <p class="flex items-center">
                                        <i class="fas fa-id-card text-red-600 mr-4 w-6 text-center"></i>
                                        <span>SIRET: 78992754800022</span>
                                    </p>
                                </div>
                                <div class="mt-8">
                                    <h4 class="text-xl font-bold mb-4">Horaires d'ouverture</h4>
                                    <ul class="space-y-2">
                                        <li><strong>Lundi - Vendredi :</strong> 9h00 - 18h00</li>
                                        <li><strong>Samedi :</strong> 9h00 - 12h00</li>
                                        <li><strong>Dimanche :</strong> Fermé</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Admin Panel Section -->
        <section id="admin-panel" class="py-20 bg-gray-100 hidden">
            <div class="container mx-auto px-6">
                <h2 class="text-3xl font-bold text-center mb-12">Gérer boutique</h2>

                <!-- Bouton pour revenir à l'accueil -->
                <div class="flex justify-start mb-8">
                    <button id="back-to-home-button" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition duration-300">
                        <i class="fas fa-arrow-left mr-2"></i> Retour à l'accueil
                    </button>
                </div>

                <!-- Formulaire d'ajout/modification de véhicule -->
                <div class="bg-white p-8 rounded-lg shadow-lg mb-12">
                    <h3 class="text-2xl font-bold mb-6" id="vehicle-form-title">Ajouter un nouveau véhicule</h3>
                    <form id="vehicle-form" class="space-y-4">
                        <input type="hidden" id="vehicle-id">
                        <div>
                            <label for="vehicle-titre-annonce" class="block text-gray-700 font-semibold mb-2">Titre de l'annonce</label>
                            <input type="text" id="vehicle-titre-annonce" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        </div>
                        <div>
                            <label for="vehicle-marque" class="block text-gray-700 font-semibold mb-2">Marque</label>
                            <select id="vehicle-marque" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                                <option value="">Sélectionner une marque</option>
                            </select>
                        </div>
                        <div>
                            <label for="vehicle-modele" class="block text-gray-700 font-semibold mb-2">Modèle</label>
                            <select id="vehicle-modele" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                                <option value="">Sélectionner un modèle</option>
                            </select>
                        </div>
                        <div>
                            <label for="vehicle-annee-modele" class="block text-gray-700 font-semibold mb-2">Année du modèle</label>
                            <input type="number" id="vehicle-annee-modele" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" min="1900" max="2099" required>
                        </div>
                        <div>
                            <label for="vehicle-date-circulation" class="block text-gray-700 font-semibold mb-2">Date de première mise en circulation (MM/AAAA)</label>
                            <input type="text" id="vehicle-date-circulation" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="MM/AAAA" pattern="(0[1-9]|1[0-2])\/(19|20)\d{2}" required>
                        </div>
                        <div>
                            <label for="vehicle-kilometrage" class="block text-gray-700 font-semibold mb-2">Kilométrage</label>
                            <input type="number" id="vehicle-kilometrage" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        </div>
                        <div>
                            <label for="vehicle-carburant" class="block text-gray-700 font-semibold mb-2">Carburant</label>
                            <select id="vehicle-carburant" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                                <option value="">Sélectionner un type de carburant</option>
                            </select>
                        </div>
                        <div>
                            <label for="vehicle-boite-vitesse" class="block text-gray-700 font-semibold mb-2">Boîte de vitesse</label>
                            <select id="vehicle-boite-vitesse" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                                <option value="">Sélectionner un type de boîte</option>
                            </select>
                        </div>
                        <div>
                            <label for="vehicle-couleur" class="block text-gray-700 font-semibold mb-2">Couleur</label>
                            <input type="text" id="vehicle-couleur" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                        </div>
                        <div>
                            <label for="vehicle-nb-places" class="block text-gray-700 font-semibold mb-2">Nombre de places</label>
                            <input type="number" id="vehicle-nb-places" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" min="1" max="9">
                        </div>
                        <div>
                            <label for="vehicle-nb-portes" class="block text-gray-700 font-semibold mb-2">Nombre de portes</label>
                            <input type="number" id="vehicle-nb-portes" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" min="1" max="5">
                        </div>
                        <div>
                            <label for="vehicle-puissance-fiscale" class="block text-gray-700 font-semibold mb-2">Puissance fiscale (CV)</label>
                            <input type="number" id="vehicle-puissance-fiscale" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" min="1">
                        </div>
                        <div>
                            <label for="vehicle-puissance-din" class="block text-gray-700 font-semibold mb-2">Puissance DIN (ch)</label>
                            <input type="number" id="vehicle-puissance-din" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" min="1">
                        </div>
                        <div>
                            <label for="vehicle-critair" class="block text-gray-700 font-semibold mb-2">Crit'Air</label>
                            <select id="vehicle-critair" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                                <option value="">Sélectionner une vignette</option>
                                <option value="0">0 (Vert)</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="Non classé">Non classé</option>
                            </select>
                        </div>
                        <div>
                            <label for="vehicle-prix" class="block text-gray-700 font-semibold mb-2">Prix (€)</label>
                            <input type="number" id="vehicle-prix" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" step="0.01" required>
                        </div>
                        <div>
                            <label for="vehicle-description" class="block text-gray-700 font-semibold mb-2">Description</label>
                            <textarea id="vehicle-description" rows="4" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"></textarea>
                        </div>
                        
                        <!-- Section Options -->
                        <div class="border-t pt-4 mt-4">
                            <h4 class="text-xl font-bold mb-4">Options</h4>
                            <div id="vehicle-options-checkboxes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <!-- Les options seront générées ici par JavaScript -->
                            </div>
                        </div>

                        <!-- Section Entretiens effectués -->
                        <div class="border-t pt-4 mt-4">
                            <h4 class="text-xl font-bold mb-4">Entretiens effectués</h4>
                            <div id="vehicle-maintenances-checkboxes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <!-- Les entretiens seront générés ici par JavaScript -->
                            </div>
                        </div>

                        <!-- Champ "Vendu" et "Cacher l'annonce" -->
                        <div class="flex flex-wrap gap-4 mt-4">
                            <div class="flex items-center">
                                <input type="checkbox" id="vehicle-vendu" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                                <label for="vehicle-vendu" class="ml-2 block text-gray-700 font-semibold">Véhicule vendu</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="vehicle-hidden" class="h-4 w-4 text-gray-600 focus:ring-gray-500 border-gray-300 rounded">
                                <label for="vehicle-hidden" class="ml-2 block text-gray-700 font-semibold">Cacher l'annonce</label>
                            </div>
                        </div>

                        <!-- Section Images -->
                        <div class="border-t pt-4 mt-4">
                            <h4 class="text-xl font-bold mb-4">Images du véhicule (glisser-déposer pour réordonner)</h4>
                            <input type="file" id="vehicle-image-upload" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" multiple accept="image/*">
                            <div id="image-upload-preview" class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-4">
                                <!-- Les aperçus des images seront ici -->
                            </div>
                            <div id="image-upload-spinner" class="text-center py-4 hidden">
                                <i class="fas fa-spinner fa-spin text-red-600 text-2xl"></i>
                                <p class="mt-2 text-gray-600">Téléchargement des images...</p>
                            </div>
                            <input type="hidden" id="vehicle-images-urls"> <!-- Pour stocker les URLs Cloudinary -->
                        </div>

                        <button type="submit" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition duration-300" id="submit-vehicle-button">Ajouter le véhicule</button>
                        <button type="button" class="w-full bg-gray-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-600 transition duration-300 mt-2 hidden" id="cancel-edit-button">Annuler la modification</button>
                    </form>
                </div>

                <!-- Liste des véhicules existants pour l'admin -->
                <h3 class="text-2xl font-bold text-center mb-6">Véhicules existants</h3>
                <div id="admin-vehicle-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Les fiches de véhicules pour l'admin seront injectées ici par JavaScript -->
                </div>
                <div id="admin-loading-spinner" class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-red-600 text-4xl"></i>
                    <p class="mt-2 text-gray-600">Chargement des véhicules...</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8">
        <div class="container mx-auto px-6 text-center">
            <p>&copy; 2024 CENTRAL CARS. Tous droits réservés.</p>
            <p class="text-sm text-gray-400 mt-2">Site conçu avec ❤️</p>
        </div>
    </footer>

    <!-- Modale de détails du véhicule -->
    <div id="vehicle-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div id="modal-content" class="bg-white rounded-lg shadow-2xl w-11/12 md:w-3/4 lg:w-2/3 max-h-[90vh] overflow-y-auto relative transform transition-all duration-300 scale-95 opacity-0">
            <!-- Contenu de la modale injecté par JavaScript -->
        </div>
    </div>

    <!-- Modale de contact pour le véhicule (nouveau) -->
    <div id="vehicle-contact-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[51] hidden">
        <div id="vehicle-contact-modal-content" class="bg-white rounded-lg shadow-2xl w-11/12 md:w-1/2 lg:w-1/3 p-8 relative transform transition-all duration-300 scale-95 opacity-0">
            <button id="close-vehicle-contact-modal-button" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 text-2xl">&times;</button>
            <h2 class="text-2xl font-bold text-center mb-6">Ce véhicule vous intéresse ?</h2>
            <p class="text-center text-gray-700 mb-6">Contactez-nous pour plus d'informations ou pour prendre rendez-vous.</p>
            <div class="flex flex-col space-y-4">
                <a id="contact-phone-link" href="tel:+33698979463" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-center hover:bg-blue-700 transition duration-300 flex items-center justify-center">
                    <i class="fas fa-phone mr-3"></i> Appeler (06 98 97 94 63)
                </a>
                <a id="contact-email-link" href="mailto:contact@centralcars.fr" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-center hover:bg-green-700 transition duration-300 flex items-center justify-center">
                    <i class="fas fa-envelope mr-3"></i> Envoyer un e-mail
                </a>
            </div>
        </div>
    </div>

    <!-- Modale de connexion/inscription -->
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl w-11/12 md:w-1/2 lg:w-1/3 p-8 relative transform transition-all duration-300 scale-95 opacity-0" id="auth-modal-content">
            <button id="close-auth-modal-button" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 text-2xl">&times;</button>
            <h2 class="text-3xl font-bold text-center mb-6" id="auth-modal-title">Connexion</h2>
            
            <!-- Formulaire de connexion -->
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-gray-700 font-semibold mb-2">Email</label>
                    <input type="email" id="login-email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Votre email" required>
                </div>
                <div>
                    <label for="login-password" class="block text-gray-700 font-semibold mb-2">Mot de passe</label>
                    <input type="password" id="login-password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Votre mot de passe" required>
                </div>
                <button type="submit" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition duration-300">Se connecter</button>
            </form>

            <!-- Formulaire d'inscription (caché par défaut) -->
            <form id="signup-form" class="space-y-4 hidden">
                <div>
                    <label for="signup-email" class="block text-gray-700 font-semibold mb-2">Email</label>
                    <input type="email" id="signup-email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Votre email" required>
                </div>
                <div>
                    <label for="signup-password" class="block text-gray-700 font-semibold mb-2">Mot de passe</label>
                    <input type="password" id="signup-password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Votre mot de passe" required>
                </div>
                <button type="submit" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition duration-300">S'inscrire</button>
            </form>

            <p class="text-center mt-4">
                <button id="toggle-auth-mode" class="text-red-600 hover:underline">Pas encore de compte ? S'inscrire</button>
            </p>
        </div>
    </div>

    <!-- Modale de l'outil de génération de PDF (NOUVEAU) -->
    <div id="pdf-tool-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div id="pdf-tool-modal-content" class="bg-white rounded-lg shadow-2xl w-11/12 md:w-3/4 lg:w-2/3 max-h-[90vh] overflow-y-auto relative transform transition-all duration-300 scale-95 opacity-0">
            <button id="close-pdf-tool-modal-button" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 text-2xl">&times;</button>
            <div class="p-8">
                <h1 class="text-3xl font-bold text-center mb-6">Outil de Génération de Rapport de Réparation</h1>
                <p class="text-center text-gray-600 mb-8">Remplissez les informations ci-dessous pour générer un rapport de réparation en PDF.</p>

                <form id="repair-report-form" class="space-y-6">
                    <!-- Informations du véhicule -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="marque" class="block text-gray-700 font-semibold mb-2">Marque</label>
                            <input type="text" id="marque" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        </div>
                        <div>
                            <label for="modele" class="block text-gray-700 font-semibold mb-2">Modèle</label>
                            <input type="text" id="modele" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        </div>
                        <div>
                            <label for="immatriculation" class="block text-gray-700 font-semibold mb-2">Numéro d'immatriculation</label>
                            <input type="text" id="immatriculation" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        </div>
                        <div>
                            <label for="chassis" class="block text-gray-700 font-semibold mb-2">Numéro de châssis (VIN)</label>
                            <input type="text" id="chassis" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        </div>
                        <div>
                            <label for="kilometrage" class="block text-gray-700 font-semibold mb-2">Kilométrage</label>
                            <input type="number" id="kilometrage" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        </div>
                        <div>
                            <label for="date-circulation" class="block text-gray-700 font-semibold mb-2">Date de 1ère mise en circulation</label>
                            <input type="date" id="date-circulation" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        </div>
                    </div>

                    <!-- Réparations pré-définies -->
                    <div class="border-t pt-6 mt-6">
                        <h3 class="text-xl font-bold mb-4">Réparations effectuées</h3>
                        <div id="repairs-checkboxes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            <!-- Checkboxes will be generated here by JS -->
                        </div>
                    </div>

                    <!-- Ajout de réparations manuelles -->
                    <div class="border-t pt-6 mt-6">
                        <h3 class="text-xl font-bold mb-4">Ajouter d'autres réparations</h3>
                        <div class="flex flex-col md:flex-row gap-4">
                            <input type="text" id="manual-repair-input" class="flex-grow px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Ex: Remplacement du turbo">
                            <button type="button" id="add-manual-repair" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-300">Ajouter</button>
                        </div>
                        <ul id="manual-repairs-list" class="mt-4 space-y-2">
                            <!-- Manually added repairs will appear here -->
                        </ul>
                    </div>

                    <!-- Observation -->
                    <div class="border-t pt-6 mt-6">
                        <h3 class="text-xl font-bold mb-4">Observation</h3>
                        <textarea id="observation" rows="5" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Ajoutez des observations supplémentaires ici..."></textarea>
                    </div>

                    <button type="submit" id="generate-pdf-button" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition duration-300">Générer le PDF</button>
                </form>
            </div>
        </div>
    </div>

    <!-- CUSTOM ALERT MODAL -->
    <div id="custom-alert" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[999] hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center relative">
            <p id="custom-alert-message" class="text-lg font-semibold mb-4"></p>
            <button id="custom-alert-close" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">OK</button>
        </div>
    </div>

    <!-- CUSTOM CONFIRM MODAL -->
    <div id="custom-confirm" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[999] hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center relative">
            <p id="custom-confirm-message" class="text-lg font-semibold mb-4"></p>
            <div class="flex justify-center space-x-4">
                <button id="custom-confirm-ok" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">Oui</button>
                <button id="custom-confirm-cancel" class="bg-gray-400 text-white py-2 px-4 rounded-lg hover:bg-gray-500 transition duration-300">Annuler</button>
            </div>
        </div>
    </div>

    <script type="module">
        // ====================================================================================================
        // IMPORTANT : CONFIGURATION DES RÈGLES DE SÉCURITÉ FIREBASE FIRESTORE
        //
        // L'erreur "Missing or insufficient permissions" indique que les règles de sécurité de votre base de données
        // Firebase ne permettent pas à l'utilisateur actuel d'effectuer l'opération demandée.
        //
        // VOUS DEVEVEZ APPLIQUER CES RÈGLES DANS VOTRE CONSOLE FIREBASE :
        // 1. Allez sur https://console.firebase.google.com/
        // 2. Sélectionnez votre projet.
        // 3. Dans le menu de gauche, cliquez sur "Firestore Database".
        // 4. Cliquez sur l'onglet "Règles".
        // 5. REMPLACEZ LE CONTENU EXISTANT par les règles ci-dessous :
        /*
        rules_version = '2';
        service cloud.firestore {
            match /databases/{database}/documents {

                // Règle pour les profils utilisateurs (rôles)
                // Chaque utilisateur peut lire et écrire son propre document 'user_data'
                match /artifacts/{appId}/users/{userId}/profile/user_data {
                    allow read, write: if request.auth != null && request.auth.uid == userId;
                }

                // Règle pour la collection 'vehicules'
                match /vehicules/{vehicleId} {
                    // Tous les utilisateurs (authentifiés ou non) peuvent lire les véhicules
                    allow read: if true;

                    // Seuls les administrateurs peuvent créer, mettre à jour et supprimer des véhicules
                    // Pour vérifier le rôle, nous lisons le document 'user_data' de l'utilisateur connecté.
                    allow create, update, delete: if request.auth != null && get(/databases/$(database)/documents/artifacts/$(app.id)/users/$(request.auth.uid)/profile/user_data).data.role == 'admin';
                }
            }
        }
        */
        // 6. Cliquez sur "Publier" pour sauvegarder les règles.
        //
        // ASSUREZ-VOUS ÉGALEMENT QU'UN UTILISATEUR A BIEN LE RÔLE 'admin' DANS FIRESTORE :
        // Pour qu'un utilisateur puisse utiliser le panneau d'administration, son rôle doit être 'admin'.
        // Après vous être connecté avec un compte, allez dans Firestore Database -> onglet "Données" :
        // artifacts -> votre_app_id -> users -> {UID_DE_L_UTILISATEUR} -> profile -> user_data
        // Modifiez le champ 'role' à 'admin'.
        // ====================================================================================================

        // --- IMPORTS ET CONFIGURATION FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, addDoc, deleteDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";


        // Configuration Firebase fournie
        const __app_id = 'central-cars-a37ae';
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyC1RQ5m7_utiAEsvyobIuuwxzAzBLx27Sw",
            authDomain: "central-cars-a37ae.firebaseapp.com",
            projectId: "central-cars-a37ae",
            storageBucket: "central-cars-a37ae.firebaseapp.com",
            messagingSenderId: "297273470734",
            appId: "1:297273470734:web:7d35e6619b28dc569d715f",
            measurementId: "G-4LXQG2VWP1" // Corrected measurementId as it was a typo
        });

        const firebaseConfig = JSON.parse(__firebase_config);

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- VARIABLES GLOBALES ---
        let allVehicles = []; // Pour stocker tous les véhicules récupérés
        window.currentUserRole = null; // Variable globale pour le rôle de l'utilisateur

        // --- GESTION DU MENU MOBILE ---
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

        // --- RÉFÉRENCES DES ÉLÉMENTS DE FILTRE ---
        const filterMarqueSelect = document.getElementById('filter-marque');
        const filterModeleSelect = document.getElementById('filter-modele');
        const filterCarburantSelect = document.getElementById('filter-carburant');
        const filterBoiteVitesseSelect = document.getElementById('filter-boite-vitesse');
        const filterPrixMinInput = document.getElementById('filter-prix-min');
        const filterPrixMaxInput = document.getElementById('filter-prix-max');
        const filterVenduCheckbox = document.getElementById('filter-vendu');
        const resetFiltersButton = document.getElementById('reset-filters-button');

        // --- FONCTION POUR AFFICHER LES VÉHICULES (Côté client) ---
        function displayVehicles(vehiclesToDisplay) {
            const vehicleList = document.getElementById('vehicle-list');
            const loadingSpinner = document.getElementById('loading-spinner');
            vehicleList.innerHTML = ''; // Vider la liste existante

            // Filter out hidden vehicles for the client view
            let visibleVehicles = vehiclesToDisplay.filter(v => !v.hidden);

            if (visibleVehicles.length === 0) {
                 vehicleList.innerHTML = `<p class="text-center col-span-full">Aucun véhicule ne correspond à vos critères de recherche.</p>`;
            } else {
                // Sort vehicles: not sold (vendu: false) first, then sold (vendu: true)
                visibleVehicles.sort((a, b) => {
                    // If 'vendu' is true, it means it's sold, so it should come after non-sold vehicles.
                    // If 'vendu' is false, it means it's not sold, so it should come before sold vehicles.
                    // We want false (0) to come before true (1). So, a.vendu - b.vendu will work.
                    // If both are same, 0 - 0 = 0 or 1 - 1 = 0 (order doesn't change)
                    return (a.vendu || false) - (b.vendu || false);
                });

                visibleVehicles.forEach(vehicle => {
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow-lg overflow-hidden transform hover:-translate-y-2 transition-transform duration-300 relative'; // Added relative for badge positioning
                    // Utilise une image de secours si la première image n'est pas définie
                    const imageUrl = vehicle.images && vehicle.images.length > 0 ? vehicle.images[0] : 'https://placehold.co/600x400/cccccc/ffffff?text=Image+Indisponible';
                    
                    // Add "Vendu" badge if vehicle is sold
                    const soldBadge = vehicle.vendu ? `
                        <span class="absolute top-2 left-2 bg-red-600 text-white text-xs font-bold px-3 py-1 rounded-full z-10">VENDU</span>
                    ` : '';

                    card.innerHTML = `
                        ${soldBadge}
                        <img src="${imageUrl}" alt="Image de ${vehicle.nom}" class="w-full h-56 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/ffffff?text=Image+Invalide';">
                        <div class="p-6">
                            <h3 class="text-2xl font-bold mb-2">${vehicle.titreAnnonce || vehicle.nom || 'Titre non disponible'}</h3>
                            <p class="text-gray-600 mb-2">${vehicle.marque || 'N/A'} - ${vehicle.modele || 'N/A'}</p>
                            <div class="text-gray-600 mb-4 space-y-1">
                                <p><i class="fas fa-calendar-alt w-6 text-red-500"></i> ${vehicle.anneeModele || 'N/A'}</p>
                                <p><i class="fas fa-tachometer-alt w-6 text-red-500"></i> ${vehicle.kilometrage ? vehicle.kilometrage.toLocaleString('fr-FR') : 'N/A'} km</p>
                                <p><i class="fas fa-gas-pump w-6 text-red-500"></i> ${vehicle.carburant || 'N/A'}</p>
                            </div>
                            <p class="text-3xl font-bold text-red-600 mb-4">${vehicle.prix ? vehicle.prix.toLocaleString('fr-FR') : 'N/A'} €</p>
                            <button data-id="${vehicle.id}" class="details-button w-full bg-gray-800 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-900 transition duration-300">
                                Voir les détails
                            </button>
                        </div>
                    `;
                    vehicleList.appendChild(card);
                });
            }
             loadingSpinner.style.display = 'none';
        }

        // --- GESTION DE LA MODALE DE DÉTAILS DU VÉHICULE ---
        const vehicleModal = document.getElementById('vehicle-modal');
        const vehicleModalContent = document.getElementById('modal-content');
        const contactPhone = '0698979463'; // Définir le numéro de téléphone ici
        const contactEmail = 'contact@centralcars.fr'; // Définir l'adresse email ici

        function openVehicleModal(vehicle) {
            let currentImageIndex = 0;
            const images = vehicle.images && vehicle.images.length > 0 ? vehicle.images : ['https://placehold.co/800x600/cccccc/ffffff?text=Image+Indisponible'];

            // Add "Vendu" badge if vehicle is sold
            const soldBadgeModal = vehicle.vendu ? `
                <span class="absolute top-4 left-4 bg-red-600 text-white text-lg font-bold px-4 py-2 rounded-full z-10">VENDU</span>
            ` : '';

            vehicleModalContent.innerHTML = `
                <button id="close-vehicle-modal-button" class="absolute top-4 right-4 text-white bg-black bg-opacity-50 rounded-full w-8 h-8 flex items-center justify-center text-2xl hover:bg-opacity-75 z-20">&times;</button>
                
                <div class="modal-image-container relative">
                    ${soldBadgeModal}
                    <img id="modal-image" src="${images[0]}" alt="Image principale de ${vehicle.titreAnnonce || vehicle.nom}" class="rounded-t-lg" onerror="this.onerror=null;this.src='https://placehold.co/800x600/cccccc/ffffff?text=Image+Invalide';">
                    <div id="modal-image-prev" class="absolute left-0 top-1/2 -translate-y-1/2 p-2 m-2 bg-black bg-opacity-50 text-white rounded-full cursor-pointer hover:bg-opacity-75 ${images.length <= 1 ? 'hidden' : ''}"><i class="fas fa-chevron-left"></i></div>
                    <div id="modal-image-next" class="absolute right-0 top-1/2 -translate-y-1/2 p-2 m-2 bg-black bg-opacity-50 text-white rounded-full cursor-pointer hover:bg-opacity-75 ${images.length <= 1 ? 'hidden' : ''}"><i class="fas fa-chevron-right"></i></div>
                </div>

                <div class="p-6 md:p-8">
                    <h2 class="text-3xl font-bold mb-2">${vehicle.titreAnnonce || vehicle.nom || 'Titre non disponible'}</h2>
                    <p class="text-xl text-gray-700 mb-4">${vehicle.marque || 'N/A'} - ${vehicle.modele || 'N/A'}</p>
                    <p class="text-4xl font-bold text-red-600 mb-6">${vehicle.prix ? vehicle.prix.toLocaleString('fr-FR') : 'N/A'} €</p>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center mb-6">
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.anneeModele || 'N/A'}</div><div class="text-sm text-gray-600">Année Modèle</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.dateCirculation || 'N/A'}</div><div class="text-sm text-gray-600">1ère circulation</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.kilometrage ? vehicle.kilometrage.toLocaleString('fr-FR') : 'N/A'}</div><div class="text-sm text-gray-600">Km</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.carburant || 'N/A'}</div><div class="text-sm text-gray-600">Carburant</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.boiteVitesse || 'N/A'}</div><div class="text-sm text-gray-600">Boîte</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.couleur || 'N/A'}</div><div class="text-sm text-gray-600">Couleur</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.nbPlaces || 'N/A'}</div><div class="text-sm text-gray-600">Places</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.nbPortes || 'N/A'}</div><div class="text-sm text-gray-600">Portes</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.puissanceFiscale || 'N/A'} CV</div><div class="text-sm text-gray-600">Puissance Fisc.</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.puissanceDIN || 'N/A'} ch</div><div class="text-sm text-gray-600">Puissance DIN</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.critAir || 'N/A'}</div><div class="text-sm text-gray-600">Crit'Air</div></div>
                    </div>

                    <h3 class="text-xl font-bold mb-3 border-b pb-2">Description</h3>
                    <p class="text-gray-700 mb-6">${vehicle.description || 'Aucune description.'}</p>

                    <h3 class="text-xl font-bold mb-3 border-b pb-2">Équipements et options</h3>
                    <ul class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 text-gray-700">
                        ${(vehicle.options && vehicle.options.length > 0) ? vehicle.options.map(opt => `<li><i class="fas fa-check-circle text-green-500 mr-2"></i>${opt}</li>`).join('') : '<li>Aucune option spécifiée.</li>'}
                    </ul>

                    <h3 class="text-xl font-bold mb-3 border-b pb-2 mt-6">Entretiens effectués</h3>
                    <ul class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 text-gray-700">
                        ${(vehicle.maintenances && vehicle.maintenances.length > 0) ? vehicle.maintenances.map(maint => `<li><i class="fas fa-wrench text-blue-500 mr-2"></i>${maint}</li>`).join('') : '<li>Aucun entretien spécifié.</li>'}
                    </ul>

                    <div class="mt-8 pt-4 border-t border-gray-200 text-sm text-gray-700 leading-relaxed">
                        <p>Tarif hors carte grise.</p>
                        <p class="mt-2">🧑🏼‍🔧 Garantie moteur et boîte 6 mois (extension de garantie possible).</p>
                        <p class="mt-2">🇫🇷🇫🇷HABILITÉE SERVICE CARTE GRISE 🇫🇷🇫🇷</p>
                        <p>Habilité par le Agence Nationale des Titres Sécurisés.</p>
                        <p>Nous nous occupons de toutes les démarches administratives d'immatriculation !</p>
                        <p class="mt-4 font-semibold">Pour faciliter les démarches administratives pensez a vous munir des pièces suivantes lors de votre visite : </p>
                        <ul class="list-disc list-inside ml-4">
                            <li>🔸Pièce d'identité en cours de validité.</li>
                            <li>🔸Permis de conduire en cours de validité.</li>
                            <li>🔸Justificatif de domicile moins de 3 mois (facture ou avis d'imposition).</li>
                            <li>🔸En cas d'hébergement : une attestation d'hébergement et la copie de la carte d'identité de l'hébergeur.</li>
                        </ul>
                        <p class="mt-4 font-bold text-lg text-center">🟥🟦 CENTRAL CARS 🟥🟦</p>
                        <p class="text-center">📫576 Rue Marcel Sembat</p>
                        <p class="text-center">59690 Vieux-condé</p>
                        <p class="mt-4 font-bold text-center">⏰HORAIRES D'OUVERTURE⏰</p>
                        <p class="text-center">- Du lundi au vendredi : 09H00-12H00 / 14H00-17h30</p>
                        <p class="text-center">- SAMEDI : 9h30 -12h 14h30 - 17H00</p>
                        <p class="mt-4 text-red-600 font-semibold text-center">⚠ Merci de prendre rendez-vous par téléphone avant votre venue afin de mieux pouvoir vous accueillir et de vous assurez de la disponibilité du véhicule ⚠</p>
                        <p class="mt-4 text-xs text-gray-500 text-center">*sous réserve d’erreurs lors de l’édition des annonce.</p>
                    </div>

                     <div class="mt-8 text-center">
                        <button id="contact-us-button" class="bg-red-600 text-white font-bold py-3 px-8 rounded-full hover:bg-red-700 transition duration-300">Ce véhicule m'intéresse</button>
                    </div>
                </div>
            `;
            
            document.body.classList.add('modal-open');
            vehicleModal.classList.remove('hidden');
            setTimeout(() => {
                vehicleModalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);

            // --- Logique de la galerie d'images ---
            const modalImage = document.getElementById('modal-image');
            const prevBtn = document.getElementById('modal-image-prev');
            const nextBtn = document.getElementById('modal-image-next');

            function updateImage() {
                modalImage.src = images[currentImageIndex];
            }

            if (images.length > 1) {
                prevBtn.addEventListener('click', () => {
                    currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
                    updateImage();
                });

                nextBtn.addEventListener('click', () => {
                    currentImageIndex = (currentImageIndex + 1) % images.length;
                    updateImage();
                });
            }

            // --- Fermeture de la modale ---
            document.getElementById('close-vehicle-modal-button').addEventListener('click', closeVehicleModal);
            
            // Ouvrir la modale de contact lorsque le bouton "Ce véhicule m'intéresse" est cliqué
            document.getElementById('contact-us-button').addEventListener('click', () => {
                closeVehicleModal(); // Ferme la modale de détails du véhicule
                openVehicleContactModal(); // Ouvre la nouvelle modale de contact
            });
        }

        function closeVehicleModal() {
            vehicleModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                vehicleModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            }, 300);
        }

        // Fermer la modale en cliquant en dehors ou avec la touche Echap
        vehicleModal.addEventListener('click', (event) => {
            if (event.target === vehicleModal) {
                closeVehicleModal();
            }
        });
        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && !vehicleModal.classList.contains('hidden')) {
                closeVehicleModal();
            }
        });

        // Ajouter les écouteurs d'événements sur les boutons "Détails"
        document.getElementById('vehicle-list').addEventListener('click', (event) => {
            const detailsButton = event.target.closest('.details-button');
            if (detailsButton) {
                const vehicleId = detailsButton.dataset.id;
                const vehicle = allVehicles.find(v => v.id === vehicleId); // Find from allVehicles
                if (vehicle) {
                    openVehicleModal(vehicle);
                }
            }
        });
        
        // --- CHARGEMENT DES DONNÉES DEPUIS FIRESTORE ---
        function listenForVehicles() {
            const vehiclesCollection = collection(db, "vehicules");
            const loadingSpinner = document.getElementById('loading-spinner');
            const vehicleList = document.getElementById('vehicle-list');

            onSnapshot(vehiclesCollection, (snapshot) => {
                allVehicles = []; // Vider la liste pour la reconstruire
                snapshot.forEach((doc) => {
                    allVehicles.push({ id: doc.id, ...doc.data() });
                });
                applyFilters(); // Appliquer les filtres après le chargement initial
                loadingSpinner.style.display = 'none';
            }, (error) => {
                console.error("Erreur lors de la récupération des véhicules: ", error);
                loadingSpinner.style.display = 'none';
                vehicleList.innerHTML = `<p class="text-center col-span-full text-red-500">Impossible de charger les véhicules. Vérifiez la console pour plus de détails.</p>`;
            });
        }

        // Démarrer l'écoute des données
        listenForVehicles();

        // --- GESTION DE LA MODALE DE CONTACT DU VÉHICULE (NOUVEAU) ---
        const vehicleContactModal = document.getElementById('vehicle-contact-modal');
        const vehicleContactModalContent = document.getElementById('vehicle-contact-modal-content');
        const closeVehicleContactModalButton = document.getElementById('close-vehicle-contact-modal-button');
        const contactPhoneLink = document.getElementById('contact-phone-link');
        const contactEmailLink = document.getElementById('contact-email-link');

        function openVehicleContactModal() {
            // Mettre à jour les liens avec les informations de contact définies
            contactPhoneLink.href = `tel:${contactPhone}`;
            contactPhoneLink.textContent = `Appeler (${contactPhone.replace(/(\d{2})(?=\d)/g, '$1 ').trim()})`; // Formatage du numéro
            contactEmailLink.href = `mailto:${contactEmail}`;

            document.body.classList.add('modal-open');
            vehicleContactModal.classList.remove('hidden');
            setTimeout(() => {
                vehicleContactModalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeVehicleContactModal() {
            vehicleContactModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                vehicleContactModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            }, 300);
        }

        closeVehicleContactModalButton.addEventListener('click', closeVehicleContactModal);
        vehicleContactModal.addEventListener('click', (event) => {
            if (event.target === vehicleContactModal) {
                closeVehicleContactModal();
            }
        });
        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && !vehicleContactModal.classList.contains('hidden')) {
                closeVehicleContactModal();
            }
        });


        // --- GESTION DE LA MODALE DE CONNEXION/INSCRIPTION ---
        const authModal = document.getElementById('auth-modal');
        const authModalContent = document.getElementById('auth-modal-content');
        const closeAuthModalButton = document.getElementById('close-auth-modal-button');
        const loginSignupButtonDesktop = document.getElementById('login-signup-button-desktop');
        const loginSignupButtonMobile = document.getElementById('login-signup-button-mobile');
        const authModalTitle = document.getElementById('auth-modal-title');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const toggleAuthModeButton = document.getElementById('toggle-auth-mode');

        function openAuthModal() {
            document.body.classList.add('modal-open');
            authModal.classList.remove('hidden');
            setTimeout(() => {
                authModalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeAuthModal() {
            authModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                authModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            }, 300);
        }

        loginSignupButtonDesktop.addEventListener('click', openAuthModal);
        loginSignupButtonMobile.addEventListener('click', openAuthModal);
        closeAuthModalButton.addEventListener('click', closeAuthModal);

        authModal.addEventListener('click', (event) => {
            if (event.target === authModal) {
                closeAuthModal();
            }
        });

        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && !authModal.classList.contains('hidden')) {
                closeAuthModal();
            }
        });

        toggleAuthModeButton.addEventListener('click', () => {
            if (loginForm.classList.contains('hidden')) {
                // Passer au mode connexion
                authModalTitle.textContent = 'Connexion';
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
                toggleAuthModeButton.textContent = 'Pas encore de compte ? S\'inscrire';
            } else {
                // Passer au mode inscription
                authModalTitle.textContent = 'Inscription';
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                toggleAuthModeButton.textContent = 'Déjà un compte ? Se connecter';
            }
        });

        // --- GESTION DE L'AUTHENTIFICATION FIREBASE ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                closeAuthModal();
                // Gérer la connexion réussie (ex: afficher un message, rediriger)
                console.log("Connexion réussie !");
            } catch (error) {
                console.error("Erreur de connexion:", error.message);
                // Afficher un message d'erreur à l'utilisateur
                // Utiliser une modale personnalisée en production au lieu d'alert
                const errorMessage = error.message.includes('auth/invalid-email') ? 'Adresse email invalide.' :
                                     error.message.includes('auth/user-not-found') ? 'Aucun utilisateur trouvé avec cet email.' :
                                     error.message.includes('auth/wrong-password') ? 'Mot de passe incorrect.' :
                                     'Erreur de connexion. Veuillez réessayer.';
                showCustomAlert(errorMessage);
            }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = signupForm['signup-email'].value;
            const password = signupForm['signup-password'].value;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                // Créer un document utilisateur avec un rôle par défaut 'client'
                await setDoc(doc(db, `artifacts/${__app_id}/users/${user.uid}/profile`, 'user_data'), {
                    email: user.email,
                    role: 'client' // Rôle par défaut
                });
                closeAuthModal();
                // Gérer l'inscription réussie
                console.log("Inscription réussie !");
            } catch (error) {
                console.error("Erreur d'inscription:", error.message);
                // Afficher un message d'erreur à l'utilisateur
                // Utiliser une modale personnalisée en production au lieu d'alert
                const errorMessage = error.message.includes('auth/email-already-in-use') ? 'Cet email est déjà utilisé.' :
                                     error.message.includes('auth/weak-password') ? 'Le mot de passe doit contenir au moins 6 caractères.' :
                                     'Erreur d\'inscription. Veuillez réessayer.';
                showCustomAlert(errorMessage);
            }
        });

        // --- GESTION DU MENU DU COMPTE UTILISATEUR ET DU RÔLE ---
        const authenticatedUserMenuToggleDesktop = document.getElementById('authenticated-user-menu-toggle-desktop');
        const authenticatedUserMenuToggleMobile = document.getElementById('authenticated-user-menu-toggle-mobile');
        const accountMenuDesktop = document.getElementById('account-menu-desktop');
        const accountMenuMobile = document.getElementById('account-menu-mobile');
        const logoutButtonDesktop = document.getElementById('logout-button-desktop');
        const logoutButtonMobile = document.getElementById('logout-button-mobile');
        const userEmailDisplayDesktop = document.getElementById('user-email-display-desktop');
        const userEmailDisplayMobile = document.getElementById('user-email-display-mobile');
        const adminGererBoutiqueDesktop = document.getElementById('admin-gerer-boutique-desktop');
        const adminGererBoutiqueMobile = document.getElementById('admin-gerer-boutique-mobile');
        const adminGenererAnnonceDesktop = document.getElementById('admin-generer-annonce-desktop'); // Nouveau bouton
        const adminGenererAnnonceMobile = document.getElementById('admin-generer-annonce-mobile'); // Nouveau bouton
        const adminAccesAntsDesktop = document.getElementById('admin-acces-ants-desktop'); // Bouton ANTS existant
        const adminAccesAntsMobile = document.getElementById('admin-acces-ants-mobile'); // Bouton ANTS existant
        const adminRapportReparationDesktop = document.getElementById('admin-rapport-reparation-desktop'); // NOUVEAU BOUTON RAPPORT
        const adminRapportReparationMobile = document.getElementById('admin-rapport-reparation-mobile'); // NOUVEAU BOUTON RAPPORT


        function toggleAccountMenu(menuElement) {
            menuElement.classList.toggle('hidden');
        }

        authenticatedUserMenuToggleDesktop.addEventListener('click', (event) => {
            event.stopPropagation(); // Empêche la fermeture immédiate par le document listener
            toggleAccountMenu(accountMenuDesktop);
            accountMenuMobile.classList.add('hidden'); // S'assurer que l'autre menu est fermé
        });

        authenticatedUserMenuToggleMobile.addEventListener('click', (event) => {
            event.stopPropagation(); // Empêche la fermeture immédiate par le document listener
            toggleAccountMenu(accountMenuMobile);
            accountMenuDesktop.classList.add('hidden'); // S'assurer que l'autre menu est fermé
        });

        // Fermer les menus si on clique en dehors
        document.addEventListener('click', (event) => {
            if (!accountMenuDesktop.contains(event.target) && !authenticatedUserMenuToggleDesktop.contains(event.target)) {
                accountMenuDesktop.classList.add('hidden');
            }
            if (!accountMenuMobile.contains(event.target) && !authenticatedUserMenuToggleMobile.contains(event.target)) {
                accountMenuMobile.classList.add('hidden');
            }
        });

        // Boutons de déconnexion
        logoutButtonDesktop.addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log("Déconnexion réussie !");
                accountMenuDesktop.classList.add('hidden'); // Cacher le menu après déconnexion
                showCustomAlert("Vous avez été déconnecté.");
            } catch (error) {
                console.error("Erreur de déconnexion:", error.message);
                showCustomAlert("Erreur lors de la déconnexion. Veuillez réessayer.");
            }
        });

        logoutButtonMobile.addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log("Déconnexion réussie !");
                accountMenuMobile.classList.add('hidden'); // Cacher le menu après déconnexion
                showCustomAlert("Vous avez été déconnecté.");
            } catch (error) {
                console.error("Erreur de déconnexion:", error.message);
                showCustomAlert("Erreur lors de la déconnexion. Veuillez réessayer.");
            }
        });


        // Gérer l'état de l'authentification (optionnel, pour afficher/masquer des éléments)
        onAuthStateChanged(auth, async (user) => { // Rendre la fonction async
            if (user) {
                console.log("Utilisateur connecté:", user.email);
                
                const userRef = doc(db, `artifacts/${__app_id}/users/${user.uid}/profile`, 'user_data');
                console.log("Chemin du document de rôle utilisateur:", userRef.path); // Pour le débogage
                console.log("ID de l'application (__app_id):", __app_id); // Pour le débogage
                console.log("UID de l'utilisateur:", user.uid); // Pour le débogage

                let userRole = 'client'; // Rôle par défaut

                try {
                    const userDoc = await getDoc(userRef);
                    if (userDoc.exists()) {
                        userRole = userDoc.data().role || 'client';
                        console.log("Rôle de l'utilisateur récupéré:", userRole); // Pour le débogage
                    } else {
                        // Si le document n'existe pas (nouvel utilisateur ou ancien sans rôle), le créer avec 'client'
                        await setDoc(userRef, { email: user.email, role: 'client' });
                        userRole = 'client';
                        console.log("Document de rôle utilisateur créé avec le rôle par défaut 'client'."); // Pour le débogage
                    }
                } catch (error) {
                    console.error("Erreur lors de la récupération/création du rôle utilisateur:", error);
                }

                window.currentUserRole = userRole; // Rendre le rôle accessible globalement

                // Afficher les éléments pour utilisateur connecté
                loginSignupButtonDesktop.classList.add('hidden');
                loginSignupButtonMobile.classList.add('hidden');
                authenticatedUserMenuToggleDesktop.classList.remove('hidden');
                authenticatedUserMenuToggleMobile.classList.remove('hidden');
                userEmailDisplayDesktop.textContent = user.email;
                userEmailDisplayMobile.textContent = user.email;

                // Afficher les boutons d'administration si l'utilisateur est admin
                if (userRole === 'admin') {
                    adminGererBoutiqueDesktop.classList.remove('hidden');
                    adminGererBoutiqueMobile.classList.remove('hidden');
                    adminGenererAnnonceDesktop.classList.remove('hidden');
                    adminGenererAnnonceMobile.classList.remove('hidden');
                    adminAccesAntsDesktop.classList.remove('hidden'); // Afficher le bouton ANTS
                    adminAccesAntsMobile.classList.remove('hidden'); // Afficher le bouton ANTS
                    adminRapportReparationDesktop.classList.remove('hidden'); // Afficher le nouveau bouton Rapport de réparation
                    adminRapportReparationMobile.classList.remove('hidden'); // Afficher le nouveau bouton Rapport de réparation
                } else {
                    adminGererBoutiqueDesktop.classList.add('hidden');
                    adminGererBoutiqueMobile.classList.add('hidden');
                    adminGenererAnnonceDesktop.classList.add('hidden');
                    adminGenererAnnonceMobile.classList.add('hidden');
                    adminAccesAntsDesktop.classList.add('hidden'); // Cacher le bouton ANTS
                    adminAccesAntsMobile.classList.add('hidden'); // Cacher le bouton ANTS
                    adminRapportReparationDesktop.classList.add('hidden'); // Cacher le nouveau bouton Rapport de réparation
                    adminRapportReparationMobile.classList.add('hidden'); // Cacher le nouveau bouton Rapport de réparation
                }

            } else {
                console.log("Aucun utilisateur connecté.");
                // Afficher les éléments pour utilisateur non connecté
                loginSignupButtonDesktop.classList.remove('hidden');
                loginSignupButtonMobile.classList.remove('hidden');
                authenticatedUserMenuToggleDesktop.classList.add('hidden');
                authenticatedUserMenuToggleMobile.classList.add('hidden');
                accountMenuDesktop.classList.add('hidden'); // S'assurer que le menu est caché
                accountMenuMobile.classList.add('hidden'); // S'assurer que le menu est caché
                adminGererBoutiqueDesktop.classList.add('hidden'); // Cacher le bouton "Gérer boutique"
                adminGererBoutiqueMobile.classList.add('hidden'); // Cacher le bouton "Gérer boutique"
                adminGenererAnnonceDesktop.classList.add('hidden'); // Cacher le bouton "Générer Annonce"
                adminGenererAnnonceMobile.classList.add('hidden'); // Cacher le bouton "Générer Annonce"
                adminAccesAntsDesktop.classList.add('hidden'); // Cacher le bouton ANTS
                adminAccesAntsMobile.classList.add('hidden'); // Cacher le bouton ANTS
                adminRapportReparationDesktop.classList.add('hidden'); // Cacher le nouveau bouton Rapport de réparation
                adminRapportReparationMobile.classList.add('hidden'); // Cacher le nouveau bouton Rapport de réparation


                window.currentUserRole = null; // Effacer le rôle
                // Cacher le panneau d'administration si l'utilisateur se déconnecte
                hideAdminPanel();
            }
        });

        // --- CUSTOM ALERT MODAL (remplace alert()) ---
        function showCustomAlert(message) {
            let customAlert = document.getElementById('custom-alert');
            let closeButton;

            if (!customAlert) {
                customAlert = document.createElement('div');
                customAlert.id = 'custom-alert';
                customAlert.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[999] hidden';
                customAlert.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center relative">
                        <p id="custom-alert-message" class="text-lg font-semibold mb-4"></p>
                        <button id="custom-alert-close" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">OK</button>
                    </div>
                `;
                document.body.appendChild(customAlert);
            }

            // Toujours obtenir la référence la plus récente au bouton de fermeture
            closeButton = customAlert.querySelector('#custom-alert-close');

            // Supprimer l'écouteur existant pour éviter les doublons si la fonction est appelée plusieurs fois
            // Ceci est une programmation défensive ; idéalement, il n'est ajouté qu'une seule fois.
            const oldClickListener = customAlert._closeClickListener; // Stocker la référence à l'ancien écouteur
            if (oldClickListener) {
                closeButton.removeEventListener('click', oldClickListener);
            }

            const newClickListener = () => {
                console.log("Bouton de fermeture de l'alerte personnalisée cliqué !");
                customAlert.classList.add('hidden');
                console.log("Alerte personnalisée masquée. classList actuelle :", customAlert.classList);
            };

            if (closeButton) {
                closeButton.addEventListener('click', newClickListener);
                customAlert._closeClickListener = newClickListener; // Stocker le nouvel écouteur
            } else {
                console.error("Bouton de fermeture de l'alerte personnalisée introuvable dans la structure modale.");
            }

            // Supprimer l'écouteur de fond existant pour éviter les doublons
            const oldBackdropListener = customAlert._backdropClickListener;
            if (oldBackdropListener) {
                customAlert.removeEventListener('click', oldBackdropListener);
            }

            const newBackdropListener = (event) => {
                if (event.target === customAlert) { // Clic sur le fond de la modale
                    console.log("Fermeture de l'alerte personnalisée via le clic sur le fond.");
                    customAlert.classList.add('hidden');
                }
            };
            customAlert.addEventListener('click', newBackdropListener);
            customAlert._backdropClickListener = newBackdropListener;


            console.log("Affichage de l'alerte personnalisée avec le message :", message); // Log pour le débogage
            document.getElementById('custom-alert-message').textContent = message;
            customAlert.classList.remove('hidden');
        }

        // --- CUSTOM CONFIRM MODAL (remplace confirm()) ---
        function showCustomConfirm(message, onConfirm) {
            let customConfirm = document.getElementById('custom-confirm');
            if (!customConfirm) {
                customConfirm = document.createElement('div');
                customConfirm.id = 'custom-confirm';
                customConfirm.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[999] hidden';
                customConfirm.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center relative">
                        <p id="custom-confirm-message" class="text-lg font-semibold mb-4"></p>
                        <div class="flex justify-center space-x-4">
                            <button id="custom-confirm-ok" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">Oui</button>
                            <button id="custom-confirm-cancel" class="bg-gray-400 text-white py-2 px-4 rounded-lg hover:bg-gray-500 transition duration-300">Annuler</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(customConfirm);

                document.getElementById('custom-confirm-ok').addEventListener('click', () => {
                    customConfirm.classList.add('hidden');
                    onConfirm(true);
                });
                document.getElementById('custom-confirm-cancel').addEventListener('click', () => {
                    customConfirm.classList.add('hidden');
                    onConfirm(false);
                });
                customConfirm.addEventListener('click', (event) => {
                    if (event.target === customConfirm) {
                        customConfirm.classList.add('hidden');
                        onConfirm(false);
                    }
                });
            }
            document.getElementById('custom-confirm-message').textContent = message;
            customConfirm.classList.remove('hidden');
        }

        // --- GESTION DU PANNEAU D'ADMINISTRATION ---
        const adminPanel = document.getElementById('admin-panel');
        const mainContentSections = document.getElementById('main-content-sections'); // Nouveau wrapper
        const vehicleForm = document.getElementById('vehicle-form');
        const vehicleIdInput = document.getElementById('vehicle-id');
        const vehicleTitreAnnonceInput = document.getElementById('vehicle-titre-annonce');
        const vehicleMarqueSelect = document.getElementById('vehicle-marque');
        const vehicleModeleSelect = document.getElementById('vehicle-modele');
        const vehicleAnneeModeleInput = document.getElementById('vehicle-annee-modele');
        const vehicleDateCirculationInput = document.getElementById('vehicle-date-circulation');
        const vehicleKilometrageInput = document.getElementById('vehicle-kilometrage');
        const vehicleCarburantSelect = document.getElementById('vehicle-carburant');
        const vehicleBoiteVitesseSelect = document.getElementById('vehicle-boite-vitesse');
        const vehicleCouleurInput = document.getElementById('vehicle-couleur');
        const vehicleNbPlacesInput = document.getElementById('vehicle-nb-places');
        const vehicleNbPortesInput = document.getElementById('vehicle-nb-portes');
        const vehiclePuissanceFiscaleInput = document.getElementById('vehicle-puissance-fiscale');
        const vehiclePuissanceDINInput = document.getElementById('vehicle-puissance-din');
        const vehicleCritAirSelect = document.getElementById('vehicle-critair');
        const vehiclePrixInput = document.getElementById('vehicle-prix');
        const vehicleDescriptionInput = document.getElementById('vehicle-description');
        const vehicleImageUploadInput = document.getElementById('vehicle-image-upload');
        const imageUploadPreview = document.getElementById('image-upload-preview');
        const imageUploadSpinner = document.getElementById('image-upload-spinner');
        const vehicleImagesUrlsInput = document.getElementById('vehicle-images-urls'); // Champ caché pour les URLs Cloudinary
        const vehicleOptionsCheckboxesDiv = document.getElementById('vehicle-options-checkboxes');
        const vehicleMaintenancesCheckboxesDiv = document.getElementById('vehicle-maintenances-checkboxes'); // Nouveau: entretiens
        const vehicleVenduCheckbox = document.getElementById('vehicle-vendu'); // Nouveau: case à cocher vendu
        const vehicleHiddenCheckbox = document.getElementById('vehicle-hidden'); // NOUVEAU: case à cocher hidden

        const submitVehicleButton = document.getElementById('submit-vehicle-button');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const vehicleFormTitle = document.getElementById('vehicle-form-title');
        const adminVehicleList = document.getElementById('admin-vehicle-list');
        const adminLoadingSpinner = document.getElementById('admin-loading-spinner');
        const backToHomeButton = document.getElementById('back-to-home-button'); // Nouveau bouton

        // --- Données pour les listes déroulantes et options ---
        const carData = {
            "Renault": ["Clio", "Mégane", "Captur", "Kadjar", "Austral", "Arkana", "Twingo", "Zoe", "Scénic", "Talisman", "Espace", "Koleos", "Kangoo"],
            "Peugeot": ["206", "207", "208", "306", "307", "308", "2008", "3008", "5008", "508", "107", "108", "Rifter", "Partner", "Traveller", "Expert"],
            "Citroën": ["C1", "C2", "C3", "C4", "C5", "C4 Picasso", "Xsara", "Xsara Picasso", "C5 Aircross", "C3 Aircross", "Berlingo", "C4 Cactus", "Jumpy", "Spacetourer"],
            "Volkswagen": ["Golf", "Polo", "Tiguan", "Passat", "T-Roc", "Arteon", "Up!", "ID.3", "ID.4", "ID.5", "ID.Buzz", "Touran", "Touareg", "Caddy"],
            "Audi": ["A1", "A3", "A4", "A5", "A6", "A7", "A8", "Q2", "Q3", "Q4 e-tron", "Q5", "Q7", "Q8", "e-tron", "TT", "R8"],
            "BMW": ["Série 1", "Série 2", "Série 3", "Série 4", "Série 5", "Série 6", "Série 7", "Série 8", "X1", "X2", "X3", "X4", "X5", "X6", "X7", "Z4", "i3", "i4", "iX", "iX3", "i5", "i7"],
            "Mercedes-Benz": ["Classe A", "Classe B", "Classe C", "Classe E", "Classe S", "CLA", "CLS", "GLA", "GLC", "GLE", "GLS", "EQA", "EQB", "EQC", "EQE", "EQS", "AMG GT", "Citan", "Vito", "Sprinter"],
            "Ford": ["Fiesta", "Focus", "Puma", "Kuga", "Mustang Mach-E", "Explorer", "Edge", "Mondeo", "Galaxy", "S-Max", "Ranger", "Transit Custom", "Tourneo Custom"],
            "Toyota": ["Yaris", "Corolla", "C-HR", "RAV4", "Aygo", "Mirai", "Camry", "Prius", "Highlander", "Land Cruiser", "Hilux", "Proace"],
            "Nissan": ["Qashqai", "Note", "Juke", "X-Trail", "Micra", "Leaf", "Ariya", "Navara", "Townstar"],
            "Hyundai": ["i10", "i20", "i30", "Kona", "Tucson", "Santa Fe", "Bayon", "Ioniq 5", "Ioniq 6", "Nexo"],
            "Kia": ["Picanto", "Rio", "Ceed", "Sportage", "Niro", "EV6", "Stonic", "Xceed", "Sorento", "Soul EV"],
            "Opel": ["Corsa", "Astra", "Mokka", "Grandland", "Crossland", "Combo Life", "Zafira", "Meriva", "Vivaro"],
            "Skoda": ["Fabia", "Octavia", "Superb", "Kamiq", "Karoq", "Kodiaq", "Enyaq iV", "Scala"],
            "Seat": ["Ibiza", "Leon", "Ateca", "Arona", "Tarraco", "Toledo", "Alhambra"],
            "Fiat": ["500", "Panda", "Tipo", "500X", "500e", "Ducato", "Talento"],
            "Volvo": ["S60", "V60", "S90", "V90", "XC40", "XC60", "XC90", "C40 Recharge", "EX30", "EX90"],
            "Tesla": ["Model 3", "Model Y", "Model S", "Model X", "Cybertruck"],
            "Dacia": ["Sandero", "Duster", "Spring", "Jogger", "Lodgy", "Logan"],
            "Mazda": ["Mazda2", "Mazda3", "Mazda6", "CX-30", "CX-5", "CX-60", "CX-80", "MX-30", "MX-5"],
            "Honda": ["Civic", "CR-V", "Jazz", "HR-V", "e", "ZR-V"],
            "Suzuki": ["Alto","Swift", "Vitara", "Ignis", "S-Cross", "Jimny", "Across"],
            "Jeep": ["Renegade", "Compass", "Wrangler", "Grand Cherokee", "Avenger"],
            "Land Rover": ["Range Rover Evoque", "Discovery Sport", "Defender", "Range Rover Sport", "Discovery", "Range Rover"],
            "Porsche": ["911", "Cayenne", "Macan", "Panamera", "Taycan", "718 Boxster", "718 Cayman"],
            "Alfa Romeo": ["Mito", "Guilietta", "Giulia", "Stelvio", "Tonale"],
            "Lexus": ["IS", "ES", "LS", "RC", "LC", "UX", "NX", "RX", "RZ"],
            "Mini": ["Copper", "Copper S", "Countryman", "Clubman", "Cabrio", "Aceman"],
            "Cupra": ["Formentor", "Born", "Leon", "Ateca", "Tavascan"],
            "Polestar": ["Polestar 2", "Polestar 3", "Polestar 4"],
            "MG": ["ZS EV", "MG4 EV", "HS", "MG5 EV", "Cyberster"]
        };

        const carburants = ["Essence", "Diesel", "Électrique", "Hybride", "Hybride Rechargeable", "GPL", "E85"];
        const boiteVitesse = ["Manuelle", "Automatique"];
        const critAirOptions = ["0 (Vert)", "1", "2", "3", "4", "5", "Non classé"];

        const vehicleOptionsData = {
            "Sécurité": [
                "ABS", "ESP", "Airbags frontaux", "Airbags latéraux", "Airbags rideaux",
                "Aide au freinage d'urgence", "Contrôle de la pression des pneus",
                "Fixations ISOFIX", "Détecteur d'angle mort", "Alerte de franchissement de ligne",
                "Régulateur de vitesse adaptatif", "Caméra de recul", "Radars de stationnement avant",
                "Radars de stationnement arrière", "Phares LED", "Feux de jour LED",
                "Système de surveillance de la vigilance du conducteur", "Freinage automatique d'urgence"
            ],
            "Intérieur": [
                "Climatisation manuelle", "Climatisation automatique bi-zone", "Sièges chauffants",
                "Sièges en cuir", "Volant multifonction", "Volant chauffant", "Accoudoir central",
                "Vitres électriques avant", "Vitres électriques arrière", "Rétroviseurs électriques",
                "Écran tactile", "GPS", "Bluetooth", "Apple CarPlay", "Android Auto",
                "Prise USB", "Prise 12V", "Toit ouvrant panoramique", "Instrumentation numérique",
                "Éclairage d'ambiance", "Sellerie tissu", "Sellerie semi-cuir", "Sièges sport"
            ],
            "Extérieur": [
                "Jantes alliage", "Peinture métallisée", "Phares antibrouillard", "Barres de toit",
                "Attelage", "Vitres teintées", "Rétroviseurs rabattables électriquement",
                "Capteur de pluie", "Capteur de luminosité", "Hayon électrique", "Phares Xénon",
                "Toit ouvrant", "Becquet arrière", "Échappement sport"
            ],
            "Confort": [
                "Démarrage sans clé", "Accès mains libres", "Aide au démarrage en côte",
                "Frein de parking électrique", "Direction assistée", "Verrouillage centralisé à distance",
                "Régulateur de vitesse", "Limiteur de vitesse", "Aide au stationnement", "Sièges réglables en hauteur"
            ],
            "Autres": [
                "Carnet d'entretien", "Double des clés", "Non-fumeur", "Garantie constructeur",
                "Roue de secours", "Kit de réparation pneus", "Pack sport", "Suspension sport"
            ]
        };

        // Nouveau: Options d'entretien
        const vehicleMaintenanceData = [
            "Kit distribution + pompe à eau",
            "Vidange moteur + filtre à huile",
            "Disques et plaquettes de frein",
            "Pneumatiques",
            "Contrôle technique OK",
            "Révision complète",
            "Climatisation rechargée",
            "Amortisseurs avant",
            "Amortisseurs arrière",
            "Batterie neuve",
            "Bougies d'allumage",
            "Filtre à air",
            "Filtre à carburant",
            "Filtre d'habitacle",
            "Embrayage"
        ];

        // Cloudinary configuration
        const CLOUDINARY_CLOUD_NAME = 'dxneu57c0';
        const CLOUDINARY_UPLOAD_PRESET = 'central_cars_unsigned_upload';
        const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;


        // --- Fonctions d'initialisation des listes déroulantes et options ---
        function populateMarques(selectElement, includeAllOption = false) {
            if (includeAllOption) {
                selectElement.innerHTML = '<option value="">Toutes les marques</option>';
            } else {
                selectElement.innerHTML = '<option value="">Sélectionner une marque</option>';
            }
            for (const marque in carData) {
                const option = document.createElement('option');
                option.value = marque;
                option.textContent = marque;
                selectElement.appendChild(option);
            }
        }

        function populateModeles(selectElement, selectedMarque, includeAllOption = false) {
            if (includeAllOption) {
                selectElement.innerHTML = '<option value="">Tous les modèles</option>'; // Réinitialiser les modèles
            } else {
                selectElement.innerHTML = '<option value="">Sélectionner un modèle</option>'; // Réinitialiser les modèles
            }
            
            if (selectedMarque && carData[selectedMarque]) {
                carData[selectedMarque].forEach(modele => {
                    const option = document.createElement('option');
                    option.value = modele;
                    option.textContent = modele;
                    selectElement.appendChild(option);
                });
            }
        }

        function populateCarburants(selectElement, includeAllOption = false) {
            if (includeAllOption) {
                selectElement.innerHTML = '<option value="">Tous les carburants</option>';
            } else {
                selectElement.innerHTML = '<option value="">Sélectionner un type de carburant</option>';
            }
            carburants.forEach(carburant => {
                const option = document.createElement('option');
                option.value = carburant;
                option.textContent = carburant;
                selectElement.appendChild(option);
            });
        }

        function populateBoiteVitesse(selectElement, includeAllOption = false) {
            if (includeAllOption) {
                selectElement.innerHTML = '<option value="">Toutes les boîtes</option>';
            } else {
                selectElement.innerHTML = '<option value="">Sélectionner un type de boîte</option>';
            }
            boiteVitesse.forEach(boite => {
                const option = document.createElement('option');
                option.value = boite;
                option.textContent = boite;
                selectElement.appendChild(option);
            });
        }

        function populateCritAir(selectElement, includeAllOption = false) {
            if (includeAllOption) {
                selectElement.innerHTML = '<option value="">Toutes les vignettes</option>';
            } else {
                selectElement.innerHTML = '<option value="">Sélectionner une vignette</option>';
            }
            critAirOptions.forEach(critair => {
                const option = document.createElement('option');
                option.value = critair;
                option.textContent = critair;
                selectElement.appendChild(option);
            });
        }

        function generateOptionsCheckboxes() {
            vehicleOptionsCheckboxesDiv.innerHTML = '';
            for (const category in vehicleOptionsData) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'col-span-1';
                categoryDiv.innerHTML = `<h5 class="font-semibold text-gray-700 mb-2">${category}</h5>`;
                
                vehicleOptionsData[category].forEach(optionText => {
                    const checkboxId = `option-${optionText.replace(/\s+/g, '-').toLowerCase()}`;
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'flex items-center mb-1';
                    checkboxDiv.innerHTML = `
                        <input type="checkbox" id="${checkboxId}" name="vehicle-option" value="${optionText}" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                        <label for="${checkboxId}" class="ml-2 text-gray-700 text-sm">${optionText}</label>
                    `;
                    categoryDiv.appendChild(checkboxDiv);
                });
                vehicleOptionsCheckboxesDiv.appendChild(categoryDiv);
            }
        }

        // Nouveau: Fonction pour générer les cases à cocher d'entretien
        function generateMaintenancesCheckboxes() {
            vehicleMaintenancesCheckboxesDiv.innerHTML = '';
            vehicleMaintenanceData.forEach(maintText => {
                const checkboxId = `maint-${maintText.replace(/\s+/g, '-').replace(/[^\w-]/g, '').toLowerCase()}`; // Sanitize ID
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'flex items-center mb-1';
                checkboxDiv.innerHTML = `
                    <input type="checkbox" id="${checkboxId}" name="vehicle-maintenance" value="${maintText}" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="${checkboxId}" class="ml-2 text-gray-700 text-sm">${maintText}</label>
                `;
                vehicleMaintenancesCheckboxesDiv.appendChild(checkboxDiv);
            });
        }


        // Initialiser les listes et options au chargement
        document.addEventListener('DOMContentLoaded', () => {
            // Pour le formulaire d'admin
            populateMarques(vehicleMarqueSelect);
            populateCarburants(vehicleCarburantSelect);
            populateBoiteVitesse(vehicleBoiteVitesseSelect);
            populateCritAir(vehicleCritAirSelect);
            generateOptionsCheckboxes();
            generateMaintenancesCheckboxes(); // Initialiser les entretiens

            // Pour les filtres du client
            populateMarques(filterMarqueSelect, true);
            populateCarburants(filterCarburantSelect, true);
            populateBoiteVitesse(filterBoiteVitesseSelect, true);

            // Initialiser les checkboxes et la liste pour l'outil PDF
            generateRepairsCheckboxes();
            renderManualRepairs();
        });

        // Écouteur pour la sélection de la marque afin de mettre à jour les modèles (formulaire admin)
        vehicleMarqueSelect.addEventListener('change', (event) => {
            populateModeles(vehicleModeleSelect, event.target.value);
        });

        // Écouteur pour la sélection de la marque afin de mettre à jour les modèles (filtres client)
        filterMarqueSelect.addEventListener('change', (event) => {
            populateModeles(filterModeleSelect, event.target.value, true);
            applyFilters(); // Appliquer les filtres quand la marque change
        });


        // --- Fonctions d'upload d'images Cloudinary et Drag & Drop ---
        let uploadedImageUrls = []; // Stocke les URLs des images déjà uploadées pour le formulaire actuel
        let draggedItem = null; // Pour le drag and drop

        // Fonction pour rendre les aperçus des images
        function renderImagePreviews() {
            imageUploadPreview.innerHTML = ''; // Clear previous previews
            uploadedImageUrls.forEach((url, index) => {
                const imgDiv = document.createElement('div');
                imgDiv.className = 'image-preview-item relative group cursor-grab border-2 border-transparent rounded-lg overflow-hidden';
                imgDiv.draggable = true;
                imgDiv.dataset.url = url; // Store URL on the element for drag-drop
                imgDiv.dataset.index = index; // Store index for reordering

                imgDiv.innerHTML = `
                    <img src="${url}" class="w-full h-24 object-cover rounded-lg shadow-md">
                    <button type="button" data-url="${url}" class="remove-image-button absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity">&times;</button>
                `;
                imageUploadPreview.appendChild(imgDiv);
            });
            vehicleImagesUrlsInput.value = uploadedImageUrls.join(','); // Update hidden input
        }

        vehicleImageUploadInput.addEventListener('change', async (event) => {
            const files = event.target.files;
            if (files.length === 0) return;

            imageUploadSpinner.classList.remove('hidden');
            // uploadedImageUrls = []; // Keep existing images if not editing a new vehicle
            
            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

                try {
                    const response = await fetch(CLOUDINARY_UPLOAD_URL, {
                        method: 'POST',
                        body: formData,
                    });
                    const data = await response.json();
                    if (data.secure_url) {
                        uploadedImageUrls.push(data.secure_url);
                    } else {
                        console.error("Cloudinary upload error:", data);
                        showCustomAlert(`Erreur lors du téléchargement de l'image ${file.name}.`);
                    }
                } catch (error) {
                    console.error("Erreur réseau lors du téléchargement Cloudinary:", error);
                    showCustomAlert(`Erreur réseau lors du téléchargement de l'image ${file.name}.`);
                }
            }
            renderImagePreviews(); // Re-render all previews after upload
            imageUploadSpinner.classList.add('hidden');
        });

        // Gérer la suppression d'images de l'aperçu
        imageUploadPreview.addEventListener('click', (event) => {
            const removeButton = event.target.closest('.remove-image-button');
            if (removeButton) {
                const imageUrlToRemove = removeButton.dataset.url;
                uploadedImageUrls = uploadedImageUrls.filter(url => url !== imageUrlToRemove);
                renderImagePreviews(); // Re-render after removal
            }
        });

        // Drag and Drop Handlers
        imageUploadPreview.addEventListener('dragstart', (e) => {
            draggedItem = e.target.closest('.image-preview-item');
            if (draggedItem) {
                e.dataTransfer.setData('text/plain', draggedItem.dataset.url);
                setTimeout(() => {
                    draggedItem.classList.add('dragging');
                }, 0);
            }
        });

        imageUploadPreview.addEventListener('dragover', (e) => {
            e.preventDefault(); // Allow drop
            const targetItem = e.target.closest('.image-preview-item');
            if (targetItem && targetItem !== draggedItem) {
                targetItem.classList.add('drag-over');
            }
        });

        imageUploadPreview.addEventListener('dragleave', (e) => {
            const targetItem = e.target.closest('.image-preview-item');
            if (targetItem) {
                targetItem.classList.remove('drag-over');
            }
        });

        imageUploadPreview.addEventListener('drop', (e) => {
            e.preventDefault();
            const targetItem = e.target.closest('.image-preview-item');
            if (draggedItem && targetItem && draggedItem !== targetItem) {
                const draggedUrl = draggedItem.dataset.url;
                const targetUrl = targetItem.dataset.url;

                const draggedIndex = uploadedImageUrls.indexOf(draggedUrl);
                const targetIndex = uploadedImageUrls.indexOf(targetUrl);

                if (draggedIndex > -1 && targetIndex > -1) {
                    const [removed] = uploadedImageUrls.splice(draggedIndex, 1);
                    uploadedImageUrls.splice(targetIndex, 0, removed);
                    renderImagePreviews(); // Re-render with new order
                }
            }
            if (targetItem) {
                targetItem.classList.remove('drag-over');
            }
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
            }
        });

        imageUploadPreview.addEventListener('dragend', () => {
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
            }
            document.querySelectorAll('.image-preview-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            draggedItem = null;
        });


        // Fonction pour afficher les véhicules dans le panneau d'administration
        function displayAdminVehicles(vehicles) {
            adminVehicleList.innerHTML = '';
            if (vehicles.length === 0) {
                adminVehicleList.innerHTML = `<p class="text-center col-span-full">Aucun véhicule à gérer pour le moment.</p>`;
            } else {
                vehicles.forEach(vehicle => {
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow-lg overflow-hidden relative'; // Added relative for badge positioning
                    const imageUrl = vehicle.images && vehicle.images.length > 0 ? vehicle.images[0] : 'https://placehold.co/600x400/cccccc/ffffff?text=Image+Indisponible';
                    
                    // Add "Vendu" badge if vehicle is sold
                    const soldBadge = vehicle.vendu ? `
                        <span class="absolute top-2 left-2 bg-red-600 text-white text-xs font-bold px-3 py-1 rounded-full z-10">VENDU</span>
                    ` : '';

                    card.innerHTML = `
                        ${soldBadge}
                        <img src="${imageUrl}" alt="Image de ${vehicle.titreAnnonce || vehicle.nom}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/ffffff?text=Image+Invalide';">
                        <div class="p-4">
                            <h4 class="text-xl font-bold mb-2">${vehicle.titreAnnonce || vehicle.nom || 'N/A'}</h4>
                            <p class="text-gray-600 text-sm mb-2">${vehicle.marque || 'N/A'} - ${vehicle.modele || 'N/A'}</p>
                            <p class="text-2xl font-bold text-red-600 mb-4">${vehicle.prix ? vehicle.prix.toLocaleString('fr-FR') : 'N/A'} €</p>
                            <div class="flex items-center mb-4">
                                <input type="checkbox" id="admin-hide-${vehicle.id}" data-id="${vehicle.id}" class="admin-hide-checkbox h-4 w-4 text-gray-600 focus:ring-gray-500 border-gray-300 rounded" ${vehicle.hidden ? 'checked' : ''}>
                                <label for="admin-hide-${vehicle.id}" class="ml-2 block text-gray-700 text-sm">Cacher l'annonce</label>
                            </div>
                            <div class="flex space-x-2">
                                <button data-id="${vehicle.id}" class="edit-vehicle-button flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">Modifier</button>
                                <button data-id="${vehicle.id}" class="delete-vehicle-button flex-1 bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">Supprimer</button>
                            </div>
                        </div>
                    `;
                    adminVehicleList.appendChild(card);
                });

                // Add event listeners for the new hide checkboxes
                document.querySelectorAll('.admin-hide-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', async (event) => {
                        const vehicleId = event.target.dataset.id;
                        const isHidden = event.target.checked;
                        try {
                            await updateDoc(doc(db, "vehicules", vehicleId), { hidden: isHidden });
                            showCustomAlert(`Annonce ${isHidden ? 'cachée' : 'affichée'} avec succès !`);
                        } catch (error) {
                            console.error("Erreur lors de la mise à jour du statut 'hidden':", error);
                            showCustomAlert("Erreur lors de la mise à jour de la visibilité de l'annonce.");
                        }
                    });
                });
            }
            adminLoadingSpinner.style.display = 'none';
        }

        // --- GESTION DU PANNEAU D'ADMINISTRATION ---
        // (Le reste de votre code JavaScript pour le panneau d'administration, les modales, etc., suit ici)

        // Fonction pour afficher le panneau d'administration et masquer le contenu principal
        function showAdminPanel() {
            mainContentSections.classList.add('hidden');
            adminPanel.classList.remove('hidden');
            // Fermer toutes les modales ouvertes
            closeVehicleModal();
            closeAuthModal();
            closeVehicleContactModal(); // Fermer la modale de contact si ouverte
            closePdfToolModal(); // Fermer la modale PDF si ouverte
            // Rafraîchir la liste des véhicules dans le panneau d'administration
            listenForAdminVehicles();
            // Réinitialiser le formulaire quand on ouvre le panneau d'admin
            resetVehicleForm();
        }

        // Fonction pour masquer le panneau d'administration et afficher le contenu principal
        function hideAdminPanel() {
            adminPanel.classList.add('hidden');
            mainContentSections.classList.remove('hidden');
        }

        // Écouteurs d'événements pour les boutons "Gérer boutique"
        adminGererBoutiqueDesktop.addEventListener('click', (e) => {
            e.preventDefault();
            if (window.currentUserRole === 'admin') {
                showAdminPanel();
                accountMenuDesktop.classList.add('hidden'); // Fermer le menu
            } else {
                showCustomAlert("Vous n'avez pas les permissions pour accéder à cette section.");
            }
        });
        adminGererBoutiqueMobile.addEventListener('click', (e) => {
            e.preventDefault();
            if (window.currentUserRole === 'admin') {
                showAdminPanel();
                accountMenuMobile.classList.add('hidden'); // Fermer le menu
            } else {
                showCustomAlert("Vous n'avez pas les permissions pour accéder à cette section.");
            }
        });

        // Écouteurs d'événements pour le bouton "Générer Annonce" (qui ouvre une nouvelle page)
        adminGenererAnnonceDesktop.addEventListener('click', (e) => {
            e.preventDefault();
            if (window.currentUserRole === 'admin') {
                window.location.href = 'annonce.html'; // Ouvre annonce.html dans le même onglet
                accountMenuDesktop.classList.add('hidden'); // Fermer le menu
            } else {
                showCustomAlert("Vous n'avez pas les permissions pour accéder à cet outil.");
            }
        });
        adminGenererAnnonceMobile.addEventListener('click', (e) => {
            e.preventDefault();
            if (window.currentUserRole === 'admin') {
                window.location.href = 'annonce.html'; // Ouvre annonce.html dans le même onglet
                accountMenuMobile.classList.add('hidden'); // Fermer le menu
            } else {
                showCustomAlert("Vous n'avez pas les permissions pour accéder à cet outil.");
            }
        });

        // Écouteurs d'événements pour le bouton "Accès ANTS" (qui ouvre tools.html)
        adminAccesAntsDesktop.addEventListener('click', (e) => {
            e.preventDefault();
            if (window.currentUserRole === 'admin') {
                window.location.href = 'tools.html'; // Redirige vers tools.html
                accountMenuDesktop.classList.add('hidden'); // Fermer le menu
            } else {
                showCustomAlert("Vous n'avez pas les permissions pour accéder à cet outil.");
            }
        });
        adminAccesAntsMobile.addEventListener('click', (e) => {
            e.preventDefault();
            if (window.currentUserRole === 'admin') {
                window.location.href = 'tools.html'; // Redirige vers tools.html
                accountMenuMobile.classList.add('hidden'); // Fermer le menu
            } else {
                showCustomAlert("Vous n'avez pas les permissions pour accéder à cet outil.");
            }
        });

        // Écouteurs d'événements pour le NOUVEAU bouton "Rapport de réparation" (qui ouvre la modale PDF)
        adminRapportReparationDesktop.addEventListener('click', (e) => {
            e.preventDefault();
            if (window.currentUserRole === 'admin') {
                openPdfToolModal(); // Ouvre la modale de l'outil PDF
                accountMenuDesktop.classList.add('hidden'); // Fermer le menu
            } else {
                showCustomAlert("Vous n'avez pas les permissions pour accéder à cet outil.");
            }
        });
        adminRapportReparationMobile.addEventListener('click', (e) => {
            e.preventDefault();
            if (window.currentUserRole === 'admin') {
                openPdfToolModal(); // Ouvre la modale de l'outil PDF
                accountMenuMobile.classList.add('hidden'); // Fermer le menu
            } else {
                showCustomAlert("Vous n'avez pas les permissions pour accéder à cet outil.");
            }
        });


        // Écouteur pour le nouveau bouton "Retour à l'accueil"
        backToHomeButton.addEventListener('click', (e) => {
            e.preventDefault();
            hideAdminPanel();
        });


        // Écoute les changements de véhicules pour le panneau d'administration
        function listenForAdminVehicles() {
            const vehiclesCollection = collection(db, "vehicules");
            adminLoadingSpinner.style.display = 'block';
            onSnapshot(vehiclesCollection, (snapshot) => {
                const adminVehicles = [];
                snapshot.forEach((doc) => {
                    adminVehicles.push({ id: doc.id, ...doc.data() });
                });
                displayAdminVehicles(adminVehicles);
            }, (error) => {
                console.error("Erreur lors de la récupération des véhicules pour l'admin: ", error);
                adminLoadingSpinner.style.display = 'none';
                adminVehicleList.innerHTML = `<p class="text-center col-span-full text-red-500">Impossible de charger les véhicules pour la gestion.</p>`;
            });
        }

        // Gérer la soumission du formulaire (Ajouter/Mettre à jour un véhicule)
        vehicleForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const vehicleId = vehicleIdInput.value;
            const selectedOptions = Array.from(document.querySelectorAll('#vehicle-options-checkboxes input[name="vehicle-option"]:checked'))
                                        .map(checkbox => checkbox.value);
            const selectedMaintenances = Array.from(document.querySelectorAll('#vehicle-maintenances-checkboxes input[name="vehicle-maintenance"]:checked'))
                                                .map(checkbox => checkbox.value);

            const vehicleData = {
                titreAnnonce: vehicleTitreAnnonceInput.value,
                marque: vehicleMarqueSelect.value,
                modele: vehicleModeleSelect.value,
                anneeModele: parseInt(vehicleAnneeModeleInput.value),
                dateCirculation: vehicleDateCirculationInput.value,
                kilometrage: parseInt(vehicleKilometrageInput.value),
                carburant: vehicleCarburantSelect.value,
                boiteVitesse: vehicleBoiteVitesseSelect.value,
                couleur: vehicleCouleurInput.value,
                nbPlaces: parseInt(vehicleNbPlacesInput.value),
                nbPortes: parseInt(vehicleNbPortesInput.value),
                puissanceFiscale: parseInt(vehiclePuissanceFiscaleInput.value),
                puissanceDIN: parseInt(vehiclePuissanceDINInput.value),
                critAir: vehicleCritAirSelect.value,
                prix: parseFloat(vehiclePrixInput.value),
                description: vehicleDescriptionInput.value,
                images: uploadedImageUrls, // Utiliser les URLs de Cloudinary
                options: selectedOptions,
                maintenances: selectedMaintenances, // Nouveau: entretiens
                vendu: vehicleVenduCheckbox.checked, // Nouveau: statut vendu
                hidden: vehicleHiddenCheckbox.checked // NOUVEAU: statut caché
            };

            try {
                if (vehicleId) {
                    // Mettre à jour le véhicule existant
                    await setDoc(doc(db, "vehicules", vehicleId), vehicleData);
                    showCustomAlert("Véhicule modifié avec succès !");
                } else {
                    // Ajouter un nouveau véhicule
                    await addDoc(collection(db, "vehicules"), vehicleData);
                    showCustomAlert("Véhicule ajouté avec succès !");
                }
                resetVehicleForm(); // Réinitialiser le formulaire après succès
            } catch (error) {
                console.error("Erreur lors de l'opération sur le véhicule:", error);
                showCustomAlert("Erreur lors de l'opération sur le véhicule. Vérifiez les permissions Firebase.");
            }
        });

        // Fonction pour réinitialiser le formulaire
        function resetVehicleForm() {
            vehicleForm.reset();
            vehicleIdInput.value = '';
            submitVehicleButton.textContent = 'Ajouter le véhicule';
            vehicleFormTitle.textContent = 'Ajouter un nouveau véhicule';
            cancelEditButton.classList.add('hidden');
            imageUploadPreview.innerHTML = ''; // Clear image previews
            uploadedImageUrls = []; // Reset uploaded image URLs
            // Désélectionner toutes les options
            document.querySelectorAll('#vehicle-options-checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            // Désélectionner tous les entretiens
            document.querySelectorAll('#vehicle-maintenances-checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            // Réinitialiser la case "Vendu"
            vehicleVenduCheckbox.checked = false;
            // NOUVEAU: Réinitialiser la case "Cacher l'annonce"
            vehicleHiddenCheckbox.checked = false;
            // Réinitialiser les listes déroulantes dynamiques
            populateModeles(vehicleModeleSelect, ''); // Vide le modèle
            vehicleMarqueSelect.value = ''; // Réinitialise la marque
            vehicleCarburantSelect.value = ''; // Réinitialise le carburant
            vehicleBoiteVitesseSelect.value = ''; // Réinitialise la boîte de vitesse
            vehicleCritAirSelect.value = ''; // Réinitialise Crit'Air
        }

        // Modifier le véhicule - Remplir le formulaire
        adminVehicleList.addEventListener('click', (event) => {
            const editButton = event.target.closest('.edit-vehicle-button');
            if (editButton) {
                const idToEdit = editButton.dataset.id;
                const vehicleToEdit = allVehicles.find(v => v.id === idToEdit);
                if (vehicleToEdit) {
                    vehicleIdInput.value = vehicleToEdit.id;
                    vehicleTitreAnnonceInput.value = vehicleToEdit.titreAnnonce || '';
                    vehicleMarqueSelect.value = vehicleToEdit.marque || '';
                    // Populer les modèles en fonction de la marque, puis définir le modèle
                    populateModeles(vehicleModeleSelect, vehicleToEdit.marque); 
                    vehicleModeleSelect.value = vehicleToEdit.modele || '';

                    vehicleAnneeModeleInput.value = vehicleToEdit.anneeModele || '';
                    vehicleDateCirculationInput.value = vehicleToEdit.dateCirculation || '';
                    vehicleKilometrageInput.value = vehicleToEdit.kilometrage || '';
                    vehicleCarburantSelect.value = vehicleToEdit.carburant || '';
                    vehicleBoiteVitesseSelect.value = vehicleToEdit.boiteVitesse || '';
                    vehicleCouleurInput.value = vehicleToEdit.couleur || '';
                    vehicleNbPlacesInput.value = vehicleToEdit.nbPlaces || '';
                    vehicleNbPortesInput.value = vehicleToEdit.nbPortes || '';
                    vehiclePuissanceFiscaleInput.value = vehicleToEdit.puissanceFiscale || '';
                    vehiclePuissanceDINInput.value = vehicleToEdit.puissanceDIN || '';
                    vehicleCritAirSelect.value = vehicleToEdit.critAir || '';
                    vehiclePrixInput.value = vehicleToEdit.prix || '';
                    vehicleDescriptionInput.value = vehicleToEdit.description || '';
                    
                    // Gérer les images existantes pour l'édition
                    uploadedImageUrls = vehicleToEdit.images ? [...vehicleToEdit.images] : []; // Copy array
                    renderImagePreviews(); // Render existing images for drag-drop

                    // Gérer les options sélectionnées
                    document.querySelectorAll('#vehicle-options-checkboxes input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = vehicleToEdit.options && vehicleToEdit.options.includes(checkbox.value);
                    });

                    // Gérer les entretiens sélectionnés
                    document.querySelectorAll('#vehicle-maintenances-checkboxes input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = vehicleToEdit.maintenances && vehicleToEdit.maintenances.includes(checkbox.value);
                    });

                    // Gérer la case "Vendu"
                    vehicleVenduCheckbox.checked = vehicleToEdit.vendu || false;
                    // NOUVEAU: Gérer la case "Cacher l'annonce"
                    vehicleHiddenCheckbox.checked = vehicleToEdit.hidden || false;

                    submitVehicleButton.textContent = 'Modifier le véhicule';
                    vehicleFormTitle.textContent = 'Modifier le véhicule existant';
                    cancelEditButton.classList.remove('hidden');
                    // Faire défiler jusqu'au formulaire
                    vehicleForm.scrollIntoView({ behavior: 'smooth' });
                }
            }
        });

        // Annuler la modification
        cancelEditButton.addEventListener('click', () => {
            resetVehicleForm();
        });

        // Supprimer le véhicule
        adminVehicleList.addEventListener('click', async (event) => {
            const deleteButton = event.target.closest('.delete-vehicle-button');
            if (deleteButton) {
                const idToDelete = deleteButton.dataset.id;
                showCustomConfirm("Êtes-vous sûr de vouloir supprimer ce véhicule ?", async (confirmed) => {
                    if (confirmed) {
                        try {
                            await deleteDoc(doc(db, "vehicules", idToDelete));
                            showCustomAlert("Véhicule supprimé avec succès !");
                        } catch (error) {
                            console.error("Erreur lors de la suppression du véhicule:", error);
                            showCustomAlert("Erreur lors de la suppression du véhicule. Veuillez réessayer.");
                        }
                    }
                });
            }
        });

        // --- LOGIQUE DE FILTRAGE DES VÉHICULES ---
        function applyFilters() {
            let filteredVehicles = [...allVehicles]; // Commencez avec tous les véhicules

            const marque = filterMarqueSelect.value;
            const modele = filterModeleSelect.value;
            const carburant = filterCarburantSelect.value;
            const boiteVitesse = filterBoiteVitesseSelect.value;
            const prixMin = parseFloat(filterPrixMinInput.value);
            const prixMax = parseFloat(filterPrixMaxInput.value);
            const showSold = filterVenduCheckbox.checked;

            // Filtrer par marque
            if (marque) {
                filteredVehicles = filteredVehicles.filter(v => v.marque === marque);
            }

            // Filtrer par modèle
            if (modele) {
                filteredVehicles = filteredVehicles.filter(v => v.modele === modele);
            }

            // Filtrer par carburant
            if (carburant) {
                filteredVehicles = filteredVehicles.filter(v => v.carburant === carburant);
            }

            // Filtrer par boîte de vitesse
            if (boiteVitesse) {
                filteredVehicles = filteredVehicles.filter(v => v.boiteVitesse === boiteVitesse);
            }

            // Filtrer par prix minimum
            if (!isNaN(prixMin)) {
                filteredVehicles = filteredVehicles.filter(v => v.prix >= prixMin);
            }

            // Filtrer par prix maximum
            if (!isNaN(prixMax)) {
                filteredVehicles = filteredVehicles.filter(v => v.prix <= prixMax);
            }

            // Filtrer par statut "vendu"
            if (!showSold) {
                filteredVehicles = filteredVehicles.filter(v => !v.vendu);
            }

            displayVehicles(filteredVehicles); // Afficher les véhicules filtrés
        }

        // --- ÉCOUTEURS D'ÉVÉNEMENTS POUR LES FILTRES ---
        filterMarqueSelect.addEventListener('change', applyFilters);
        filterModeleSelect.addEventListener('change', applyFilters);
        filterCarburantSelect.addEventListener('change', applyFilters);
        filterBoiteVitesseSelect.addEventListener('change', applyFilters);
        filterPrixMinInput.addEventListener('input', applyFilters); // Utiliser 'input' pour une réaction plus rapide
        filterPrixMaxInput.addEventListener('input', applyFilters);
        filterVenduCheckbox.addEventListener('change', applyFilters);

        resetFiltersButton.addEventListener('click', () => {
            filterMarqueSelect.value = '';
            populateModeles(filterModeleSelect, '', true); // Réinitialiser les modèles aussi
            filterCarburantSelect.value = '';
            filterBoiteVitesseSelect.value = '';
            filterPrixMinInput.value = '';
            filterPrixMaxInput.value = '';
            filterVenduCheckbox.checked = false;
            applyFilters(); // Appliquer les filtres réinitialisés
        });

        // ====================================================================================================
        // NOUVEL OUTIL : GÉNÉRATION DE RAPPORT DE RÉPARATION EN PDF (intégré en modal)
        // ====================================================================================================

        // --- Références des éléments du DOM de la modale PDF ---
        const pdfToolModal = document.getElementById('pdf-tool-modal');
        const pdfToolModalContent = document.getElementById('pdf-tool-modal-content');
        const closePdfToolModalButton = document.getElementById('close-pdf-tool-modal-button');

        const repairReportForm = document.getElementById('repair-report-form');
        const marqueInput = document.getElementById('marque');
        const modeleInput = document.getElementById('modele');
        const immatriculationInput = document.getElementById('immatriculation');
        const chassisInput = document.getElementById('chassis');
        const kilometrageInput = document.getElementById('kilometrage');
        const dateCirculationInput = document.getElementById('date-circulation');
        const repairsCheckboxesDiv = document.getElementById('repairs-checkboxes');
        const manualRepairInput = document.getElementById('manual-repair-input');
        const addManualRepairButton = document.getElementById('add-manual-repair');
        const manualRepairsList = document.getElementById('manual-repairs-list');
        const observationTextarea = document.getElementById('observation');
        const generatePdfButton = document.getElementById('generate-pdf-button');

        // --- Données de la société (à adapter) ---
        const companyInfo = {
            name: "CENTRAL CARS",
            siret: "78992754800022",
            address: "123 Rue de la République, 59690 Vieux-Condé, France",
            phone: "06 98 97 94 63",
            email: "contact@centralcars.fr"
        };

        // --- Réparations pré-définies ---
        const predefinedRepairs = [
            "Kit distribution",
            "Pompe à eau",
            "Disques et plaquettes de frein",
            "Vidange moteur et filtre à huile",
            "Injecteurs",
            "Amortisseurs avant",
            "Amortisseurs arrière",
            "Pneumatiques (avant)",
            "Pneumatiques (arrière)",
            "Embrayage",
            "Boîte de vitesse",
            "Turbo",
            "Joint de culasse",
            "Batterie",
            "Alternateur",
            "Démarreur",
            "Climatisation rechargée",
            "Contrôle technique"
        ];

        let manualRepairs = []; // Pour stocker les réparations ajoutées manuellement

        // --- Fonctions d'initialisation et de gestion du formulaire PDF ---

        // Générer les cases à cocher pour les réparations pré-définies
        function generateRepairsCheckboxes() {
            repairsCheckboxesDiv.innerHTML = '';
            predefinedRepairs.forEach(repair => {
                const checkboxId = `repair-${repair.replace(/\s+/g, '-').replace(/[^\w-]/g, '').toLowerCase()}`;
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'flex items-center';
                checkboxDiv.innerHTML = `
                    <input type="checkbox" id="${checkboxId}" name="predefined-repair" value="${repair}" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="${checkboxId}" class="ml-2 text-gray-700 text-sm">${repair}</label>
                `;
                repairsCheckboxesDiv.appendChild(checkboxDiv);
            });
        }

        // Ajouter une réparation manuelle
        addManualRepairButton.addEventListener('click', () => {
            const repairText = manualRepairInput.value.trim();
            if (repairText && !manualRepairs.includes(repairText)) {
                manualRepairs.push(repairText);
                renderManualRepairs();
                manualRepairInput.value = ''; // Clear input
            } else if (manualRepairs.includes(repairText)) {
                showCustomAlert("Cette réparation a déjà été ajoutée.");
            }
        });

        // Rendre la liste des réparations manuelles
        function renderManualRepairs() {
            manualRepairsList.innerHTML = '';
            manualRepairs.forEach((repair, index) => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between bg-gray-50 p-2 rounded-md shadow-sm';
                li.innerHTML = `
                    <span class="text-gray-700">${repair}</span>
                    <button type="button" data-index="${index}" class="remove-manual-repair text-red-600 hover:text-red-800 focus:outline-none">
                        <i class="fas fa-times-circle"></i>
                    </button>
                `;
                manualRepairsList.appendChild(li);
            });

            // Ajouter les écouteurs pour la suppression
            document.querySelectorAll('.remove-manual-repair').forEach(button => {
                button.addEventListener('click', (event) => {
                    const indexToRemove = parseInt(event.currentTarget.dataset.index);
                    manualRepairs.splice(indexToRemove, 1);
                    renderManualRepairs();
                });
            });
        }

        // --- Fonctions pour ouvrir/fermer la modale PDF ---
        function openPdfToolModal() {
            if (window.currentUserRole === 'admin') {
                document.body.classList.add('modal-open');
                pdfToolModal.classList.remove('hidden');
                setTimeout(() => {
                    pdfToolModalContent.classList.remove('scale-95', 'opacity-0');
                }, 10);
                // Réinitialiser le formulaire à chaque ouverture
                resetPdfForm();
            } else {
                showCustomAlert("Vous n'avez pas les permissions pour accéder à cet outil.");
            }
        }

        function closePdfToolModal() {
            pdfToolModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                pdfToolModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            }, 300);
        }

        // Fonction pour réinitialiser le formulaire PDF
        function resetPdfForm() {
            repairReportForm.reset();
            manualRepairs = [];
            renderManualRepairs();
            // Désélectionner toutes les checkboxes
            document.querySelectorAll('#repairs-checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        // Écouteurs pour la modale PDF
        closePdfToolModalButton.addEventListener('click', closePdfToolModal);
        pdfToolModal.addEventListener('click', (event) => {
            if (event.target === pdfToolModal) {
                closePdfToolModal();
            }
        });
        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && !pdfToolModal.classList.contains('hidden')) {
                closePdfToolModal();
            }
        });

        // --- Génération du PDF ---
        generatePdfButton.addEventListener('click', async (e) => {
            e.preventDefault();

            // Récupérer les données du formulaire
            const vehicleData = {
                marque: marqueInput.value.trim(),
                modele: modeleInput.value.trim(),
                immatriculation: immatriculationInput.value.trim(),
                chassis: chassisInput.value.trim(),
                kilometrage: kilometrageInput.value.trim(),
                dateCirculation: dateCirculationInput.value.trim()
            };

            // Valider les champs requis
            for (const key in vehicleData) {
                if (!vehicleData[key]) {
                    showCustomAlert(`Veuillez remplir le champ "${key.replace(/([A-Z])/g, ' $1').toLowerCase()}".`);
                    return;
                }
            }

            const selectedPredefinedRepairs = Array.from(document.querySelectorAll('#repairs-checkboxes input[name="predefined-repair"]:checked'))
                                                .map(checkbox => checkbox.value);
            
            const allRepairs = [...selectedPredefinedRepairs, ...manualRepairs];
            const observation = observationTextarea.value.trim();
            const editionDate = new Date().toLocaleDateString('fr-FR', {
                year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });

            // Créer le document PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            let yOffset = 20;
            const margin = 20;
            const lineHeight = 7;
            const headerHeight = 40; // Espace pour l'en-tête de la société

            // Informations de la société (en-tête)
            doc.setFontSize(24);
            doc.setTextColor(204, 0, 0); // Rouge CENTRAL CARS
            doc.text(companyInfo.name, margin, yOffset);
            doc.setFontSize(10);
            doc.setTextColor(55, 65, 81); // Gris
            yOffset += lineHeight;
            doc.text(`SIRET: ${companyInfo.siret}`, margin, yOffset);
            yOffset += lineHeight;
            doc.text(companyInfo.address, margin, yOffset);
            yOffset += lineHeight;
            doc.text(`Téléphone: ${companyInfo.phone}`, margin, yOffset);
            yOffset += lineHeight;
            doc.text(`Email: ${companyInfo.email}`, margin, yOffset);

            yOffset = headerHeight + 10; // Réinitialiser yOffset après l'en-tête

            // Titre du rapport
            doc.setFontSize(18);
            doc.setTextColor(0, 0, 0); // Noir
            doc.text("Rapport de Réparation Véhicule", doc.internal.pageSize.width / 2, yOffset, { align: 'center' });
            yOffset += 15;

            // Informations du véhicule
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text("Informations du Véhicule :", margin, yOffset);
            yOffset += lineHeight;
            doc.setFont(undefined, 'normal');
            doc.text(`Marque: ${vehicleData.marque}`, margin, yOffset);
            yOffset += lineHeight;
            doc.text(`Modèle: ${vehicleData.modele}`, margin, yOffset);
            yOffset += lineHeight;
            doc.text(`Immatriculation: ${vehicleData.immatriculation}`, margin, yOffset);
            yOffset += lineHeight;
            doc.text(`Châssis (VIN): ${vehicleData.chassis}`, margin, yOffset);
            yOffset += lineHeight;
            doc.text(`Kilométrage: ${vehicleData.kilometrage} km`, margin, yOffset);
            yOffset += lineHeight;
            doc.text(`Date 1ère Circulation: ${vehicleData.dateCirculation}`, margin, yOffset);
            yOffset += 10;

            // Réparations
            doc.setFont(undefined, 'bold');
            doc.text("Réparations Effectuées :", margin, yOffset);
            yOffset += lineHeight;
            doc.setFont(undefined, 'normal');

            if (allRepairs.length > 0) {
                const repairsTableData = allRepairs.map(repair => [repair]);
                doc.autoTable({
                    startY: yOffset,
                    head: [['Description de la réparation']],
                    body: repairsTableData,
                    theme: 'striped',
                    styles: { fontSize: 10, cellPadding: 2 },
                    headStyles: { fillColor: [204, 0, 0], textColor: [255, 255, 255], fontStyle: 'bold' },
                    margin: { left: margin, right: margin },
                    didDrawPage: function (data) {
                        // Footer pour chaque page
                        doc.setFontSize(8);
                        doc.setTextColor(150);
                        doc.text(`Page ${doc.internal.getNumberOfPages()}`, doc.internal.pageSize.width - margin, doc.internal.pageSize.height - 10, { align: 'right' });
                        doc.text(`Édité le: ${editionDate}`, margin, doc.internal.pageSize.height - 10);
                    }
                });
                yOffset = doc.autoTable.previous.finalY + 10;
            } else {
                doc.text("Aucune réparation spécifiée.", margin, yOffset);
                yOffset += lineHeight + 10;
            }

            // Observation
            if (observation) {
                doc.setFont(undefined, 'bold');
                doc.text("Observation :", margin, yOffset);
                yOffset += lineHeight;
                doc.setFont(undefined, 'normal');
                // Utiliser splitTextToSize pour gérer les retours à la ligne automatiques
                const splitObservation = doc.splitTextToSize(observation, doc.internal.pageSize.width - 2 * margin);
                doc.text(splitObservation, margin, yOffset);
                yOffset += (splitObservation.length * lineHeight) + 10;
            }

            // Date d'édition (au bas de la dernière page si pas déjà dans le footer autoTable)
            if (!allRepairs.length > 0) { // Si pas de tableau, ajouter la date ici
                doc.setFontSize(10);
                doc.setTextColor(55, 65, 81); // Gris
                doc.text(`Date d'édition: ${editionDate}`, margin, doc.internal.pageSize.height - 15);
            }
            
            // Sauvegarder le PDF
            doc.save(`Rapport_Reparation_${vehicleData.marque}_${vehicleData.modele}_${vehicleData.immatriculation}.pdf`);
            showCustomAlert("Le PDF a été généré avec succès !");
            closePdfToolModal(); // Fermer la modale après génération
        });

    </script>
</body>
</html>
