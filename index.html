<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CENTRAL CARS - V√©hicules d'occasion √† Vieux-Cond√©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style pour l'animation de scroll fluide */
        html {
            scroll-behavior: smooth;
        }
        /* Style pour la barre de d√©filement */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Emp√™cher le d√©filement du corps lorsque la modale est ouverte */
        .modal-open {
            overflow: hidden;
        }
        /* Style pour le menu d√©roulant du compte */
        .account-menu {
            position: absolute;
            top: calc(100% + 10px); /* Position sous le bouton */
            right: 0;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-width: 180px;
            z-index: 60; /* Au-dessus du header */
        }
        .account-menu a, .account-menu button {
            display: block;
            padding: 0.75rem 1rem;
            text-align: left;
            width: 100%;
            color: #4a5568; /* gray-700 */
            transition: background-color 0.2s;
        }
        .account-menu a:hover, .account-menu button:hover {
            background-color: #f7fafc; /* gray-100 */
        }
        .account-menu button.logout-button {
            color: #e53e3e; /* red-600 */
            font-weight: 600;
        }
        .account-menu button.logout-button:hover {
            background-color: #ffebeb; /* red-100 */
        }
        /* Correction : Supprimer !important pour permettre aux classes Tailwind de fonctionner */
        .hidden {
            display: none;
        }

        /* Styles pour le drag and drop des images */
        .image-preview-item {
            position: relative;
            cursor: grab;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }
        .image-preview-item.dragging {
            opacity: 0.5;
            border-color: #ef4444; /* red-500 */
        }
        .image-preview-item.drag-over {
            border-color: #3b82f6; /* blue-500 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header id="header" class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#" class="text-2xl font-bold text-gray-900">
                <i class="fas fa-car-side text-red-600"></i> CENTRAL <span class="text-red-600">CARS</span>
            </a>
            <div class="hidden md:flex space-x-8 items-center relative">
                <a href="#accueil" class="text-gray-600 hover:text-red-600 transition duration-300">Accueil</a>
                <a href="#vehicules" class="text-gray-600 hover:text-red-600 transition duration-300">Nos V√©hicules</a>
                <a href="#services" class="text-gray-600 hover:text-red-600 transition duration-300">Nos Services</a>
                <a href="#contact" class="text-gray-600 hover:text-red-600 transition duration-300">Contact</a>
                
                <!-- Bouton de connexion/inscription pour les grands √©crans (non connect√©) -->
                <button id="login-signup-button-desktop" class="text-gray-600 hover:text-red-600 focus:outline-none">
                    <i class="fas fa-user-circle text-2xl"></i>
                </button>

                <!-- Bouton/Ic√¥ne de l'utilisateur connect√© pour les grands √©crans -->
                <button id="authenticated-user-menu-toggle-desktop" class="text-red-600 hover:text-red-700 focus:outline-none hidden">
                    <i class="fas fa-user-check text-2xl"></i>
                </button>

                <!-- Menu du compte (pour les grands √©crans) -->
                <div id="account-menu-desktop" class="account-menu hidden">
                    <div class="px-4 py-2 border-b text-sm text-gray-500" id="user-email-display-desktop"></div>
                    <a href="#" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Mon profil</a>
                    <a href="#" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Mes favoris</a>
                    <button id="admin-gerer-boutique-desktop" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">G√©rer boutique</button>
                    <button id="admin-generer-annonce-desktop" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">G√©n√©rer Annonce</button>
                    <button id="admin-acces-ants-desktop" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">Acc√®s ANTS</button>
                    <button id="logout-button-desktop" class="logout-button text-sm">Se d√©connecter</button>
                </div>
            </div>
            <div class="md:hidden flex items-center space-x-4 relative">
                <!-- Bouton de connexion/inscription pour les petits √©crans (non connect√©) -->
                <button id="login-signup-button-mobile" class="text-gray-600 hover:text-red-600 focus:outline-none">
                    <i class="fas fa-user-circle text-2xl"></i>
                </button>

                <!-- Bouton/Ic√¥ne de l'utilisateur connect√© pour les petits √©crans -->
                <button id="authenticated-user-menu-toggle-mobile" class="text-red-600 hover:text-red-700 focus:outline-none hidden">
                    <i class="fas fa-user-check text-2xl"></i>
                </button>

                <button id="mobile-menu-button" class="text-gray-600 hover:text-red-600 focus:outline-none">
                    <i class="fas fa-bars text-2xl"></i>
                </button>

                <!-- Menu du compte (pour les petits √©crans, affich√© via le menu mobile ou popover) -->
                <div id="account-menu-mobile" class="account-menu hidden">
                    <div class="px-4 py-2 border-b text-sm text-gray-500" id="user-email-display-mobile"></div>
                    <a href="#" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Mon profil</a>
                    <a href="#" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Mes favoris</a>
                    <button id="admin-gerer-boutique-mobile" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">G√©rer boutique</button>
                    <button id="admin-generer-annonce-mobile" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">G√©n√©rer Annonce</button>
                    <button id="admin-acces-ants-mobile" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100 hidden">Acc√®s ANTS</button>
                    <button id="logout-button-mobile" class="logout-button text-sm">Se d√©connecter</button>
                </div>
            </div>
        </nav>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-white">
            <a href="#accueil" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Accueil</a>
            <a href="#vehicules" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Nos V√©hicules</a>
            <a href="#services" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Nos Services</a>
            <a href="#contact" class="block py-2 px-4 text-sm text-gray-600 hover:bg-gray-100">Contact</a>
            <!-- Les options du menu mobile pourraient inclure la d√©connexion ici aussi si le menu popover n'est pas utilis√© -->
        </div>
    </header>

    <main>
        <!-- Wrapper pour les sections de contenu principal -->
        <div id="main-content-sections">
            <!-- Section Accueil (Hero) -->
            <section id="accueil" class="h-screen bg-cover bg-center bg-fixed flex items-center justify-center" style="background-image: url('https://images.unsplash.com/photo-1553440569-bcc63803a83d?q=80&w=2025&auto=format&fit=crop');">
                <div class="absolute inset-0 bg-black opacity-50"></div>
                <div class="text-center text-white z-10 p-4">
                    <h1 class="text-4xl md:text-6xl font-bold mb-4">CENTRAL CARS</h1>
                    <p class="text-lg md:text-2xl mb-8">Votre partenaire confiance pour les v√©hicules d'occasion √† Vieux-Cond√©.</p>
                    <a href="#vehicules" class="bg-red-600 text-white font-bold py-3 px-8 rounded-full hover:bg-red-700 transition duration-300 transform hover:scale-105">D√©couvrir nos voitures</a>
                </div>
            </section>

            <!-- Section V√©hicules -->
            <section id="vehicules" class="py-20 bg-white">
                <div class="container mx-auto px-6">
                    <h2 class="text-3xl font-bold text-center mb-2">Nos V√©hicules d'Occasion</h2>
                    <p class="text-center text-gray-500 mb-12">Des voitures s√©lectionn√©es et garanties pour votre s√©r√©nit√©.</p>
                    
                    <div id="vehicle-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <!-- Les fiches de v√©hicules seront inject√©es ici par JavaScript -->
                    </div>
                    <div id="loading-spinner" class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-red-600 text-4xl"></i>
                        <p class="mt-2 text-gray-600">Chargement des v√©hicules...</p>
                    </div>
                </div>
            </section>

            <!-- Section Nos Services -->
            <section id="services" class="py-20 bg-gray-100">
                <div class="container mx-auto px-6">
                    <h2 class="text-3xl font-bold text-center mb-12">Nos Services</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <div class="bg-white p-8 rounded-lg shadow-lg">
                            <h3 class="text-2xl font-bold mb-4 text-red-600"><i class="fas fa-wrench mr-3"></i>Entretiens et M√©canique</h3>
                            <ul class="list-disc list-inside space-y-2 text-gray-700 text-lg">
                                <li>Entretiens toutes marques (vidange, distribution, freinage, allumage, etc.)</li>
                            </ul>
                        </div>
                        <div class="bg-white p-8 rounded-lg shadow-lg">
                            <h3 class="text-2xl font-bold mb-4 text-red-600"><i class="fas fa-cogs mr-3"></i>G√©om√©trie et √âquilibrage</h3>
                            <ul class="list-disc list-inside space-y-2 text-gray-700 text-lg">
                                <li>G√©om√©trie/√âquilibrage avec montage des pneus</li>
                            </ul>
                        </div>
                        <div class="bg-white p-8 rounded-lg shadow-lg">
                            <h3 class="text-2xl font-bold mb-4 text-red-600"><i class="fas fa-key mr-3"></i>Reproduction de Cl√©s</h3>
                            <ul class="list-disc list-inside space-y-2 text-gray-700 text-lg">
                                <li>Reproduction de cl√© toutes marques (Taillage et reprogrammation)</li>
                            </ul>
                        </div>
                        <div class="md:col-span-full bg-white p-8 rounded-lg shadow-lg">
                            <h3 class="text-2xl font-bold mb-4 text-red-600"><i class="fas fa-file-alt mr-3"></i>Service Administratif (Carte Grise)</h3>
                            <ul class="list-disc list-inside space-y-2 text-gray-700 text-lg">
                                <li>Service administratif (carte grise, d√©claration de cession, v√©hicule import√©, etc...) habilit√© par le SIV.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section Contact -->
            <section id="contact" class="py-20 bg-white">
                <div class="container mx-auto px-6">
                    <h2 class="text-3xl font-bold text-center mb-12">Contactez-nous</h2>
                    <div class="flex flex-wrap -mx-4">
                        <!-- Formulaire de contact -->
                        <div class="w-full lg:w-1/2 px-4 mb-8 lg:mb-0">
                            <div class="bg-gray-100 p-8 rounded-lg shadow-lg">
                                <h3 class="text-2xl font-bold mb-6">Envoyez-nous un message</h3>
                                <form>
                                    <div class="mb-4">
                                        <label for="name" class="block text-gray-700 font-semibold mb-2">Nom complet</label>
                                        <input type="text" id="name" name="name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Votre nom">
                                    </div>
                                    <div class="mb-4">
                                        <label for="email" class="block text-gray-700 font-semibold mb-2">Email</label>
                                        <input type="email" id="email" name="email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Votre email">
                                    </div>
                                    <div class="mb-6">
                                        <label for="message" class="block text-gray-700 font-semibold mb-2">Message</label>
                                        <textarea id="message" name="message" rows="5" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Votre message..."></textarea>
                                    </div>
                                    <button type="submit" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition duration-300">Envoyer</button>
                                </form>
                            </div>
                        </div>
                        <!-- Informations de contact -->
                        <div class="w-full lg:w-1/2 px-4">
                            <div class="bg-gray-100 p-8 rounded-lg shadow-lg h-full">
                                <h3 class="text-2xl font-bold mb-6">Nos Coordonn√©es</h3>
                                <div class="space-y-6 text-lg">
                                    <p class="flex items-start">
                                        <i class="fas fa-map-marker-alt text-red-600 mt-1 mr-4 w-6 text-center"></i>
                                        <span>CENTRAL CARS<br>123 Rue de la R√©publique<br>59690 Vieux-Cond√©, France</span>
                                    </p>
                                    <p class="flex items-center">
                                        <i class="fas fa-phone text-red-600 mr-4 w-6 text-center"></i>
                                        <a href="tel:+33123456789" class="hover:text-red-600">01 23 45 67 89</a>
                                     </p>
                                    <p class="flex items-center">
                                        <i class="fas fa-envelope text-red-600 mr-4 w-6 text-center"></i>
                                        <a href="mailto:contact@centralcars.fr" class="hover:text-red-600">contact@centralcars.fr</a>
                                     </p>
                                    <p class="flex items-center">
                                        <i class="fas fa-id-card text-red-600 mr-4 w-6 text-center"></i>
                                        <span>SIRET: 78992754800022</span>
                                    </p>
                                </div>
                                <div class="mt-8">
                                    <h4 class="text-xl font-bold mb-4">Horaires d'ouverture</h4>
                                    <ul class="space-y-2">
                                        <li><strong>Lundi - Vendredi :</strong> 9h00 - 18h00</li>
                                        <li><strong>Samedi :</strong> 9h00 - 12h00</li>
                                        <li><strong>Dimanche :</strong> Ferm√©</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Admin Panel Section -->
        <section id="admin-panel" class="py-20 bg-gray-100 hidden">
            <div class="container mx-auto px-6">
                <h2 class="text-3xl font-bold text-center mb-12">G√©rer boutique</h2>

                <!-- Bouton pour revenir √† l'accueil -->
                <div class="flex justify-start mb-8">
                    <button id="back-to-home-button" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition duration-300">
                        <i class="fas fa-arrow-left mr-2"></i> Retour √† l'accueil
                    </button>
                </div>

                <!-- Formulaire d'ajout/modification de v√©hicule -->
                <div class="bg-white p-8 rounded-lg shadow-lg mb-12">
                    <h3 class="text-2xl font-bold mb-6" id="vehicle-form-title">Ajouter un nouveau v√©hicule</h3>
                    <form id="vehicle-form" class="space-y-4">
                        <input type="hidden" id="vehicle-id">
                        <div>
                            <label for="vehicle-titre-annonce" class="block text-gray-700 font-semibold mb-2">Titre de l'annonce</label>
                            <input type="text" id="vehicle-titre-annonce" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        </div>
                        <div>
                            <label for="vehicle-marque" class="block text-gray-700 font-semibold mb-2">Marque</label>
                            <select id="vehicle-marque" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                                <option value="">S√©lectionner une marque</option>
                            </select>
                        </div>
                        <div>
                            <label for="vehicle-modele" class="block text-gray-700 font-semibold mb-2">Mod√®le</label>
                            <select id="vehicle-modele" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                                <option value="">S√©lectionner un mod√®le</option>
                            </select>
                        </div>
                        <div>
                            <label for="vehicle-annee-modele" class="block text-gray-700 font-semibold mb-2">Ann√©e du mod√®le</label>
                            <input type="number" id="vehicle-annee-modele" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" min="1900" max="2099" required>
                        </div>
                        <div>
                            <label for="vehicle-date-circulation" class="block text-gray-700 font-semibold mb-2">Date de premi√®re mise en circulation (MM/AAAA)</label>
                            <input type="text" id="vehicle-date-circulation" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="MM/AAAA" pattern="(0[1-9]|1[0-2])\/(19|20)\d{2}" required>
                        </div>
                        <div>
                            <label for="vehicle-kilometrage" class="block text-gray-700 font-semibold mb-2">Kilom√©trage</label>
                            <input type="number" id="vehicle-kilometrage" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        </div>
                        <div>
                            <label for="vehicle-carburant" class="block text-gray-700 font-semibold mb-2">Carburant</label>
                            <select id="vehicle-carburant" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                                <option value="">S√©lectionner un type de carburant</option>
                            </select>
                        </div>
                        <div>
                            <label for="vehicle-boite-vitesse" class="block text-gray-700 font-semibold mb-2">Bo√Æte de vitesse</label>
                            <select id="vehicle-boite-vitesse" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                                <option value="">S√©lectionner un type de bo√Æte</option>
                            </select>
                        </div>
                        <div>
                            <label for="vehicle-couleur" class="block text-gray-700 font-semibold mb-2">Couleur</label>
                            <input type="text" id="vehicle-couleur" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                        </div>
                        <div>
                            <label for="vehicle-nb-places" class="block text-gray-700 font-semibold mb-2">Nombre de places</label>
                            <input type="number" id="vehicle-nb-places" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" min="1" max="9">
                        </div>
                        <div>
                            <label for="vehicle-nb-portes" class="block text-gray-700 font-semibold mb-2">Nombre de portes</label>
                            <input type="number" id="vehicle-nb-portes" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" min="1" max="5">
                        </div>
                        <div>
                            <label for="vehicle-puissance-fiscale" class="block text-gray-700 font-semibold mb-2">Puissance fiscale (CV)</label>
                            <input type="number" id="vehicle-puissance-fiscale" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" min="1">
                        </div>
                        <div>
                            <label for="vehicle-puissance-din" class="block text-gray-700 font-semibold mb-2">Puissance DIN (ch)</label>
                            <input type="number" id="vehicle-puissance-din" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" min="1">
                        </div>
                        <div>
                            <label for="vehicle-critair" class="block text-gray-700 font-semibold mb-2">Crit'Air</label>
                            <select id="vehicle-critair" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                                <option value="">S√©lectionner une vignette</option>
                                <option value="0">0 (Vert)</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="Non class√©">Non class√©</option>
                            </select>
                        </div>
                        <div>
                            <label for="vehicle-prix" class="block text-gray-700 font-semibold mb-2">Prix (‚Ç¨)</label>
                            <input type="number" id="vehicle-prix" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" step="0.01" required>
                        </div>
                        <div>
                            <label for="vehicle-description" class="block text-gray-700 font-semibold mb-2">Description</label>
                            <textarea id="vehicle-description" rows="4" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"></textarea>
                        </div>
                        
                        <!-- Section Options -->
                        <div class="border-t pt-4 mt-4">
                            <h4 class="text-xl font-bold mb-4">Options</h4>
                            <div id="vehicle-options-checkboxes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <!-- Les options seront g√©n√©r√©es ici par JavaScript -->
                            </div>
                        </div>

                        <!-- Section Entretiens effectu√©s -->
                        <div class="border-t pt-4 mt-4">
                            <h4 class="text-xl font-bold mb-4">Entretiens effectu√©s</h4>
                            <div id="vehicle-maintenances-checkboxes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <!-- Les entretiens seront g√©n√©r√©s ici par JavaScript -->
                            </div>
                        </div>

                        <!-- Champ "Vendu" -->
                        <div class="flex items-center mt-4">
                            <input type="checkbox" id="vehicle-vendu" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                            <label for="vehicle-vendu" class="ml-2 block text-gray-700 font-semibold">V√©hicule vendu</label>
                        </div>

                        <!-- Section Images -->
                        <div class="border-t pt-4 mt-4">
                            <h4 class="text-xl font-bold mb-4">Images du v√©hicule (glisser-d√©poser pour r√©ordonner)</h4>
                            <input type="file" id="vehicle-image-upload" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" multiple accept="image/*">
                            <div id="image-upload-preview" class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-4">
                                <!-- Les aper√ßus des images seront ici -->
                            </div>
                            <div id="image-upload-spinner" class="text-center py-4 hidden">
                                <i class="fas fa-spinner fa-spin text-red-600 text-2xl"></i>
                                <p class="mt-2 text-gray-600">T√©l√©chargement des images...</p>
                            </div>
                            <input type="hidden" id="vehicle-images-urls"> <!-- Pour stocker les URLs Cloudinary -->
                        </div>

                        <button type="submit" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition duration-300" id="submit-vehicle-button">Ajouter le v√©hicule</button>
                        <button type="button" class="w-full bg-gray-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-600 transition duration-300 mt-2 hidden" id="cancel-edit-button">Annuler la modification</button>
                    </form>
                </div>

                <!-- Liste des v√©hicules existants pour l'admin -->
                <h3 class="text-2xl font-bold text-center mb-6">V√©hicules existants</h3>
                <div id="admin-vehicle-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Les fiches de v√©hicules pour l'admin seront inject√©es ici par JavaScript -->
                </div>
                <div id="admin-loading-spinner" class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-red-600 text-4xl"></i>
                    <p class="mt-2 text-gray-600">Chargement des v√©hicules...</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8">
        <div class="container mx-auto px-6 text-center">
            <p>&copy; 2024 CENTRAL CARS. Tous droits r√©serv√©s.</p>
            <p class="text-sm text-gray-400 mt-2">Site con√ßu avec ‚ù§Ô∏è</p>
        </div>
    </footer>

    <!-- Modale de d√©tails du v√©hicule -->
    <div id="vehicle-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div id="modal-content" class="bg-white rounded-lg shadow-2xl w-11/12 md:w-3/4 lg:w-2/3 max-h-[90vh] overflow-y-auto relative transform transition-all duration-300 scale-95 opacity-0">
            <!-- Contenu de la modale inject√© par JavaScript -->
        </div>
    </div>

    <!-- Modale de contact pour le v√©hicule (nouveau) -->
    <div id="vehicle-contact-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[51] hidden">
        <div id="vehicle-contact-modal-content" class="bg-white rounded-lg shadow-2xl w-11/12 md:w-1/2 lg:w-1/3 p-8 relative transform transition-all duration-300 scale-95 opacity-0">
            <button id="close-vehicle-contact-modal-button" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 text-2xl">&times;</button>
            <h2 class="text-2xl font-bold text-center mb-6">Ce v√©hicule vous int√©resse ?</h2>
            <p class="text-center text-gray-700 mb-6">Contactez-nous pour plus d'informations ou pour prendre rendez-vous.</p>
            <div class="flex flex-col space-y-4">
                <a id="contact-phone-link" href="tel:+33123456789" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-center hover:bg-blue-700 transition duration-300 flex items-center justify-center">
                    <i class="fas fa-phone mr-3"></i> Appeler (01 23 45 67 89)
                </a>
                <a id="contact-email-link" href="mailto:contact@centralcars.fr" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-center hover:bg-green-700 transition duration-300 flex items-center justify-center">
                    <i class="fas fa-envelope mr-3"></i> Envoyer un e-mail
                </a>
            </div>
        </div>
    </div>

    <!-- Modale de connexion/inscription -->
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl w-11/12 md:w-1/2 lg:w-1/3 p-8 relative transform transition-all duration-300 scale-95 opacity-0" id="auth-modal-content">
            <button id="close-auth-modal-button" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 text-2xl">&times;</button>
            <h2 class="text-3xl font-bold text-center mb-6" id="auth-modal-title">Connexion</h2>
            
            <!-- Formulaire de connexion -->
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-gray-700 font-semibold mb-2">Email</label>
                    <input type="email" id="login-email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Votre email" required>
                </div>
                <div>
                    <label for="login-password" class="block text-gray-700 font-semibold mb-2">Mot de passe</label>
                    <input type="password" id="login-password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Votre mot de passe" required>
                </div>
                <button type="submit" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition duration-300">Se connecter</button>
            </form>

            <!-- Formulaire d'inscription (cach√© par d√©faut) -->
            <form id="signup-form" class="space-y-4 hidden">
                <div>
                    <label for="signup-email" class="block text-gray-700 font-semibold mb-2">Email</label>
                    <input type="email" id="signup-email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Votre email" required>
                </div>
                <div>
                    <label for="signup-password" class="block text-gray-700 font-semibold mb-2">Mot de passe</label>
                    <input type="password" id="signup-password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Votre mot de passe" required>
                </div>
                <button type="submit" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition duration-300">S'inscrire</button>
            </form>

            <p class="text-center mt-4">
                <button id="toggle-auth-mode" class="text-red-600 hover:underline">Pas encore de compte ? S'inscrire</button>
            </p>
        </div>
    </div>

    <!-- CUSTOM ALERT MODAL -->
    <div id="custom-alert" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[999] hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center relative">
            <p id="custom-alert-message" class="text-lg font-semibold mb-4"></p>
            <button id="custom-alert-close" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">OK</button>
        </div>
    </div>

    <!-- CUSTOM CONFIRM MODAL -->
    <div id="custom-confirm" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[999] hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center relative">
            <p id="custom-confirm-message" class="text-lg font-semibold mb-4"></p>
            <div class="flex justify-center space-x-4">
                <button id="custom-confirm-ok" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">Oui</button>
                <button id="custom-confirm-cancel" class="bg-gray-400 text-white py-2 px-4 rounded-lg hover:bg-gray-500 transition duration-300">Annuler</button>
            </div>
        </div>
    </div>

    <script type="module">
        // ====================================================================================================
        // IMPORTANT : CONFIGURATION DES R√àGLES DE S√âCURIT√â FIREBASE FIRESTORE
        //
        // L'erreur "Missing or insufficient permissions" indique que les r√®gles de s√©curit√© de votre base de donn√©es
        // Firebase ne permettent pas √† l'utilisateur actuel d'effectuer l'op√©ration demand√©e.
        //
        // VOUS DEVEZ APPLIQUER CES R√àGLES DANS VOTRE CONSOLE FIREBASE :
        // 1. Allez sur https://console.firebase.google.com/
        // 2. S√©lectionnez votre projet.
        // 3. Dans le menu de gauche, cliquez sur "Firestore Database".
        // 4. Cliquez sur l'onglet "R√®gles".
        // 5. REMPLACEZ LE CONTENU EXISTANT par les r√®gles ci-dessous :
        /*
        rules_version = '2';
        service cloud.firestore {
            match /databases/{database}/documents {

                // R√®gle pour les profils utilisateurs (r√¥les)
                // Chaque utilisateur peut lire et √©crire son propre document 'user_data'
                match /artifacts/{appId}/users/{userId}/profile/user_data {
                    allow read, write: if request.auth != null && request.auth.uid == userId;
                }

                // R√®gle pour la collection 'vehicules'
                match /vehicules/{vehicleId} {
                    // Tous les utilisateurs (authentifi√©s ou non) peuvent lire les v√©hicules
                    allow read: if true;

                    // Seuls les administrateurs peuvent cr√©er, mettre √† jour et supprimer des v√©hicules
                    // Pour v√©rifier le r√¥le, nous lisons le document 'user_data' de l'utilisateur connect√©.
                    allow create, update, delete: if request.auth != null && get(/databases/$(database)/documents/artifacts/$(app.id)/users/$(request.auth.uid)/profile/user_data).data.role == 'admin';
                }
            }
        }
        */
        // 6. Cliquez sur "Publier" pour sauvegarder les r√®gles.
        //
        // ASSUREZ-VOUS √âGALEMENT QU'UN UTILISATEUR A BIEN LE R√îLE 'admin' DANS FIRESTORE :
        // Pour qu'un utilisateur puisse utiliser le panneau d'administration, son r√¥le doit √™tre 'admin'.
        // Apr√®s vous √™tre connect√© avec un compte, allez dans Firestore Database -> onglet "Donn√©es" :
        // artifacts -> votre_app_id -> users -> {UID_DE_L_UTILISATEUR} -> profile -> user_data
        // Modifiez le champ 'role' √† 'admin'.
        // ====================================================================================================

        // --- IMPORTS ET CONFIGURATION FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, addDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";


        // Configuration Firebase fournie
        const __app_id = 'central-cars-a37ae';
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyC1RQ5m7_utiAEsvyobIuuwxzAzBLx27Sw",
            authDomain: "central-cars-a37ae.firebaseapp.com",
            projectId: "central-cars-a37ae",
            storageBucket: "central-cars-a37ae.firebaseapp.com",
            messagingSenderId: "297273470734",
            appId: "1:297273470734:web:7d35e6619b28dc569d715f",
            measurementId: "G-4LXQG2VWP2"
        });

        const firebaseConfig = JSON.parse(__firebase_config);

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- VARIABLES GLOBALES ---
        let allVehicles = []; // Pour stocker tous les v√©hicules r√©cup√©r√©s
        window.currentUserRole = null; // Variable globale pour le r√¥le de l'utilisateur

        // --- GESTION DU MENU MOBILE ---
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

        // --- FONCTION POUR AFFICHER LES V√âHICULES (C√¥t√© client) ---
        function displayVehicles(vehicles) {
            const vehicleList = document.getElementById('vehicle-list');
            const loadingSpinner = document.getElementById('loading-spinner');
            vehicleList.innerHTML = ''; // Vider la liste existante

            if (vehicles.length === 0) {
                 vehicleList.innerHTML = `<p class="text-center col-span-full">Aucun v√©hicule disponible pour le moment.</p>`;
            } else {
                // Sort vehicles: not sold (vendu: false) first, then sold (vendu: true)
                vehicles.sort((a, b) => {
                    // If 'vendu' is true, it means it's sold, so it should come after non-sold vehicles.
                    // If 'vendu' is false, it means it's not sold, so it should come before sold vehicles.
                    // We want false (0) to come before true (1). So, a.vendu - b.vendu will work.
                    // If a.vendu is false (0) and b.vendu is true (1), 0 - 1 = -1 (a comes before b)
                    // If both are same, 0 - 0 = 0 or 1 - 1 = 0 (order doesn't change)
                    return (a.vendu || false) - (b.vendu || false);
                });

                vehicles.forEach(vehicle => {
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow-lg overflow-hidden transform hover:-translate-y-2 transition-transform duration-300 relative'; // Added relative for badge positioning
                    // Utilise une image de secours si la premi√®re image n'est pas d√©finie
                    const imageUrl = vehicle.images && vehicle.images.length > 0 ? vehicle.images[0] : 'https://placehold.co/600x400/cccccc/ffffff?text=Image+Indisponible';
                    
                    // Add "Vendu" badge if vehicle is sold
                    const soldBadge = vehicle.vendu ? `
                        <span class="absolute top-2 left-2 bg-red-600 text-white text-xs font-bold px-3 py-1 rounded-full z-10">VENDU</span>
                    ` : '';

                    card.innerHTML = `
                        ${soldBadge}
                        <img src="${imageUrl}" alt="Image de ${vehicle.nom}" class="w-full h-56 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/ffffff?text=Image+Invalide';">
                        <div class="p-6">
                            <h3 class="text-2xl font-bold mb-2">${vehicle.titreAnnonce || vehicle.nom || 'Titre non disponible'}</h3>
                            <p class="text-gray-600 mb-2">${vehicle.marque || 'N/A'} - ${vehicle.modele || 'N/A'}</p>
                            <div class="text-gray-600 mb-4 space-y-1">
                                <p><i class="fas fa-calendar-alt w-6 text-red-500"></i> ${vehicle.anneeModele || 'N/A'}</p>
                                <p><i class="fas fa-tachometer-alt w-6 text-red-500"></i> ${vehicle.kilometrage ? vehicle.kilometrage.toLocaleString('fr-FR') : 'N/A'} km</p>
                                <p><i class="fas fa-gas-pump w-6 text-red-500"></i> ${vehicle.carburant || 'N/A'}</p>
                            </div>
                            <p class="text-3xl font-bold text-red-600 mb-4">${vehicle.prix ? vehicle.prix.toLocaleString('fr-FR') : 'N/A'} ‚Ç¨</p>
                            <button data-id="${vehicle.id}" class="details-button w-full bg-gray-800 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-900 transition duration-300">
                                Voir les d√©tails
                            </button>
                        </div>
                    `;
                    vehicleList.appendChild(card);
                });
            }
             loadingSpinner.style.display = 'none';
        }

        // --- GESTION DE LA MODALE DE D√âTAILS DU V√âHICULE ---
        const vehicleModal = document.getElementById('vehicle-modal');
        const vehicleModalContent = document.getElementById('modal-content');
        const contactPhone = '0123456789'; // D√©finir le num√©ro de t√©l√©phone ici
        const contactEmail = 'contact@centralcars.fr'; // D√©finir l'adresse email ici

        function openVehicleModal(vehicle) {
            let currentImageIndex = 0;
            const images = vehicle.images && vehicle.images.length > 0 ? vehicle.images : ['https://placehold.co/800x600/cccccc/ffffff?text=Image+Indisponible'];

            // Add "Vendu" badge if vehicle is sold
            const soldBadgeModal = vehicle.vendu ? `
                <span class="absolute top-4 left-4 bg-red-600 text-white text-lg font-bold px-4 py-2 rounded-full z-10">VENDU</span>
            ` : '';

            vehicleModalContent.innerHTML = `
                <button id="close-vehicle-modal-button" class="absolute top-4 right-4 text-white bg-black bg-opacity-50 rounded-full w-8 h-8 flex items-center justify-center text-2xl hover:bg-opacity-75 z-20">&times;</button>
                
                <div class="w-full h-64 md:h-96 relative">
                    ${soldBadgeModal}
                    <img id="modal-image" src="${images[0]}" alt="Image principale de ${vehicle.titreAnnonce || vehicle.nom}" class="w-full h-full object-cover rounded-t-lg" onerror="this.onerror=null;this.src='https://placehold.co/800x600/cccccc/ffffff?text=Image+Invalide';">
                    <div id="modal-image-prev" class="absolute left-0 top-1/2 -translate-y-1/2 p-2 m-2 bg-black bg-opacity-50 text-white rounded-full cursor-pointer hover:bg-opacity-75 ${images.length <= 1 ? 'hidden' : ''}"><i class="fas fa-chevron-left"></i></div>
                    <div id="modal-image-next" class="absolute right-0 top-1/2 -translate-y-1/2 p-2 m-2 bg-black bg-opacity-50 text-white rounded-full cursor-pointer hover:bg-opacity-75 ${images.length <= 1 ? 'hidden' : ''}"><i class="fas fa-chevron-right"></i></div>
                </div>

                <div class="p-6 md:p-8">
                    <h2 class="text-3xl font-bold mb-2">${vehicle.titreAnnonce || vehicle.nom || 'Titre non disponible'}</h2>
                    <p class="text-xl text-gray-700 mb-4">${vehicle.marque || 'N/A'} - ${vehicle.modele || 'N/A'}</p>
                    <p class="text-4xl font-bold text-red-600 mb-6">${vehicle.prix ? vehicle.prix.toLocaleString('fr-FR') : 'N/A'} ‚Ç¨</p>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center mb-6">
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.anneeModele || 'N/A'}</div><div class="text-sm text-gray-600">Ann√©e Mod√®le</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.dateCirculation || 'N/A'}</div><div class="text-sm text-gray-600">1√®re circulation</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.kilometrage ? vehicle.kilometrage.toLocaleString('fr-FR') : 'N/A'}</div><div class="text-sm text-gray-600">Km</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.carburant || 'N/A'}</div><div class="text-sm text-gray-600">Carburant</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.boiteVitesse || 'N/A'}</div><div class="text-sm text-gray-600">Bo√Æte</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.couleur || 'N/A'}</div><div class="text-sm text-gray-600">Couleur</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.nbPlaces || 'N/A'}</div><div class="text-sm text-gray-600">Places</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.nbPortes || 'N/A'}</div><div class="text-sm text-gray-600">Portes</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.puissanceFiscale || 'N/A'} CV</div><div class="text-sm text-gray-600">Puissance Fisc.</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.puissanceDIN || 'N/A'} ch</div><div class="text-sm text-gray-600">Puissance DIN</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-lg">${vehicle.critAir || 'N/A'}</div><div class="text-sm text-gray-600">Crit'Air</div></div>
                    </div>

                    <h3 class="text-xl font-bold mb-3 border-b pb-2">Description</h3>
                    <p class="text-gray-700 mb-6">${vehicle.description || 'Aucune description.'}</p>

                    <h3 class="text-xl font-bold mb-3 border-b pb-2">√âquipements et options</h3>
                    <ul class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 text-gray-700">
                        ${(vehicle.options && vehicle.options.length > 0) ? vehicle.options.map(opt => `<li><i class="fas fa-check-circle text-green-500 mr-2"></i>${opt}</li>`).join('') : '<li>Aucune option sp√©cifi√©e.</li>'}
                    </ul>

                    <h3 class="text-xl font-bold mb-3 border-b pb-2 mt-6">Entretiens effectu√©s</h3>
                    <ul class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 text-gray-700">
                        ${(vehicle.maintenances && vehicle.maintenances.length > 0) ? vehicle.maintenances.map(maint => `<li><i class="fas fa-wrench text-blue-500 mr-2"></i>${maint}</li>`).join('') : '<li>Aucun entretien sp√©cifi√©.</li>'}
                    </ul>

                    <div class="mt-8 pt-4 border-t border-gray-200 text-sm text-gray-700 leading-relaxed">
                        <p>Tarif hors carte grise.</p>
                        <p class="mt-2">üßëüèº‚Äçüîß Garantie moteur et bo√Æte 6 mois (extension de garantie possible).</p>
                        <p class="mt-2">üá´üá∑üá´üá∑HABILIT√âE SERVICE CARTE GRISE üá´üá∑üá´üá∑</p>
                        <p>Habilit√© par le Agence Nationale des Titres S√©curis√©s.</p>
                        <p>Nous nous occupons de toutes les d√©marches administratives d'immatriculation !</p>
                        <p class="mt-4 font-semibold">Pour faciliter les d√©marches administratives pensez a vous munir des pi√®ces suivantes lors de votre visite : </p>
                        <ul class="list-disc list-inside ml-4">
                            <li>üî∏Pi√®ce d'identit√© en cours de validit√©.</li>
                            <li>üî∏Permis de conduire en cours de validit√©.</li>
                            <li>üî∏Justificatif de domicile moins de 3 mois (facture ou avis d'imposition).</li>
                            <li>üî∏En cas d'h√©bergement : une attestation d'h√©bergement et la copie de la carte d'identit√© de l'h√©bergeur.</li>
                        </ul>
                        <p class="mt-4 font-bold text-lg text-center">üü•üü¶ CENTRAL CARS üü•üü¶</p>
                        <p class="text-center">üì´576 Rue Marcel Sembat</p>
                        <p class="text-center">59690 Vieux-cond√©</p>
                        <p class="mt-4 font-bold text-center">‚è∞HORAIRES D'OUVERTURE‚è∞</p>
                        <p class="text-center">- Du lundi au vendredi : 09H00-12H00 / 14H00-17h30</p>
                        <p class="text-center">- SAMEDI : 9h30 -12h 14h30 - 17H00</p>
                        <p class="mt-4 text-red-600 font-semibold text-center">‚ö† Merci de prendre rendez-vous par t√©l√©phone avant votre venue afin de mieux pouvoir vous accueillir et de vous assurez de la disponibilit√© du v√©hicule ‚ö†</p>
                        <p class="mt-4 text-xs text-gray-500 text-center">*sous r√©serve d‚Äôerreurs lors de l‚Äô√©dition des annonce.</p>
                    </div>

                     <div class="mt-8 text-center">
                        <button id="contact-us-button" class="bg-red-600 text-white font-bold py-3 px-8 rounded-full hover:bg-red-700 transition duration-300">Ce v√©hicule m'int√©resse</button>
                    </div>
                </div>
            `;
            
            document.body.classList.add('modal-open');
            vehicleModal.classList.remove('hidden');
            setTimeout(() => {
                vehicleModalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);

            // --- Logique de la galerie d'images ---
            const modalImage = document.getElementById('modal-image');
            const prevBtn = document.getElementById('modal-image-prev');
            const nextBtn = document.getElementById('modal-image-next');

            function updateImage() {
                modalImage.src = images[currentImageIndex];
            }

            if (images.length > 1) {
                prevBtn.addEventListener('click', () => {
                    currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
                    updateImage();
                });

                nextBtn.addEventListener('click', () => {
                    currentImageIndex = (currentImageIndex + 1) % images.length;
                    updateImage();
                });
            }

            // --- Fermeture de la modale ---
            document.getElementById('close-vehicle-modal-button').addEventListener('click', closeVehicleModal);
            
            // Ouvrir la modale de contact lorsque le bouton "Ce v√©hicule m'int√©resse" est cliqu√©
            document.getElementById('contact-us-button').addEventListener('click', () => {
                closeVehicleModal(); // Ferme la modale de d√©tails du v√©hicule
                openVehicleContactModal(); // Ouvre la nouvelle modale de contact
            });
        }

        function closeVehicleModal() {
            vehicleModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                vehicleModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            }, 300);
        }

        // Fermer la modale en cliquant en dehors ou avec la touche Echap
        vehicleModal.addEventListener('click', (event) => {
            if (event.target === vehicleModal) {
                closeVehicleModal();
            }
        });
        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && !vehicleModal.classList.contains('hidden')) {
                closeVehicleModal();
            }
        });

        // Ajouter les √©couteurs d'√©v√©nements sur les boutons "D√©tails"
        document.getElementById('vehicle-list').addEventListener('click', (event) => {
            const detailsButton = event.target.closest('.details-button');
            if (detailsButton) {
                const vehicleId = detailsButton.dataset.id;
                const vehicle = allVehicles.find(v => v.id === vehicleId);
                if (vehicle) {
                    openVehicleModal(vehicle);
                }
            }
        });
        
        // --- CHARGEMENT DES DONN√âES DEPUIS FIRESTORE ---
        function listenForVehicles() {
            const vehiclesCollection = collection(db, "vehicules");
            const loadingSpinner = document.getElementById('loading-spinner');
            const vehicleList = document.getElementById('vehicle-list');

            onSnapshot(vehiclesCollection, (snapshot) => {
                allVehicles = []; // Vider la liste pour la reconstruire
                snapshot.forEach((doc) => {
                    allVehicles.push({ id: doc.id, ...doc.data() });
                });
                displayVehicles(allVehicles);
                loadingSpinner.style.display = 'none';
            }, (error) => {
                console.error("Erreur lors de la r√©cup√©ration des v√©hicules: ", error);
                loadingSpinner.style.display = 'none';
                vehicleList.innerHTML = `<p class="text-center col-span-full text-red-500">Impossible de charger les v√©hicules. V√©rifiez la console pour plus de d√©tails.</p>`;
            });
        }

        // D√©marrer l'√©coute des donn√©es
        listenForVehicles();

        // --- GESTION DE LA MODALE DE CONTACT DU V√âHICULE (NOUVEAU) ---
        const vehicleContactModal = document.getElementById('vehicle-contact-modal');
        const vehicleContactModalContent = document.getElementById('vehicle-contact-modal-content');
        const closeVehicleContactModalButton = document.getElementById('close-vehicle-contact-modal-button');
        const contactPhoneLink = document.getElementById('contact-phone-link');
        const contactEmailLink = document.getElementById('contact-email-link');

        function openVehicleContactModal() {
            // Mettre √† jour les liens avec les informations de contact d√©finies
            contactPhoneLink.href = `tel:${contactPhone}`;
            contactPhoneLink.textContent = `Appeler (${contactPhone.replace(/(\d{2})(?=\d)/g, '$1 ').trim()})`; // Formatage du num√©ro
            contactEmailLink.href = `mailto:${contactEmail}`;

            document.body.classList.add('modal-open');
            vehicleContactModal.classList.remove('hidden');
            setTimeout(() => {
                vehicleContactModalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeVehicleContactModal() {
            vehicleContactModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                vehicleContactModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            }, 300);
        }

        closeVehicleContactModalButton.addEventListener('click', closeVehicleContactModal);
        vehicleContactModal.addEventListener('click', (event) => {
            if (event.target === vehicleContactModal) {
                closeVehicleContactModal();
            }
        });
        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && !vehicleContactModal.classList.contains('hidden')) {
                closeVehicleContactModal();
            }
        });


        // --- GESTION DE LA MODALE DE CONNEXION/INSCRIPTION ---
        const authModal = document.getElementById('auth-modal');
        const authModalContent = document.getElementById('auth-modal-content');
        const closeAuthModalButton = document.getElementById('close-auth-modal-button');
        const loginSignupButtonDesktop = document.getElementById('login-signup-button-desktop');
        const loginSignupButtonMobile = document.getElementById('login-signup-button-mobile');
        const authModalTitle = document.getElementById('auth-modal-title');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const toggleAuthModeButton = document.getElementById('toggle-auth-mode');

        function openAuthModal() {
            document.body.classList.add('modal-open');
            authModal.classList.remove('hidden');
            setTimeout(() => {
                authModalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeAuthModal() {
            authModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                authModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            }, 300);
        }

        loginSignupButtonDesktop.addEventListener('click', openAuthModal);
        loginSignupButtonMobile.addEventListener('click', openAuthModal);
        closeAuthModalButton.addEventListener('click', closeAuthModal);

        authModal.addEventListener('click', (event) => {
            if (event.target === authModal) {
                closeAuthModal();
            }
        });

        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && !authModal.classList.contains('hidden')) {
                closeAuthModal();
            }
        });

        toggleAuthModeButton.addEventListener('click', () => {
            if (loginForm.classList.contains('hidden')) {
                // Passer au mode connexion
                authModalTitle.textContent = 'Connexion';
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
                toggleAuthModeButton.textContent = 'Pas encore de compte ? S\'inscrire';
            } else {
                // Passer au mode inscription
                authModalTitle.textContent = 'Inscription';
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                toggleAuthModeButton.textContent = 'D√©j√† un compte ? Se connecter';
            }
        });

        // --- GESTION DE L'AUTHENTIFICATION FIREBASE ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                closeAuthModal();
                // G√©rer la connexion r√©ussie (ex: afficher un message, rediriger)
                console.log("Connexion r√©ussie !");
            } catch (error) {
                console.error("Erreur de connexion:", error.message);
                // Afficher un message d'erreur √† l'utilisateur
                // Utiliser une modale personnalis√©e en production au lieu d'alert
                const errorMessage = error.message.includes('auth/invalid-email') ? 'Adresse email invalide.' :
                                     error.message.includes('auth/user-not-found') ? 'Aucun utilisateur trouv√© avec cet email.' :
                                     error.message.includes('auth/wrong-password') ? 'Mot de passe incorrect.' :
                                     'Erreur de connexion. Veuillez r√©essayer.';
                showCustomAlert(errorMessage);
            }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = signupForm['signup-email'].value;
            const password = signupForm['signup-password'].value;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                // Cr√©er un document utilisateur avec un r√¥le par d√©faut 'client'
                await setDoc(doc(db, `artifacts/${__app_id}/users/${user.uid}/profile`, 'user_data'), {
                    email: user.email,
                    role: 'client' // R√¥le par d√©faut
                });
                closeAuthModal();
                // G√©rer l'inscription r√©ussie
                console.log("Inscription r√©ussie !");
            } catch (error) {
                console.error("Erreur d'inscription:", error.message);
                // Afficher un message d'erreur √† l'utilisateur
                // Utiliser une modale personnalis√©e en production au lieu d'alert
                const errorMessage = error.message.includes('auth/email-already-in-use') ? 'Cet email est d√©j√† utilis√©.' :
                                     error.message.includes('auth/weak-password') ? 'Le mot de passe doit contenir au moins 6 caract√®res.' :
                                     'Erreur d\'inscription. Veuillez r√©essayer.';
                showCustomAlert(errorMessage);
            }
        });

        // --- GESTION DU MENU DU COMPTE UTILISATEUR ET DU R√îLE ---
        const authenticatedUserMenuToggleDesktop = document.getElementById('authenticated-user-menu-toggle-desktop');
        const authenticatedUserMenuToggleMobile = document.getElementById('authenticated-user-menu-toggle-mobile');
        const accountMenuDesktop = document.getElementById('account-menu-desktop');
        const accountMenuMobile = document.getElementById('account-menu-mobile');
        const logoutButtonDesktop = document.getElementById('logout-button-desktop');
        const logoutButtonMobile = document.getElementById('logout-button-mobile');
        const userEmailDisplayDesktop = document.getElementById('user-email-display-desktop');
        const userEmailDisplayMobile = document.getElementById('user-email-display-mobile');
        const adminGererBoutiqueDesktop = document.getElementById('admin-gerer-boutique-desktop');
        const adminGererBoutiqueMobile = document.getElementById('admin-gerer-boutique-mobile');
        const adminGenererAnnonceDesktop = document.getElementById('admin-generer-annonce-desktop'); // Nouveau bouton
        const adminGenererAnnonceMobile = document.getElementById('admin-generer-annonce-mobile'); // Nouveau bouton
        const adminAccesAntsDesktop = document.getElementById('admin-acces-ants-desktop'); // Nouveau bouton ANTS
        const adminAccesAntsMobile = document.getElementById('admin-acces-ants-mobile'); // Nouveau bouton ANTS


        function toggleAccountMenu(menuElement) {
            menuElement.classList.toggle('hidden');
        }

        authenticatedUserMenuToggleDesktop.addEventListener('click', (event) => {
            event.stopPropagation(); // Emp√™che la fermeture imm√©diate par le document listener
            toggleAccountMenu(accountMenuDesktop);
            accountMenuMobile.classList.add('hidden'); // S'assurer que l'autre menu est ferm√©
        });

        authenticatedUserMenuToggleMobile.addEventListener('click', (event) => {
            event.stopPropagation(); // Emp√™che la fermeture imm√©diate par le document listener
            toggleAccountMenu(accountMenuMobile);
            accountMenuDesktop.classList.add('hidden'); // S'assurer que l'autre menu est ferm√©
        });

        // Fermer les menus si on clique en dehors
        document.addEventListener('click', (event) => {
            if (!accountMenuDesktop.contains(event.target) && !authenticatedUserMenuToggleDesktop.contains(event.target)) {
                accountMenuDesktop.classList.add('hidden');
            }
            if (!accountMenuMobile.contains(event.target) && !authenticatedUserMenuToggleMobile.contains(event.target)) {
                accountMenuMobile.classList.add('hidden');
            }
        });

        // Boutons de d√©connexion
        logoutButtonDesktop.addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log("D√©connexion r√©ussie !");
                accountMenuDesktop.classList.add('hidden'); // Cacher le menu apr√®s d√©connexion
                showCustomAlert("Vous avez √©t√© d√©connect√©.");
            } catch (error) {
                console.error("Erreur de d√©connexion:", error.message);
                showCustomAlert("Erreur lors de la d√©connexion. Veuillez r√©essayer.");
            }
        });

        logoutButtonMobile.addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log("D√©connexion r√©ussie !");
                accountMenuMobile.classList.add('hidden'); // Cacher le menu apr√®s d√©connexion
                showCustomAlert("Vous avez √©t√© d√©connect√©.");
            } catch (error) {
                console.error("Erreur de d√©connexion:", error.message);
                showCustomAlert("Erreur lors de la d√©connexion. Veuillez r√©essayer.");
            }
        });


        // G√©rer l'√©tat de l'authentification (optionnel, pour afficher/masquer des √©l√©ments)
        onAuthStateChanged(auth, async (user) => { // Rendre la fonction async
            if (user) {
                console.log("Utilisateur connect√©:", user.email);
                
                const userRef = doc(db, `artifacts/${__app_id}/users/${user.uid}/profile`, 'user_data');
                console.log("Chemin du document de r√¥le utilisateur:", userRef.path); // Pour le d√©bogage
                console.log("ID de l'application (__app_id):", __app_id); // Pour le d√©bogage
                console.log("UID de l'utilisateur:", user.uid); // Pour le d√©bogage

                let userRole = 'client'; // R√¥le par d√©faut

                try {
                    const userDoc = await getDoc(userRef);
                    if (userDoc.exists()) {
                        userRole = userDoc.data().role || 'client';
                        console.log("R√¥le de l'utilisateur r√©cup√©r√©:", userRole); // Pour le d√©bogage
                    } else {
                        // Si le document n'existe pas (nouvel utilisateur ou ancien sans r√¥le), le cr√©er avec 'client'
                        await setDoc(userRef, { email: user.email, role: 'client' });
                        userRole = 'client';
                        console.log("Document de r√¥le utilisateur cr√©√© avec le r√¥le par d√©faut 'client'."); // Pour le d√©bogage
                    }
                } catch (error) {
                    console.error("Erreur lors de la r√©cup√©ration/cr√©ation du r√¥le utilisateur:", error);
                }

                window.currentUserRole = userRole; // Rendre le r√¥le accessible globalement

                // Afficher les √©l√©ments pour utilisateur connect√©
                loginSignupButtonDesktop.classList.add('hidden');
                loginSignupButtonMobile.classList.add('hidden');
                authenticatedUserMenuToggleDesktop.classList.remove('hidden');
                authenticatedUserMenuToggleMobile.classList.remove('hidden');
                userEmailDisplayDesktop.textContent = user.email;
                userEmailDisplayMobile.textContent = user.email;

                // Afficher les boutons d'administration si l'utilisateur est admin
                if (userRole === 'admin') {
                    adminGererBoutiqueDesktop.classList.remove('hidden');
                    adminGererBoutiqueMobile.classList.remove('hidden');
                    adminGenererAnnonceDesktop.classList.remove('hidden');
                    adminGenererAnnonceMobile.classList.remove('hidden');
                    adminAccesAntsDesktop.classList.remove('hidden'); // Afficher le bouton ANTS
                    adminAccesAntsMobile.classList.remove('hidden'); // Afficher le bouton ANTS
                } else {
                    adminGererBoutiqueDesktop.classList.add('hidden');
                    adminGererBoutiqueMobile.classList.add('hidden');
                    adminGenererAnnonceDesktop.classList.add('hidden');
                    adminGenererAnnonceMobile.classList.add('hidden');
                    adminAccesAntsDesktop.classList.add('hidden'); // Cacher le bouton ANTS
                    adminAccesAntsMobile.classList.add('hidden'); // Cacher le bouton ANTS
                }

            } else {
                console.log("Aucun utilisateur connect√©.");
                // Afficher les √©l√©ments pour utilisateur non connect√©
                loginSignupButtonDesktop.classList.remove('hidden');
                loginSignupButtonMobile.classList.remove('hidden');
                authenticatedUserMenuToggleDesktop.classList.add('hidden');
                authenticatedUserMenuToggleMobile.classList.add('hidden');
                accountMenuDesktop.classList.add('hidden'); // S'assurer que le menu est cach√©
                accountMenuMobile.classList.add('hidden'); // S'assurer que le menu est cach√©
                adminGererBoutiqueDesktop.classList.add('hidden'); // Cacher le bouton "G√©rer boutique"
                adminGererBoutiqueMobile.classList.add('hidden'); // Cacher le bouton "G√©rer boutique"
                adminGenererAnnonceDesktop.classList.add('hidden'); // Cacher le bouton "G√©n√©rer Annonce"
                adminGenererAnnonceMobile.classList.add('hidden'); // Cacher le bouton "G√©n√©rer Annonce"
                adminAccesAntsDesktop.classList.add('hidden'); // Cacher le bouton ANTS
                adminAccesAntsMobile.classList.add('hidden'); // Cacher le bouton ANTS


                window.currentUserRole = null; // Effacer le r√¥le
                // Cacher le panneau d'administration si l'utilisateur se d√©connecte
                hideAdminPanel();
            }
        });

        // --- CUSTOM ALERT MODAL (remplace alert()) ---
        function showCustomAlert(message) {
            let customAlert = document.getElementById('custom-alert');
            let closeButton;

            if (!customAlert) {
                customAlert = document.createElement('div');
                customAlert.id = 'custom-alert';
                customAlert.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[999] hidden';
                customAlert.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center relative">
                        <p id="custom-alert-message" class="text-lg font-semibold mb-4"></p>
                        <button id="custom-alert-close" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">OK</button>
                    </div>
                `;
                document.body.appendChild(customAlert);
            }

            // Toujours obtenir la r√©f√©rence la plus r√©cente au bouton de fermeture
            closeButton = customAlert.querySelector('#custom-alert-close');

            // Supprimer l'√©couteur existant pour √©viter les doublons si la fonction est appel√©e plusieurs fois
            // Ceci est une programmation d√©fensive ; id√©alement, il n'est ajout√© qu'une seule fois.
            const oldClickListener = customAlert._closeClickListener; // Stocker la r√©f√©rence √† l'ancien √©couteur
            if (oldClickListener) {
                closeButton.removeEventListener('click', oldClickListener);
            }

            const newClickListener = () => {
                console.log("Bouton de fermeture de l'alerte personnalis√©e cliqu√© !");
                customAlert.classList.add('hidden');
                console.log("Alerte personnalis√©e masqu√©e. classList actuelle :", customAlert.classList);
            };

            if (closeButton) {
                closeButton.addEventListener('click', newClickListener);
                customAlert._closeClickListener = newClickListener; // Stocker le nouvel √©couteur
            } else {
                console.error("Bouton de fermeture de l'alerte personnalis√©e introuvable dans la structure modale.");
            }

            // Supprimer l'√©couteur de fond existant pour √©viter les doublons
            const oldBackdropListener = customAlert._backdropClickListener;
            if (oldBackdropListener) {
                customAlert.removeEventListener('click', oldBackdropListener);
            }

            const newBackdropListener = (event) => {
                if (event.target === customAlert) { // Clic sur le fond de la modale
                    console.log("Fermeture de l'alerte personnalis√©e via le clic sur le fond.");
                    customAlert.classList.add('hidden');
                }
            };
            customAlert.addEventListener('click', newBackdropListener);
            customAlert._backdropClickListener = newBackdropListener;


            console.log("Affichage de l'alerte personnalis√©e avec le message :", message); // Log pour le d√©bogage
            document.getElementById('custom-alert-message').textContent = message;
            customAlert.classList.remove('hidden');
        }

        // --- CUSTOM CONFIRM MODAL (remplace confirm()) ---
        function showCustomConfirm(message, onConfirm) {
            let customConfirm = document.getElementById('custom-confirm');
            if (!customConfirm) {
                customConfirm = document.createElement('div');
                customConfirm.id = 'custom-confirm';
                customConfirm.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[999] hidden';
                customConfirm.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center relative">
                        <p id="custom-confirm-message" class="text-lg font-semibold mb-4"></p>
                        <div class="flex justify-center space-x-4">
                            <button id="custom-confirm-ok" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">Oui</button>
                            <button id="custom-confirm-cancel" class="bg-gray-400 text-white py-2 px-4 rounded-lg hover:bg-gray-500 transition duration-300">Annuler</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(customConfirm);

                document.getElementById('custom-confirm-ok').addEventListener('click', () => {
                    customConfirm.classList.add('hidden');
                    onConfirm(true);
                });
                document.getElementById('custom-confirm-cancel').addEventListener('click', () => {
                    customConfirm.classList.add('hidden');
                    onConfirm(false);
                });
                customConfirm.addEventListener('click', (event) => {
                    if (event.target === customConfirm) {
                        customConfirm.classList.add('hidden');
                        onConfirm(false);
                    }
                });
            }
            document.getElementById('custom-confirm-message').textContent = message;
            customConfirm.classList.remove('hidden');
        }

        // --- GESTION DU PANNEAU D'ADMINISTRATION ---
        const adminPanel = document.getElementById('admin-panel');
        const mainContentSections = document.getElementById('main-content-sections'); // Nouveau wrapper
        const vehicleForm = document.getElementById('vehicle-form');
        const vehicleIdInput = document.getElementById('vehicle-id');
        const vehicleTitreAnnonceInput = document.getElementById('vehicle-titre-annonce');
        const vehicleMarqueSelect = document.getElementById('vehicle-marque');
        const vehicleModeleSelect = document.getElementById('vehicle-modele');
        const vehicleAnneeModeleInput = document.getElementById('vehicle-annee-modele');
        const vehicleDateCirculationInput = document.getElementById('vehicle-date-circulation');
        const vehicleKilometrageInput = document.getElementById('vehicle-kilometrage');
        const vehicleCarburantSelect = document.getElementById('vehicle-carburant');
        const vehicleBoiteVitesseSelect = document.getElementById('vehicle-boite-vitesse');
        const vehicleCouleurInput = document.getElementById('vehicle-couleur');
        const vehicleNbPlacesInput = document.getElementById('vehicle-nb-places');
        const vehicleNbPortesInput = document.getElementById('vehicle-nb-portes');
        const vehiclePuissanceFiscaleInput = document.getElementById('vehicle-puissance-fiscale');
        const vehiclePuissanceDINInput = document.getElementById('vehicle-puissance-din');
        const vehicleCritAirSelect = document.getElementById('vehicle-critair');
        const vehiclePrixInput = document.getElementById('vehicle-prix');
        const vehicleDescriptionInput = document.getElementById('vehicle-description');
        const vehicleImageUploadInput = document.getElementById('vehicle-image-upload');
        const imageUploadPreview = document.getElementById('image-upload-preview');
        const imageUploadSpinner = document.getElementById('image-upload-spinner');
        const vehicleImagesUrlsInput = document.getElementById('vehicle-images-urls'); // Champ cach√© pour les URLs Cloudinary
        const vehicleOptionsCheckboxesDiv = document.getElementById('vehicle-options-checkboxes');
        const vehicleMaintenancesCheckboxesDiv = document.getElementById('vehicle-maintenances-checkboxes'); // Nouveau: entretiens
        const vehicleVenduCheckbox = document.getElementById('vehicle-vendu'); // Nouveau: case √† cocher vendu

        const submitVehicleButton = document.getElementById('submit-vehicle-button');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const vehicleFormTitle = document.getElementById('vehicle-form-title');
        const adminVehicleList = document.getElementById('admin-vehicle-list');
        const adminLoadingSpinner = document.getElementById('admin-loading-spinner');
        const backToHomeButton = document.getElementById('back-to-home-button'); // Nouveau bouton

        // --- Donn√©es pour les listes d√©roulantes et options ---
        const carData = {
            "Renault": ["Clio", "M√©gane", "Captur", "Kadjar", "Austral", "Arkana", "Twingo", "Zoe", "Sc√©nic", "Talisman", "Espace", "Koleos", "Kangoo"],
            "Peugeot": ["208", "308", "2008", "3008", "5008", "508", "108", "Rifter", "Partner", "Traveller", "Expert"],
            "Citro√´n": ["C3", "C4", "C5 Aircross", "C3 Aircross", "Berlingo", "C1", "C4 Cactus", "C5 X", "Jumpy", "Spacetourer"],
            "Volkswagen": ["Golf", "Polo", "Tiguan", "Passat", "T-Roc", "Arteon", "Up!", "ID.3", "ID.4", "ID.5", "ID.Buzz", "Touran", "Touareg", "Caddy"],
            "Audi": ["A1", "A3", "A4", "A5", "A6", "A7", "A8", "Q2", "Q3", "Q4 e-tron", "Q5", "Q7", "Q8", "e-tron", "TT", "R8"],
            "BMW": ["S√©rie 1", "S√©rie 2", "S√©rie 3", "S√©rie 4", "S√©rie 5", "S√©rie 6", "S√©rie 7", "S√©rie 8", "X1", "X2", "X3", "X4", "X5", "X6", "X7", "Z4", "i3", "i4", "iX", "iX3", "i5", "i7"],
            "Mercedes-Benz": ["Classe A", "Classe B", "Classe C", "Classe E", "Classe S", "CLA", "CLS", "GLA", "GLC", "GLE", "GLS", "EQA", "EQB", "EQC", "EQE", "EQS", "AMG GT", "Citan", "Vito", "Sprinter"],
            "Ford": ["Fiesta", "Focus", "Puma", "Kuga", "Mustang Mach-E", "Explorer", "Edge", "Mondeo", "Galaxy", "S-Max", "Ranger", "Transit Custom", "Tourneo Custom"],
            "Toyota": ["Yaris", "Corolla", "C-HR", "RAV4", "Aygo", "Mirai", "Camry", "Prius", "Highlander", "Land Cruiser", "Hilux", "Proace"],
            "Nissan": ["Qashqai", "Juke", "X-Trail", "Micra", "Leaf", "Ariya", "Navara", "Townstar"],
            "Hyundai": ["i10", "i20", "i30", "Kona", "Tucson", "Santa Fe", "Bayon", "Ioniq 5", "Ioniq 6", "Nexo"],
            "Kia": ["Picanto", "Rio", "Ceed", "Sportage", "Niro", "EV6", "Stonic", "Xceed", "Sorento", "Soul EV"],
            "Opel": ["Corsa", "Astra", "Mokka", "Grandland", "Crossland", "Combo Life", "Zafira Life", "Vivaro"],
            "Skoda": ["Fabia", "Octavia", "Superb", "Kamiq", "Karoq", "Kodiaq", "Enyaq iV", "Scala"],
            "Seat": ["Ibiza", "Leon", "Ateca", "Arona", "Tarraco", "Toledo", "Alhambra"],
            "Fiat": ["500", "Panda", "Tipo", "500X", "500e", "Ducato", "Talento"],
            "Volvo": ["S60", "V60", "S90", "V90", "XC40", "XC60", "XC90", "C40 Recharge", "EX30", "EX90"],
            "Tesla": ["Model 3", "Model Y", "Model S", "Model X", "Cybertruck"],
            "Dacia": ["Sandero", "Duster", "Spring", "Jogger", "Lodgy", "Logan"],
            "Mazda": ["Mazda2", "Mazda3", "Mazda6", "CX-30", "CX-5", "CX-60", "CX-80", "MX-30", "MX-5"],
            "Honda": ["Civic", "CR-V", "Jazz", "HR-V", "e", "ZR-V"],
            "Suzuki": ["Swift", "Vitara", "Ignis", "S-Cross", "Jimny", "Across"],
            "Jeep": ["Renegade", "Compass", "Wrangler", "Grand Cherokee", "Avenger"],
            "Land Rover": ["Range Rover Evoque", "Discovery Sport", "Defender", "Range Rover Sport", "Discovery", "Range Rover"],
            "Porsche": ["911", "Cayenne", "Macan", "Panamera", "Taycan", "718 Boxster", "718 Cayman"],
            "Alfa Romeo": ["Giulia", "Stelvio", "Tonale"],
            "Lexus": ["IS", "ES", "LS", "RC", "LC", "UX", "NX", "RX", "RZ"],
            "Mini": ["Mini 3 Portes", "Mini 5 Portes", "Countryman", "Clubman", "Cabrio", "Aceman"],
            "Cupra": ["Formentor", "Born", "Leon", "Ateca", "Tavascan"],
            "Polestar": ["Polestar 2", "Polestar 3", "Polestar 4"],
            "MG": ["ZS EV", "MG4 EV", "HS", "MG5 EV", "Cyberster"]
        };

        const carburants = ["Essence", "Diesel", "√âlectrique", "Hybride", "Hybride Rechargeable", "GPL", "E85"];
        const boiteVitesse = ["Manuelle", "Automatique"];
        const critAirOptions = ["0 (Vert)", "1", "2", "3", "4", "5", "Non class√©"];

        const vehicleOptionsData = {
            "S√©curit√©": [
                "ABS", "ESP", "Airbags frontaux", "Airbags lat√©raux", "Airbags rideaux",
                "Aide au freinage d'urgence", "Contr√¥le de la pression des pneus",
                "Fixations ISOFIX", "D√©tecteur d'angle mort", "Alerte de franchissement de ligne",
                "R√©gulateur de vitesse adaptatif", "Cam√©ra de recul", "Radars de stationnement avant",
                "Radars de stationnement arri√®re", "Phares LED", "Feux de jour LED",
                "Syst√®me de surveillance de la vigilance du conducteur", "Freinage automatique d'urgence"
            ],
            "Int√©rieur": [
                "Climatisation manuelle", "Climatisation automatique bi-zone", "Si√®ges chauffants",
                "Si√®ges en cuir", "Volant multifonction", "Volant chauffant", "Accoudoir central",
                "Vitres √©lectriques avant", "Vitres √©lectriques arri√®re", "R√©troviseurs √©lectriques",
                "√âcran tactile", "GPS", "Bluetooth", "Apple CarPlay", "Android Auto",
                "Prise USB", "Prise 12V", "Toit ouvrant panoramique", "Instrumentation num√©rique",
                "√âclairage d'ambiance", "Sellerie tissu", "Sellerie semi-cuir", "Si√®ges sport"
            ],
            "Ext√©rieur": [
                "Jantes alliage", "Peinture m√©tallis√©e", "Phares antibrouillard", "Barres de toit",
                "Attelage", "Vitres teint√©es", "R√©troviseurs rabattables √©lectriquement",
                "Capteur de pluie", "Capteur de luminosit√©", "Hayon √©lectrique", "Phares X√©non",
                "Toit ouvrant", "Becquet arri√®re", "√âchappement sport"
            ],
            "Confort": [
                "D√©marrage sans cl√©", "Acc√®s mains libres", "Aide au d√©marrage en c√¥te",
                "Frein de parking √©lectrique", "Direction assist√©e", "Verrouillage centralis√© √† distance",
                "R√©gulateur de vitesse", "Limiteur de vitesse", "Aide au stationnement", "Si√®ges r√©glables en hauteur"
            ],
            "Autres": [
                "Carnet d'entretien", "Double des cl√©s", "Non-fumeur", "Garantie constructeur",
                "Roue de secours", "Kit de r√©paration pneus", "Pack sport", "Suspension sport"
            ]
        };

        // Nouveau: Options d'entretien
        const vehicleMaintenanceData = [
            "Kit distribution + pompe √† eau",
            "Vidange moteur + filtre √† huile",
            "Disques et plaquettes de frein",
            "Pneumatiques",
            "Contr√¥le technique OK",
            "R√©vision compl√®te",
            "Climatisation recharg√©e",
            "Amortisseurs avant",
            "Amortisseurs arri√®re",
            "Batterie neuve",
            "Bougies d'allumage",
            "Filtre √† air",
            "Filtre √† carburant",
            "Filtre d'habitacle",
            "Embrayage"
        ];

        // Cloudinary configuration
        const CLOUDINARY_CLOUD_NAME = 'dxneu57c0';
        const CLOUDINARY_UPLOAD_PRESET = 'central_cars_unsigned_upload';
        const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;


        // --- Fonctions d'initialisation des listes d√©roulantes et options ---
        function populateMarques() {
            for (const marque in carData) {
                const option = document.createElement('option');
                option.value = marque;
                option.textContent = marque;
                vehicleMarqueSelect.appendChild(option);
            }
        }

        function populateModeles(selectedMarque) {
            vehicleModeleSelect.innerHTML = '<option value="">S√©lectionner un mod√®le</option>'; // R√©initialiser les mod√®les
            if (selectedMarque && carData[selectedMarque]) {
                carData[selectedMarque].forEach(modele => {
                    const option = document.createElement('option');
                    option.value = modele;
                    option.textContent = modele;
                    vehicleModeleSelect.appendChild(option);
                });
            }
        }

        function populateCarburants() {
            carburants.forEach(carburant => {
                const option = document.createElement('option');
                option.value = carburant;
                option.textContent = carburant;
                vehicleCarburantSelect.appendChild(option);
            });
        }

        function populateBoiteVitesse() {
            boiteVitesse.forEach(boite => {
                const option = document.createElement('option');
                option.value = boite;
                option.textContent = boite;
                vehicleBoiteVitesseSelect.appendChild(option);
            });
        }

        function populateCritAir() {
            critAirOptions.forEach(critair => {
                const option = document.createElement('option');
                option.value = critair;
                option.textContent = critair;
                vehicleCritAirSelect.appendChild(option);
            });
        }

        function generateOptionsCheckboxes() {
            vehicleOptionsCheckboxesDiv.innerHTML = '';
            for (const category in vehicleOptionsData) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'col-span-1';
                categoryDiv.innerHTML = `<h5 class="font-semibold text-gray-700 mb-2">${category}</h5>`;
                
                vehicleOptionsData[category].forEach(optionText => {
                    const checkboxId = `option-${optionText.replace(/\s+/g, '-').toLowerCase()}`;
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'flex items-center mb-1';
                    checkboxDiv.innerHTML = `
                        <input type="checkbox" id="${checkboxId}" name="vehicle-option" value="${optionText}" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                        <label for="${checkboxId}" class="ml-2 text-gray-700 text-sm">${optionText}</label>
                    `;
                    categoryDiv.appendChild(checkboxDiv);
                });
                vehicleOptionsCheckboxesDiv.appendChild(categoryDiv);
            }
        }

        // Nouveau: Fonction pour g√©n√©rer les cases √† cocher d'entretien
        function generateMaintenancesCheckboxes() {
            vehicleMaintenancesCheckboxesDiv.innerHTML = '';
            vehicleMaintenanceData.forEach(maintText => {
                const checkboxId = `maint-${maintText.replace(/\s+/g, '-').replace(/[^\w-]/g, '').toLowerCase()}`; // Sanitize ID
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'flex items-center mb-1';
                checkboxDiv.innerHTML = `
                    <input type="checkbox" id="${checkboxId}" name="vehicle-maintenance" value="${maintText}" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="${checkboxId}" class="ml-2 text-gray-700 text-sm">${maintText}</label>
                `;
                vehicleMaintenancesCheckboxesDiv.appendChild(checkboxDiv);
            });
        }


        // Initialiser les listes et options au chargement
        document.addEventListener('DOMContentLoaded', () => {
            populateMarques();
            populateCarburants();
            populateBoiteVitesse();
            populateCritAir();
            generateOptionsCheckboxes();
            generateMaintenancesCheckboxes(); // Initialiser les entretiens
        });

        // √âcouteur pour la s√©lection de la marque afin de mettre √† jour les mod√®les
        vehicleMarqueSelect.addEventListener('change', (event) => {
            populateModeles(event.target.value);
        });


        // --- Fonctions d'upload d'images Cloudinary et Drag & Drop ---
        let uploadedImageUrls = []; // Stocke les URLs des images d√©j√† upload√©es pour le formulaire actuel
        let draggedItem = null; // Pour le drag and drop

        // Fonction pour rendre les aper√ßus des images
        function renderImagePreviews() {
            imageUploadPreview.innerHTML = ''; // Clear previous previews
            uploadedImageUrls.forEach((url, index) => {
                const imgDiv = document.createElement('div');
                imgDiv.className = 'image-preview-item relative group cursor-grab border-2 border-transparent rounded-lg overflow-hidden';
                imgDiv.draggable = true;
                imgDiv.dataset.url = url; // Store URL on the element for drag-drop
                imgDiv.dataset.index = index; // Store index for reordering

                imgDiv.innerHTML = `
                    <img src="${url}" class="w-full h-24 object-cover rounded-lg shadow-md">
                    <button type="button" data-url="${url}" class="remove-image-button absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity">&times;</button>
                `;
                imageUploadPreview.appendChild(imgDiv);
            });
            vehicleImagesUrlsInput.value = uploadedImageUrls.join(','); // Update hidden input
        }

        vehicleImageUploadInput.addEventListener('change', async (event) => {
            const files = event.target.files;
            if (files.length === 0) return;

            imageUploadSpinner.classList.remove('hidden');
            // uploadedImageUrls = []; // Keep existing images if not editing a new vehicle
            
            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

                try {
                    const response = await fetch(CLOUDINARY_UPLOAD_URL, {
                        method: 'POST',
                        body: formData,
                    });
                    const data = await response.json();
                    if (data.secure_url) {
                        uploadedImageUrls.push(data.secure_url);
                    } else {
                        console.error("Cloudinary upload error:", data);
                        showCustomAlert(`Erreur lors du t√©l√©chargement de l'image ${file.name}.`);
                    }
                } catch (error) {
                    console.error("Erreur r√©seau lors du t√©l√©chargement Cloudinary:", error);
                    showCustomAlert(`Erreur r√©seau lors du t√©l√©chargement de l'image ${file.name}.`);
                }
            }
            renderImagePreviews(); // Re-render all previews after upload
            imageUploadSpinner.classList.add('hidden');
        });

        // G√©rer la suppression d'images de l'aper√ßu
        imageUploadPreview.addEventListener('click', (event) => {
            const removeButton = event.target.closest('.remove-image-button');
            if (removeButton) {
                const imageUrlToRemove = removeButton.dataset.url;
                uploadedImageUrls = uploadedImageUrls.filter(url => url !== imageUrlToRemove);
                renderImagePreviews(); // Re-render after removal
            }
        });

        // Drag and Drop Handlers
        imageUploadPreview.addEventListener('dragstart', (e) => {
            draggedItem = e.target.closest('.image-preview-item');
            if (draggedItem) {
                e.dataTransfer.setData('text/plain', draggedItem.dataset.url);
                setTimeout(() => {
                    draggedItem.classList.add('dragging');
                }, 0);
            }
        });

        imageUploadPreview.addEventListener('dragover', (e) => {
            e.preventDefault(); // Allow drop
            const targetItem = e.target.closest('.image-preview-item');
            if (targetItem && targetItem !== draggedItem) {
                targetItem.classList.add('drag-over');
            }
        });

        imageUploadPreview.addEventListener('dragleave', (e) => {
            const targetItem = e.target.closest('.image-preview-item');
            if (targetItem) {
                targetItem.classList.remove('drag-over');
            }
        });

        imageUploadPreview.addEventListener('drop', (e) => {
            e.preventDefault();
            const targetItem = e.target.closest('.image-preview-item');
            if (draggedItem && targetItem && draggedItem !== targetItem) {
                const draggedUrl = draggedItem.dataset.url;
                const targetUrl = targetItem.dataset.url;

                const draggedIndex = uploadedImageUrls.indexOf(draggedUrl);
                const targetIndex = uploadedImageUrls.indexOf(targetUrl);

                if (draggedIndex > -1 && targetIndex > -1) {
                    const [removed] = uploadedImageUrls.splice(draggedIndex, 1);
                    uploadedImageUrls.splice(targetIndex, 0, removed);
                    renderImagePreviews(); // Re-render with new order
                }
            }
            if (targetItem) {
                targetItem.classList.remove('drag-over');
            }
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
            }
        });

        imageUploadPreview.addEventListener('dragend', () => {
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
            }
            document.querySelectorAll('.image-preview-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            draggedItem = null;
        });


        // Fonction pour afficher les v√©hicules dans le panneau d'administration
        function displayAdminVehicles(vehicles) {
            adminVehicleList.innerHTML = '';
            if (vehicles.length === 0) {
                adminVehicleList.innerHTML = `<p class="text-center col-span-full">Aucun v√©hicule √† g√©rer pour le moment.</p>`;
            } else {
                vehicles.forEach(vehicle => {
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow-lg overflow-hidden relative'; // Added relative for badge positioning
                    const imageUrl = vehicle.images && vehicle.images.length > 0 ? vehicle.images[0] : 'https://placehold.co/600x400/cccccc/ffffff?text=Image+Indisponible';
                    
                    // Add "Vendu" badge if vehicle is sold
                    const soldBadge = vehicle.vendu ? `
                        <span class="absolute top-2 left-2 bg-red-600 text-white text-xs font-bold px-3 py-1 rounded-full z-10">VENDU</span>
                    ` : '';

                    card.innerHTML = `
                        ${soldBadge}
                        <img src="${imageUrl}" alt="Image de ${vehicle.titreAnnonce || vehicle.nom}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/ffffff?text=Image+Invalide';">
                        <div class="p-4">
                            <h4 class="text-xl font-bold mb-2">${vehicle.titreAnnonce || vehicle.nom || 'N/A'}</h4>
                            <p class="text-gray-600 text-sm mb-2">${vehicle.marque || 'N/A'} - ${vehicle.modele || 'N/A'}</p>
                            <p class="text-2xl font-bold text-red-600 mb-4">${vehicle.prix ? vehicle.prix.toLocaleString('fr-FR') : 'N/A'} ‚Ç¨</p>
                            <div class="flex space-x-2">
                                <button data-id="${vehicle.id}" class="edit-vehicle-button flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">Modifier</button>
                                <button data-id="${vehicle.id}" class="delete-vehicle-button flex-1 bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">Supprimer</button>
                            </div>
                        </div>
                    `;
                    adminVehicleList.appendChild(card);
                });
            }
            adminLoadingSpinner.style.display = 'none';
        }

        // --- GESTION DU PANNEAU D'ADMINISTRATION ---
        // (Le reste de votre code JavaScript pour le panneau d'administration, les modales, etc., suit ici)

        // Fonction pour afficher le panneau d'administration et masquer le contenu principal
        function showAdminPanel() {
            mainContentSections.classList.add('hidden');
            adminPanel.classList.remove('hidden');
            // Fermer toutes les modales ouvertes
            closeVehicleModal();
            closeAuthModal();
            closeVehicleContactModal(); // Fermer la modale de contact si ouverte
            // Rafra√Æchir la liste des v√©hicules dans le panneau d'administration
            listenForAdminVehicles();
            // R√©initialiser le formulaire quand on ouvre le panneau d'admin
            resetVehicleForm();
        }

        // Fonction pour masquer le panneau d'administration et afficher le contenu principal
        function hideAdminPanel() {
            adminPanel.classList.add('hidden');
            mainContentSections.classList.remove('hidden');
        }

        // √âcouteurs d'√©v√©nements pour les boutons "G√©rer boutique"
        adminGererBoutiqueDesktop.addEventListener('click', (e) => {
            e.preventDefault();
            if (window.currentUserRole === 'admin') {
                showAdminPanel();
                accountMenuDesktop.classList.add('hidden'); // Fermer le menu
            } else {
                showCustomAlert("Vous n'avez pas les permissions pour acc√©der √† cette section.");
            }
        });
        adminGererBoutiqueMobile.addEventListener('click', (e) => {
            e.preventDefault();
            if (window.currentUserRole === 'admin') {
                showAdminPanel();
                accountMenuMobile.classList.add('hidden'); // Fermer le menu
            } else {
                showCustomAlert("Vous n'avez pas les permissions pour acc√©der √† cette section.");
            }
        });

        // √âcouteurs d'√©v√©nements pour le nouveau bouton "G√©n√©rer Annonce"
        adminGenererAnnonceDesktop.addEventListener('click', (e) => {
            e.preventDefault();
            if (window.currentUserRole === 'admin') {
                window.open('annonce.html', '_blank'); // Ouvre annonce.html dans un nouvel onglet
                accountMenuDesktop.classList.add('hidden'); // Fermer le menu
            } else {
                showCustomAlert("Vous n'avez pas les permissions pour acc√©der √† cet outil.");
            }
        });
        adminGenererAnnonceMobile.addEventListener('click', (e) => {
            e.preventDefault();
            if (window.currentUserRole === 'admin') {
                window.open('annonce.html', '_blank'); // Ouvre annonce.html dans un nouvel onglet
                accountMenuMobile.classList.add('hidden'); // Fermer le menu
            } else {
                showCustomAlert("Vous n'avez pas les permissions pour acc√©der √† cet outil.");
            }
        });

        // √âcouteurs d'√©v√©nements pour le nouveau bouton "Acc√®s ANTS"
        adminAccesAntsDesktop.addEventListener('click', (e) => {
            e.preventDefault();
            if (window.currentUserRole === 'admin') {
                window.open('tools.html', '_blank'); // Ouvre tools.html dans un nouvel onglet
                accountMenuDesktop.classList.add('hidden'); // Fermer le menu
            } else {
                showCustomAlert("Vous n'avez pas les permissions pour acc√©der √† cet outil.");
            }
        });
        adminAccesAntsMobile.addEventListener('click', (e) => {
            e.preventDefault();
            if (window.currentUserRole === 'admin') {
                window.open('tools.html', '_blank'); // Ouvre tools.html dans un nouvel onglet
                accountMenuMobile.classList.add('hidden'); // Fermer le menu
            } else {
                showCustomAlert("Vous n'avez pas les permissions pour acc√©der √† cet outil.");
            }
        });


        // √âcouteur pour le nouveau bouton "Retour √† l'accueil"
        backToHomeButton.addEventListener('click', (e) => {
            e.preventDefault();
            hideAdminPanel();
        });


        // √âcoute les changements de v√©hicules pour le panneau d'administration
        function listenForAdminVehicles() {
            const vehiclesCollection = collection(db, "vehicules");
            adminLoadingSpinner.style.display = 'block';
            onSnapshot(vehiclesCollection, (snapshot) => {
                const adminVehicles = [];
                snapshot.forEach((doc) => {
                    adminVehicles.push({ id: doc.id, ...doc.data() });
                });
                displayAdminVehicles(adminVehicles);
            }, (error) => {
                console.error("Erreur lors de la r√©cup√©ration des v√©hicules pour l'admin: ", error);
                adminLoadingSpinner.style.display = 'none';
                adminVehicleList.innerHTML = `<p class="text-center col-span-full text-red-500">Impossible de charger les v√©hicules pour la gestion.</p>`;
            });
        }

        // G√©rer la soumission du formulaire (Ajouter/Mettre √† jour un v√©hicule)
        vehicleForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const vehicleId = vehicleIdInput.value;
            const selectedOptions = Array.from(document.querySelectorAll('#vehicle-options-checkboxes input[name="vehicle-option"]:checked'))
                                        .map(checkbox => checkbox.value);
            const selectedMaintenances = Array.from(document.querySelectorAll('#vehicle-maintenances-checkboxes input[name="vehicle-maintenance"]:checked'))
                                                .map(checkbox => checkbox.value);

            const vehicleData = {
                titreAnnonce: vehicleTitreAnnonceInput.value,
                marque: vehicleMarqueSelect.value,
                modele: vehicleModeleSelect.value,
                anneeModele: parseInt(vehicleAnneeModeleInput.value),
                dateCirculation: vehicleDateCirculationInput.value,
                kilometrage: parseInt(vehicleKilometrageInput.value),
                carburant: vehicleCarburantSelect.value,
                boiteVitesse: vehicleBoiteVitesseSelect.value,
                couleur: vehicleCouleurInput.value,
                nbPlaces: parseInt(vehicleNbPlacesInput.value),
                nbPortes: parseInt(vehicleNbPortesInput.value),
                puissanceFiscale: parseInt(vehiclePuissanceFiscaleInput.value),
                puissanceDIN: parseInt(vehiclePuissanceDINInput.value),
                critAir: vehicleCritAirSelect.value,
                prix: parseFloat(vehiclePrixInput.value),
                description: vehicleDescriptionInput.value,
                images: uploadedImageUrls, // Utiliser les URLs de Cloudinary
                options: selectedOptions,
                maintenances: selectedMaintenances, // Nouveau: entretiens
                vendu: vehicleVenduCheckbox.checked // Nouveau: statut vendu
            };

            try {
                if (vehicleId) {
                    // Mettre √† jour le v√©hicule existant
                    await setDoc(doc(db, "vehicules", vehicleId), vehicleData);
                    showCustomAlert("V√©hicule modifi√© avec succ√®s !");
                } else {
                    // Ajouter un nouveau v√©hicule
                    await addDoc(collection(db, "vehicules"), vehicleData);
                    showCustomAlert("V√©hicule ajout√© avec succ√®s !");
                }
                resetVehicleForm(); // R√©initialiser le formulaire apr√®s succ√®s
            } catch (error) {
                console.error("Erreur lors de l'op√©ration sur le v√©hicule:", error);
                showCustomAlert("Erreur lors de l'op√©ration sur le v√©hicule. V√©rifiez les permissions Firebase.");
            }
        });

        // Fonction pour r√©initialiser le formulaire
        function resetVehicleForm() {
            vehicleForm.reset();
            vehicleIdInput.value = '';
            submitVehicleButton.textContent = 'Ajouter le v√©hicule';
            vehicleFormTitle.textContent = 'Ajouter un nouveau v√©hicule';
            cancelEditButton.classList.add('hidden');
            imageUploadPreview.innerHTML = ''; // Clear image previews
            uploadedImageUrls = []; // Reset uploaded image URLs
            // D√©s√©lectionner toutes les options
            document.querySelectorAll('#vehicle-options-checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            // D√©s√©lectionner tous les entretiens
            document.querySelectorAll('#vehicle-maintenances-checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            // R√©initialiser la case "Vendu"
            vehicleVenduCheckbox.checked = false;
            // R√©initialiser les listes d√©roulantes dynamiques
            populateModeles(''); // Vide le mod√®le
            vehicleMarqueSelect.value = ''; // R√©initialise la marque
            vehicleCarburantSelect.value = ''; // R√©initialise le carburant
            vehicleBoiteVitesseSelect.value = ''; // R√©initialise la bo√Æte de vitesse
            vehicleCritAirSelect.value = ''; // R√©initialise Crit'Air
        }

        // Modifier le v√©hicule - Remplir le formulaire
        adminVehicleList.addEventListener('click', (event) => {
            const editButton = event.target.closest('.edit-vehicle-button');
            if (editButton) {
                const idToEdit = editButton.dataset.id;
                const vehicleToEdit = allVehicles.find(v => v.id === idToEdit);
                if (vehicleToEdit) {
                    vehicleIdInput.value = vehicleToEdit.id;
                    vehicleTitreAnnonceInput.value = vehicleToEdit.titreAnnonce || '';
                    vehicleMarqueSelect.value = vehicleToEdit.marque || '';
                    populateModeles(vehicleToEdit.marque); // Populer les mod√®les en fonction de la marque
                    vehicleModeleSelect.value = vehicleToEdit.modele || '';
                    vehicleAnneeModeleInput.value = vehicleToEdit.anneeModele || '';
                    vehicleDateCirculationInput.value = vehicleToEdit.dateCirculation || '';
                    vehicleKilometrageInput.value = vehicleToEdit.kilometrage || '';
                    vehicleCarburantSelect.value = vehicleToEdit.carburant || '';
                    vehicleBoiteVitesseSelect.value = vehicleToEdit.boiteVitesse || '';
                    vehicleCouleurInput.value = vehicleToEdit.couleur || '';
                    vehicleNbPlacesInput.value = vehicleToEdit.nbPlaces || '';
                    vehicleNbPortesInput.value = vehicleToEdit.nbPortes || '';
                    vehiclePuissanceFiscaleInput.value = vehicleToEdit.puissanceFiscale || '';
                    vehiclePuissanceDINInput.value = vehicleToEdit.puissanceDIN || '';
                    vehicleCritAirSelect.value = vehicleToEdit.critAir || '';
                    vehiclePrixInput.value = vehicleToEdit.prix || '';
                    vehicleDescriptionInput.value = vehicleToEdit.description || '';
                    
                    // G√©rer les images existantes pour l'√©dition
                    uploadedImageUrls = vehicleToEdit.images ? [...vehicleToEdit.images] : []; // Copy array
                    renderImagePreviews(); // Render existing images for drag-drop

                    // G√©rer les options s√©lectionn√©es
                    document.querySelectorAll('#vehicle-options-checkboxes input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = vehicleToEdit.options && vehicleToEdit.options.includes(checkbox.value);
                    });

                    // G√©rer les entretiens s√©lectionn√©s
                    document.querySelectorAll('#vehicle-maintenances-checkboxes input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = vehicleToEdit.maintenances && vehicleToEdit.maintenances.includes(checkbox.value);
                    });

                    // G√©rer la case "Vendu"
                    vehicleVenduCheckbox.checked = vehicleToEdit.vendu || false;

                    submitVehicleButton.textContent = 'Modifier le v√©hicule';
                    vehicleFormTitle.textContent = 'Modifier le v√©hicule existant';
                    cancelEditButton.classList.remove('hidden');
                    // Faire d√©filer jusqu'au formulaire
                    vehicleForm.scrollIntoView({ behavior: 'smooth' });
                }
            }
        });

        // Annuler la modification
        cancelEditButton.addEventListener('click', () => {
            resetVehicleForm();
        });

        // Supprimer le v√©hicule
        adminVehicleList.addEventListener('click', async (event) => {
            const deleteButton = event.target.closest('.delete-vehicle-button');
            if (deleteButton) {
                const idToDelete = deleteButton.dataset.id;
                showCustomConfirm("√ätes-vous s√ªr de vouloir supprimer ce v√©hicule ?", async (confirmed) => {
                    if (confirmed) {
                        try {
                            await deleteDoc(doc(db, "vehicules", idToDelete));
                            showCustomAlert("V√©hicule supprim√© avec succ√®s !");
                        } catch (error) {
                            console.error("Erreur lors de la suppression du v√©hicule:", error);
                            showCustomAlert("Erreur lors de la suppression du v√©hicule. Veuillez r√©essayer.");
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
