<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CENTRAL CARS</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Police Inter pour une esthétique moderne */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Styles pour masquer/afficher les modales */
        .modal-hidden {
            display: none;
        }
        .modal-visible {
            display: flex;
        }
        /* Tailwind @apply directives for custom component classes (from ANTS snippet) */
        .table-input {
            @apply w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm;
        }
        .btn {
            @apply px-4 py-2 rounded-md shadow-sm text-sm font-medium transition-colors duration-150 ease-in-out;
        }
        .btn-primary {
            @apply text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500;
        }
        .btn-secondary {
            @apply text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500;
        }
        .btn-danger {
            @apply text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-500;
        }
        .modal {
            @apply fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4;
        }
        .modal-content {
            @apply bg-white p-5 rounded-lg shadow-xl w-full max-w-md mx-auto;
        }

        /* Styles pour le filigrane "VENDU" */
        .sold-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 0, 0, 0.7); /* Slightly more opaque red */
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem; /* Larger "VENDU" text */
            font-weight: bold;
            text-transform: uppercase;
            transform: rotate(-25deg);
            pointer-events: none;
            z-index: 10; /* Ensure it's on top of everything */
            opacity: 0.95; /* More opaque */
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.6); /* Stronger text shadow */
        }

        /* NOUVEAUX Styles pour les cartes de véhicules */
        .vehicle-card {
            @apply relative overflow-hidden rounded-3xl shadow-lg flex flex-col border border-gray-200 bg-white; /* Changed to rounded-3xl */
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out, background 0.5s ease-in-out;
            cursor: pointer;
            min-height: 350px; /* Ensure a minimum height for consistent look */
        }

        .vehicle-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.25);
            background: linear-gradient(to bottom right, #BFDBFE, #22D3EE); /* Gradient on hover */
        }

        .vehicle-card-image-container {
            @apply w-full h-48 overflow-hidden relative rounded-t-3xl; /* Changed to rounded-t-3xl */
        }

        .vehicle-card-image {
            @apply w-full h-full object-cover transition-transform duration-300 ease-in-out;
        }

        .vehicle-card-content {
            @apply p-5 flex-grow flex flex-col justify-between items-center; /* Added items-center for centering children */
            position: relative; /* For z-index context */
            z-index: 2; /* Ensure content is above any background effects */
        }

        .vehicle-card-title {
            /* Updated: Centered and bold */
            @apply text-2xl font-extrabold text-gray-900 mb-1 leading-tight uppercase text-center; /* Reduced mb-2 to mb-1 for closer price */
            transition: color 0.3s ease-in-out;
        }

        .vehicle-card-price {
            /* Updated: Centered and bold */
            @apply text-3xl font-extrabold text-blue-700 mb-3 text-center;
            transition: color 0.3s ease-in-out;
        }

        .vehicle-card:hover .vehicle-card-title,
        .vehicle-card:hover .vehicle-card-price {
            color: white; /* Text color changes to white on hover */
        }

        .vehicle-card-detail {
            @apply text-gray-700 text-base mb-1;
            transition: color 0.3s ease-in-out;
        }

        .vehicle-card:hover .vehicle-card-detail {
            color: rgba(255, 255, 255, 0.9); /* Lighter text on hover for details */
        }

        .vehicle-card-description {
            @apply text-gray-600 text-sm line-clamp-3 mt-2;
            transition: color 0.3s ease-in-out;
        }

        .vehicle-card:hover .vehicle-card-description {
            color: rgba(255, 255, 255, 0.8);
        }

        /* Style pour les véhicules en vedette sur la page d'accueil (keep existing for featured) */
        .featured-vehicle-card {
            @apply relative overflow-hidden rounded-xl shadow-lg transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-2xl bg-white flex flex-col cursor-pointer border border-gray-200;
        }
        .featured-vehicle-card .featured-image-container {
            @apply w-full h-48 overflow-hidden;
        }
        .featured-vehicle-card .featured-image {
            @apply w-full h-full object-cover transition-transform duration-300 ease-in-out;
        }
        .featured-vehicle-card:hover .featured-image {
            transform: scale(1.05);
        }
        .featured-vehicle-card-content {
            @apply p-4 flex-grow flex flex-col items-center; /* Added items-center for centering children */
        }
        .featured-vehicle-card-title {
            /* Updated: Centered and bold */
            @apply text-xl font-extrabold text-gray-900 mb-1 leading-tight uppercase text-center; /* Changed from font-bold to font-extrabold */
        }
        .featured-vehicle-card-price {
            /* Updated: Centered and bold */
            @apply text-2xl font-extrabold text-blue-700 mb-2 text-center;
        }
        .featured-vehicle-card-detail {
            @apply text-gray-700 text-sm;
        }

        /* Styles pour le glisser-déposer des images */
        .draggable-image-item {
            @apply flex flex-col items-center space-y-2 p-2 border border-gray-300 rounded-md bg-white shadow-sm cursor-grab relative;
            transition: transform 0.2s ease-in-out;
        }
        .draggable-image-item.dragging {
            @apply opacity-50 border-blue-500;
        }
        .draggable-image-item.drag-over {
            @apply border-2 border-blue-600 bg-blue-50;
        }
        .draggable-image-item img {
            @apply w-24 h-24 object-cover rounded-md;
        }
        .draggable-image-item .remove-image-url-btn {
            @apply absolute top-1 right-1 bg-red-500 text-white rounded-full h-6 w-6 flex items-center justify-center text-xs font-bold opacity-80 hover:opacity-100 transition-opacity;
        }
        .image-url-input {
            @apply text-sm;
        }

        /* Styles pour les sections d'options */
        .accordion-header {
            @apply flex justify-between items-center w-full p-4 bg-blue-100 text-blue-800 font-semibold rounded-md cursor-pointer hover:bg-blue-200 transition-colors duration-200 ease-in-out;
        }
        .accordion-content {
            @apply p-4 bg-white border border-blue-100 rounded-b-md;
            display: none;
        }
        .accordion-content.active {
            display: block;
        }
        .accordion-arrow {
            @apply transform transition-transform duration-200 ease-in-out;
        }
        .accordion-arrow.rotate {
            @apply rotate-180;
        }

        /* Styles pour les champs éditables de page */
        .editable-field-container {
            position: relative;
            padding: 0.5rem; /* Add some padding for better clickability/hover */
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.2s ease-in-out;
        }
        .editable-field-container:hover {
            background-color: #f0f4f8; /* Light blue-gray on hover */
        }

        .editable-field-container.editing {
            background-color: #e0f2fe; /* Lighter blue when editing */
            border: 1px solid #90cdf4; /* Blue border when editing */
        }

        .editable-controls {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: none; /* Hidden by default */
        }
        .editable-field-container:hover .editable-controls {
            display: block; /* Show on hover */
        }
        .editable-field-container.editing .editable-controls {
            display: block; /* Always show when editing */
        }

        .editable-controls button {
            @apply px-2 py-1 text-xs rounded-md shadow-sm transition-colors duration-150 ease-in-out;
        }
        .editable-controls .edit-btn {
            @apply bg-yellow-500 text-white hover:bg-yellow-600;
        }
        .editable-controls .save-btn {
            @apply bg-green-500 text-white hover:bg-green-600;
        }
        .editable-controls .cancel-btn {
            @apply bg-red-500 text-white hover:bg-red-600;
        }

        .editable-textarea, .editable-input {
            @apply w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500;
        }
        /* Ensure textareas for description take full width */
        textarea.editable-textarea {
            width: 100%;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col bg-gray-100">

    <!-- Navbar -->
    <nav class="bg-gray-800 p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center flex-wrap">
            <div class="text-white text-3xl font-bold font-inter rounded-md p-2">CENTRAL CARS</div>
            <div class="flex items-center flex-wrap justify-center sm:justify-start mt-2 sm:mt-0">
                <div class="flex space-x-4 mr-4"> <!-- Group main navigation buttons -->
                    <button id="nav-home" class="text-white px-3 py-2 rounded-md text-lg font-medium transition duration-300 ease-in-out transform hover:scale-105 hover:bg-gray-700">Accueil</button>
                    <button id="nav-shop" class="text-white px-3 py-2 rounded-md text-lg font-medium transition duration-300 ease-in-out transform hover:scale-105 hover:bg-gray-700">Boutique</button>
                    <button id="nav-about" class="text-white px-3 py-2 rounded-md text-lg font-medium transition duration-300 ease-in-out transform hover:scale-105 hover:bg-gray-700">À propos</button>
                    <button id="nav-contact" class="text-white px-3 py-2 rounded-md text-lg font-medium transition duration-300 ease-in-out transform hover:scale-105 hover:bg-gray-700">Contact</button>
                    <button id="nav-dossier" class="text-white px-3 py-2 rounded-md text-lg font-medium transition duration-300 ease-in-out transform hover:scale-105 hover:bg-gray-700 hidden">Dossier</button>
                </div>
                <!-- Auth/Admin buttons -->
                <button id="nav-login-signup" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-lg font-semibold transition duration-300 ease-in-out transform hover:scale-105 shadow-md">Connexion / Inscription</button>
                <button id="nav-admin-panel" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md text-lg font-semibold transition duration-300 ease-in-out transform hover:scale-105 shadow-md ml-4 hidden">Espace Pro</button>
                <button id="nav-logout" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-lg font-semibold transition duration-300 ease-in-out transform hover:scale-105 shadow-md ml-4 hidden">Déconnexion</button>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main id="app-content" class="flex-grow container mx-auto p-4">
        <!-- Content will be loaded here by JavaScript -->
        <div class="flex justify-center items-center h-screen text-xl text-gray-700">
            Chargement de l'application...
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white p-4 text-center mt-8">
        <p>&copy; 2025 CENTRAL CARS. Tous droits réservés.</p>
        <p id="user-info-display" class="text-sm mt-1">Non connecté</p>
    </footer>

    <!-- Auth Modal (Login/Signup) -->
    <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-50 p-4 modal-hidden">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            <h2 id="auth-modal-title" class="text-2xl font-bold mb-6 text-gray-800 text-center">Connexion</h2>
            <form id="auth-form" class="space-y-4">
                <div id="auth-name-group" class="hidden">
                    <label for="auth-name" class="block text-gray-700 font-medium mb-1">Nom</label>
                    <input type="text" id="auth-name" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Votre nom" />
                </div>
                <div>
                    <label for="auth-email" class="block text-gray-700 font-medium mb-1">Email</label>
                    <input type="email" id="auth-email" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="votre@email.com" required />
                </div>
                <div>
                    <label for="auth-password" class="block text-gray-700 font-medium mb-1">Mot de passe</label>
                    <input type="password" id="auth-password" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="********" required />
                </div>
                <p id="auth-error-message" class="text-red-500 text-sm hidden"></p>
                <div class="flex justify-between items-center">
                    <button type="submit" id="auth-submit-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105">Se connecter</button>
                    <button type="button" id="auth-toggle-mode" class="text-blue-600 hover:underline text-sm">Pas encore de compte ? S'inscire</button>
                </div>
            </form>
            <button id="auth-close-button" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 text-3xl font-bold">&times;</button>
        </div>
    </div>

    <!-- Vehicle Detail Modal -->
    <div id="vehicle-detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-50 p-4 modal-hidden">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto relative">
            <button id="detail-close-button" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 text-3xl font-bold">&times;</button>
            <h2 id="detail-title" class="text-3xl font-bold text-blue-700 mb-4 text-center"></h2>
            <div class="flex flex-col md:flex-row gap-6 mb-6">
                <div class="md:w-1/2 relative">
                    <img id="detail-image" src="" alt="Image du véhicule" class="w-full h-auto rounded-lg shadow-md cursor-pointer" />
                    <button id="prev-image" class="absolute left-2 top-1/2 transform -translate-y-1/2 bg-gray-800 bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75 transition hidden">&#10094;</button>
                    <button id="next-image" class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-gray-800 bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75 transition hidden">&#10095;</button>
                    <div id="image-counter" class="absolute bottom-2 left-0 right-0 text-center text-white text-sm bg-gray-800 bg-opacity-50 py-1 rounded-b-lg hidden"></div>
                </div>
                <div class="md:w-1/2 text-gray-800">
                    <p class="text-xl font-semibold mb-2">Prix: <span id="detail-price"></span></p>
                    <p class="text-sm text-gray-600 mb-4">Tous les prix sont TTC, hors prix carte grise.</p>
                    <p class="mb-2"><strong class="text-blue-600">Année:</strong> <span id="detail-year"></span></p>
                    <p class="mb-2"><strong class="text-blue-600">Kilométrage:</strong> <span id="detail-mileage"></span> km</p>
                    <p class="mb-2"><strong class="text-blue-600">Motorisation:</strong> <span id="detail-engine-type"></span></p>
                    <p class="mb-2"><strong class="text-blue-600">Boîte de vitesse:</strong> <span id="detail-gearbox-type"></span></p>
                    <p class="mb-2"><strong class="text-blue-600">Carburant:</strong> <span id="detail-fuel-type"></span></p>
                    <p class="mb-2"><strong class="text-blue-600">Puissance fiscale:</strong> <span id="detail-tax-horsepower"></span> CV</p>
                    <p class="mb-2"><strong class="text-blue-600">Puissance (ch):</strong> <span id="detail-steam-horsepower"></span> ch</p>
                </div>
            </div>
            <div class="text-gray-800 mb-4">
                <h3 class="text-xl font-semibold text-blue-600 mb-2">Description:</h3>
                <p id="detail-description" class="text-gray-700"></p>
            </div>
            <div id="detail-options-section" class="text-gray-800 hidden">
                <h3 class="text-xl font-semibold text-blue-600 mb-2">Options:</h3>
                <ul id="detail-options" class="list-disc list-inside ml-4 grid grid-cols-1 sm:grid-cols-2 gap-1"></ul>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                <button id="detail-close-button-bottom" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105">Fermer</button>
                <a id="call-garage-button" href="tel:0698979463" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105 text-center">Appeler le garage</a>
            </div>
        </div>
    </div>

    <!-- Fullscreen Image Modal -->
    <div id="fullscreen-image-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 items-center justify-center z-[100] p-4 modal-hidden">
        <button id="fullscreen-close-button" class="absolute top-4 right-4 text-white text-4xl font-bold z-[101] hover:scale-110 transition-transform">&times;</button>
        <img id="fullscreen-image" src="" alt="Image en plein écran" class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl" />
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // IMPORTANT: REMPLACEZ LES VALEURS CI-DESSOUS PAR CELLES DE VOTRE firebaseConfig
        // Vous les trouverez dans les paramètres de votre projet Firebase (icône roue dentée -> Paramètres du projet -> Vos applications -> Web app)
        const __app_id = 'central-cars-a37ae'; // Ex: '1:1234567890:web:abcdef1234567890abcdef12'
        const __firebase_config = JSON.stringify({
           apiKey: "AIzaSyC1RQ5m7_utiAEsvyobIuuwxzAzBLx27Sw",
           authDomain: "central-cars-a37ae.firebaseapp.com",
           projectId: "central-cars-a37ae",
           storageBucket: "central-cars-a37ae.firebasestorage.app",
           messagingSenderId: "297273470734",
           appId: "1:297273470734:web:7d35e6619b28dc569d715f",
           measurementId: "G-4LXQG2VWP2"
        });
        // __initial_auth_token n'est plus utilisé car l'authentification Firebase est désormais gérée par email/mot de passe.
        const __initial_auth_token = '';

        // --- Cloudinary Configuration ---
        // REMPLACEZ CES VALEURS PAR LES VÔTRES !
        // cloudName: Votre "Cloud Name" depuis le tableau de bord Cloudinary.
        // uploadPreset: Le nom de votre "Upload Preset" non signé que vous avez créé dans Cloudinary (ex: 'your_unsigned_preset_name').
        const CLOUDINARY_CLOUD_NAME = 'dxneu57c0'; // Remplacez par votre Cloud Name Cloudinary
        const CLOUDINARY_UPLOAD_PRESET = 'central_cars_unsigned_upload'; // Remplacez par le nom de votre preset non signé

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, query, where, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-firestore.js";
        // Firebase Storage imports are removed as we are now using Cloudinary
        // import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-storage.js";

        // Global variables for app state
        let currentPage = 'home';
        let currentAdminTool = 'shop-management'; // Default admin tool view
        let vehicles = [];
        let clientDossiers = []; // New array for client dossiers
        let reviews = []; // New array for reviews
        let selectedVehicle = null;
        let selectedClientDossier = null; // New variable for selected client dossier
        let currentImageIndex = 0;
        let pageContent = {}; // Stores dynamic page content from Firestore

        // Auth state
        let currentUser = null;
        let userName = 'Non connecté';
        let userRole = 'guest'; // 'guest', 'client', 'admin'
        let isLoggedIn = false;
        let isAdmin = false;
        let isClient = false;

        // Firebase configuration and initialization
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-central-cars-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        // const storage = getStorage(app); // Firebase Storage is no longer used
        const auth = getAuth(app); // Initialize Firebase Auth

        // DOM Elements
        const appContent = document.getElementById('app-content');
        const userInfoDisplay = document.getElementById('user-info-display'); // Updated ID for user info display
        const navDossierButton = document.getElementById('nav-dossier');
        const navLoginSignupButton = document.getElementById('nav-login-signup'); // Renamed from navEspaceProButton
        const navAdminPanelButton = document.getElementById('nav-admin-panel'); // New button
        const navLogoutButton = document.getElementById('nav-logout');
        
        // Auth Modal elements
        const authModal = document.getElementById('auth-modal');
        const authModalTitle = document.getElementById('auth-modal-title');
        const authForm = document.getElementById('auth-form');
        const authNameGroup = document.getElementById('auth-name-group');
        const authNameInput = document.getElementById('auth-name');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authErrorMessage = document.getElementById('auth-error-message');
        const authSubmitButton = document.getElementById('auth-submit-button');
        const authToggleModeButton = document.getElementById('auth-toggle-mode');
        const authCloseButton = document.getElementById('auth-close-button');

        let isLoginMode = true; // State for Auth Modal: true for login, false for signup

        // Vehicle Detail Modal elements
        const vehicleDetailModal = document.getElementById('vehicle-detail-modal');
        const detailCloseButton = document.getElementById('detail-close-button');
        const detailCloseButtonBottom = document.getElementById('detail-close-button-bottom');
        const detailTitle = document.getElementById('detail-title');
        const detailImage = document.getElementById('detail-image');
        const prevImageButton = document.getElementById('prev-image');
        const nextImageButton = document.getElementById('next-image');
        const imageCounter = document.getElementById('image-counter');
        const detailPrice = document.getElementById('detail-price');
        const detailYear = document.getElementById('detail-year');
        const detailMileage = document.getElementById('detail-mileage');
        const detailEngineType = document.getElementById('detail-engine-type');
        const detailGearboxType = document.getElementById('detail-gearbox-type');
        const detailFuelType = document.getElementById('detail-fuel-type');
        const detailTaxHorsepower = document.getElementById('detail-tax-horsepower');
        const detailSteamHorsepower = document.getElementById('detail-steam-horsepower');
        const detailDescription = document.getElementById('detail-description');
        const detailOptionsSection = document.getElementById('detail-options-section');
        const detailOptionsList = document.getElementById('detail-options');
        const callGarageButton = document.getElementById('call-garage-button');

        // Fullscreen Image Modal elements
        const fullscreenImageModal = document.getElementById('fullscreen-image-modal');
        const fullscreenCloseButton = document.getElementById('fullscreen-close-button');
        const fullscreenImage = document.getElementById('fullscreen-image');

        // Admin Tool specific elements (declared globally for access after content render)
        let adminToolContentArea; // The div where specific admin tool content will be loaded

        // Shop Management Tool elements
        let adminImageUploadInput;
        let adminUploadStatus;
        let adminOptionsCheckboxesContainer;
        let adminImageUrlsContainer;
        let adminCustomOptionInput;
        let adminAddCustomOptionButton;
        let shopManagementForm;
        let shopManagementSubmitButton;
        let shopManagementCancelEditButton;
        let shopManagementFormTitle;
        let adminMakeSelect;
        let adminFuelTypeSelect;
        let adminGearboxTypeSelect;
        let adminAddImageUrlButton;
        let adminIsSoldCheckbox;

        // ANTS Tool elements
        let antsMaVariableInput;
        let antsAccessDossierButton;

        // Client Dossier Tool elements
        let clientDossierForm;
        let clientDossierSubmitButton;
        let clientDossierCancelEditButton;
        let clientDossierFormTitle;
        let clientDossiersTableBody;
        let clientDossiersNoDataMessage;
        let clientDossiersError;
        let dossierSearchInput;
        let dossierDetailsDisplay;

        // Review Form elements (on homepage)
        let reviewForm;
        let reviewRatingInput;
        let reviewCommentInput;
        let reviewSubmitButton;
        let reviewStatusMessage;
        let googleReviewsContainer;

        // Drag and drop variables
        let draggedItem = null;


        // --- Page Content Templates ---

        // Helper function to generate vehicle card HTML (reused for shop and home)
        function generateVehicleCardHtml(vehicle, isFeatured = false) {
            const imageUrl = vehicle.imageUrls && vehicle.imageUrls.length > 0 ? vehicle.imageUrls[0] : `https://placehold.co/400x250/ADD8E6/000000?text=${vehicle.make}+${vehicle.model}`;
            const cardClass = isFeatured ? 'featured-vehicle-card' : 'vehicle-card';
            const imageContainerClass = isFeatured ? 'featured-image-container' : 'vehicle-card-image-container';
            const imageClass = isFeatured ? 'featured-image' : 'vehicle-card-image';
            const contentClass = isFeatured ? 'featured-vehicle-card-content' : 'vehicle-card-content';
            const titleClass = isFeatured ? 'featured-vehicle-card-title' : 'vehicle-card-title';
            const priceClass = isFeatured ? 'featured-vehicle-card-price' : 'vehicle-card-price';
            const detailClass = isFeatured ? 'featured-vehicle-card-detail' : 'vehicle-card-detail';
            const descriptionClass = 'hidden'; // Description is always hidden on cards

            const soldOverlay = vehicle.isSold ? `<div class="sold-overlay">VENDU</div>` : '';
            // Conditionally display price or nothing in the title based on isSold
            const priceHtml = vehicle.isSold ? '' : `<span class="${priceClass} w-full">${new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(vehicle.price)}</span>`;

            return `
                <div class="${cardClass}" data-vehicle-id="${vehicle.id}">
                    <div class="${imageContainerClass}">
                        <img src="${imageUrl}" alt="${vehicle.make} ${vehicle.model}" class="${imageClass}" onerror="this.onerror=null;this.src='https://placehold.co/400x250/ADD8E6/000000?text=Image+non+disponible';" />
                        ${soldOverlay} <!-- Sold overlay directly on the image container -->
                    </div>
                    <div class="${contentClass}">
                        <h2 class="${titleClass} w-full">${vehicle.make.toUpperCase()} ${vehicle.model.toUpperCase()}</h2>
                        ${priceHtml} <!-- Price moved outside h2 for separate line -->
                        <p class="${detailClass}">Année: ${vehicle.year}</p>
                        ${vehicle.engineType ? `<p class="${detailClass}">Motorisation: ${vehicle.engineType}</p>` : ''}
                        ${vehicle.steamHorsepower ? `<p class="${detailClass}">Puissance: ${vehicle.steamHorsepower} ch</p>` : ''}
                        <p class="${descriptionClass}">${vehicle.description || ''}</p>
                    </div>
                </div>
            `;
        }

        // Helper to generate star ratings
        function generateStars(rating) {
            let stars = '';
            for (let i = 0; i < 5; i++) {
                stars += `<span class="text-yellow-500 text-xl">${i < rating ? '&#9733;' : '&#9734;'}</span>`;
            }
            return stars;
        }

        // Helper to create an editable field wrapper
        function createEditableField(pageId, fieldName, content, tag = 'p', isTitle = false) {
            const elementId = `${pageId}-${fieldName}`;
            const isEditingClass = isAdmin ? 'editable-field-container' : '';
            const tagType = isTitle ? 'h1' : tag; // Use h1 for main titles

            return `
                <div class="${isEditingClass}" data-page-id="${pageId}" data-field-name="${fieldName}" data-tag="${tag}">
                    <${tagType} id="${elementId}" class="${isTitle ? 'w-full' : ''}">${content}</${tagType}>
                    ${isAdmin ? `
                    <div class="editable-controls space-x-2">
                        <button class="edit-btn" data-action="edit">Éditer</button>
                        <button class="save-btn hidden" data-action="save">Sauvegarder</button>
                        <button class="cancel-btn hidden" data-action="cancel">Annuler</button>
                    </div>` : ''}
                </div>
            `;
        }

        // Page content functions now accept pageData
        function getHomePageContent(pageData) {
            return `
                <div class="bg-white p-8 rounded-lg shadow-xl text-gray-800 my-8">
                    ${createEditableField('home', 'title', pageData.title, 'h1', true)}
                    ${createEditableField('home', 'paragraph1', pageData.paragraph1)}
                    
                    <div class="mt-12 p-6 bg-blue-50 rounded-lg shadow-md">
                        ${createEditableField('home', 'featured_vehicles_title', pageData.featured_vehicles_title, 'h2')}
                        <div id="featured-vehicles-container" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Featured vehicles will be loaded here -->
                        </div>
                        <p id="no-featured-vehicles-message" class="text-center text-xl text-gray-600 mt-8 hidden">Aucun véhicule en vedette pour le moment.</p>
                    </div>

                    <div class="mt-12 text-center">
                        <img
                            src="https://placehold.co/800x400/ADD8E6/000000?text=Garage+CENTRAL+CARS"
                            alt="Image du garage CENTRAL CARS"
                            class="rounded-lg shadow-md mx-auto w-full max-w-4xl"
                            onerror="this.onerror=null;this.src='https://placehold.co/800x400/ADD8E6/000000?text=Image+non+disponible';"
                        />
                    </div>

                    <!-- New Google Reviews Section -->
                    <div class="mt-12 p-6 bg-yellow-50 rounded-lg shadow-md">
                        ${createEditableField('home', 'reviews_title', pageData.reviews_title, 'h2')}
                        <div id="google-reviews-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Reviews will be loaded here -->
                        </div>
                        <p class="text-center text-gray-600 text-sm mt-6">
                            Ces avis sont des exemples. Pour une intégration en temps réel des avis Google, une API dédiée ou un service tiers serait nécessaire.
                        </p>
                        <div class="text-center mt-4">
                            <a href="https://g.co/kgs/rCYbWHK" target="_blank" class="text-blue-600 hover:underline font-medium">Voir tous les avis Google</a>
                        </div>
                    </div>

                    <!-- Add Review Section (visible only when logged in) -->
                    <div id="add-review-section" class="mt-12 p-6 bg-green-50 rounded-lg shadow-md hidden">
                        ${createEditableField('home', 'add_review_title', pageData.add_review_title, 'h2')}
                        <form id="review-form" class="space-y-4">
                            <div>
                                <label for="review-rating" class="block text-gray-700 font-medium mb-1">Note (1-5 étoiles)</label>
                                <input type="number" id="review-rating" min="1" max="5" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required />
                            </div>
                            <div>
                                <label for="review-comment" class="block text-gray-700 font-medium mb-1">Votre commentaire</label>
                                <textarea id="review-comment" rows="4" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required></textarea>
                            </div>
                            <button type="submit" id="review-submit-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105">Soumettre l'avis</button>
                            <p id="review-status-message" class="mt-4 text-center text-green-600 font-semibold"></p>
                        </form>
                    </div>
                </div>
            `;
        }

        function getAboutPageContent(pageData) {
            return `
                <div class="bg-white p-8 rounded-lg shadow-xl text-gray-800 my-8">
                    ${createEditableField('about', 'title', pageData.title, 'h1', true)}
                    ${createEditableField('about', 'paragraph1', pageData.paragraph1)}
                    <div class="grid md:grid-cols-2 gap-8 mt-10">
                        <div class="flex flex-col items-center text-center">
                            <svg class="w-16 h-16 text-blue-600 mb-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm0 6a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2zm0 6a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2z" clip-rule="evenodd"></path>
                            </svg>
                            ${createEditableField('about', 'mission_title', pageData.mission_title, 'h3')}
                            ${createEditableField('about', 'mission_text', pageData.mission_text)}
                        </div>
                        <div class="flex flex-col items-center text-center">
                            <svg class="w-16 h-16 text-blue-600 mb-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                                <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
                            </svg>
                            ${createEditableField('about', 'vision_title', pageData.vision_title, 'h3')}
                            ${createEditableField('about', 'vision_text', pageData.vision_text)}
                        </div>
                    </div>
                    <div class="mt-10 text-center">
                        ${createEditableField('about', 'commitments_title', pageData.commitments_title, 'h2')}
                        <ul class="list-disc list-inside text-lg text-gray-700 max-w-2xl mx-auto space-y-2">
                            <li>${createEditableField('about', 'commitment1', pageData.commitment1, 'span')}</li>
                            <li>${createEditableField('about', 'commitment2', pageData.commitment2, 'span')}</li>
                            <li>${createEditableField('about', 'commitment3', pageData.commitment3, 'span')}</li>
                            <li>${createEditableField('about', 'commitment4', pageData.commitment4, 'span')}</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function getContactPageContent(pageData) {
            return `
                <div class="bg-white p-8 rounded-lg shadow-xl text-gray-800 my-8">
                    ${createEditableField('contact', 'title', pageData.title, 'h1', true)}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            ${createEditableField('contact', 'contact_info_title', pageData.contact_info_title, 'h2')}
                            <p class="mb-2"><strong class="text-blue-600">Adresse:</strong> ${createEditableField('contact', 'address', pageData.address, 'span')}</p>
                            <p class="mb-2"><strong class="text-blue-600">Téléphone:</strong> ${createEditableField('contact', 'phone', pageData.phone, 'span')}</p>
                            <p class="mb-2"><strong class="text-blue-600">Email:</strong> ${createEditableField('contact', 'email', pageData.email, 'span')}</p>
                            <p class="mb-2">${createEditableField('contact', 'hours_title', pageData.hours_title, 'strong')}</p>
                            <ul class="list-disc list-inside ml-4">
                                <li>${createEditableField('contact', 'hours_mon_fri', pageData.hours_mon_fri, 'span')}</li>
                                <li>${createEditableField('contact', 'hours_sat', pageData.hours_sat, 'span')}</li>
                                <li>${createEditableField('contact', 'hours_sun', pageData.hours_sun, 'span')}</li>
                            </ul>
                            <div class="mt-6">
                                ${createEditableField('contact', 'map_title', pageData.map_title, 'h3')}
                                <div class="aspect-w-16 aspect-h-9 rounded-lg overflow-hidden shadow-md">
                                    <iframe
                                        src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d2535.8080000000003!2d3.5786483!3d50.4005083!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x47c2b3f1a0e1b5f1%3A0x6d7e2e3f4a5b6c7d!2s576%20Rue%20Marcel%20Sembat%2C%2059690%20Vieux-Cond%C3%A9%2C%20France!5e0!3m2!1sen!2sfr!4v1700000000000!5m2!1sfr!2sfr"
                                        width="100%"
                                        height="300"
                                        style="border:0;"
                                        allowfullscreen=""
                                        loading="lazy"
                                        referrerpolicy="no-referrer-when-downgrade"
                                        title="Localisation de CENTRAL CARS"
                                        class="rounded-lg"
                                    ></iframe>
                                </div>
                            </div>
                        </div>
                        <div>
                            ${createEditableField('contact', 'message_section_title', pageData.message_section_title, 'h2')}
                            <form id="contact-form" class="space-y-4">
                                <div>
                                    <label for="contact-name" class="block text-gray-700 font-medium mb-1">Nom</label>
                                    <input type="text" id="contact-name" name="name" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                                </div>
                                <div>
                                    <label for="contact-email" class="block text-gray-700 font-medium mb-1">Email</label>
                                    <input type="email" id="contact-email" name="email" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                                </div>
                                <div>
                                    <label for="contact-message" class="block text-gray-700 font-medium mb-1">Votre Message</label>
                                    <textarea id="contact-message" name="message" rows="5" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required></textarea>
                                </div>
                                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105">Envoyer le Message</button>
                                <p id="contact-status-message" class="mt-4 text-center text-green-600 font-semibold"></p>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }

        // Shop Page Content (no changes to this content itself)
        const shopPageContent = `
            <div class="bg-white p-8 rounded-lg shadow-xl text-gray-800 my-8 relative">
                <h1 class="text-4xl font-bold text-center text-blue-700 mb-8">Notre Boutique</h1>
                <!-- Admin Access Icon - Removed from here, now in main nav -->
                <div id="shop-vehicles-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Vehicles will be loaded here -->
                </div>
                <p id="no-vehicles-message" class="text-center text-xl text-gray-600 mt-8 hidden">Aucun véhicule n'est actuellement disponible à la vente. Revenez bientôt !</p>
                <div id="shop-loading" class="flex justify-center items-center h-48">
                    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
                    <p class="ml-4 text-xl text-gray-700">Chargement des véhicules...</p>
                </div>
                <p id="shop-error" class="text-center text-xl text-red-600 mt-8 hidden"></p>
            </div>
        `;

        // New Admin Tools Main Page Content
        const adminToolsPageContent = `
            <div class="bg-white p-8 rounded-lg shadow-xl text-gray-800 my-8">
                <h1 class="text-4xl font-bold text-center text-blue-700 mb-8">Panneau d'Administration</h1>

                <!-- Sub-navigation for Admin Tools -->
                <div class="flex flex-wrap justify-center gap-4 mb-8 border-b-2 border-gray-200 pb-4">
                    <button id="subnav-shop-management" class="btn btn-secondary">Gestion Boutique</button>
                    <button id="subnav-ants-tool" class="btn btn-secondary">Outil ANTS</button>
                    <button id="subnav-client-dossiers" class="btn btn-secondary">Dossiers Clients</button>
                    <button id="subnav-page-management" class="btn btn-secondary">Gestion des Pages</button>
                    <button id="admin-logout-button" class="btn btn-danger">Quitter le mode Admin</button>
                </div>

                <!-- Content area for selected admin tool -->
                <div id="admin-tool-content-area">
                    <!-- Specific tool content will be loaded here by renderAdminToolContent -->
                </div>
            </div>
        `;

        // Renamed existing adminPageContent to shopManagementToolContent
        const shopManagementToolContent = `
            <div id="shop-management-tool-container">
                <div id="admin-form-section" class="mb-12 p-6 border border-blue-200 rounded-lg shadow-md bg-blue-50">
                    <h2 id="admin-form-title" class="text-3xl font-semibold text-blue-800 mb-6 text-center">Ajouter un Nouveau Véhicule</h2>
                    <form id="admin-vehicle-form" class="space-y-6">
                        <!-- Section: Détails du Véhicule -->
                        <div class="bg-white p-6 rounded-lg shadow-inner border border-gray-200">
                            <h3 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Détails du Véhicule</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="admin-make" class="block text-gray-700 font-medium mb-1">Marque</label>
                                    <select id="admin-make" name="make" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                        <!-- Options will be dynamically loaded -->
                                    </select>
                                </div>
                                <div>
                                    <label for="admin-model" class="block text-gray-700 font-medium mb-1">Modèle</label>
                                    <input type="text" id="admin-model" name="model" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                                </div>
                                <div>
                                    <label for="admin-year" class="block text-gray-700 font-medium mb-1">Année</label>
                                    <input type="number" id="admin-year" name="year" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                                </div>
                                <div>
                                    <label for="admin-price" class="block text-gray-700 font-medium mb-1">Prix (€)</label>
                                    <input type="number" id="admin-price" name="price" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" step="0.01" required />
                                </div>
                                <div>
                                    <label for="admin-mileage" class="block text-gray-700 font-medium mb-1">Kilométrage (km)</label>
                                    <input type="number" id="admin-mileage" name="mileage" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                                <div>
                                    <label for="admin-engineType" class="block text-gray-700 font-medium mb-1">Motorisation</label>
                                    <input type="text" id="admin-engineType" name="engineType" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                                <div>
                                    <label for="admin-gearboxType" class="block text-gray-700 font-medium mb-1">Type de boîte de vitesse</label>
                                    <select id="admin-gearboxType" name="gearboxType" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <!-- Options will be dynamically loaded -->
                                    </select>
                                </div>
                                <div>
                                    <label for="admin-fuelType" class="block text-gray-700 font-medium mb-1">Carburant</label>
                                    <select id="admin-fuelType" name="fuelType" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <!-- Options will be dynamically loaded -->
                                    </select>
                                </div>
                                <div>
                                    <label for="admin-taxHorsepower" class="block text-gray-700 font-medium mb-1">Puissance fiscale (CV)</label>
                                    <input type="number" id="admin-taxHorsepower" name="taxHorsepower" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                                <div>
                                    <label for="admin-steamHorsepower" class="block text-gray-700 font-medium mb-1">Puissance (ch)</label>
                                    <input type="number" id="admin-steamHorsepower" name="steamHorsepower" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                                <div class="md:col-span-2 flex items-center">
                                    <input type="checkbox" id="admin-is-sold" name="isSold" class="h-5 w-5 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                                    <label for="admin-is-sold" class="ml-2 block text-lg text-gray-700 font-medium">Véhicule Vendu</label>
                                </div>
                            </div>
                        </div>

                        <!-- Section: Images -->
                        <div class="bg-white p-6 rounded-lg shadow-inner border border-gray-200">
                            <h3 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Images du Véhicule</h3>
                            <div class="mb-4">
                                <label for="admin-image-upload" class="block text-gray-700 font-medium mb-1">Téléverser de nouvelles Images</label>
                                <input type="file" id="admin-image-upload" name="imageUpload" multiple accept="image/*" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                <p id="admin-upload-status" class="text-sm text-gray-600 mt-2 hidden"></p>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-1">Images existantes (glisser-déposer pour réorganiser)</label>
                                <div id="admin-image-urls-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 p-3 border border-gray-300 rounded-md bg-gray-50 min-h-[120px]">
                                    <!-- Dynamic image URL inputs/thumbnails will be loaded here -->
                                </div>
                                <button type="button" id="admin-add-image-url-btn" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">Ajouter une URL d'image</button>
                            </div>
                        </div>

                        <!-- Section: Options -->
                        <div class="bg-white p-6 rounded-lg shadow-inner border border-gray-200">
                            <h3 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Options du Véhicule</h3>
                            <div id="admin-options-checkboxes-container" class="space-y-3">
                                <!-- Accordion sections for options will be dynamically loaded here -->
                            </div>
                            <div class="flex items-center mt-6">
                                <input type="text" id="admin-custom-option-input" placeholder="Ajouter une option personnalisée" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                <button type="button" id="admin-add-custom-option-btn" class="ml-2 px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition">Ajouter</button>
                            </div>
                        </div>

                        <!-- Section: Description -->
                        <div class="bg-white p-6 rounded-lg shadow-inner border border-gray-200">
                            <h3 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Description</h3>
                            <div>
                                <label for="admin-description" class="block text-gray-700 font-medium mb-1">Description (sera complétée automatiquement)</label>
                                <textarea id="admin-description" name="description" rows="6" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required></textarea>
                            </div>
                        </div>

                        <div class="flex justify-end space-x-4 mt-6">
                            <button type="button" id="admin-cancel-edit" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-6 rounded-md transition duration-300 ease-in-out transform hover:scale-105 hidden">Annuler l'édition</button>
                            <button type="submit" id="admin-submit-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105">Ajouter le Véhicule</button>
                        </div>
                    </form>
                </div>

                <h2 class="text-3xl font-semibold text-gray-800 mb-6 text-center">Véhicules Actuels</h2>
                <div id="admin-vehicles-table-container" class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Marque</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Modèle</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Année</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Prix</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-vehicles-table-body">
                            <!-- Vehicles will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <p id="admin-no-vehicles-message" class="text-center text-xl text-gray-600 mt-8 hidden"></p>
                <p id="admin-error" class="text-center text-xl text-red-600 mt-8 hidden"></p>
            </div>
        `;

        // Renamed existing antsPageContent to antsToolContent
        const antsToolContent = `
            <div id="ants-tool-container" class="flex-grow px-4 py-8 flex flex-col items-center justify-center text-center">
                <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg w-full max-w-md">
                    <h1 class="text-2xl sm:text-3xl font-bold text-slate-700 mb-6">Accès Dossier ANTS</h1>
                    <input type="text" id="maVariable" maxlength="8" placeholder="Entrer numéro dossier" class="w-full p-3 mb-4 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-center text-lg">
                    <button id="access-dossier-button" class="w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-150 ease-in-out text-lg">
                        Accéder au dossier
                    </button>
                </div>
            </div>
        `;

        // Client Dossier Page Content
        const dossierPageContent = `
            <div class="bg-white p-8 rounded-lg shadow-xl text-gray-800 my-8">
                <h1 class="text-4xl font-bold text-center text-blue-700 mb-8">Mon Dossier Client</h1>
                <div class="max-w-md mx-auto p-6 border border-blue-200 rounded-lg shadow-md bg-blue-50">
                    <label for="dossier-search-input" class="block text-gray-700 font-medium mb-1">Rechercher par numéro de dossier</label>
                    <div class="flex space-x-2 mb-4">
                        <input type="text" id="dossier-search-input" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Entrez le numéro de dossier" />
                        <button id="dossier-search-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105">Rechercher</button>
                    </div>
                    <div id="dossier-details-display" class="mt-6 p-4 border border-gray-300 rounded-md bg-white hidden">
                        <!-- Dossier details will be displayed here -->
                    </div>
                    <p id="dossier-error-message" class="text-red-500 text-sm mt-4 hidden"></p>
                </div>
            </div>
        `;

        // Client Dossier Tool Content (for Admin Panel)
        const clientDossierToolContent = `
            <div id="client-dossier-tool-container">
                <div class="p-6 border border-blue-200 rounded-lg shadow-md bg-blue-50 mb-8">
                    <h2 id="client-dossier-form-title" class="text-3xl font-semibold text-blue-800 mb-6 text-center">Ajouter un Nouveau Dossier Client</h2>
                    <form id="client-dossier-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="client-name" class="block text-gray-700 font-medium mb-1">Nom du Client</label>
                            <input type="text" id="client-name" name="clientName" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                        </div>
                        <div>
                            <label for="client-vehicle" class="block text-gray-700 font-medium mb-1">Véhicule</label>
                            <input type="text" id="client-vehicle" name="vehicle" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        </div>
                        <div>
                            <label for="client-vin" class="block text-gray-700 font-medium mb-1">VIN (Numéro d'identification du véhicule)</label>
                            <input type="text" id="client-vin" name="vin" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        </div>
                        <div>
                            <label for="client-invoice-number" class="block text-gray-700 font-medium mb-1">Numéro de Facture</label>
                            <input type="text" id="client-invoice-number" name="invoiceNumber" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        </div>
                        <div>
                            <label for="client-status" class="block text-gray-700 font-medium mb-1">Statut du Dossier</label>
                            <select id="client-status" name="status" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="En cours">En cours</option>
                                <option value="Terminé">Terminé</option>
                                <option value="En attente">En attente</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label for="client-notes" class="block text-gray-700 font-medium mb-1">Notes</label>
                            <textarea id="client-notes" name="notes" rows="3" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        <div class="md:col-span-2 flex justify-end space-x-4 mt-4">
                            <button type="button" id="client-dossier-cancel-edit" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-6 rounded-md transition duration-300 ease-in-out transform hover:scale-105 hidden">Annuler l'édition</button>
                            <button type="submit" id="client-dossier-submit-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105">Ajouter le Dossier</button>
                        </div>
                    </form>
                </div>

                <h2 class="text-3xl font-semibold text-gray-800 mb-6 text-center">Dossiers Clients Actuels</h2>
                <div id="client-dossiers-table-container" class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Client</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Véhicule</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">VIN</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Facture</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Statut</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="client-dossiers-table-body">
                            <!-- Client dossiers will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <p id="client-dossiers-no-data-message" class="text-center text-xl text-gray-600 mt-8 hidden"></p>
                <p id="client-dossiers-error" class="text-center text-xl text-red-600 mt-8 hidden"></p>
            </div>
        `;

        // Page Management Tool Content
        const pageManagementToolContent = `
            <div id="page-management-tool-container">
                <h2 class="text-3xl font-semibold text-gray-800 mb-6 text-center">Gérer le Contenu des Pages</h2>

                <!-- Home Page Section -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h3 class="text-2xl font-semibold text-blue-700 mb-4">Page d'Accueil (Accueil)</h3>
                    <div id="page-content-home" class="space-y-4">
                        <!-- Home page editable fields will be loaded here -->
                        <p class="text-gray-600">Chargement du contenu...</p>
                    </div>
                </div>

                <!-- About Page Section -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h3 class="text-2xl font-semibold text-blue-700 mb-4">Page À Propos (About)</h3>
                    <div id="page-content-about" class="space-y-4">
                        <!-- About page editable fields will be loaded here -->
                        <p class="text-gray-600">Chargement du contenu...</p>
                    </div>
                </div>

                <!-- Contact Page Section -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h3 class="text-2xl font-semibold text-blue-700 mb-4">Page Contact (Contact)</h3>
                    <div id="page-content-contact" class="space-y-4">
                        <!-- Contact page editable fields will be loaded here -->
                        <p class="text-gray-600">Chargement du contenu...</p>
                    </div>
                </div>
            </div>
        `;


        // --- Core Application Logic ---

        // Function to render content based on current page
        async function renderPage() {
            appContent.innerHTML = ''; // Clear current content
            // Fetch page content before rendering
            await fetchPageContent();

            switch (currentPage) {
                case 'home':
                    appContent.innerHTML = getHomePageContent(pageContent.home || {});
                    loadFeaturedVehicles(); // Load featured vehicles on home page
                    loadReviews(); // Load reviews on home page
                    setupReviewForm(); // Setup review form
                    // Show/hide add review section based on login status
                    if (isLoggedIn) {
                        document.getElementById('add-review-section').classList.remove('hidden');
                    } else {
                        document.getElementById('add-review-section').classList.add('hidden');
                    }
                    break;
                case 'shop':
                    appContent.innerHTML = shopPageContent;
                    loadShopVehicles();
                    break;
                case 'about': // Changed from 'services'
                    appContent.innerHTML = getAboutPageContent(pageContent.about || {});
                    break;
                case 'contact':
                    appContent.innerHTML = getContactPageContent(pageContent.contact || {});
                    setupContactForm();
                    break;
                case 'dossier': // New page for client dossiers
                    if (isLoggedIn) {
                        appContent.innerHTML = dossierPageContent;
                        setupDossierPage();
                    } else {
                        currentPage = 'home';
                        renderPage();
                        alert("Veuillez vous connecter pour accéder à votre dossier.");
                    }
                    break;
                case 'admin-tools': // New case for admin tools main page
                    if (isAdmin) {
                        appContent.innerHTML = adminToolsPageContent;
                        adminToolContentArea = document.getElementById('admin-tool-content-area');
                        setupAdminToolsPage(); // Setup sub-navigation and initial tool
                        renderAdminToolContent(currentAdminTool); // Render the default or last selected admin tool
                    } else {
                        // If not admin, redirect to home or show access denied message
                        currentPage = 'home'; // Redirect to home if not authorized
                        renderPage(); // Re-render home page
                        alert("Accès refusé. Vous n'êtes pas autorisé à accéder au panneau d'administration.");
                    }
                    break;
                default:
                    appContent.innerHTML = getHomePageContent(pageContent.home || {});
            }
            updateNavbarActiveState();
        }

        // Update Navbar active state and visibility of auth-related buttons
        function updateNavbarActiveState() {
            document.querySelectorAll('nav button').forEach(button => {
                // Exclude auth/admin/logout buttons from regular active state logic
                if (button.id === 'nav-login-signup' || button.id === 'nav-admin-panel' || button.id === 'nav-logout') {
                    return;
                }

                const page = button.id.replace('nav-', '');
                if (page === currentPage) {
                    button.classList.add('bg-gray-700');
                } else {
                    button.classList.remove('bg-gray-700');
                }
            });

            // Handle visibility of auth/admin/logout buttons
            if (isLoggedIn) {
                navLoginSignupButton.classList.add('hidden'); // Hide login/signup if logged in
                navLogoutButton.classList.remove('hidden'); // Show logout if logged in
                if (isAdmin) {
                    navAdminPanelButton.classList.remove('hidden'); // Show admin panel button for admins
                    navDossierButton.classList.add('hidden'); // Admins don't need client dossier page
                } else {
                    navAdminPanelButton.classList.add('hidden'); // Hide admin panel button for non-admins
                    if (isClient) {
                        navDossierButton.classList.remove('hidden'); // Show dossier for clients
                    } else {
                        navDossierButton.classList.add('hidden'); // Hide dossier for other logged-in roles (if any)
                    }
                }
            } else {
                navLoginSignupButton.classList.remove('hidden'); // Show login/signup if not logged in
                navLogoutButton.classList.add('hidden'); // Hide logout if not logged in
                navAdminPanelButton.classList.add('hidden'); // Hide admin panel button if not logged in
                navDossierButton.classList.add('hidden'); // Hide dossier if not logged in
            }

            // Update footer user info
            if (isLoggedIn) {
                userInfoDisplay.textContent = `Connecté en tant que: ${userName} (Rôle: ${userRole})`;
            } else {
                userInfoDisplay.textContent = `Non connecté`;
            }
        }

        // --- Firebase Auth Logic ---
        function setupAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    isLoggedIn = true;
                    // Fetch user role from Firestore
                    try {
                        const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, user.uid);
                        const userDocSnap = await getDoc(userDocRef);
                        if (userDocSnap.exists()) {
                            const userData = userDocSnap.data();
                            userName = userData.name || user.email;
                            userRole = userData.role || 'client'; // Default to client if role not set
                            isAdmin = (userRole === 'admin');
                            isClient = (userRole === 'client');
                        } else {
                            // User exists in Auth but not in Firestore 'users' collection (e.g., old user or manual creation)
                            // Create a basic user profile in Firestore if it doesn't exist
                            await setDoc(userDocRef, {
                                name: user.displayName || user.email,
                                email: user.email,
                                role: 'client', // Default role for new Firestore user profiles
                                createdAt: new Date()
                            }, { merge: true }); // Use merge to avoid overwriting if partial data exists
                            userName = user.displayName || user.email;
                            userRole = 'client';
                            isAdmin = false;
                            isClient = true;
                        }
                    } catch (error) {
                        console.error("Erreur lors de la récupération/création du profil utilisateur Firestore:", error);
                        userName = user.displayName || user.email; // Fallback
                        userRole = 'client'; // Assume client role on error
                        isAdmin = false;
                        isClient = true;
                    }
                    console.log(`Utilisateur connecté: ${userName} (Rôle: ${userRole}, UID: ${user.uid})`); // Added UID for debugging
                } else {
                    currentUser = null;
                    userName = 'Non connecté';
                    userRole = 'guest';
                    isLoggedIn = false;
                    isAdmin = false;
                    isClient = false;
                    console.log("Utilisateur déconnecté.");
                }
                renderPage(); // Re-render the page to update UI based on auth state
            });
        }

        function showAuthModal(mode = 'login') {
            isLoginMode = (mode === 'login');
            authErrorMessage.classList.add('hidden');
            authEmailInput.value = '';
            authPasswordInput.value = '';
            authNameInput.value = '';

            if (isLoginMode) {
                authModalTitle.textContent = 'Connexion';
                authSubmitButton.textContent = 'Se connecter';
                authToggleModeButton.textContent = 'Pas encore de compte ? S\'inscrire';
                authNameGroup.classList.add('hidden');
                authNameInput.removeAttribute('required');
            } else {
                authModalTitle.textContent = 'Créer un compte';
                authSubmitButton.textContent = 'S\'inscrire';
                authToggleModeButton.textContent = 'Déjà un compte ? Se connecter';
                authNameGroup.classList.remove('hidden');
                authNameInput.setAttribute('required', 'required');
            }
            authModal.classList.remove('modal-hidden');
            authModal.classList.add('modal-visible');
        }

        function hideAuthModal() {
            authModal.classList.remove('modal-visible');
            authModal.classList.add('modal-hidden');
        }

        async function handleAuthFormSubmit(e) {
            e.preventDefault();
            authErrorMessage.classList.add('hidden'); // Hide previous errors

            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            const name = authNameInput.value;

            if (isLoginMode) {
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    hideAuthModal();
                    // onAuthStateChanged will handle UI update
                } catch (error) {
                    console.error("Erreur de connexion:", error);
                    let message = "Erreur de connexion. Veuillez vérifier votre email et mot de passe.";
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        message = "Email ou mot de passe incorrect.";
                    } else if (error.code === 'auth/invalid-email') {
                        message = "Format d'email invalide.";
                    }
                    authErrorMessage.textContent = message;
                    authErrorMessage.classList.remove('hidden');
                }
            } else { // Signup mode
                if (!name.trim()) {
                    authErrorMessage.textContent = "Veuillez entrer votre nom.";
                    authErrorMessage.classList.remove('hidden');
                    return;
                }
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    // Store user's name and role in Firestore
                    await setDoc(doc(db, `artifacts/${appId}/public/data/users`, userCredential.user.uid), {
                        name: name,
                        email: email,
                        role: 'client', // Default role for new users
                        createdAt: new Date()
                    });
                    hideAuthModal();
                    alert("Compte créé avec succès ! Vous êtes maintenant connecté.");
                    // onAuthStateChanged will handle UI update
                } catch (error) {
                    console.error("Erreur d'inscription:", error);
                    let message = "Erreur lors de la création du compte.";
                    if (error.code === 'auth/email-already-in-use') {
                        message = "Cet email est déjà utilisé.";
                    } else if (error.code === 'auth/weak-password') {
                        message = "Le mot de passe doit contenir au moins 6 caractères.";
                    } else if (error.code === 'auth/invalid-email') {
                        message = "Format d'email invalide.";
                    }
                    authErrorMessage.textContent = message;
                    authErrorMessage.classList.remove('hidden');
                }
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                // onAuthStateChanged will handle UI update
                currentPage = 'home'; // Redirect to home after logout
                renderPage();
            } catch (error) {
                console.error("Erreur de déconnexion:", error);
                alert("Erreur lors de la déconnexion.");
            }
        }

        // --- Shop Page Logic ---
        function loadShopVehicles() {
            const shopVehiclesContainer = document.getElementById('shop-vehicles-container');
            const shopLoading = document.getElementById('shop-loading');
            const shopError = document.getElementById('shop-error');
            const noVehiclesMessage = document.getElementById('no-vehicles-message');

            if (shopLoading) shopLoading.classList.remove('hidden');
            if (shopError) shopError.classList.add('hidden');
            if (noVehiclesMessage) noVehiclesMessage.classList.add('hidden');
            if (shopVehiclesContainer) shopVehiclesContainer.innerHTML = ''; // Clear previous vehicles

            const vehiclesCollectionRef = collection(db, `artifacts/${appId}/public/data/vehicles`);
            onSnapshot(vehiclesCollectionRef, (snapshot) => {
                vehicles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (shopLoading) shopLoading.classList.add('hidden');

                if (vehicles.length === 0) {
                    if (noVehiclesMessage) noVehiclesMessage.classList.remove('hidden');
                } else {
                    if (noVehiclesMessage) noVehiclesMessage.classList.add('hidden');
                    shopVehiclesContainer.innerHTML = ''; // Clear before re-rendering
                    vehicles.forEach(vehicle => {
                        const vehicleCardHtml = generateVehicleCardHtml(vehicle); // Use the helper function
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = vehicleCardHtml;
                        const vehicleCard = tempDiv.firstElementChild;
                        vehicleCard.addEventListener('click', () => showVehicleDetailModal(vehicle.id));
                        shopVehiclesContainer.appendChild(vehicleCard);
                    });
                }
            }, (err) => {
                console.error("Erreur de récupération des véhicules:", err);
                if (shopLoading) shopLoading.classList.add('hidden');
                if (shopError) shopError.textContent = "Impossible de charger les véhicules. Veuillez réessayer plus tard.";
                if (shopError) shopError.classList.remove('hidden');
            });
        }

        // --- Vehicle Detail Modal Logic ---
        function showVehicleDetailModal(vehicleId) {
            selectedVehicle = vehicles.find(v => v.id === vehicleId);
            if (!selectedVehicle) return;

            // Populate modal content
            detailTitle.textContent = `${selectedVehicle.make} ${selectedVehicle.model}`;
            detailPrice.textContent = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(selectedVehicle.price);
            detailYear.textContent = selectedVehicle.year;
            detailMileage.textContent = new Intl.NumberFormat('fr-FR').format(selectedVehicle.mileage || 0);
            detailEngineType.textContent = selectedVehicle.engineType || 'N/A';
            detailGearboxType.textContent = selectedVehicle.gearboxType || 'N/A';
            detailFuelType.textContent = selectedVehicle.fuelType || 'N/A';
            detailTaxHorsepower.textContent = selectedVehicle.taxHorsepower || 'N/A';
            detailSteamHorsepower.textContent = selectedVehicle.steamHorsepower || 'N/A';
            detailDescription.textContent = selectedVehicle.description || 'Aucune description disponible.';

            // Handle options
            detailOptionsList.innerHTML = '';
            if (selectedVehicle.options && selectedVehicle.options.length > 0) {
                selectedVehicle.options.forEach(option => {
                    const li = document.createElement('li');
                    li.textContent = option;
                    detailOptionsList.appendChild(li);
                });
                detailOptionsSection.classList.remove('hidden');
            } else {
                detailOptionsSection.classList.add('hidden');
            }

            // Handle image carousel
            currentImageIndex = 0;
            updateDetailImage();

            // Show/hide carousel navigation
            if (selectedVehicle.imageUrls && selectedVehicle.imageUrls.length > 1) {
                prevImageButton.classList.remove('hidden');
                nextImageButton.classList.remove('hidden');
                imageCounter.classList.remove('hidden');
            } else {
                prevImageButton.classList.add('hidden');
                nextImageButton.classList.add('hidden');
                imageCounter.classList.add('hidden');
            }

            vehicleDetailModal.classList.remove('modal-hidden');
            vehicleDetailModal.classList.add('modal-visible');
        }

        function updateDetailImage() {
            if (selectedVehicle && selectedVehicle.imageUrls && selectedVehicle.imageUrls.length > 0) {
                detailImage.src = selectedVehicle.imageUrls[currentImageIndex];
                detailImage.alt = `${selectedVehicle.make} ${selectedVehicle.model} - Image ${currentImageIndex + 1}`;
                imageCounter.textContent = `${currentImageIndex + 1} / ${selectedVehicle.imageUrls.length}`;
            } else {
                detailImage.src = `https://placehold.co/600x400/ADD8E6/000000?text=Image+non+disponible`;
                detailImage.alt = `Image non disponible`;
                imageCounter.textContent = '';
            }
            detailImage.onerror = function() {
                this.onerror = null;
                this.src = `https://placehold.co/600x400/ADD8E6/000000?text=Image+non+disponible`;
            };
        }

        function hideVehicleDetailModal() {
            vehicleDetailModal.classList.remove('modal-visible');
            vehicleDetailModal.classList.add('modal-hidden');
            selectedVehicle = null;
        }

        // --- Fullscreen Image Modal Logic ---
        function showFullscreenImage(imageUrl) {
            fullscreenImage.src = imageUrl;
            fullscreenImage.onerror = function() {
                this.onerror = null;
                this.src = "https://placehold.co/1200x800/ADD8E6/000000?text=Image+non+disponible";
            };
            fullscreenImageModal.classList.remove('modal-hidden');
            fullscreenImageModal.classList.add('modal-visible');
        }

        function hideFullscreenImage() {
            fullscreenImageModal.classList.remove('modal-visible');
            fullscreenImageModal.classList.add('modal-hidden');
        }

        // --- Contact Page Logic ---
        function setupContactForm() {
            const contactForm = document.getElementById('contact-form');
            const contactStatusMessage = document.getElementById('contact-status-message');
            if (contactForm) {
                contactForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(contactForm);
                    const name = formData.get('name');
                    const email = formData.get('email');
                    const message = formData.get('message');

                    console.log('Formulaire de contact soumis:', { name, email, message });
                    contactStatusMessage.textContent = 'Votre message a été envoyé avec succès ! Nous vous répondrons bientôt.';
                    contactForm.reset(); // Réinitialiser le formulaire
                    setTimeout(() => contactStatusMessage.textContent = '', 5000); // Effacer le message après 5 secondes
                });
            }
        }

        // --- Admin Tools Main Page Logic ---
        function setupAdminToolsPage() {
            // Get sub-navigation buttons
            const subnavShopManagement = document.getElementById('subnav-shop-management');
            const subnavAntsTool = document.getElementById('subnav-ants-tool');
            const subnavClientDossiers = document.getElementById('subnav-client-dossiers');
            const subnavPageManagement = document.getElementById('subnav-page-management'); // New button
            const adminLogoutButton = document.getElementById('admin-logout-button');

            // Add event listeners for sub-navigation
            if (subnavShopManagement) {
                subnavShopManagement.addEventListener('click', () => renderAdminToolContent('shop-management'));
            }
            if (subnavAntsTool) {
                subnavAntsTool.addEventListener('click', () => renderAdminToolContent('ants-tool'));
            }
            if (subnavClientDossiers) {
                subnavClientDossiers.addEventListener('click', () => renderAdminToolContent('client-dossiers'));
            }
            if (subnavPageManagement) { // New event listener
                subnavPageManagement.addEventListener('click', () => renderAdminToolContent('page-management'));
            }
            if (adminLogoutButton) {
                adminLogoutButton.addEventListener('click', () => {
                    handleLogout(); // Use the general logout function
                });
            }
            updateAdminSubnavActiveState();
        }

        function updateAdminSubnavActiveState() {
            document.querySelectorAll('.flex.flex-wrap.justify-center.gap-4 button').forEach(button => {
                const toolName = button.id.replace('subnav-', '');
                if (toolName === currentAdminTool) {
                    button.classList.remove('btn-secondary');
                    button.classList.add('btn-primary');
                } else {
                    button.classList.remove('btn-primary');
                    button.classList.add('btn-secondary');
                }
            });
        }

        function renderAdminToolContent(toolName) {
            currentAdminTool = toolName; // Update the current tool
            if (!adminToolContentArea) {
                console.error("Admin tool content area not found.");
                return;
            }
            adminToolContentArea.innerHTML = ''; // Clear previous tool content

            switch (toolName) {
                case 'shop-management':
                    adminToolContentArea.innerHTML = shopManagementToolContent;
                    setupShopManagementTool();
                    loadShopManagementVehicles();
                    break;
                case 'ants-tool':
                    adminToolContentArea.innerHTML = antsToolContent;
                    setupAntsTool();
                    break;
                case 'client-dossiers':
                    adminToolContentArea.innerHTML = clientDossierToolContent;
                    setupClientDossierTool();
                    loadClientDossiers();
                    break;
                case 'page-management': // New case
                    adminToolContentArea.innerHTML = pageManagementToolContent;
                    setupPageManagementTool();
                    break;
                default:
                    adminToolContentArea.innerHTML = `<p class="text-center text-xl text-gray-600">Sélectionnez un outil d'administration.</p>`;
            }
            updateAdminSubnavActiveState(); // Update active state of sub-navigation buttons
        }


        // --- Shop Management Tool Logic ---
        let editingVehicleId = null; // Stores the ID of the vehicle being edited

        // Predefined lists for dropdowns and checkboxes
        const predefinedMakes = ["", "Renault", "Peugeot", "Citroën", "Volkswagen", "Audi", "BMW", "Mercedes-Benz", "Ford", "Opel", "Toyota", "Nissan", "Hyundai", "Kia", "Fiat", "Skoda", "Volvo", "Mazda", "Honda", "Suzuki", "Jeep", "Tesla", "Porsche", "Ferrari", "Lamborghini"];
        const predefinedFuelTypes = ["", "Essence", "Diesel", "Électrique", "Hybride", "GPL", "Éthanol"];
        const predefinedGearboxTypes = ["", "Manuelle", "Automatique"];

        // Categorized options for checkboxes
        const categorizedOptions = {
            "Confort et Intérieur": [
                "Climatisation", "Sièges chauffants", "Sièges ventilés", "Volant chauffant", "Volant multifonctions",
                "Accoudoir central", "Vitres électriques", "Ventilation banquette arrière", "Toit ouvrant panoramique",
                "Démarrage sans clé", "Clé mains libres", "Recharge sans fil pour smartphone", "Éclairage d'ambiance"
            ],
            "Technologie et Multimédia": [
                "GPS", "Bluetooth", "Prise Auxiliaire", "USB", "Radio commande au volant", "Ordinateur de bord",
                "Android Auto", "Apple CarPlay", "Affichage tête haute", "Système audio premium"
            ],
            "Sécurité et Assistance à la Conduite": [
                "ABS", "Airbags frontaux, latéraux", "ISOFIX", "Aide au stationnement", "Caméra de recul",
                "Radar de recul avant et arrière", "Alerte franchissement de ligne", "Système Start & Stop",
                "Frein de parking électrique", "Aide au démarrage en côte", "Avertisseur d'angle mort",
                "Aide au freinage d'urgence", "Avertisseur de collision", "Reconnaissance des panneaux de signalisation"
            ],
            "Extérieur et Esthétique": [
                "Jantes aluminium", "Phares LED", "Phares Xénon", "Phares antibrouillard avant", "Phares antibrouillard arrière",
                "Rétroviseur électriques", "Peinture métallisée", "Attelage remorque", "Barres de toit"
            ],
            "Autres": [
                "Limiteur de vitesse", "Régulateur de vitesse", "Feu automatique", "Balais essuie-glace automatique",
                "Vendu avec deux clés", "Commande console centrale", "Feu de brouillard arrière",
                "Volant réglable en hauteur et en profondeur", "Roue de secours", "Suspension adaptative",
                "Ouverture/fermeture centralisée", "Allume cigare", "Détecteur de pluie", "Régulateur de vitesse adaptatif"
            ]
        };

        // Standard description text to append
        const standardDescriptionText = `
Tarif hors carte grise.

🧑🏼‍🔧 Garantie moteur et boîte 6 mois (extension de garantie possible).

🇫🇷🇫🇷HABILITÉE SERVICE CARTE GRISE 🇫🇷🇫🇷

Habilité par le Agence Nationale des Titres Sécurisés.

Nous nous occupons de toutes les démarches administratives d'immatriculation !

Pour faciliter les démarches administratives pensez a vous munir des pièces suivantes lors de votre visite :
🔸Pièce d'identité en cours de validité.
🔸Permis de conduire en cours de validité.
🔸Justificatif de domicile moins de 3 mois (facture ou avis d'imposition).
🔸En cas d'hébergement : une attestation d'hébergement et la copie de la carte d'identité de l'hébergeur.
`;

        function renderShopManagementOptionsCheckboxes(selectedOptions = []) {
            const optionsContainer = document.getElementById('admin-options-checkboxes-container');
            if (!optionsContainer) return;

            optionsContainer.innerHTML = ''; // Clear previous content

            for (const category in categorizedOptions) {
                const categoryOptions = categorizedOptions[category];
                const categoryId = category.replace(/\s+/g, '-').toLowerCase();

                const accordionSection = document.createElement('div');
                accordionSection.className = 'rounded-md shadow-sm border border-blue-200';

                const header = document.createElement('button');
                header.type = 'button';
                header.className = 'accordion-header';
                header.innerHTML = `
                    <span>${category}</span>
                    <svg class="accordion-arrow w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                `;
                accordionSection.appendChild(header);

                const content = document.createElement('div');
                content.className = 'accordion-content';
                content.id = `accordion-content-${categoryId}`;
                content.innerHTML = `<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2"></div>`; // Inner grid for checkboxes
                accordionSection.appendChild(content);

                const innerGrid = content.querySelector('div');

                categoryOptions.forEach(option => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center';
                    const checkboxId = `option-${option.replace(/\s+/g, '-').replace(/[^\w-]/g, '').toLowerCase()}`; // Sanitize ID
                    div.innerHTML = `
                        <input type="checkbox" id="${checkboxId}" name="options" value="${option}" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="${checkboxId}" class="ml-2 block text-sm text-gray-900">${option}</label>
                    `;
                    const checkbox = div.querySelector(`#${checkboxId}`);
                    if (selectedOptions.includes(option)) {
                        checkbox.checked = true;
                    }
                    innerGrid.appendChild(div);
                });

                // Add event listener for accordion toggle
                header.addEventListener('click', () => {
                    content.classList.toggle('active');
                    header.querySelector('.accordion-arrow').classList.toggle('rotate');
                });

                optionsContainer.appendChild(accordionSection);
            }
        }

        // Function to render dynamic image URL inputs for shop management
        function renderShopManagementImageUrlsInputs(urls = []) {
            if (!adminImageUrlsContainer) return;

            adminImageUrlsContainer.innerHTML = ''; // Clear existing inputs

            // Ensure there's at least one empty input if no URLs are provided and not editing
            if (urls.length === 0 && editingVehicleId === null) {
                urls.push('');
            }

            urls.forEach((url, index) => {
                const div = document.createElement('div');
                div.className = 'draggable-image-item'; // Add class for styling and D&D
                div.draggable = true; // Make it draggable
                div.dataset.index = index; // Store original index for D&D logic

                // Add D&D event listeners directly to the element
                div.addEventListener('dragstart', handleDragStart);
                div.addEventListener('dragover', handleDragOver);
                div.addEventListener('dragleave', handleDragLeave);
                div.addEventListener('drop', handleDrop);
                div.addEventListener('dragend', handleDragEnd);

                const thumbnailUrl = url || 'https://placehold.co/64x64/E0E0E0/000000?text=No+Image'; // Placeholder for empty URL
                
                div.innerHTML = `
                    <img src="${thumbnailUrl}" alt="Thumbnail" class="w-24 h-24 object-cover rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/64x64/E0E0E0/000000?text=Error';">
                    <input type="url" class="image-url-input w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="URL de l'image" value="${url}">
                    <button type="button" class="remove-image-url-btn">X</button>
                `;
                adminImageUrlsContainer.appendChild(div);
            });

            // Add event listeners for remove buttons (ensure they are re-attached after re-rendering)
            adminImageUrlsContainer.querySelectorAll('.remove-image-url-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.target.closest('.draggable-image-item').remove(); // Remove the parent draggable item
                });
            });

            // Add event listener for URL input changes to update thumbnail
            adminImageUrlsContainer.querySelectorAll('.image-url-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const imgElement = e.target.previousElementSibling; // The img element is the one before the input
                    if (imgElement && e.target.value) {
                        imgElement.src = e.target.value;
                        imgElement.onerror = function() {
                            this.onerror = null;
                            this.src = 'https://placehold.co/64x64/E0E0E0/000000?text=Error';
                        };
                    } else if (imgElement) {
                        imgElement.src = 'https://placehold.co/64x64/E0E0E0/000000?text=No+Image';
                    }
                });
            });
        }

        function addShopManagementImageUrlInput() {
            if (!adminImageUrlsContainer) return;
            const div = document.createElement('div');
            div.className = 'draggable-image-item';
            div.draggable = true;
            // No dataset.index initially, it will be re-evaluated on submit based on DOM order
            
            // Add D&D event listeners
            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('dragover', handleDragOver);
            div.addEventListener('dragleave', handleDragLeave);
            div.addEventListener('drop', handleDrop);
            div.addEventListener('dragend', handleDragEnd);

            div.innerHTML = `
                <img src="https://placehold.co/64x64/E0E0E0/000000?text=No+Image" alt="Thumbnail" class="w-24 h-24 object-cover rounded-md">
                <input type="url" class="image-url-input w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="URL de l'image">
                <button type="button" class="remove-image-url-btn">X</button>
            `;
            adminImageUrlsContainer.appendChild(div);
            div.querySelector('.remove-image-url-btn').addEventListener('click', (e) => {
                e.target.closest('.draggable-image-item').remove();
            });
            div.querySelector('.image-url-input').addEventListener('input', (e) => {
                const imgElement = e.target.previousElementSibling;
                if (imgElement && e.target.value) {
                    imgElement.src = e.target.value;
                    imgElement.onerror = function() {
                        this.onerror = null;
                        this.src = 'https://placehold.co/64x64/E0E0E0/000000?text=Error';
                    };
                } else if (imgElement) {
                    imgElement.src = 'https://placehold.co/64x64/E0E0E0/000000?text=No+Image';
                }
            });
        }

        // --- Drag and Drop Functions ---
        function handleDragStart(e) {
            draggedItem = this; // 'this' refers to the draggable-image-item div
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML); // Store the entire HTML for potential re-insertion
            this.classList.add('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault(); // Necessary to allow dropping
            const dropTarget = e.target.closest('.draggable-image-item');
            if (dropTarget && dropTarget !== draggedItem) {
                // Remove drag-over from all items first
                adminImageUrlsContainer.querySelectorAll('.draggable-image-item').forEach(item => {
                    item.classList.remove('drag-over');
                });
                // Add drag-over to the current target
                dropTarget.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            if (e.target.closest('.draggable-image-item')) {
                e.target.closest('.draggable-image-item').classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            const dropTarget = e.target.closest('.draggable-image-item');

            if (dropTarget && draggedItem && dropTarget !== draggedItem) {
                // Determine if we're dropping before or after the target
                const rect = dropTarget.getBoundingClientRect();
                const offsetY = e.clientY - rect.top;
                const insertBefore = offsetY < rect.height / 2;

                if (insertBefore) {
                    adminImageUrlsContainer.insertBefore(draggedItem, dropTarget);
                } else {
                    adminImageUrlsContainer.insertBefore(draggedItem, dropTarget.nextSibling);
                }
            }
            // Clean up drag-over class
            adminImageUrlsContainer.querySelectorAll('.draggable-image-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            draggedItem = null; // Clear dragged item
            // Ensure any lingering drag-over classes are removed
            adminImageUrlsContainer.querySelectorAll('.draggable-image-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }


        function setupShopManagementTool() {
            // Assign elements for shop management
            shopManagementForm = document.getElementById('admin-vehicle-form');
            shopManagementSubmitButton = document.getElementById('admin-submit-button');
            shopManagementCancelEditButton = document.getElementById('admin-cancel-edit');
            shopManagementFormTitle = document.getElementById('admin-form-title');
            adminMakeSelect = document.getElementById('admin-make');
            adminFuelTypeSelect = document.getElementById('admin-fuelType');
            adminGearboxTypeSelect = document.getElementById('admin-gearboxType');
            adminAddImageUrlButton = document.getElementById('admin-add-image-url-btn');
            adminIsSoldCheckbox = document.getElementById('admin-is-sold');
            adminImageUploadInput = document.getElementById('admin-image-upload');
            adminUploadStatus = document.getElementById('admin-upload-status');
            adminOptionsCheckboxesContainer = document.getElementById('admin-options-checkboxes-container'); // Updated ID
            adminImageUrlsContainer = document.getElementById('admin-image-urls-container');
            adminCustomOptionInput = document.getElementById('admin-custom-option-input');
            adminAddCustomOptionButton = document.getElementById('admin-add-custom-option-btn');

            // Populate dropdowns
            function populateSelect(selectElement, optionsList, selectedValue = '') {
                selectElement.innerHTML = '';
                optionsList.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    if (option === selectedValue) {
                        opt.selected = true;
                    }
                    selectElement.appendChild(opt);
                });
            }

            populateSelect(adminMakeSelect, predefinedMakes);
            populateSelect(adminFuelTypeSelect, predefinedFuelTypes);
            populateSelect(adminGearboxTypeSelect, predefinedGearboxTypes);

            // Render options checkboxes and image URL inputs initially
            renderShopManagementOptionsCheckboxes();
            renderShopManagementImageUrlsInputs(); // This will now set up D&D listeners

            if (shopManagementForm) {
                shopManagementForm.addEventListener('submit', handleShopManagementSubmit);
            }
            if (shopManagementCancelEditButton) {
                shopManagementCancelEditButton.addEventListener('click', resetShopManagementForm);
            }
            if (adminAddCustomOptionButton) {
                adminAddCustomOptionButton.addEventListener('click', () => {
                    const customOption = adminCustomOptionInput.value.trim();
                    if (customOption) {
                        // Add to "Autres" category and re-render options
                        if (!categorizedOptions["Autres"]) {
                            categorizedOptions["Autres"] = [];
                        }
                        categorizedOptions["Autres"].push(customOption);
                        renderShopManagementOptionsCheckboxes(getCheckedOptions()); // Re-render with current selections + new option
                        adminCustomOptionInput.value = ''; // Clear input
                    }
                });
            }
            if (adminAddImageUrlButton) {
                adminAddImageUrlButton.addEventListener('click', addShopManagementImageUrlInput);
            }
        }

        // Helper to get currently checked options (useful before re-rendering options)
        function getCheckedOptions() {
            const checkedOptions = [];
            document.querySelectorAll('#admin-options-checkboxes-container input[type="checkbox"]:checked').forEach(checkbox => {
                checkedOptions.push(checkbox.value);
            });
            return checkedOptions;
        }

        async function loadShopManagementVehicles() {
            const adminVehiclesTableBody = document.getElementById('admin-vehicles-table-body');
            const adminNoVehiclesMessage = document.getElementById('admin-no-vehicles-message');
            const adminError = document.getElementById('admin-error');

            if (adminVehiclesTableBody) adminVehiclesTableBody.innerHTML = ''; // Clear table
            if (adminNoVehiclesMessage) adminNoVehiclesMessage.classList.add('hidden');
            if (adminError) adminError.classList.add('hidden');

            const vehiclesCollectionRef = collection(db, `artifacts/${appId}/public/data/vehicles`);
            onSnapshot(vehiclesCollectionRef, (snapshot) => {
                vehicles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Sort vehicles by make and then model for consistent display
                vehicles.sort((a, b) => {
                    const makeCompare = (a.make || '').localeCompare(b.make || '');
                    if (makeCompare !== 0) return makeCompare;
                    return (a.model || '').localeCompare(b.model || '');
                });

                if (adminVehiclesTableBody) adminVehiclesTableBody.innerHTML = ''; // Clear before re-rendering

                if (vehicles.length === 0) {
                    if (adminNoVehiclesMessage) adminNoVehiclesMessage.classList.remove('hidden');
                } else {
                    if (adminNoVehiclesMessage) adminNoVehiclesMessage.classList.add('hidden');
                    vehicles.forEach(vehicle => {
                        const row = adminVehiclesTableBody.insertRow();
                        row.innerHTML = `
                            <td class="py-3 px-4 text-gray-800">${vehicle.make || 'N/A'}</td>
                            <td class="py-3 px-4 text-gray-800">${vehicle.model || 'N/A'}</td>
                            <td class="py-3 px-4 text-gray-800">${vehicle.year || 'N/A'}</td>
                            <td class="py-3 px-4 text-gray-800">${new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(vehicle.price || 0)}</td>
                            <td class="py-3 px-4 flex space-x-2">
                                <button class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-md text-sm transition duration-300 ease-in-out transform hover:scale-105 edit-btn" data-id="${vehicle.id}">Modifier</button>
                                <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md text-sm transition duration-300 ease-in-out transform hover:scale-105 delete-btn" data-id="${vehicle.id}">Supprimer</button>
                            </td>
                        `;
                    });

                    // Attach event listeners to new buttons
                    document.querySelectorAll('.edit-btn').forEach(button => {
                        button.addEventListener('click', (e) => handleShopManagementEdit(e.target.dataset.id));
                    });
                    document.querySelectorAll('.delete-btn').forEach(button => {
                        button.addEventListener('click', (e) => handleShopManagementDelete(e.target.dataset.id));
                    });
                }
            }, (err) => {
                console.error("Erreur de récupération des véhicules pour l'admin:", err);
                if (adminError) adminError.textContent = "Impossible de charger les véhicules.";
                if (adminError) adminError.classList.remove('hidden');
            });
        }

        async function handleShopManagementSubmit(e) {
            e.preventDefault();
            const formElements = e.target.elements;
            
            adminUploadStatus.textContent = 'Téléchargement des images...';
            adminUploadStatus.classList.remove('hidden');
            adminUploadStatus.classList.remove('text-red-600');
            adminUploadStatus.classList.add('text-gray-600');


            const uploadedImageUrls = [];
            const files = adminImageUploadInput.files; // Get files from the input

            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

                try {
                    const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    if (result.secure_url) {
                        uploadedImageUrls.push(result.secure_url);
                    } else {
                        console.error("Erreur Cloudinary: Pas d'URL sécurisée", result);
                        adminUploadStatus.textContent = `Erreur de téléversement pour ${file.name}. Détails: ${result.error ? result.error.message : 'Inconnu'}`;
                        adminUploadStatus.classList.remove('text-gray-600');
                        adminUploadStatus.classList.add('text-red-600');
                        // Continue to try other files or break
                    }
                } catch (uploadError) {
                    console.error("Erreur lors du téléversement de l'image vers Cloudinary:", file.name, uploadError);
                    adminUploadStatus.textContent = `Erreur de téléversement pour ${file.name}. Vérifiez votre configuration Cloudinary et la console.`;
                    adminUploadStatus.classList.remove('text-gray-600');
                    adminUploadStatus.classList.add('text-red-600');
                    // Continue to try other files or break
                }
            }
            
            // Collect existing URLs from dynamic inputs in their current DOM order
            const currentImageUrlsInOrder = Array.from(adminImageUrlsContainer.querySelectorAll('.image-url-input'))
                                            .map(input => input.value.trim())
                                            .filter(url => url !== '');
            const finalImageUrls = [...currentImageUrlsInOrder, ...uploadedImageUrls]; // New uploads are appended

            // Collect selected options from checkboxes
            const selectedOptions = Array.from(document.querySelectorAll('#admin-options-checkboxes-container input[type="checkbox"]:checked'))
                                       .map(checkbox => checkbox.value);

            let descriptionContent = formElements.description.value.trim();
            // Append standard text if not already present (simple check)
            if (!descriptionContent.includes("Tarif hors carte grise.")) {
                descriptionContent += standardDescriptionText;
            }

            const vehicleData = {
                make: formElements.make.value,
                model: formElements.model.value,
                year: parseInt(formElements.year.value),
                price: parseFloat(formElements.price.value),
                description: descriptionContent, // Utilise la description complétée
                imageUrls: finalImageUrls, // Utilise les URLs combinées (maintenant de Cloudinary)
                mileage: parseInt(formElements.mileage.value) || 0,
                engineType: formElements.engineType.value,
                gearboxType: formElements.gearboxType.value,
                fuelType: formElements.fuelType.value,
                options: selectedOptions, // Utilise les options des checkboxes
                taxHorsepower: parseInt(formElements.taxHorsepower.value) || 0,
                steamHorsepower: parseInt(formElements.steamHorsepower.value) || 0,
                isSold: formElements.isSold.checked // Get the value of the "Vendu" checkbox
            };

            try {
                if (editingVehicleId) {
                    const vehicleDocRef = doc(db, `artifacts/${appId}/public/data/vehicles`, editingVehicleId);
                    await updateDoc(vehicleDocRef, vehicleData);
                    console.log("Véhicule mis à jour avec succès !");
                    adminUploadStatus.textContent = "Véhicule mis à jour avec succès !";
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/vehicles`), vehicleData);
                    console.log("Véhicule ajouté avec succès !");
                    adminUploadStatus.textContent = "Véhicule ajouté avec succès !";
                }
                adminUploadStatus.classList.remove('hidden');
                adminUploadStatus.classList.remove('text-red-600');
                adminUploadStatus.classList.add('text-green-600');
                setTimeout(() => adminUploadStatus.classList.add('hidden'), 3000); // Hide after 3 seconds
                resetShopManagementForm();
            } catch (err) {
                console.error("Erreur lors de la soumission du véhicule vers Firestore:", err);
                adminUploadStatus.textContent = "Erreur lors de l'enregistrement du véhicule dans Firestore. Vérifiez la console.";
                adminUploadStatus.classList.remove('hidden');
                adminUploadStatus.classList.remove('text-green-600');
                adminUploadStatus.classList.add('text-red-600');
            }
        }

        function handleShopManagementEdit(id) {
            editingVehicleId = id;
            const vehicle = vehicles.find(v => v.id === id);
            if (vehicle) {
                shopManagementFormTitle.textContent = 'Modifier un Véhicule';
                shopManagementSubmitButton.textContent = 'Mettre à jour le Véhicule';
                shopManagementCancelEditButton.classList.remove('hidden');

                document.getElementById('admin-model').value = vehicle.model || '';
                document.getElementById('admin-year').value = vehicle.year || '';
                document.getElementById('admin-price').value = vehicle.price || '';
                document.getElementById('admin-description').value = vehicle.description || '';
                // Populate dropdowns with current vehicle data
                document.getElementById('admin-make').value = vehicle.make || '';
                document.getElementById('admin-fuelType').value = vehicle.fuelType || '';
                document.getElementById('admin-gearboxType').value = vehicle.gearboxType || '';

                // Populate existing image URLs into dynamic inputs, now with D&D
                renderShopManagementImageUrlsInputs(vehicle.imageUrls || []);
                
                document.getElementById('admin-mileage').value = vehicle.mileage || '';
                document.getElementById('admin-engineType').value = vehicle.engineType || '';
                document.getElementById('admin-taxHorsepower').value = vehicle.taxHorsepower || '';
                document.getElementById('admin-steamHorsepower').value = vehicle.steamHorsepower || '';
                document.getElementById('admin-is-sold').checked = vehicle.isSold || false; // Set "Vendu" checkbox

                // Pass existing options to render function to pre-check them
                renderShopManagementOptionsCheckboxes(vehicle.options || []);
                
                // Clear the file input when editing, so user only uploads new files if needed
                if (adminImageUploadInput) adminImageUploadInput.value = '';
                if (adminUploadStatus) adminUploadStatus.classList.add('hidden');

                document.getElementById('admin-form-section').scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function handleShopManagementDelete(id) {
            const confirmDelete = window.confirm("Êtes-vous sûr de vouloir supprimer ce véhicule ?");
            if (confirmDelete) {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/vehicles`, id));
                    console.log("Véhicule supprimé avec succès !");
                } catch (err) {
                    console.error("Erreur lors de la suppression du véhicule:", err);
                    alert("Erreur lors de la suppression du véhicule."); // Using alert for simplicity
                }
            }
        }

        function resetShopManagementForm() {
            editingVehicleId = null;
            shopManagementFormTitle.textContent = 'Ajouter un Nouveau Véhicule';
            shopManagementSubmitButton.textContent = 'Ajouter le Véhicule';
            shopManagementCancelEditButton.classList.add('hidden');
            shopManagementForm.reset();
            // Clear file input and status
            if (adminImageUploadInput) adminImageUploadInput.value = '';
            if (adminUploadStatus) adminUploadStatus.classList.add('hidden');
            // Reset options checkboxes
            renderShopManagementOptionsCheckboxes();
            // Reset image URL inputs
            renderShopManagementImageUrlsInputs();
            // Reset "Vendu" checkbox
            document.getElementById('admin-is-sold').checked = false;
        }

        // --- ANTS Tool Logic ---
        function setupAntsTool() {
            antsMaVariableInput = document.getElementById("maVariable");
            antsAccessDossierButton = document.getElementById("access-dossier-button");

            if (antsMaVariableInput) {
                antsMaVariableInput.addEventListener('keypress', handleAntsKeyPress);
            }
            if (antsAccessDossierButton) {
                antsAccessDossierButton.addEventListener('click', modifierLien);
            }
        }

        function modifierLien() {
            const valeurSaisie = antsMaVariableInput.value;
            if (valeurSaisie.trim() === "") {
                console.warn("Le numéro de dossier ne peut pas être vide.");
                alert("Veuillez entrer un numéro de dossier."); // Using alert for simplicity
                return;
            }
            const lien = 'https://mesdemarches.siv.interieur.gouv.fr/siv-tp/#/reprise/' + valeurSaisie;
            window.open(lien, '_blank'); // Open in new tab
        }

        function handleAntsKeyPress(event) {
            if (event.key === 'Enter') {
                modifierLien();
            }
        }

        // --- Client Dossier Tool Logic (Admin Panel) ---
        let editingClientDossierId = null;

        function setupClientDossierTool() {
            clientDossierForm = document.getElementById('client-dossier-form');
            clientDossierSubmitButton = document.getElementById('client-dossier-submit-button');
            clientDossierCancelEditButton = document.getElementById('client-dossier-cancel-edit');
            clientDossierFormTitle = document.getElementById('client-dossier-form-title');
            clientDossiersTableBody = document.getElementById('client-dossiers-table-body');
            clientDossiersNoDataMessage = document.getElementById('client-dossiers-no-data-message');
            clientDossiersError = document.getElementById('client-dossiers-error');

            if (clientDossierForm) {
                clientDossierForm.addEventListener('submit', handleClientDossierSubmit);
            }
            if (clientDossierCancelEditButton) {
                clientDossierCancelEditButton.addEventListener('click', resetClientDossierForm);
            }
        }

        async function loadClientDossiers() {
            if (!isLoggedIn) {
                console.warn("Utilisateur non connecté. Impossible de charger les dossiers clients.");
                if (clientDossiersError) clientDossiersError.textContent = "Veuillez vous connecter pour accéder aux dossiers clients.";
                if (clientDossiersError) clientDossiersError.classList.remove('hidden');
                if (clientDossiersTableBody) clientDossiersTableBody.innerHTML = '';
                if (clientDossiersNoDataMessage) clientDossiersNoDataMessage.classList.add('hidden');
                return;
            }

            if (clientDossiersTableBody) clientDossiersTableBody.innerHTML = '';
            if (clientDossiersNoDataMessage) clientDossiersNoDataMessage.classList.add('hidden');
            if (clientDossiersError) clientDossiersError.classList.add('hidden');

            const clientDossiersCollectionRef = collection(db, `artifacts/${appId}/public/data/client_dossiers`);
            onSnapshot(clientDossiersCollectionRef, (snapshot) => {
                clientDossiers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                clientDossiers.sort((a, b) => (a.clientName || '').localeCompare(b.clientName || '')); // Sort by client name

                if (clientDossiersTableBody) clientDossiersTableBody.innerHTML = '';

                if (clientDossiers.length === 0) {
                    if (clientDossiersNoDataMessage) clientDossiersNoDataMessage.classList.remove('hidden');
                } else {
                    if (clientDossiersNoDataMessage) clientDossiersNoDataMessage.classList.add('hidden');
                    clientDossiers.forEach(dossier => {
                        const row = clientDossiersTableBody.insertRow();
                        row.innerHTML = `
                            <td class="py-3 px-4 text-gray-800">${dossier.clientName || 'N/A'}</td>
                            <td class="py-3 px-4 text-gray-800">${dossier.vehicle || 'N/A'}</td>
                            <td class="py-3 px-4 text-gray-800">${dossier.vin || 'N/A'}</td>
                            <td class="py-3 px-4 text-gray-800">${dossier.invoiceNumber || 'N/A'}</td>
                            <td class="py-3 px-4 text-gray-800">${dossier.status || 'N/A'}</td>
                            <td class="py-3 px-4 flex space-x-2">
                                <button class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-md text-sm transition duration-300 ease-in-out transform hover:scale-105 edit-client-dossier-btn" data-id="${dossier.id}">Modifier</button>
                                <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md text-sm transition duration-300 ease-in-out transform hover:scale-105 delete-client-dossier-btn" data-id="${dossier.id}">Supprimer</button>
                            </td>
                        `;
                    });

                    document.querySelectorAll('.edit-client-dossier-btn').forEach(button => {
                        button.addEventListener('click', (e) => handleClientDossierEdit(e.target.dataset.id));
                    });
                    document.querySelectorAll('.delete-client-dossier-btn').forEach(button => {
                        button.addEventListener('click', (e) => handleClientDossierDelete(e.target.dataset.id));
                    });
                }
            }, (err) => {
                console.error("Erreur de récupération des dossiers clients:", err);
                if (clientDossiersError) clientDossiersError.textContent = "Impossible de charger les dossiers clients.";
                if (clientDossiersError) clientDossiers.classList.remove('hidden');
            });
        }

        async function handleClientDossierSubmit(e) {
            e.preventDefault();
            const formElements = e.target.elements;

            const dossierData = {
                clientName: formElements.clientName.value,
                vehicle: formElements.vehicle.value,
                vin: formElements.vin.value,
                invoiceNumber: formElements.invoiceNumber.value,
                status: formElements.status.value,
                notes: formElements.notes.value
            };

            try {
                if (editingClientDossierId) {
                    const dossierDocRef = doc(db, `artifacts/${appId}/public/data/client_dossiers`, editingClientDossierId);
                    await updateDoc(dossierDocRef, dossierData);
                    console.log("Dossier client mis à jour avec succès !");
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/client_dossiers`), dossierData);
                    console.log("Dossier client ajouté avec succès !");
                }
                resetClientDossierForm();
            } catch (err) {
                console.error("Erreur lors de la soumission du dossier client:", err);
                alert("Erreur lors de l'enregistrement du dossier client. Vérifiez la console pour plus de détails.");
            }
        }

        function handleClientDossierEdit(id) {
            editingClientDossierId = id;
            const dossier = clientDossiers.find(d => d.id === id);
            if (dossier) {
                clientDossierFormTitle.textContent = 'Modifier un Dossier Client';
                clientDossierSubmitButton.textContent = 'Mettre à jour le Dossier';
                clientDossierCancelEditButton.classList.remove('hidden');

                document.getElementById('client-name').value = dossier.clientName || '';
                document.getElementById('client-vehicle').value = dossier.vehicle || '';
                document.getElementById('client-vin').value = dossier.vin || '';
                document.getElementById('client-invoice-number').value = dossier.invoiceNumber || '';
                document.getElementById('client-status').value = dossier.status || '';
                document.getElementById('client-notes').value = dossier.notes || '';

                document.getElementById('client-dossier-tool-container').scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function handleClientDossierDelete(id) {
            const confirmDelete = window.confirm("Êtes-vous sûr de vouloir supprimer ce dossier client ?");
            if (confirmDelete) {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/client_dossiers`, id));
                    console.log("Dossier client supprimé avec succès !");
                } catch (err) {
                    console.error("Erreur lors de la suppression du dossier client:", err);
                    alert("Erreur lors de la suppression du dossier client.");
                }
            }
        }

        function resetClientDossierForm() {
            editingClientDossierId = null;
            clientDossierFormTitle.textContent = 'Ajouter un Nouveau Dossier Client';
            clientDossierSubmitButton.textContent = 'Ajouter le Dossier';
            clientDossierCancelEditButton.classList.add('hidden');
            clientDossierForm.reset();
        }

        // --- Client Dossier Page Logic (for Clients) ---
        function setupDossierPage() {
            dossierSearchInput = document.getElementById('dossier-search-input');
            dossierDetailsDisplay = document.getElementById('dossier-details-display');
            const dossierErrorMessage = document.getElementById('dossier-error-message');
            const dossierSearchButton = document.getElementById('dossier-search-button');

            if (dossierSearchButton) {
                dossierSearchButton.addEventListener('click', searchClientDossier);
            }
            if (dossierSearchInput) {
                dossierSearchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchClientDossier();
                    }
                });
            }
        }

        async function searchClientDossier() {
            if (!isLoggedIn) {
                dossierErrorMessage.textContent = "Vous devez être connecté pour rechercher un dossier.";
                dossierErrorMessage.classList.remove('hidden');
                return;
            }

            const dossierNumber = dossierSearchInput.value.trim();
            dossierDetailsDisplay.classList.add('hidden');
            dossierDetailsDisplay.innerHTML = '';
            dossierErrorMessage.classList.add('hidden');

            if (!dossierNumber) {
                dossierErrorMessage.textContent = "Veuillez entrer un numéro de dossier.";
                dossierErrorMessage.classList.remove('hidden');
                return;
            }

            if (!currentUser || !userName) {
                dossierErrorMessage.textContent = "Vous devez être connecté pour rechercher un dossier.";
                dossierErrorMessage.classList.remove('hidden');
                return;
            }

            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/client_dossiers`),
                                where("invoiceNumber", "==", dossierNumber),
                                where("clientName", "==", userName)); // Ensure clientName matches logged-in user's name
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    dossierErrorMessage.textContent = "Aucun dossier trouvé avec ce numéro pour votre compte.";
                    dossierErrorMessage.classList.remove('hidden');
                } else {
                    querySnapshot.forEach((doc) => {
                        const dossier = doc.data();
                        dossierDetailsDisplay.innerHTML = `
                            <h3 class="text-xl font-semibold text-blue-700 mb-2">Détails du Dossier : ${dossier.invoiceNumber}</h3>
                            <p><strong class="text-blue-600">Client:</strong> ${dossier.clientName}</p>
                            <p><strong class="text-blue-600">Véhicule:</strong> ${dossier.vehicle || 'N/A'}</p>
                            <p><strong class="text-blue-600">VIN:</strong> ${dossier.vin || 'N/A'}</p>
                            <p><strong class="text-blue-600">Statut:</strong> ${dossier.status}</p>
                            <p><strong class="text-blue-600">Notes:</strong> ${dossier.notes || 'Aucune'}</p>
                        `;
                        dossierDetailsDisplay.classList.remove('hidden');
                    });
                }
            } catch (error) {
                console.error("Erreur lors de la recherche du dossier client:", error);
                dossierErrorMessage.textContent = "Erreur lors de la recherche du dossier. Veuillez réessayer.";
                dossierErrorMessage.classList.remove('hidden');
            }
        }

        // --- Home Page Featured Vehicles Logic ---
        function loadFeaturedVehicles() {
            const featuredVehiclesContainer = document.getElementById('featured-vehicles-container');
            const noFeaturedVehiclesMessage = document.getElementById('no-featured-vehicles-message');

            if (!featuredVehiclesContainer) return;

            featuredVehiclesContainer.innerHTML = ''; // Clear previous featured vehicles

            // Filter out sold vehicles for featured display
            const availableVehicles = vehicles.filter(v => !v.isSold);

            if (availableVehicles.length === 0) {
                if (noFeaturedVehiclesMessage) noFeaturedVehiclesMessage.classList.remove('hidden');
                return;
            } else {
                if (noFeaturedVehiclesMessage) noFeaturedVehiclesMessage.classList.add('hidden');
            }

            // Shuffle vehicles and pick top 3
            const shuffledVehicles = [...availableVehicles].sort(() => 0.5 - Math.random());
            const selectedFeatured = shuffledVehicles.slice(0, 3);

            selectedFeatured.forEach(vehicle => {
                const vehicleCardHtml = generateVehicleCardHtml(vehicle, true); // Use helper with isFeatured = true
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = vehicleCardHtml;
                const vehicleCard = tempDiv.firstElementChild;
                vehicleCard.addEventListener('click', (event) => {
                    // Prevent opening detail modal if clicking on a child element that has its own action
                    if (event.target.tagName === 'A' || event.target.tagName === 'BUTTON') {
                        return;
                    }
                    // Redirect to shop page and then open the detail modal
                    currentPage = 'shop';
                    renderPage();
                    // Delay opening modal slightly to ensure shop page is rendered
                    setTimeout(() => showVehicleDetailModal(vehicle.id), 100);
                });
                featuredVehiclesContainer.appendChild(vehicleCard);
            });
        }

        // --- Review System Logic (Homepage) ---
        function setupReviewForm() {
            reviewForm = document.getElementById('review-form');
            reviewRatingInput = document.getElementById('review-rating');
            reviewCommentInput = document.getElementById('review-comment');
            reviewSubmitButton = document.getElementById('review-submit-button');
            reviewStatusMessage = document.getElementById('review-status-message');

            if (reviewForm) {
                reviewForm.addEventListener('submit', submitReview);
            }
        }

        async function submitReview(e) {
            e.preventDefault();
            reviewStatusMessage.classList.add('hidden');

            if (!currentUser) {
                reviewStatusMessage.textContent = "Vous devez être connecté pour soumettre un avis.";
                reviewStatusMessage.classList.remove('hidden');
                reviewStatusMessage.classList.remove('text-green-600');
                reviewStatusMessage.classList.add('text-red-600');
                return;
            }

            const rating = parseInt(reviewRatingInput.value);
            const comment = reviewCommentInput.value.trim();

            if (isNaN(rating) || rating < 1 || rating > 5) {
                reviewStatusMessage.textContent = "Veuillez donner une note entre 1 et 5 étoiles.";
                reviewStatusMessage.classList.remove('hidden');
                reviewStatusMessage.classList.remove('text-green-600');
                reviewStatusMessage.classList.add('text-red-600');
                return;
            }
            if (!comment) {
                reviewStatusMessage.textContent = "Veuillez écrire un commentaire.";
                reviewStatusMessage.classList.remove('hidden');
                reviewStatusMessage.classList.remove('text-green-600');
                reviewStatusMessage.classList.add('text-red-600');
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/reviews`), {
                    userName: userName, // Use the display name of the logged-in user
                    rating: rating,
                    comment: comment,
                    timestamp: new Date()
                });
                reviewStatusMessage.textContent = "Votre avis a été soumis avec succès !";
                reviewStatusMessage.classList.remove('hidden');
                reviewStatusMessage.classList.remove('text-red-600');
                reviewStatusMessage.classList.add('text-green-600');
                reviewForm.reset();
                loadReviews(); // Reload reviews to show the new one
            } catch (error) {
                console.error("Erreur lors de la soumission de l'avis:", error);
                reviewStatusMessage.textContent = "Erreur lors de la soumission de l'avis. Veuillez réessayer.";
                reviewStatusMessage.classList.remove('hidden');
                reviewStatusMessage.classList.remove('text-green-600');
                reviewStatusMessage.classList.add('text-red-600');
            }
        }

        function loadReviews() {
            googleReviewsContainer = document.getElementById('google-reviews-container');
            if (!googleReviewsContainer) return;

            // Clear existing reviews (including the hardcoded examples)
            googleReviewsContainer.innerHTML = '';

            const reviewsCollectionRef = collection(db, `artifacts/${appId}/public/data/reviews`);
            onSnapshot(reviewsCollectionRef, (snapshot) => {
                reviews = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Sort by newest first
                reviews.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());

                if (reviews.length === 0) {
                    googleReviewsContainer.innerHTML = `<p class="text-center text-gray-600 col-span-full">Aucun avis pour le moment. Soyez le premier à en laisser un !</p>`;
                } else {
                    reviews.forEach(review => {
                        const reviewCard = document.createElement('div');
                        reviewCard.className = 'bg-white p-4 rounded-lg shadow-sm';
                        reviewCard.innerHTML = `
                            <div class="flex items-center mb-2">
                                ${generateStars(review.rating)}
                                <span class="ml-2 font-semibold">${review.userName || 'Anonyme'}</span>
                            </div>
                            <p class="text-gray-700 text-sm">${review.comment}</p>
                            <p class="text-gray-500 text-xs mt-1">${review.timestamp ? new Date(review.timestamp.toDate()).toLocaleDateString('fr-FR') : ''}</p>
                        `;
                        googleReviewsContainer.appendChild(reviewCard);
                    });
                }
            }, (error) => {
                console.error("Erreur lors du chargement des avis:", error);
                googleReviewsContainer.innerHTML = `<p class="text-red-600 text-center col-span-full">Impossible de charger les avis.</p>`;
            });
        }

        // --- Page Content Management Logic (Admin Panel) ---
        let originalPageContent = {}; // To store content before editing for cancel functionality

        async function fetchPageContent() {
            const pageContentCollectionRef = collection(db, `artifacts/${appId}/public/data/page_content`);
            try {
                const snapshot = await getDocs(pageContentCollectionRef);
                pageContent = {}; // Clear previous content
                snapshot.forEach(doc => {
                    pageContent[doc.id] = doc.data();
                });
                console.log("Contenu des pages chargé:", pageContent);
            } catch (error) {
                console.error("Erreur lors du chargement du contenu des pages:", error);
            }
        }

        async function initializePageContentDefaults() {
            const defaultContent = {
                home: {
                    title: "Bienvenue chez CENTRAL CARS",
                    paragraph1: "Notre équipe de professionnels expérimentés et passionnés vous viendra en aide chaleureusement et avec transparence à des prix compétitifs. Un garage automobile où qualité et service vont de pair.",
                    featured_vehicles_title: "Véhicules en Vedette",
                    reviews_title: "Ce que nos clients disent de nous",
                    add_review_title: "Ajouter un avis"
                },
                about: {
                    title: "À propos de CENTRAL CARS",
                    paragraph1: "Chez CENTRAL CARS, nous sommes fiers de notre engagement envers l'excellence et la satisfaction client. Forts de nombreuses années d'expérience dans l'industrie automobile, nous nous efforçons de fournir des services de qualité supérieure et une sélection de véhicules d'occasion fiables.",
                    mission_title: "Notre Mission",
                    mission_text: "Fournir des véhicules inspectés et garantis, ainsi que des services d'entretien de premier ordre pour assurer votre tranquillité d'esprit sur la route.",
                    vision_title: "Notre Vision",
                    vision_text: "Devenir le leader reconnu de l'industrie automobile locale, en bâtissant des relations durables basées sur la confiance et l'excellence.",
                    commitments_title: "Nos Engagements",
                    commitment1: "Transparence totale sur l'historique et l'état des véhicules.",
                    commitment2: "Conseils personnalisés pour trouver le véhicule adapté à vos besoins.",
                    commitment3: "Services d'entretien et de réparation effectués par des techniciens qualifiés.",
                    commitment4: "Un service après-vente réactif et à votre écoute."
                },
                contact: {
                    title: "Nous Contacter",
                    contact_info_title: "Informations de Contact",
                    address: "576 rue Marcel Sembat, 59690 Vieux Condé, France",
                    phone: "0698979463",
                    email: "contact@centralcars.fr",
                    hours_title: "Horaires:",
                    hours_mon_fri: "Lundi - Vendredi: 09h00 - 12h00 et 14h00 - 17h30",
                    hours_sat: "Samedi: 09h00 - 12h00",
                    hours_sun: "Dimanche: Fermé",
                    map_title: "Retrouvez-nous sur la carte :",
                    message_section_title: "Envoyez-nous un message"
                }
            };

            for (const pageId in defaultContent) {
                const docRef = doc(db, `artifacts/${appId}/public/data/page_content`, pageId);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) {
                    await setDoc(docRef, defaultContent[pageId]);
                    console.log(`Contenu par défaut pour la page '${pageId}' ajouté à Firestore.`);
                }
            }
        }

        function setupPageManagementTool() {
            // Display current content
            for (const pageId of ['home', 'about', 'contact']) {
                const container = document.getElementById(`page-content-${pageId}`);
                if (container) {
                    container.innerHTML = ''; // Clear loading message

                    const pageData = pageContent[pageId] || {};
                    let htmlContent = '';

                    // Dynamically generate editable fields based on the pageData structure
                    if (pageId === 'home') {
                        htmlContent += createEditableField(pageId, 'title', pageData.title, 'h1', true);
                        htmlContent += createEditableField(pageId, 'paragraph1', pageData.paragraph1, 'p');
                        htmlContent += createEditableField(pageId, 'featured_vehicles_title', pageData.featured_vehicles_title, 'h2');
                        htmlContent += createEditableField(pageId, 'reviews_title', pageData.reviews_title, 'h2');
                        htmlContent += createEditableField(pageId, 'add_review_title', pageData.add_review_title, 'h2');
                    } else if (pageId === 'about') {
                        htmlContent += createEditableField(pageId, 'title', pageData.title, 'h1', true);
                        htmlContent += createEditableField(pageId, 'paragraph1', pageData.paragraph1, 'p');
                        htmlContent += `<div class="mt-4">`;
                        htmlContent += createEditableField(pageId, 'mission_title', pageData.mission_title, 'h3');
                        htmlContent += createEditableField(pageId, 'mission_text', pageData.mission_text, 'p');
                        htmlContent += createEditableField(pageId, 'vision_title', pageData.vision_title, 'h3');
                        htmlContent += createEditableField(pageId, 'vision_text', pageData.vision_text, 'p');
                        htmlContent += `</div>`;
                        htmlContent += createEditableField(pageId, 'commitments_title', pageData.commitments_title, 'h2');
                        htmlContent += `<ul class="list-disc list-inside ml-4 space-y-2">`;
                        htmlContent += `<li>${createEditableField(pageId, 'commitment1', pageData.commitment1, 'span')}</li>`;
                        htmlContent += `<li>${createEditableField(pageId, 'commitment2', pageData.commitment2, 'span')}</li>`;
                        htmlContent += `<li>${createEditableField(pageId, 'commitment3', pageData.commitment3, 'span')}</li>`;
                        htmlContent += `<li>${createEditableField(pageId, 'commitment4', pageData.commitment4, 'span')}</li>`;
                        htmlContent += `</ul>`;
                    } else if (pageId === 'contact') {
                        htmlContent += createEditableField(pageId, 'title', pageData.title, 'h1', true);
                        htmlContent += createEditableField(pageId, 'contact_info_title', pageData.contact_info_title, 'h2');
                        htmlContent += `<p class="mb-2"><strong class="text-blue-600">Adresse:</strong> ${createEditableField(pageId, 'address', pageData.address, 'span')}</p>`;
                        htmlContent += `<p class="mb-2"><strong class="text-blue-600">Téléphone:</strong> ${createEditableField(pageId, 'phone', pageData.phone, 'span')}</p>`;
                        htmlContent += `<p class="mb-2"><strong class="text-blue-600">Email:</strong> ${createEditableField(pageId, 'email', pageData.email, 'span')}</p>`;
                        htmlContent += `<p class="mb-2">${createEditableField(pageId, 'hours_title', pageData.hours_title, 'strong')}</p>`;
                        htmlContent += `<ul class="list-disc list-inside ml-4">`;
                        htmlContent += `<li>${createEditableField(pageId, 'hours_mon_fri', pageData.hours_mon_fri, 'span')}</li>`;
                        htmlContent += `<li>${createEditableField(pageId, 'hours_sat', pageData.hours_sat, 'span')}</li>`;
                        htmlContent += `<li>${createEditableField(pageId, 'hours_sun', pageData.hours_sun, 'span')}</li>`;
                        htmlContent += `</ul>`;
                        htmlContent += `<div class="mt-6">`;
                        htmlContent += createEditableField(pageId, 'map_title', pageData.map_title, 'h3');
                        htmlContent += `</div>`; // Closing div for map_title
                        htmlContent += createEditableField(pageId, 'message_section_title', pageData.message_section_title, 'h2');
                    }
                    container.innerHTML = htmlContent;
                }
            }

            // Attach event listeners to all editable field containers
            document.querySelectorAll('.editable-field-container').forEach(container => {
                const editBtn = container.querySelector('[data-action="edit"]');
                const saveBtn = container.querySelector('[data-action="save"]');
                const cancelBtn = container.querySelector('[data-action="cancel"]');

                if (editBtn) editBtn.addEventListener('click', () => toggleEditMode(container, true));
                if (saveBtn) saveBtn.addEventListener('click', () => handlePageSave(container));
                if (cancelBtn) cancelBtn.addEventListener('click', () => toggleEditMode(container, false));
            });
        }

        function toggleEditMode(container, enableEdit) {
            const pageId = container.dataset.pageId;
            const fieldName = container.dataset.fieldName;
            const originalTag = container.dataset.tag; // The original HTML tag (p, h1, span, strong)
            const displayElement = container.querySelector(`#${pageId}-${fieldName}`);
            const editBtn = container.querySelector('[data-action="edit"]');
            const saveBtn = container.querySelector('[data-action="save"]');
            const cancelBtn = container.querySelector('[data-action="cancel"]');

            if (enableEdit) {
                container.classList.add('editing');
                editBtn.classList.add('hidden');
                saveBtn.classList.remove('hidden');
                cancelBtn.classList.remove('hidden');

                // Store original content
                originalPageContent[`${pageId}-${fieldName}`] = displayElement.textContent;

                // Replace display element with input/textarea
                const inputElement = (originalTag === 'p' || originalTag === 'span') ?
                                     document.createElement('textarea') :
                                     document.createElement('input');
                
                inputElement.id = `${pageId}-${fieldName}-edit`;
                inputElement.className = (originalTag === 'p' || originalTag === 'span') ? 'editable-textarea' : 'editable-input';
                inputElement.value = displayElement.textContent;
                if (originalTag === 'p' || originalTag === 'span') {
                    inputElement.rows = 3; // Default rows for textarea
                }

                displayElement.replaceWith(inputElement);
            } else { // Disable edit mode (cancel or after save)
                container.classList.remove('editing');
                editBtn.classList.remove('hidden');
                saveBtn.classList.add('hidden');
                cancelBtn.classList.add('hidden');

                const inputElement = container.querySelector(`#${pageId}-${fieldName}-edit`);
                if (inputElement) {
                    const newDisplayElement = document.createElement(originalTag);
                    newDisplayElement.id = `${pageId}-${fieldName}`;
                    // If canceling, revert to original content
                    newDisplayElement.textContent = originalPageContent[`${pageId}-${fieldName}`];
                    // Add w-full to h1 elements for proper centering
                    if (originalTag === 'h1') {
                        newDisplayElement.classList.add('w-full');
                    }
                    inputElement.replaceWith(newDisplayElement);
                }
            }
        }

        async function handlePageSave(container) {
            const pageId = container.dataset.pageId;
            const fieldName = container.dataset.fieldName;
            const inputElement = container.querySelector(`#${pageId}-${fieldName}-edit`);
            if (!inputElement) return;

            const newValue = inputElement.value;

            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/page_content`, pageId);
                // Update only the specific field
                await updateDoc(docRef, { [fieldName]: newValue });
                console.log(`Page '${pageId}', champ '${fieldName}' mis à jour avec succès.`);

                // Update local pageContent object
                if (pageContent[pageId]) {
                    pageContent[pageId][fieldName] = newValue;
                }

                toggleEditMode(container, false); // Switch back to display mode
                renderPage(); // Re-render the entire app to reflect changes on public pages
            } catch (error) {
                console.error("Erreur lors de la sauvegarde du contenu de la page:", error);
                alert("Erreur lors de la sauvegarde. Veuillez réessayer.");
            }
        }


        // --- Event Listeners ---
        document.getElementById('nav-home').addEventListener('click', () => { currentPage = 'home'; renderPage(); });
        document.getElementById('nav-shop').addEventListener('click', () => { currentPage = 'shop'; renderPage(); });
        document.getElementById('nav-about').addEventListener('click', () => { currentPage = 'about'; renderPage(); }); // Changed ID
        document.getElementById('nav-contact').addEventListener('click', () => { currentPage = 'contact'; renderPage(); });
        document.getElementById('nav-dossier').addEventListener('click', () => { currentPage = 'dossier'; renderPage(); });
        
        // Updated: nav-login-signup always opens auth modal
        navLoginSignupButton.addEventListener('click', () => showAuthModal('login'));

        // New: nav-admin-panel button
        if (navAdminPanelButton) {
            navAdminPanelButton.addEventListener('click', () => {
                currentPage = 'admin-tools';
                renderPage();
            });
        }
        
        document.getElementById('nav-logout').addEventListener('click', handleLogout);

        // Auth modal event listeners
        if (authForm) {
            authForm.addEventListener('submit', handleAuthFormSubmit);
        }
        if (authToggleModeButton) {
            authToggleModeButton.addEventListener('click', (e) => {
                e.preventDefault();
                showAuthModal(isLoginMode ? 'signup' : 'login');
            });
        }
        if (authCloseButton) {
            authCloseButton.addEventListener('click', hideAuthModal);
        }

        // Vehicle detail modal event listeners
        detailCloseButton.addEventListener('click', hideVehicleDetailModal);
        detailCloseButtonBottom.addEventListener('click', hideVehicleDetailModal);
        prevImageButton.addEventListener('click', () => {
            currentImageIndex = (currentImageIndex - 1 + selectedVehicle.imageUrls.length) % selectedVehicle.imageUrls.length;
            updateDetailImage();
        });
        nextImageButton.addEventListener('click', () => {
            currentImageIndex = (currentImageIndex + 1) % selectedVehicle.imageUrls.length;
            updateDetailImage();
        });
        detailImage.addEventListener('click', () => {
            if (selectedVehicle && selectedVehicle.imageUrls && selectedVehicle.imageUrls.length > 0) {
                showFullscreenImage(selectedVehicle.imageUrls[currentImageIndex]);
            }
        });

        fullscreenCloseButton.addEventListener('click', hideFullscreenImage);

        // Initial setup and render when script loads
        document.addEventListener('DOMContentLoaded', async () => {
            await initializePageContentDefaults(); // Ensure default content exists
            setupAuth(); // Initialize Firebase Auth listener (will call renderPage)
        });
    </script>
</body>
</html>
